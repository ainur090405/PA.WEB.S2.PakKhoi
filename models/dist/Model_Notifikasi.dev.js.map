{"version":3,"sources":["Model_Notifikasi.js"],"names":["connection","require","Model_Notifikasi","Data","Promise","resolve","reject","id_user","Error","query","err","result","sql","rows","isUpdating","console","log","notifSql","Date","toLocaleString","error","count","id_notifikasi","module","exports"],"mappings":"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","sourcesContent":["const connection = require('../config/database');\r\n\r\nclass Model_Notifikasi {\r\n\r\n  static async Store(Data) {\r\n    return new Promise((resolve, reject) => {\r\n      // Pastikan id_user tidak null\r\n      if (!Data.id_user) {\r\n        reject(new Error('id_user cannot be null'));\r\n        return;\r\n      }\r\n      connection.query('INSERT INTO notifikasi SET ?', Data, (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getByUser(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `SELECT * FROM notifikasi WHERE id_user = ? ORDER BY id_notifikasi DESC LIMIT 10`;\r\n      connection.query(sql, [id_user], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async autoUpdateStatus() {\r\n    if (this.isUpdating) return console.log('⏳ Skip auto update, masih jalan.');\r\n\r\n    this.isUpdating = true;\r\n    try {\r\n      const sql = `\r\n        UPDATE reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        SET r.status = 'selesai'\r\n        WHERE r.status IN ('disetujui', 'menunggu')\r\n          AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\r\n\r\n        UPDATE reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        SET r.status = 'booking', j.status_slot = 'kosong'\r\n        WHERE r.status = 'menunggu'\r\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\r\n      `;\r\n\r\n      await new Promise((resolve, reject) => {\r\n        connection.query(sql, (err) => (err ? reject(err) : resolve()));\r\n      });\r\n\r\n      const notifSql = `\r\n        INSERT INTO notifikasi (id_user, pesan)\r\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' telah selesai otomatis.')\r\n        FROM reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        JOIN arena a ON j.id_arena = a.id_arena\r\n        WHERE r.status = 'selesai';\r\n\r\n        INSERT INTO notifikasi (id_user, pesan)\r\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' dibatalkan otomatis karena tidak dikonfirmasi admin.')\r\n        FROM reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        JOIN arena a ON j.id_arena = a.id_arena\r\n        WHERE r.status = 'booking';\r\n      `;\r\n\r\n      await new Promise((resolve, reject) => {\r\n        connection.query(notifSql, (err) => (err ? reject(err) : resolve()));\r\n      });\r\n\r\n      console.log(`[AUTO] Status & notifikasi diperbarui otomatis ${new Date().toLocaleString()}`);\r\n    } catch (err) {\r\n      console.error('❌ Error auto update:', err);\r\n    } finally {\r\n      this.isUpdating = false;\r\n    }\r\n  }\r\n\r\n\r\n  static async getUnreadCount(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `SELECT COUNT(*) as count FROM notifikasi WHERE id_user = ? AND dibaca = 0`;\r\n      connection.query(sql, [id_user], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows[0].count);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async markAsRead(id_notifikasi) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('UPDATE notifikasi SET dibaca = 1 WHERE id_notifikasi = ?', [id_notifikasi], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async markAllAsRead(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('UPDATE notifikasi SET dibaca = 1 WHERE id_user = ?', [id_user], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = Model_Notifikasi;\r\n"],"file":"Model_Notifikasi.dev.js"}