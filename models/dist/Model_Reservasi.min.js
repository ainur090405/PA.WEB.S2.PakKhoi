"use strict";function _classCallCheck(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(n,e){for(var a=0;a<e.length;a++){var r=e[a];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}function _createClass(n,e,a){return e&&_defineProperties(n.prototype,e),a&&_defineProperties(n,a),n}var connection=require("../config/database"),Model_Jadwal=require("./Model_Jadwal"),isUpdating=!1,Model_Reservasi=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"Store",value:function(e){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(a,r){connection.query("INSERT INTO reservasi SET ?",e,function(n,e){n?r(n):a(e)})}));case 1:case"end":return n.stop()}})}},{key:"getByUser",value:function(e){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(a,r){connection.query("\n        SELECT \n          r.id_reservasi,\n          r.status,\n          r.tanggal_pesan,\n          r.payment_method,\n          r.amount,\n          a.nama_arena,\n          j.tanggal,\n          j.jam_mulai,\n          j.jam_selesai,\n          CASE \n            WHEN u.id_ulasan IS NOT NULL THEN 1 \n            ELSE 0 \n          END AS sudah_ulasan\n        FROM reservasi r\n        JOIN arena a ON r.id_arena = a.id_arena\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        LEFT JOIN ulasan u ON r.id_reservasi = u.id_reservasi\n        WHERE r.id_user = ?\n        ORDER BY r.tanggal_pesan DESC\n      ",[e],function(n,e){n?r(n):a(e)})}));case 1:case"end":return n.stop()}})}},{key:"getAll",value:function(){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(a,r){connection.query("\n        SELECT r.*, u.nama AS nama_user, a.nama_arena, j.tanggal, j.jam_mulai\n        FROM reservasi r\n        JOIN users u ON r.id_user = u.id_user\n        JOIN arena a ON r.id_arena = a.id_arena\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        ORDER BY r.tanggal_pesan DESC\n      ",function(n,e){n?r(n):a(e)})}));case 1:case"end":return n.stop()}})}},{key:"getById",value:function(e){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(a,r){connection.query("\n        SELECT r.*, u.nama AS nama_user, a.nama_arena, j.tanggal, j.jam_mulai\n        FROM reservasi r\n        JOIN users u ON r.id_user = u.id_user\n        JOIN arena a ON r.id_arena = a.id_arena\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        WHERE r.id_reservasi = ?\n      ",[e],function(n,e){n?r(n):a(e)})}));case 1:case"end":return n.stop()}})}},{key:"autoUpdateStatus",value:function(){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:if(isUpdating)return console.log("⏳ Skip auto update, server sedang sibuk."),n.abrupt("return");n.next=3;break;case 3:return isUpdating=!0,n.prev=4,"\n      -- 1️⃣ Ubah ke 'selesai' jika waktu main sudah lewat\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET r.status = 'selesai'\n      WHERE r.status IN ('disetujui', 'menunggu')\n        AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\n\n      -- 2️⃣ Jika status 'menunggu' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET \n        r.status = 'booking',\n        j.status_slot = 'kosong'\n      WHERE r.status = 'menunggu'\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\n\n      -- 3️⃣ Jika status 'ditolak' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET \n        r.status = 'booking',\n        j.status_slot = 'kosong'\n      WHERE r.status = 'ditolak'\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\n    ",n.next=8,regeneratorRuntime.awrap(new Promise(function(a,r){connection.query("\n      -- 1️⃣ Ubah ke 'selesai' jika waktu main sudah lewat\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET r.status = 'selesai'\n      WHERE r.status IN ('disetujui', 'menunggu')\n        AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\n\n      -- 2️⃣ Jika status 'menunggu' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET \n        r.status = 'booking',\n        j.status_slot = 'kosong'\n      WHERE r.status = 'menunggu'\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\n\n      -- 3️⃣ Jika status 'ditolak' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET \n        r.status = 'booking',\n        j.status_slot = 'kosong'\n      WHERE r.status = 'ditolak'\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\n    ",function(n,e){n?r(n):a(e)})}));case 8:console.log("[AUTO] Status reservasi & jadwal diperbarui otomatis: ".concat((new Date).toLocaleString())),n.next=14;break;case 11:n.prev=11,n.t0=n.catch(4),console.error("❌ Gagal auto update status:",n.t0);case 14:return n.prev=14,isUpdating=!1,n.finish(14);case 17:case"end":return n.stop()}},null,null,[[4,11,14,17]])}},{key:"isBusy",value:function(){return isUpdating}},{key:"rejectAndFreeSlot",value:function(e){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(a,r){connection.query("\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET \n        r.status = 'ditolak',\n        j.status_slot = 'kosong'\n      WHERE r.id_reservasi = ?;\n    ",[e],function(n,e){n?r(n):a(e)})}));case 1:case"end":return n.stop()}})}},{key:"Update",value:function(e,t){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(a,r){connection.query("UPDATE reservasi SET ? WHERE id_reservasi = ?",[t,e],function(n,e){n?r(n):a(e)})}));case 1:case"end":return n.stop()}})}},{key:"Delete",value:function(e){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(a,r){connection.query("DELETE FROM reservasi WHERE id_reservasi = ?",[e],function(n,e){n?r(n):a(e)})}));case 1:case"end":return n.stop()}})}}]),n}();module.exports=Model_Reservasi;
//# sourceMappingURL=Model_Reservasi.min.js.map
