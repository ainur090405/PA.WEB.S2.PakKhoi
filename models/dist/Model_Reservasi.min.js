"use strict";function _classCallCheck(a,n){if(!(a instanceof n))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,n){for(var e=0;e<n.length;e++){var r=n[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(a,r.key,r)}}function _createClass(a,n,e){return n&&_defineProperties(a.prototype,n),e&&_defineProperties(a,e),a}var connection=require("../config/database"),Model_Jadwal=require("./Model_Jadwal");function runQuery(a){var n=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return new Promise(function(e,r){connection.query(a,n,function(a,n){if(a)return r(a);e(n)})})}var isUpdating=!1,Model_Reservasi=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"Store",value:function(n){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",runQuery("INSERT INTO reservasi SET ?",[n]));case 1:case"end":return a.stop()}})}},{key:"getByUser",value:function(n){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return"\n      SELECT\n        r.*,\n        a.nama_arena,\n        j.tanggal,\n        j.jam_mulai,\n        j.jam_selesai,\n\n        p.id_pembayaran,\n        p.metode_pembayaran   AS pembayaran_metode,\n        p.status_pembayaran   AS pembayaran_status,\n        p.status_bukti        AS pembayaran_status_bukti,\n        p.bukti_pembayaran    AS pembayaran_bukti,\n        p.jumlah              AS pembayaran_jumlah,\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\n        p.catatan_admin       AS pembayaran_catatan\n\n      FROM reservasi r\n      JOIN arena a ON r.id_arena = a.id_arena\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\n      WHERE r.id_user = ?\n      ORDER BY r.tanggal_pesan DESC\n    ",a.abrupt("return",runQuery("\n      SELECT\n        r.*,\n        a.nama_arena,\n        j.tanggal,\n        j.jam_mulai,\n        j.jam_selesai,\n\n        p.id_pembayaran,\n        p.metode_pembayaran   AS pembayaran_metode,\n        p.status_pembayaran   AS pembayaran_status,\n        p.status_bukti        AS pembayaran_status_bukti,\n        p.bukti_pembayaran    AS pembayaran_bukti,\n        p.jumlah              AS pembayaran_jumlah,\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\n        p.catatan_admin       AS pembayaran_catatan\n\n      FROM reservasi r\n      JOIN arena a ON r.id_arena = a.id_arena\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\n      WHERE r.id_user = ?\n      ORDER BY r.tanggal_pesan DESC\n    ",[n]));case 2:case"end":return a.stop()}})}},{key:"getAll",value:function(){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return"\n      SELECT\n        r.*,\n        u.nama              AS nama_user,\n        a.nama_arena,\n        j.tanggal,\n        j.jam_mulai,\n        j.jam_selesai,\n\n        p.id_pembayaran,\n        p.metode_pembayaran   AS pembayaran_metode,\n        p.status_pembayaran   AS pembayaran_status,\n        p.status_bukti        AS pembayaran_status_bukti,\n        p.bukti_pembayaran    AS pembayaran_bukti,\n        p.jumlah              AS pembayaran_jumlah,\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\n        p.catatan_admin       AS pembayaran_catatan\n\n      FROM reservasi r\n      JOIN users u   ON r.id_user = u.id_user\n      JOIN arena a   ON r.id_arena = a.id_arena\n      JOIN jadwal j  ON r.id_jadwal = j.id_jadwal\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\n      ORDER BY r.tanggal_pesan DESC\n    ",a.abrupt("return",runQuery("\n      SELECT\n        r.*,\n        u.nama              AS nama_user,\n        a.nama_arena,\n        j.tanggal,\n        j.jam_mulai,\n        j.jam_selesai,\n\n        p.id_pembayaran,\n        p.metode_pembayaran   AS pembayaran_metode,\n        p.status_pembayaran   AS pembayaran_status,\n        p.status_bukti        AS pembayaran_status_bukti,\n        p.bukti_pembayaran    AS pembayaran_bukti,\n        p.jumlah              AS pembayaran_jumlah,\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\n        p.catatan_admin       AS pembayaran_catatan\n\n      FROM reservasi r\n      JOIN users u   ON r.id_user = u.id_user\n      JOIN arena a   ON r.id_arena = a.id_arena\n      JOIN jadwal j  ON r.id_jadwal = j.id_jadwal\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\n      ORDER BY r.tanggal_pesan DESC\n    "));case 2:case"end":return a.stop()}})}},{key:"getById",value:function(n){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return"\n      SELECT\n        r.*,\n        u.nama              AS nama_user,\n        a.nama_arena,\n        j.tanggal,\n        j.jam_mulai,\n        j.jam_selesai,\n\n        p.id_pembayaran,\n        p.metode_pembayaran   AS pembayaran_metode,\n        p.status_pembayaran   AS pembayaran_status,\n        p.status_bukti        AS pembayaran_status_bukti,\n        p.bukti_pembayaran    AS pembayaran_bukti,\n        p.jumlah              AS pembayaran_jumlah,\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\n        p.catatan_admin       AS pembayaran_catatan\n\n      FROM reservasi r\n      JOIN users u   ON r.id_user = u.id_user\n      JOIN arena a   ON r.id_arena = a.id_arena\n      JOIN jadwal j  ON r.id_jadwal = j.id_jadwal\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\n      WHERE r.id_reservasi = ?\n      LIMIT 1\n    ",a.abrupt("return",runQuery("\n      SELECT\n        r.*,\n        u.nama              AS nama_user,\n        a.nama_arena,\n        j.tanggal,\n        j.jam_mulai,\n        j.jam_selesai,\n\n        p.id_pembayaran,\n        p.metode_pembayaran   AS pembayaran_metode,\n        p.status_pembayaran   AS pembayaran_status,\n        p.status_bukti        AS pembayaran_status_bukti,\n        p.bukti_pembayaran    AS pembayaran_bukti,\n        p.jumlah              AS pembayaran_jumlah,\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\n        p.catatan_admin       AS pembayaran_catatan\n\n      FROM reservasi r\n      JOIN users u   ON r.id_user = u.id_user\n      JOIN arena a   ON r.id_arena = a.id_arena\n      JOIN jadwal j  ON r.id_jadwal = j.id_jadwal\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\n      WHERE r.id_reservasi = ?\n      LIMIT 1\n    ",[n]));case 2:case"end":return a.stop()}})}},{key:"autoUpdateStatus",value:function(){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:if(isUpdating)return a.abrupt("return");a.next=2;break;case 2:return isUpdating=!0,a.prev=3,a.next=6,regeneratorRuntime.awrap(runQuery("\n        UPDATE reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        SET r.status = 'selesai'\n        WHERE r.status = 'disetujui'\n          AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW()\n      "));case 6:return a.next=8,regeneratorRuntime.awrap(runQuery("\n        UPDATE reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        SET r.status = 'booking',\n            j.status_slot = 'kosong'\n        WHERE r.status = 'menunggu'\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20\n      "));case 8:return a.next=10,regeneratorRuntime.awrap(runQuery("\n        UPDATE reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        SET r.status = 'booking',\n            j.status_slot = 'kosong'\n        WHERE r.status = 'ditolak'\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20\n      "));case 10:console.log("AUTO UPDATE OK"),a.next=16;break;case 13:a.prev=13,a.t0=a.catch(3),console.error("AUTO UPDATE ERROR:",a.t0);case 16:isUpdating=!1;case 17:case"end":return a.stop()}},null,null,[[3,13]])}},{key:"isBusy",value:function(){return isUpdating}},{key:"rejectAndFreeSlot",value:function(n){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return"\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET r.status = 'ditolak',\n          j.status_slot = 'kosong'\n      WHERE r.id_reservasi = ?\n    ",a.abrupt("return",runQuery("\n      UPDATE reservasi r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n      SET r.status = 'ditolak',\n          j.status_slot = 'kosong'\n      WHERE r.id_reservasi = ?\n    ",[n]));case 2:case"end":return a.stop()}})}},{key:"Update",value:function(n,e){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",runQuery("UPDATE reservasi SET ? WHERE id_reservasi = ?",[e,n]));case 1:case"end":return a.stop()}})}},{key:"Delete",value:function(n){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",runQuery("DELETE FROM reservasi WHERE id_reservasi = ?",[n]));case 1:case"end":return a.stop()}})}}]),a}();module.exports=Model_Reservasi;
//# sourceMappingURL=Model_Reservasi.min.js.map
