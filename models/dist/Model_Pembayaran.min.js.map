{"version":3,"sources":["Model_Pembayaran.js"],"names":["connection","require","Model_Pembayaran","Promise","resolve","reject","query","err","rows","id_pembayaran","sql","id_reservasi","data","result","jumlah","metode_pembayaran","status_pembayaran","status_bukti","konfirmasi_admin","tanggal_pembayaran","Date","created_at","updated_at","this","Store","filename","update","bukti_pembayaran","affectedRows","insert","err2","res2","status","catatan_admin","undefined"],"mappings":"mZACA,IAAMA,WAAaC,QAAQ,sBAErBC,kPAOK,IAAIC,QAAQ,SAACC,EAASC,GAF/BL,WAAAM,MALIJ,iXAKJ,SAAAK,EAAAC,GAgBM,GAAID,EAAK,OAAOF,EAAOE,GACvBH,EAAQI,4EAdDC,4GAYTT,IAAAA,QAAAA,SAAAA,EAAiBU,GACfV,WAAAM,MACAF,mDACD,CAAAK,GACF,SAAAF,EAAAC,GASK,GAAID,EAAK,OAAOF,EAAOE,GACvBH,EAAQI,mFAOYG,4GACnB,IAAIR,QAAQ,SAACC,EAASC,GAC3BL,WAAWM,MACT,0DACA,CAACK,GACD,SAACJ,EAAKC,GACJ,GAAID,EAAK,OAAOF,EAAOE,GACvBH,EAAQI,0EAMGI,4GACV,IAAIT,QAAQ,SAACC,EAASC,GAC3BL,WAAWM,MACT,+BACAM,EACA,SAACL,EAAKM,GACJ,GAAIN,EAAK,OAAOF,EAAOE,GApB/BH,EAAAS,2EA2BoBJ,EAAeG,4GAC1B,IAAIT,QAAQ,SAACC,EAASC,GAC3BL,WAAWM,MACT,kDA3BFN,CAAAA,EAAAA,GAII,SAAAO,EAAAM,GACAT,GAAAA,EAAAA,OAAQI,EAARD,GACDH,EANHS,2EAqCgBJ,4GACX,IAAIN,QAAQ,SAACC,EAASC,GAC3BL,WAAWM,MACT,iDACA,CAACG,GACD,SAACF,EAAKM,GACJ,GAAIN,EAAK,OAhCEK,EAgCYL,GACvBH,EAAQS,yFAWkBF,EAAcG,gGACxCF,EAAO,CACXD,aAAAA,EACAI,kBAAmB,MACnBC,kBAAmB,SACnBF,OAAAA,EACAG,aAAc,UACdC,kBAAkB,EAClBC,mBAAoB,IAAIC,KACxBC,WAAY,IAAID,KAChBE,WAAY,IAAIF,wBAEXG,KAAKC,MAAMZ,iGAQgBD,EAAcc,4GACzC,IAAItB,QAAQ,SAACC,EAASC,GAC3B,IAAMqB,EAAS,CACbC,iBAAkBF,EAClBR,aAAc,WACdD,kBAAmB,UACnBG,mBAAoB,IAAIC,KACxBF,kBAAkB,EAClBI,WAAY,IAAIF,MAGlBpB,WAAWM,MACT,iDACA,CAACoB,EAAQf,GACT,SAACJ,EAAKM,GACJ,GAAIN,EAAK,OAAOF,EAAOE,GA/CvB,GAAgBF,IAAhBQ,EAAAe,aAAuBrB,CAExB,IANHsB,EAAA,CAQDlB,aAAAA,EAiDSI,kBAAmB,YACnBC,kBAAmB,UACnBC,aAAc,WACdU,iBAAkBF,EAClBX,OAAQ,EACRI,kBAAkB,EAClBC,mBAAoB,IAAIC,KApDpCC,WAAA,IAAAD,KACAE,WAAA,IAAAF,MAGApB,WAAAM,MAqDY,+BACAuB,EACA,SAACC,EAAMC,GACL,GAAID,EAAM,OAAOzB,EAAOyB,GACxB1B,EAAQ2B,UAIZ3B,EAAQS,8FAoBqBF,EAAcqB,4GAAQC,iCAAgB,uBACpE,IAAI9B,QAAQ,SAACC,EAASC,GAlE/B,IAAAO,EAAA,CACAI,kBAAAgB,EAGAf,aAAA,cAAAe,GAAA,SAAAA,EAmEU,gBACAE,EACJhB,kBAAkB,EAClBe,cAAAA,EACAX,WAAY,IAAIF,MAGlBpB,WAAWM,MACT,iDAxEF,CAAAM,EAAAD,GACEgB,SAAAA,EAAAA,GACAV,GAAAA,EAAAA,OAAAA,EAAcV,GAAsBH,EAAAS,kMAWlC,IAAAV,QAAII,SAAAA,EAAKF,GAaLgB,WAAAA,MA2DC,+ZA3DDA,SAAAA,EAAYb,GACZc,GAAAA,EAAAA,OAAAA,EAAAA,GAValB,EAAAI,qDAqBfJ,OAAAA,QAAAA","file":"Model_Pembayaran.min.js","sourcesContent":["// models/Model_Pembayaran.js\r\nconst connection = require('../config/database');\r\n\r\nclass Model_Pembayaran {\r\n  // ========================\r\n  // BASIC GET / CRUD\r\n  // ========================\r\n\r\n  // Ambil semua pembayaran (untuk admin, join user & arena)\r\n  static async getAllWithUserArena() {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT \r\n          p.*,\r\n          r.status AS status_reservasi,\r\n          u.nama AS nama_user,\r\n          a.nama_arena\r\n        FROM pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        ORDER BY p.tanggal_pembayaran DESC\r\n      `;\r\n      connection.query(sql, (err, rows) => {\r\n        if (err) return reject(err);\r\n        resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getById(id_pembayaran) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n        [id_pembayaran],\r\n        (err, rows) => {\r\n          if (err) return reject(err);\r\n          resolve(rows);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // Ambil 1 pembayaran berdasarkan reservasi\r\n  static async getByReservasi(id_reservasi) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'SELECT * FROM pembayaran WHERE id_reservasi = ? LIMIT 1',\r\n        [id_reservasi],\r\n        (err, rows) => {\r\n          if (err) return reject(err);\r\n          resolve(rows);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Store(data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'INSERT INTO pembayaran SET ?',\r\n        data,\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Update(id_pembayaran, data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_pembayaran = ?',\r\n        [data, id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Delete(id_pembayaran) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'DELETE FROM pembayaran WHERE id_pembayaran = ?',\r\n        [id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA COD\r\n  // ========================\r\n\r\n  // Dipakai saat user pilih COD\r\n  static async createCODByReservasi(id_reservasi, jumlah) {\r\n    const data = {\r\n      id_reservasi,\r\n      metode_pembayaran: 'cod',      // enum('cod','transaksi')\r\n      status_pembayaran: 'unpaid',   // default di DB juga 'unpaid'\r\n      jumlah,\r\n      status_bukti: 'pending',\r\n      konfirmasi_admin: false,\r\n      tanggal_pembayaran: new Date(),\r\n      created_at: new Date(),\r\n      updated_at: new Date()\r\n    };\r\n    return this.Store(data);\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA TRANSFER (UPLOAD BUKTI)\r\n  // ========================\r\n\r\n  // Dipanggil ketika user upload bukti transfer\r\n  static async uploadBuktiByReservasi(id_reservasi, filename) {\r\n    return new Promise((resolve, reject) => {\r\n      const update = {\r\n        bukti_pembayaran: filename,\r\n        status_bukti: 'uploaded',           // enum('pending','uploaded')\r\n        status_pembayaran: 'pending',       // enum('pending','uploaded','paid','confirmed','unpaid')\r\n        tanggal_pembayaran: new Date(),\r\n        konfirmasi_admin: false,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [update, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n\r\n          if (result.affectedRows === 0) {\r\n            // belum ada pembayaran → buat baru\r\n            const insert = {\r\n              id_reservasi,\r\n              metode_pembayaran: 'transaksi',   // sesuai enum di tabel\r\n              status_pembayaran: 'pending',\r\n              status_bukti: 'uploaded',\r\n              bukti_pembayaran: filename,\r\n              jumlah: 0,\r\n              konfirmasi_admin: false,\r\n              tanggal_pembayaran: new Date(),\r\n              created_at: new Date(),\r\n              updated_at: new Date()\r\n            };\r\n            connection.query(\r\n              'INSERT INTO pembayaran SET ?',\r\n              insert,\r\n              (err2, res2) => {\r\n                if (err2) return reject(err2);\r\n                resolve(res2);\r\n              }\r\n            );\r\n          } else {\r\n            resolve(result);\r\n          }\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // KONFIRMASI ADMIN\r\n  // ========================\r\n\r\n  /**\r\n   * status:\r\n   *   - 'confirmed' → pembayaran fix (bisa untuk COD atau transfer)\r\n   *   - 'paid'      → COD sudah dibayar tapi belum final, terserah flow-mu\r\n   *   - 'unpaid'    → belum bayar (COD)\r\n   *   - 'uploaded'  → jarang dipakai, kita pakai status_bukti utk ini\r\n   *\r\n   * Catatan: JANGAN gunakan 'rejected' karena tidak ada di enum status_pembayaran.\r\n   */\r\n  static async confirmPaymentByReservasi(id_reservasi, status, catatan_admin = null) {\r\n    return new Promise((resolve, reject) => {\r\n      const data = {\r\n        status_pembayaran: status,\r\n        // status_bukti hanya relevan untuk transfer\r\n        status_bukti: status === 'confirmed' || status === 'paid'\r\n          ? 'uploaded'    // bukti tetap 'uploaded'\r\n          : undefined,\r\n        konfirmasi_admin: true,\r\n        catatan_admin,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [data, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // Pembayaran yang status_pembayaran masih 'pending' → untuk list verifikasi admin\r\n  static async getPendingPayments() {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT \r\n          p.*,\r\n          r.status AS status_reservasi,\r\n          u.nama AS nama_user,\r\n          a.nama_arena\r\n        FROM pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        WHERE p.status_pembayaran = 'pending'\r\n        ORDER BY p.tanggal_pembayaran ASC\r\n      `;\r\n      connection.query(sql, (err, rows) => {\r\n        if (err) return reject(err);\r\n        resolve(rows);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = Model_Pembayaran;\r\n"]}