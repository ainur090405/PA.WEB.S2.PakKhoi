{"version":3,"sources":["Model_Pembayaran.js"],"names":["connection","require","Model_Notifikasi","Model_Reservasi","Model_Jadwal","createLog","runQuery","sql","params","arguments","length","undefined","Promise","resolve","reject","err","rows","id_pembayaran","id_reservasi","data","query","result","jumlah","metode_pembayaran","status_bukti","konfirmasi_admin","tanggal_pembayaran","Date","created_at","updated_at","this","Store","filename","update","affectedRows","insert","status_pembayaran","err2","res2","catatan_admin","status","catatanDefault","row","console","warn","_context11","t0","id_user","judul","isi_pesan","concat","nama_arena","jenis_notif","tipe","dibaca","status_reservasi","_context12","module","exports","Model_Pembayaran"],"mappings":"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","file":"Model_Pembayaran.min.js","sourcesContent":["// models/Model_Pembayaran.js\r\nconst connection = require('../config/database');\r\n\r\n// tambahan untuk notifikasi + log auto reject\r\nconst Model_Notifikasi = require('./Model_Notifikasi');\r\nconst Model_Reservasi = require('./Model_Reservasi');\r\nconst Model_Jadwal = require('./Model_Jadwal');\r\nconst { createLog } = require('../helpers/logHelper');\r\n\r\n// helper kecil biar query pakai Promise\r\nfunction runQuery(sql, params = []) {\r\n  return new Promise((resolve, reject) => {\r\n    connection.query(sql, params, (err, rows) => {\r\n      if (err) return reject(err);\r\n      resolve(rows);\r\n    });\r\n  });\r\n}\r\n\r\nclass Model_Pembayaran {\r\n  // ========================\r\n  // BASIC GET / CRUD\r\n  // ========================\r\n\r\n  // Ambil semua pembayaran (untuk admin, join user & arena)\r\n  static async getAllWithUserArena() {\r\n    const sql = `\r\n      SELECT \r\n        p.*,\r\n        r.status AS status_reservasi,\r\n        u.nama AS nama_user,\r\n        a.nama_arena\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN users u ON r.id_user = u.id_user\r\n      JOIN arena a ON r.id_arena = a.id_arena\r\n      ORDER BY p.tanggal_pembayaran DESC\r\n    `;\r\n    return runQuery(sql);\r\n  }\r\n\r\n  static async getById(id_pembayaran) {\r\n    return runQuery(\r\n      'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n      [id_pembayaran]\r\n    );\r\n  }\r\n\r\n  // Ambil 1 pembayaran berdasarkan reservasi\r\n  static async getByReservasi(id_reservasi) {\r\n    return runQuery(\r\n      'SELECT * FROM pembayaran WHERE id_reservasi = ? LIMIT 1',\r\n      [id_reservasi]\r\n    );\r\n  }\r\n\r\n  static async Store(data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'INSERT INTO pembayaran SET ?',\r\n        data,\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Update(id_pembayaran, data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_pembayaran = ?',\r\n        [data, id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Delete(id_pembayaran) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'DELETE FROM pembayaran WHERE id_pembayaran = ?',\r\n        [id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA COD\r\n  // ========================\r\n\r\n  // Dipakai saat user pilih COD\r\n  static async createCODByReservasi(id_reservasi, jumlah) {\r\n    const data = {\r\n      id_reservasi,\r\n      metode_pembayaran: 'cod',      // enum('cod','transaksi')\r\n      status_pembayaran: 'unpaid',   // default di DB juga 'unpaid'\r\n      jumlah,\r\n      status_bukti: 'pending',\r\n      konfirmasi_admin: false,\r\n      tanggal_pembayaran: new Date(),\r\n      created_at: new Date(),\r\n      updated_at: new Date()\r\n    };\r\n    return this.Store(data);\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA TRANSFER (UPLOAD BUKTI)\r\n  // ========================\r\n\r\n  // Dipanggil ketika user upload bukti transfer\r\n  static async uploadBuktiByReservasi(id_reservasi, filename) {\r\n    return new Promise((resolve, reject) => {\r\n      const update = {\r\n        bukti_pembayaran: filename,\r\n        status_bukti: 'uploaded',           // enum('pending','uploaded')\r\n        status_pembayaran: 'pending',       // enum di tabel, kita pakai 'pending'\r\n        tanggal_pembayaran: new Date(),\r\n        konfirmasi_admin: false,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [update, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n\r\n          if (result.affectedRows === 0) {\r\n            // belum ada pembayaran → buat baru\r\n            const insert = {\r\n              id_reservasi,\r\n              metode_pembayaran: 'transaksi',\r\n              status_pembayaran: 'pending',\r\n              status_bukti: 'uploaded',\r\n              bukti_pembayaran: filename,\r\n              jumlah: 0,\r\n              konfirmasi_admin: false,\r\n              tanggal_pembayaran: new Date(),\r\n              created_at: new Date(),\r\n              updated_at: new Date()\r\n            };\r\n            connection.query(\r\n              'INSERT INTO pembayaran SET ?',\r\n              insert,\r\n              (err2, res2) => {\r\n                if (err2) return reject(err2);\r\n                resolve(res2);\r\n              }\r\n            );\r\n          } else {\r\n            resolve(result);\r\n          }\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // KONFIRMASI ADMIN\r\n  // ========================\r\n\r\n  static async confirmPaymentByReservasi(\r\n    id_reservasi,\r\n    status,\r\n    catatan_admin = null\r\n  ) {\r\n    return new Promise((resolve, reject) => {\r\n      const data = {\r\n        status_pembayaran: status,\r\n        status_bukti:\r\n          status === 'confirmed' || status === 'paid'\r\n            ? 'uploaded'\r\n            : undefined,\r\n        konfirmasi_admin: true,\r\n        catatan_admin,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [data, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // Pembayaran yang status_pembayaran masih 'pending' → untuk list verifikasi admin\r\n  static async getPendingPayments() {\r\n    const sql = `\r\n      SELECT \r\n        p.*,\r\n        r.status AS status_reservasi,\r\n        u.nama AS nama_user,\r\n        a.nama_arena\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN users u ON r.id_user = u.id_user\r\n      JOIN arena a ON r.id_arena = a.id_arena\r\n      WHERE p.status_pembayaran = 'pending'\r\n      ORDER BY p.tanggal_pembayaran ASC\r\n    `;\r\n    return runQuery(sql);\r\n  }\r\n\r\n// =====================================================\r\n// AUTO REJECT 1: tidak upload bukti 20 menit (transaksi)\r\n// =====================================================\r\nstatic async autoRejectNoProof() {\r\n  const rows = await runQuery(\r\n    `\r\n      SELECT\r\n        p.id_pembayaran,\r\n        p.id_reservasi,\r\n        p.status_pembayaran,\r\n        p.bukti_pembayaran,\r\n        r.id_user,\r\n        r.id_jadwal,\r\n        a.nama_arena,          -- ⬅ ambil dari tabel arena\r\n        r.status       AS status_reservasi,\r\n        r.tanggal_pesan\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN arena a     ON r.id_arena     = a.id_arena\r\n      WHERE p.metode_pembayaran = 'transaksi'\r\n        AND (p.bukti_pembayaran IS NULL OR p.bukti_pembayaran = '')\r\n        AND p.status_pembayaran IN ('unpaid','pending')\r\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20\r\n    `\r\n  );\r\n\r\n  if (!rows.length) return 0;\r\n\r\n  const catatanDefault =\r\n    'Pembayaran ditolak (waktu upload bukti 20 menit habis).';\r\n\r\n  for (const row of rows) {\r\n    await runQuery(\r\n      `\r\n        UPDATE pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN jadwal j    ON r.id_jadwal    = j.id_jadwal\r\n        SET\r\n          p.status_pembayaran = 'rejected',\r\n          p.catatan_admin = COALESCE(p.catatan_admin, ?),\r\n          p.updated_at = NOW(),\r\n          r.status = 'ditolak',\r\n          j.status_slot = 'kosong'\r\n        WHERE p.id_pembayaran = ?\r\n      `,\r\n      [catatanDefault, row.id_pembayaran]\r\n    );\r\n\r\n    try {\r\n      await createLog(\r\n        row.id_reservasi,\r\n        row.status_reservasi || 'menunggu',\r\n        'ditolak',\r\n        'Pembayaran otomatis ditolak karena batas waktu upload bukti (20 menit) telah habis.'\r\n      );\r\n    } catch (e) {\r\n      console.warn('Gagal buat log autoRejectNoProof:', e);\r\n    }\r\n\r\n    try {\r\n      if (row.id_user) {\r\n        await Model_Notifikasi.Store({\r\n          id_user: row.id_user,\r\n          judul: 'Pembayaran Ditolak (Waktu Upload Habis)',\r\n          isi_pesan: `Pembayaran Anda untuk arena ${\r\n            row.nama_arena || 'Arena'\r\n          } ditolak karena batas waktu upload bukti (20 menit) telah habis dan data pembayaran tidak lengkap.`,\r\n          jenis_notif: 'status',\r\n          tipe: 'payment',\r\n          dibaca: 0\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.warn('Gagal kirim notif autoRejectNoProof:', e);\r\n    }\r\n  }\r\n\r\n  return rows.length;\r\n}\r\n\r\n// =====================================================\r\n// AUTO REJECT 2: sudah upload, admin tidak konfirmasi 20 menit\r\n// =====================================================\r\nstatic async autoRejectLateConfirmed() {\r\n  const rows = await runQuery(\r\n    `\r\n      SELECT\r\n        p.id_pembayaran,\r\n        p.id_reservasi,\r\n        p.status_pembayaran,\r\n        p.bukti_pembayaran,\r\n        p.updated_at,\r\n        r.id_user,\r\n        r.id_jadwal,\r\n        a.nama_arena,         -- ⬅ ambil dari tabel arena\r\n        r.status AS status_reservasi\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN arena a     ON r.id_arena     = a.id_arena\r\n      WHERE p.metode_pembayaran = 'transaksi'\r\n        AND p.bukti_pembayaran IS NOT NULL\r\n        AND p.status_pembayaran IN ('unpaid','pending')\r\n        AND TIMESTAMPDIFF(MINUTE, p.updated_at, NOW()) >= 20\r\n    `\r\n  );\r\n\r\n  if (!rows.length) return 0;\r\n\r\n  const catatanDefault =\r\n    'Pembayaran ditolak karena admin tidak mengkonfirmasi dalam batas waktu 20 menit.';\r\n\r\n  for (const row of rows) {\r\n    await runQuery(\r\n      `\r\n        UPDATE pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN jadwal j    ON r.id_jadwal    = j.id_jadwal\r\n        SET\r\n          p.status_pembayaran = 'rejected',\r\n          p.catatan_admin = COALESCE(p.catatan_admin, ?),\r\n          p.updated_at = NOW(),\r\n          r.status = 'ditolak',\r\n          j.status_slot = 'kosong'\r\n        WHERE p.id_pembayaran = ?\r\n      `,\r\n      [catatanDefault, row.id_pembayaran]\r\n    );\r\n\r\n    try {\r\n      await createLog(\r\n        row.id_reservasi,\r\n        row.status_reservasi || 'menunggu',\r\n        'ditolak',\r\n        'Pembayaran otomatis ditolak karena tidak dikonfirmasi admin dalam 20 menit.'\r\n      );\r\n    } catch (e) {\r\n      console.warn('Gagal buat log autoRejectLateConfirmed:', e);\r\n    }\r\n\r\n    try {\r\n      if (row.id_user) {\r\n        await Model_Notifikasi.Store({\r\n          id_user: row.id_user,\r\n          judul: 'Pembayaran Ditolak',\r\n          isi_pesan: `Pembayaran Anda untuk arena ${\r\n            row.nama_arena || 'Arena'\r\n          } ditolak karena admin tidak mengkonfirmasi pembayaran dalam batas waktu 20 menit.`,\r\n          jenis_notif: 'status',\r\n          tipe: 'payment',\r\n          dibaca: 0\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.warn('Gagal kirim notif autoRejectLateConfirmed:', e);\r\n    }\r\n  }\r\n\r\n  return rows.length;\r\n}\r\n}\r\n\r\nmodule.exports = Model_Pembayaran;\r\n"]}