{"version":3,"sources":["Model_Notifikasi.js"],"names":["connection","require","Model_Notifikasi","Data","Promise","resolve","reject","id_user","query","err","result","rows","this","isUpdating","console","log","concat","Date","toLocaleString","error","_context3","t0","sql","id_notifikasi","notifSql","module","exports"],"mappings":"mZAAA,IAAMA,WAAaC,QAAQ,sBAErBC,yHAEeC,4GACV,IAAIC,QAAQ,SAACC,EAASC,GAEtBH,EAAKI,QAIVP,WAAWQ,MAAM,+BAAgCL,EAAM,SAACM,EAAKC,GACvDD,EAAKH,EAAOG,GACXJ,EAAQK,KAbfV,EAAU,IAAGC,MAAQ,oGAkBFM,4GACd,IAAIH,QAAQ,SAACC,EAASC,GAE3BN,WAAWQ,MADF,kFACa,CAACD,GAAU,SAACE,EAAKE,GACjCF,EAAKH,EAAOG,GACXJ,EAAQM,0KAbdC,KAAAC,oCAAAC,QAAAC,IAAA,kEACDf,KAAAA,YAAAA,ohBAoCM,IAAII,QAAQ,SAACC,EAASC,GAC1BN,WAAWQ,6eAAW,SAACC,GAAD,OAAUA,EAAMH,EAAOG,GAAOJ,6tBAmBhD,IAAID,QAAQ,SAACC,EAASC,GAC1BN,WAAWQ,0qBAAgB,SAACC,GAAD,OAAUA,EAAMH,EAAOG,GAAOJ,iBAG3DS,QAAQC,IAAR,kDAAAC,QAA8D,IAAIC,MAAOC,qEAEzEJ,QAAQK,MAAM,uBAAdC,EAAAC,6BAEAT,KAAKC,YAAa,oHA5CpBN,4GAkDO,IAAIH,QAAQ,SAACC,EAASC,GAE3BN,WAAWQ,MAlDLc,4EAkDgB,CAACf,GAAU,SAACE,EAAKE,GACjCF,EAAKH,EAAOG,GApChBT,EAAAA,EAAU,GAACQ,mFA0COe,4GAvCdC,IAAAA,QAwCW,SAACnB,EAASC,GAC3BN,WAAWQ,MAAM,2DAA4D,CAACe,GAAgB,SAACd,EAAKC,GAC9FD,EAAKH,EAAOG,GAzBhBT,EAAAA,kFA+BqBO,4GA5BvBO,IAAAA,QAAQC,SAAAA,EAART,GA8BAN,WAAWQ,MAAM,qDAAsD,CAACD,GAAU,SAACE,EAAKC,GAClFD,EAAKH,EAAOG,GACXJ,EAAQK,qDAMrBe,OAAOC,QAAUxB","file":"Model_Notifikasi.min.js","sourcesContent":["const connection = require('../config/database');\r\n\r\nclass Model_Notifikasi {\r\n\r\n  static async Store(Data) {\r\n    return new Promise((resolve, reject) => {\r\n      // Pastikan id_user tidak null\r\n      if (!Data.id_user) {\r\n        reject(new Error('id_user cannot be null'));\r\n        return;\r\n      }\r\n      connection.query('INSERT INTO notifikasi SET ?', Data, (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getByUser(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `SELECT * FROM notifikasi WHERE id_user = ? ORDER BY id_notifikasi DESC LIMIT 10`;\r\n      connection.query(sql, [id_user], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async autoUpdateStatus() {\r\n    if (this.isUpdating) return console.log('⏳ Skip auto update, masih jalan.');\r\n\r\n    this.isUpdating = true;\r\n    try {\r\n      const sql = `\r\n        UPDATE reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        SET r.status = 'selesai'\r\n        WHERE r.status IN ('disetujui', 'menunggu')\r\n          AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\r\n\r\n        UPDATE reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        SET r.status = 'booking', j.status_slot = 'kosong'\r\n        WHERE r.status = 'menunggu'\r\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\r\n      `;\r\n\r\n      await new Promise((resolve, reject) => {\r\n        connection.query(sql, (err) => (err ? reject(err) : resolve()));\r\n      });\r\n\r\n      const notifSql = `\r\n        INSERT INTO notifikasi (id_user, pesan)\r\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' telah selesai otomatis.')\r\n        FROM reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        JOIN arena a ON j.id_arena = a.id_arena\r\n        WHERE r.status = 'selesai';\r\n\r\n        INSERT INTO notifikasi (id_user, pesan)\r\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' dibatalkan otomatis karena tidak dikonfirmasi admin.')\r\n        FROM reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        JOIN arena a ON j.id_arena = a.id_arena\r\n        WHERE r.status = 'booking';\r\n      `;\r\n\r\n      await new Promise((resolve, reject) => {\r\n        connection.query(notifSql, (err) => (err ? reject(err) : resolve()));\r\n      });\r\n\r\n      console.log(`[AUTO] Status & notifikasi diperbarui otomatis ${new Date().toLocaleString()}`);\r\n    } catch (err) {\r\n      console.error('❌ Error auto update:', err);\r\n    } finally {\r\n      this.isUpdating = false;\r\n    }\r\n  }\r\n\r\n\r\n  static async getUnreadCount(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `SELECT COUNT(*) as count FROM notifikasi WHERE id_user = ? AND dibaca = 0`;\r\n      connection.query(sql, [id_user], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows[0].count);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async markAsRead(id_notifikasi) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('UPDATE notifikasi SET dibaca = 1 WHERE id_notifikasi = ?', [id_notifikasi], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async markAllAsRead(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('UPDATE notifikasi SET dibaca = 1 WHERE id_user = ?', [id_user], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = Model_Notifikasi;\r\n"]}