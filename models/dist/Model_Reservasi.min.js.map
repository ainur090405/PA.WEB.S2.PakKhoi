{"version":3,"sources":["Model_Reservasi.js"],"names":["connection","require","Model_Jadwal","isUpdating","Model_Reservasi","Promise","resolve","reject","query","Data","err","result","id_user","rows","id","console","log","sql","Date","toLocaleString","error","_context5","t0","id_reservasi","module","exports"],"mappings":"mZAAA,IAAMA,WAAaC,QAAQ,sBACrBC,aAAeD,QAAQ,kBAGzBE,YAAa,EAEXC,wHANaH,4GASR,IAAII,QAAQ,SAACC,EAASC,GAR3BL,WAAYM,MAAGP,8BAErBQ,EAAA,SAAAC,EAAAC,GAQYD,EAAKH,EAAOG,GACXJ,EAAQK,8EAKIC,4GACd,IAAIP,QAAQ,SAACC,EAASC,GAuB3BP,WAAWQ,MAtBF,onBAsBa,CAACI,GAAU,SAACF,EAAKG,GACjCH,EAAKH,EAAOG,GACXJ,EAAQO,sLAMV,IAAIR,QAAQ,SAACC,EAASC,GAS3BP,WAAWQ,MAvCX,+SAuCsB,SAACE,EAAKG,GACtBH,EAAKH,EAAOG,GACXJ,EAAQO,4EAKEC,4GACZ,IAAIT,QAAQ,SAACC,EAASC,GAJ5BP,WAaYQ,MARF,0SAQa,CAACM,GAAK,SAACJ,EAAKG,GAC5BH,EAAKH,EAAOG,GACXJ,EAAQO,0KAMfV,kBACFY,QAAQC,IAAI,4FAIdb,YAAa,2gCA6BL,IAAIE,QAAQ,SAACC,EAASC,GAjC5BQ,WAAAA,o+BAAY,SAAAL,EAAAC,GAmCJD,EAAKH,EAAOG,GACXJ,EAAQK,eA9BXM,QAAAA,IAAAA,yDAAAA,QAkC+D,IAAIC,MAAOC,qEAEhFJ,QAAQK,MAAM,8BAAdC,EAAAC,6BAPInB,YAAA,8GAKJY,OAAAA,qDAY2BQ,4GACtB,IAAIlB,QAAQ,SAACC,EAASC,GAS3BP,WAAWQ,MARF,mMAQa,CAACe,GAAe,SAACb,EAAKC,GACtCD,EAAKH,EAAOG,GACXJ,EAAQK,2EAMGG,EAAIL,4GACf,IAAIJ,QAAQ,SAACC,EAASC,GAC3BP,WAAWQ,MAAM,gDAxBL,CAAAC,EAAAK,GAAA,SAAAJ,EAAAC,GACdD,EAAOP,EAAPO,GACDJ,EAAAK,2EA6BmBG,4GACX,IAAIT,QAAQ,SAACC,EAASC,GAC3BP,WAAWQ,MAAM,+CAAgD,CAACM,GAAK,SAACJ,EAAKC,GACvED,EAAKH,EAAOG,GA5BpBJ,EAAMW,qDAmCVO,OAAOC,QAAUrB","file":"Model_Reservasi.min.js","sourcesContent":["const connection = require('../config/database');\r\nconst Model_Jadwal = require('./Model_Jadwal');\r\n\r\n// ✅ Tambahkan flag di luar class (biar tetap sama di semua pemanggilan)\r\nlet isUpdating = false;\r\n\r\nclass Model_Reservasi {\r\n\r\n  static async Store(Data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('INSERT INTO reservasi SET ?', Data, (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getByUser(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT \r\n          r.id_reservasi,\r\n          r.status,\r\n          r.tanggal_pesan,\r\n          r.payment_method,\r\n          r.amount,\r\n          a.nama_arena,\r\n          j.tanggal,\r\n          j.jam_mulai,\r\n          j.jam_selesai,\r\n          CASE \r\n            WHEN u.id_ulasan IS NOT NULL THEN 1 \r\n            ELSE 0 \r\n          END AS sudah_ulasan\r\n        FROM reservasi r\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        LEFT JOIN ulasan u ON r.id_reservasi = u.id_reservasi\r\n        WHERE r.id_user = ?\r\n        ORDER BY r.tanggal_pesan DESC\r\n      `;\r\n      connection.query(sql, [id_user], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getAll() {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT r.*, u.nama AS nama_user, a.nama_arena, j.tanggal, j.jam_mulai\r\n        FROM reservasi r\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        ORDER BY r.tanggal_pesan DESC\r\n      `;\r\n      connection.query(sql, (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getById(id) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT r.*, u.nama AS nama_user, a.nama_arena, j.tanggal, j.jam_mulai\r\n        FROM reservasi r\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        WHERE r.id_reservasi = ?\r\n      `;\r\n      connection.query(sql, [id], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\nstatic async autoUpdateStatus() {\r\n  if (isUpdating) {\r\n    console.log(\"⏳ Skip auto update, server sedang sibuk.\");\r\n    return;\r\n  }\r\n\r\n  isUpdating = true;\r\n  try {\r\n    const sql = `\r\n      -- 1️⃣ Ubah ke 'selesai' jika waktu main sudah lewat\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET r.status = 'selesai'\r\n      WHERE r.status IN ('disetujui', 'menunggu')\r\n        AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\r\n\r\n      -- 2️⃣ Jika status 'menunggu' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET \r\n        r.status = 'booking',\r\n        j.status_slot = 'kosong'\r\n      WHERE r.status = 'menunggu'\r\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\r\n\r\n      -- 3️⃣ Jika status 'ditolak' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET \r\n        r.status = 'booking',\r\n        j.status_slot = 'kosong'\r\n      WHERE r.status = 'ditolak'\r\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\r\n    `;\r\n\r\n    await new Promise((resolve, reject) => {\r\n      connection.query(sql, (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n\r\n    console.log(`[AUTO] Status reservasi & jadwal diperbarui otomatis: ${new Date().toLocaleString()}`);\r\n  } catch (err) {\r\n    console.error('❌ Gagal auto update status:', err);\r\n  } finally {\r\n    isUpdating = false;\r\n  }\r\n}\r\n\r\n  static isBusy() {\r\n    return isUpdating;\r\n  }\r\n\r\nstatic async rejectAndFreeSlot(id_reservasi) {\r\n  return new Promise((resolve, reject) => {\r\n    const sql = `\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET \r\n        r.status = 'ditolak',\r\n        j.status_slot = 'kosong'\r\n      WHERE r.id_reservasi = ?;\r\n    `;\r\n    connection.query(sql, [id_reservasi], (err, result) => {\r\n      if (err) reject(err);\r\n      else resolve(result);\r\n    });\r\n  });\r\n}\r\n\r\n\r\n  static async Update(id, Data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('UPDATE reservasi SET ? WHERE id_reservasi = ?', [Data, id], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async Delete(id) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('DELETE FROM reservasi WHERE id_reservasi = ?', [id], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = Model_Reservasi;\r\n"]}