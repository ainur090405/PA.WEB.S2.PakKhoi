{"version":3,"sources":["Model_Reservasi.js"],"names":["connection","require","Model_Jadwal","runQuery","sql","params","Promise","resolve","reject","query","err","rows","isUpdating","Model_Reservasi","Data","id_user","id","console","log","error","id_reservasi","data","module","exports"],"mappings":";;;;;;;;AAAA;AACA,IAAMA,UAAU,GAAGC,OAAO,CAAC,oBAAD,CAA1B;;AACA,IAAMC,YAAY,GAAGD,OAAO,CAAC,gBAAD,CAA5B,C,CAEA;;;AACA,SAASE,QAAT,CAAkBC,GAAlB,EAAoC;AAAA,MAAbC,MAAa,uEAAJ,EAAI;AAClC,SAAO,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACtCR,IAAAA,UAAU,CAACS,KAAX,CAAiBL,GAAjB,EAAsBC,MAAtB,EAA8B,UAACK,GAAD,EAAMC,IAAN,EAAe;AAC3C,UAAID,GAAJ,EAAS,OAAOF,MAAM,CAACE,GAAD,CAAb;AACTH,MAAAA,OAAO,CAACI,IAAD,CAAP;AACD,KAHD;AAID,GALM,CAAP;AAMD;;AAED,IAAIC,UAAU,GAAG,KAAjB;;IAEMC,e;;;;;;;;;AAEJ;0BACmBC,I;;;;;+CACVX,QAAQ,CAAC,6BAAD,EAAgC,CAACW,IAAD,CAAhC,C;;;;;;;;MAGjB;;;;8BACuBC,O;;;;;;AACfX,cAAAA,G;gDAyBCD,QAAQ,CAACC,GAAD,EAAM,CAACW,OAAD,CAAN,C;;;;;;;;MAGjB;;;;;;;;;;AAEQX,cAAAA,G;gDA0BCD,QAAQ,CAACC,GAAD,C;;;;;;;;MAGjB;;;;4BACqBY,E;;;;;;AACbZ,cAAAA,G;gDA2BCD,QAAQ,CAACC,GAAD,EAAM,CAACY,EAAD,CAAN,C;;;;;;;;MAGjB;AACA;AACA;;;;;;;;;mBAEMJ,U;;;;;;;;AACJA,cAAAA,UAAU,GAAG,IAAb;;;8CAKQT,QAAQ,iO;;;;8CASRA,QAAQ,6Q;;;;8CAURA,QAAQ,4Q;;;AASdc,cAAAA,OAAO,CAACC,GAAR,CAAY,gBAAZ;;;;;;;AAEAD,cAAAA,OAAO,CAACE,KAAR,CAAc,oBAAd;;;AAGFP,cAAAA,UAAU,GAAG,KAAb;;;;;;;;;;;6BAGc;AACd,aAAOA,UAAP;AACD,K,CAED;;;;sCAC+BQ,Y;;;;;;AACvBhB,cAAAA,G;gDAOCD,QAAQ,CAACC,GAAD,EAAM,CAACgB,YAAD,CAAN,C;;;;;;;;MAGjB;;;;2BACoBJ,E,EAAIK,I;;;;;gDACflB,QAAQ,CAAC,+CAAD,EAAkD,CAACkB,IAAD,EAAOL,EAAP,CAAlD,C;;;;;;;;;;;2BAGGA,E;;;;;gDACXb,QAAQ,CAAC,8CAAD,EAAiD,CAACa,EAAD,CAAjD,C;;;;;;;;;;;;;;AAInBM,MAAM,CAACC,OAAP,GAAiBV,eAAjB","sourcesContent":["// models/Model_Reservasi.js\r\nconst connection = require('../config/database');\r\nconst Model_Jadwal = require('./Model_Jadwal');\r\n\r\n// helper Promise\r\nfunction runQuery(sql, params = []) {\r\n  return new Promise((resolve, reject) => {\r\n    connection.query(sql, params, (err, rows) => {\r\n      if (err) return reject(err);\r\n      resolve(rows);\r\n    });\r\n  });\r\n}\r\n\r\nlet isUpdating = false;\r\n\r\nclass Model_Reservasi {\r\n\r\n  // CREATE\r\n  static async Store(Data) {\r\n    return runQuery('INSERT INTO reservasi SET ?', [Data]);\r\n  }\r\n\r\n  // GET BY USER\r\n  static async getByUser(id_user) {\r\n    const sql = `\r\n      SELECT\r\n        r.*,\r\n        a.nama_arena,\r\n        j.tanggal,\r\n        j.jam_mulai,\r\n        j.jam_selesai,\r\n\r\n        p.id_pembayaran,\r\n        p.metode_pembayaran   AS pembayaran_metode,\r\n        p.status_pembayaran   AS pembayaran_status,\r\n        p.status_bukti        AS pembayaran_status_bukti,\r\n        p.bukti_pembayaran    AS pembayaran_bukti,\r\n        p.jumlah              AS pembayaran_jumlah,\r\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\r\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\r\n        p.catatan_admin       AS pembayaran_catatan\r\n\r\n      FROM reservasi r\r\n      JOIN arena a ON r.id_arena = a.id_arena\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\r\n      WHERE r.id_user = ?\r\n      ORDER BY r.tanggal_pesan DESC\r\n    `;\r\n    return runQuery(sql, [id_user]);\r\n  }\r\n\r\n  // GET ALL (ADMIN)\r\n  static async getAll() {\r\n    const sql = `\r\n      SELECT\r\n        r.*,\r\n        u.nama              AS nama_user,\r\n        a.nama_arena,\r\n        j.tanggal,\r\n        j.jam_mulai,\r\n        j.jam_selesai,\r\n\r\n        p.id_pembayaran,\r\n        p.metode_pembayaran   AS pembayaran_metode,\r\n        p.status_pembayaran   AS pembayaran_status,\r\n        p.status_bukti        AS pembayaran_status_bukti,\r\n        p.bukti_pembayaran    AS pembayaran_bukti,\r\n        p.jumlah              AS pembayaran_jumlah,\r\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\r\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\r\n        p.catatan_admin       AS pembayaran_catatan\r\n\r\n      FROM reservasi r\r\n      JOIN users u   ON r.id_user = u.id_user\r\n      JOIN arena a   ON r.id_arena = a.id_arena\r\n      JOIN jadwal j  ON r.id_jadwal = j.id_jadwal\r\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\r\n      ORDER BY r.tanggal_pesan DESC\r\n    `;\r\n    return runQuery(sql);\r\n  }\r\n\r\n  // GET BY ID\r\n  static async getById(id) {\r\n    const sql = `\r\n      SELECT\r\n        r.*,\r\n        u.nama              AS nama_user,\r\n        a.nama_arena,\r\n        j.tanggal,\r\n        j.jam_mulai,\r\n        j.jam_selesai,\r\n\r\n        p.id_pembayaran,\r\n        p.metode_pembayaran   AS pembayaran_metode,\r\n        p.status_pembayaran   AS pembayaran_status,\r\n        p.status_bukti        AS pembayaran_status_bukti,\r\n        p.bukti_pembayaran    AS pembayaran_bukti,\r\n        p.jumlah              AS pembayaran_jumlah,\r\n        p.tanggal_pembayaran  AS pembayaran_tanggal,\r\n        p.konfirmasi_admin    AS pembayaran_konfirmasi,\r\n        p.catatan_admin       AS pembayaran_catatan\r\n\r\n      FROM reservasi r\r\n      JOIN users u   ON r.id_user = u.id_user\r\n      JOIN arena a   ON r.id_arena = a.id_arena\r\n      JOIN jadwal j  ON r.id_jadwal = j.id_jadwal\r\n      LEFT JOIN pembayaran p ON p.id_reservasi = r.id_reservasi\r\n      WHERE r.id_reservasi = ?\r\n      LIMIT 1\r\n    `;\r\n    return runQuery(sql, [id]);\r\n  }\r\n\r\n  // ==========================\r\n  // AUTO UPDATE STATUS (punya kamu)\r\n  // ==========================\r\n  static async autoUpdateStatus() {\r\n    if (isUpdating) return;\r\n    isUpdating = true;\r\n\r\n    try {\r\n      // 1) tandai selesai bila waktu main sudah lewat\r\n      // 1) tandai selesai bila waktu main sudah lewat\r\n      await runQuery(`\r\n        UPDATE reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        SET r.status = 'selesai'\r\n        WHERE r.status = 'disetujui'\r\n          AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW()\r\n      `);\r\n\r\n      // 2) menunggu > 20 menit → slot dibuka lagi (status booking)\r\n      await runQuery(`\r\n        UPDATE reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        SET r.status = 'booking',\r\n            j.status_slot = 'kosong'\r\n        WHERE r.status = 'menunggu'\r\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20\r\n      `);\r\n\r\n      // 3) ditolak > 20 menit → free slot juga\r\n      await runQuery(`\r\n        UPDATE reservasi r\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        SET r.status = 'booking',\r\n            j.status_slot = 'kosong'\r\n        WHERE r.status = 'ditolak'\r\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20\r\n      `);\r\n\r\n      console.log('AUTO UPDATE OK');\r\n    } catch (err) {\r\n      console.error('AUTO UPDATE ERROR:', err);\r\n    }\r\n\r\n    isUpdating = false;\r\n  }\r\n\r\n  static isBusy() {\r\n    return isUpdating;\r\n  }\r\n\r\n  // reject + free slot\r\n  static async rejectAndFreeSlot(id_reservasi) {\r\n    const sql = `\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET r.status = 'ditolak',\r\n          j.status_slot = 'kosong'\r\n      WHERE r.id_reservasi = ?\r\n    `;\r\n    return runQuery(sql, [id_reservasi]);\r\n  }\r\n\r\n  // UPDATE & DELETE\r\n  static async Update(id, data) {\r\n    return runQuery('UPDATE reservasi SET ? WHERE id_reservasi = ?', [data, id]);\r\n  }\r\n\r\n  static async Delete(id) {\r\n    return runQuery('DELETE FROM reservasi WHERE id_reservasi = ?', [id]);\r\n  }\r\n}\r\n\r\nmodule.exports = Model_Reservasi;\r\n"],"file":"Model_Reservasi.dev.js"}