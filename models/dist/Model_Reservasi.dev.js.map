{"version":3,"sources":["Model_Reservasi.js"],"names":["connection","require","Model_Jadwal","isUpdating","Model_Reservasi","Data","Promise","resolve","reject","query","err","result","id_user","sql","rows","id","console","log","Date","toLocaleString","error","id_reservasi","module","exports"],"mappings":"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","sourcesContent":["const connection = require('../config/database');\r\nconst Model_Jadwal = require('./Model_Jadwal');\r\n\r\n// ✅ Tambahkan flag di luar class (biar tetap sama di semua pemanggilan)\r\nlet isUpdating = false;\r\n\r\nclass Model_Reservasi {\r\n\r\n  static async Store(Data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('INSERT INTO reservasi SET ?', Data, (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getByUser(id_user) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT \r\n          r.id_reservasi,\r\n          r.status,\r\n          r.tanggal_pesan,\r\n          r.payment_method,\r\n          r.amount,\r\n          a.nama_arena,\r\n          j.tanggal,\r\n          j.jam_mulai,\r\n          j.jam_selesai,\r\n          CASE \r\n            WHEN u.id_ulasan IS NOT NULL THEN 1 \r\n            ELSE 0 \r\n          END AS sudah_ulasan\r\n        FROM reservasi r\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        LEFT JOIN ulasan u ON r.id_reservasi = u.id_reservasi\r\n        WHERE r.id_user = ?\r\n        ORDER BY r.tanggal_pesan DESC\r\n      `;\r\n      connection.query(sql, [id_user], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getAll() {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT r.*, u.nama AS nama_user, a.nama_arena, j.tanggal, j.jam_mulai\r\n        FROM reservasi r\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        ORDER BY r.tanggal_pesan DESC\r\n      `;\r\n      connection.query(sql, (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getById(id) {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT r.*, u.nama AS nama_user, a.nama_arena, j.tanggal, j.jam_mulai\r\n        FROM reservasi r\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n        WHERE r.id_reservasi = ?\r\n      `;\r\n      connection.query(sql, [id], (err, rows) => {\r\n        if (err) reject(err);\r\n        else resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\nstatic async autoUpdateStatus() {\r\n  if (isUpdating) {\r\n    console.log(\"⏳ Skip auto update, server sedang sibuk.\");\r\n    return;\r\n  }\r\n\r\n  isUpdating = true;\r\n  try {\r\n    const sql = `\r\n      -- 1️⃣ Ubah ke 'selesai' jika waktu main sudah lewat\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET r.status = 'selesai'\r\n      WHERE r.status IN ('disetujui', 'menunggu')\r\n        AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\r\n\r\n      -- 2️⃣ Jika status 'menunggu' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET \r\n        r.status = 'booking',\r\n        j.status_slot = 'kosong'\r\n      WHERE r.status = 'menunggu'\r\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\r\n\r\n      -- 3️⃣ Jika status 'ditolak' lebih dari 20 menit → ubah jadi 'booking' + kosongkan slot\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET \r\n        r.status = 'booking',\r\n        j.status_slot = 'kosong'\r\n      WHERE r.status = 'ditolak'\r\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\r\n    `;\r\n\r\n    await new Promise((resolve, reject) => {\r\n      connection.query(sql, (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n\r\n    console.log(`[AUTO] Status reservasi & jadwal diperbarui otomatis: ${new Date().toLocaleString()}`);\r\n  } catch (err) {\r\n    console.error('❌ Gagal auto update status:', err);\r\n  } finally {\r\n    isUpdating = false;\r\n  }\r\n}\r\n\r\n  static isBusy() {\r\n    return isUpdating;\r\n  }\r\n\r\nstatic async rejectAndFreeSlot(id_reservasi) {\r\n  return new Promise((resolve, reject) => {\r\n    const sql = `\r\n      UPDATE reservasi r\r\n      JOIN jadwal j ON r.id_jadwal = j.id_jadwal\r\n      SET \r\n        r.status = 'ditolak',\r\n        j.status_slot = 'kosong'\r\n      WHERE r.id_reservasi = ?;\r\n    `;\r\n    connection.query(sql, [id_reservasi], (err, result) => {\r\n      if (err) reject(err);\r\n      else resolve(result);\r\n    });\r\n  });\r\n}\r\n\r\n\r\n  static async Update(id, Data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('UPDATE reservasi SET ? WHERE id_reservasi = ?', [Data, id], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async Delete(id) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query('DELETE FROM reservasi WHERE id_reservasi = ?', [id], (err, result) => {\r\n        if (err) reject(err);\r\n        else resolve(result);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = Model_Reservasi;\r\n"],"file":"Model_Reservasi.dev.js"}