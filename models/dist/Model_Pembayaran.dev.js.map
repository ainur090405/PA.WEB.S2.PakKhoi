{"version":3,"sources":["Model_Pembayaran.js"],"names":["connection","require","Model_Notifikasi","Model_Reservasi","Model_Jadwal","createLog","runQuery","sql","params","Promise","resolve","reject","query","err","rows","Model_Pembayaran","id_pembayaran","id_reservasi","data","result","jumlah","metode_pembayaran","status_pembayaran","status_bukti","konfirmasi_admin","tanggal_pembayaran","Date","created_at","updated_at","Store","filename","update","bukti_pembayaran","affectedRows","insert","err2","res2","status","catatan_admin","undefined","length","catatanDefault","row","status_reservasi","console","warn","id_user","judul","isi_pesan","nama_arena","jenis_notif","tipe","dibaca","module","exports"],"mappings":"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","sourcesContent":["// models/Model_Pembayaran.js\r\nconst connection = require('../config/database');\r\n\r\n// tambahan untuk notifikasi + log auto reject\r\nconst Model_Notifikasi = require('./Model_Notifikasi');\r\nconst Model_Reservasi = require('./Model_Reservasi');\r\nconst Model_Jadwal = require('./Model_Jadwal');\r\nconst { createLog } = require('../helpers/logHelper');\r\n\r\n// helper kecil biar query pakai Promise\r\nfunction runQuery(sql, params = []) {\r\n  return new Promise((resolve, reject) => {\r\n    connection.query(sql, params, (err, rows) => {\r\n      if (err) return reject(err);\r\n      resolve(rows);\r\n    });\r\n  });\r\n}\r\n\r\nclass Model_Pembayaran {\r\n  // ========================\r\n  // BASIC GET / CRUD\r\n  // ========================\r\n\r\n  // Ambil semua pembayaran (untuk admin, join user & arena)\r\n  static async getAllWithUserArena() {\r\n    const sql = `\r\n      SELECT \r\n        p.*,\r\n        r.status AS status_reservasi,\r\n        u.nama AS nama_user,\r\n        a.nama_arena\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN users u ON r.id_user = u.id_user\r\n      JOIN arena a ON r.id_arena = a.id_arena\r\n      ORDER BY p.tanggal_pembayaran DESC\r\n    `;\r\n    return runQuery(sql);\r\n  }\r\n\r\n  static async getById(id_pembayaran) {\r\n    return runQuery(\r\n      'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n      [id_pembayaran]\r\n    );\r\n  }\r\n\r\n  // Ambil 1 pembayaran berdasarkan reservasi\r\n  static async getByReservasi(id_reservasi) {\r\n    return runQuery(\r\n      'SELECT * FROM pembayaran WHERE id_reservasi = ? LIMIT 1',\r\n      [id_reservasi]\r\n    );\r\n  }\r\n\r\n  static async Store(data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'INSERT INTO pembayaran SET ?',\r\n        data,\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Update(id_pembayaran, data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_pembayaran = ?',\r\n        [data, id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Delete(id_pembayaran) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'DELETE FROM pembayaran WHERE id_pembayaran = ?',\r\n        [id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA COD\r\n  // ========================\r\n\r\n  // Dipakai saat user pilih COD\r\n  static async createCODByReservasi(id_reservasi, jumlah) {\r\n    const data = {\r\n      id_reservasi,\r\n      metode_pembayaran: 'cod',      // enum('cod','transaksi')\r\n      status_pembayaran: 'unpaid',   // default di DB juga 'unpaid'\r\n      jumlah,\r\n      status_bukti: 'pending',\r\n      konfirmasi_admin: false,\r\n      tanggal_pembayaran: new Date(),\r\n      created_at: new Date(),\r\n      updated_at: new Date()\r\n    };\r\n    return this.Store(data);\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA TRANSFER (UPLOAD BUKTI)\r\n  // ========================\r\n\r\n  // Dipanggil ketika user upload bukti transfer\r\n  static async uploadBuktiByReservasi(id_reservasi, filename) {\r\n    return new Promise((resolve, reject) => {\r\n      const update = {\r\n        bukti_pembayaran: filename,\r\n        status_bukti: 'uploaded',           // enum('pending','uploaded')\r\n        status_pembayaran: 'pending',       // enum di tabel, kita pakai 'pending'\r\n        tanggal_pembayaran: new Date(),\r\n        konfirmasi_admin: false,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [update, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n\r\n          if (result.affectedRows === 0) {\r\n            // belum ada pembayaran → buat baru\r\n            const insert = {\r\n              id_reservasi,\r\n              metode_pembayaran: 'transaksi',\r\n              status_pembayaran: 'pending',\r\n              status_bukti: 'uploaded',\r\n              bukti_pembayaran: filename,\r\n              jumlah: 0,\r\n              konfirmasi_admin: false,\r\n              tanggal_pembayaran: new Date(),\r\n              created_at: new Date(),\r\n              updated_at: new Date()\r\n            };\r\n            connection.query(\r\n              'INSERT INTO pembayaran SET ?',\r\n              insert,\r\n              (err2, res2) => {\r\n                if (err2) return reject(err2);\r\n                resolve(res2);\r\n              }\r\n            );\r\n          } else {\r\n            resolve(result);\r\n          }\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // KONFIRMASI ADMIN\r\n  // ========================\r\n\r\n  static async confirmPaymentByReservasi(\r\n    id_reservasi,\r\n    status,\r\n    catatan_admin = null\r\n  ) {\r\n    return new Promise((resolve, reject) => {\r\n      const data = {\r\n        status_pembayaran: status,\r\n        status_bukti:\r\n          status === 'confirmed' || status === 'paid'\r\n            ? 'uploaded'\r\n            : undefined,\r\n        konfirmasi_admin: true,\r\n        catatan_admin,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [data, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // Pembayaran yang status_pembayaran masih 'pending' → untuk list verifikasi admin\r\n  static async getPendingPayments() {\r\n    const sql = `\r\n      SELECT \r\n        p.*,\r\n        r.status AS status_reservasi,\r\n        u.nama AS nama_user,\r\n        a.nama_arena\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN users u ON r.id_user = u.id_user\r\n      JOIN arena a ON r.id_arena = a.id_arena\r\n      WHERE p.status_pembayaran = 'pending'\r\n      ORDER BY p.tanggal_pembayaran ASC\r\n    `;\r\n    return runQuery(sql);\r\n  }\r\n\r\n// =====================================================\r\n// AUTO REJECT 1: tidak upload bukti 20 menit (transaksi)\r\n// =====================================================\r\nstatic async autoRejectNoProof() {\r\n  const rows = await runQuery(\r\n    `\r\n      SELECT\r\n        p.id_pembayaran,\r\n        p.id_reservasi,\r\n        p.status_pembayaran,\r\n        p.bukti_pembayaran,\r\n        r.id_user,\r\n        r.id_jadwal,\r\n        a.nama_arena,          -- ⬅ ambil dari tabel arena\r\n        r.status       AS status_reservasi,\r\n        r.tanggal_pesan\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN arena a     ON r.id_arena     = a.id_arena\r\n      WHERE p.metode_pembayaran = 'transaksi'\r\n        AND (p.bukti_pembayaran IS NULL OR p.bukti_pembayaran = '')\r\n        AND p.status_pembayaran IN ('unpaid','pending')\r\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20\r\n    `\r\n  );\r\n\r\n  if (!rows.length) return 0;\r\n\r\n  const catatanDefault =\r\n    'Pembayaran ditolak (waktu upload bukti 20 menit habis).';\r\n\r\n  for (const row of rows) {\r\n    await runQuery(\r\n      `\r\n        UPDATE pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN jadwal j    ON r.id_jadwal    = j.id_jadwal\r\n        SET\r\n          p.status_pembayaran = 'rejected',\r\n          p.catatan_admin = COALESCE(p.catatan_admin, ?),\r\n          p.updated_at = NOW(),\r\n          r.status = 'ditolak',\r\n          j.status_slot = 'kosong'\r\n        WHERE p.id_pembayaran = ?\r\n      `,\r\n      [catatanDefault, row.id_pembayaran]\r\n    );\r\n\r\n    try {\r\n      await createLog(\r\n        row.id_reservasi,\r\n        row.status_reservasi || 'menunggu',\r\n        'ditolak',\r\n        'Pembayaran otomatis ditolak karena batas waktu upload bukti (20 menit) telah habis.'\r\n      );\r\n    } catch (e) {\r\n      console.warn('Gagal buat log autoRejectNoProof:', e);\r\n    }\r\n\r\n    try {\r\n      if (row.id_user) {\r\n        await Model_Notifikasi.Store({\r\n          id_user: row.id_user,\r\n          judul: 'Pembayaran Ditolak (Waktu Upload Habis)',\r\n          isi_pesan: `Pembayaran Anda untuk arena ${\r\n            row.nama_arena || 'Arena'\r\n          } ditolak karena batas waktu upload bukti (20 menit) telah habis dan data pembayaran tidak lengkap.`,\r\n          jenis_notif: 'status',\r\n          tipe: 'payment',\r\n          dibaca: 0\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.warn('Gagal kirim notif autoRejectNoProof:', e);\r\n    }\r\n  }\r\n\r\n  return rows.length;\r\n}\r\n\r\n// =====================================================\r\n// AUTO REJECT 2: sudah upload, admin tidak konfirmasi 20 menit\r\n// =====================================================\r\nstatic async autoRejectLateConfirmed() {\r\n  const rows = await runQuery(\r\n    `\r\n      SELECT\r\n        p.id_pembayaran,\r\n        p.id_reservasi,\r\n        p.status_pembayaran,\r\n        p.bukti_pembayaran,\r\n        p.updated_at,\r\n        r.id_user,\r\n        r.id_jadwal,\r\n        a.nama_arena,         -- ⬅ ambil dari tabel arena\r\n        r.status AS status_reservasi\r\n      FROM pembayaran p\r\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n      JOIN arena a     ON r.id_arena     = a.id_arena\r\n      WHERE p.metode_pembayaran = 'transaksi'\r\n        AND p.bukti_pembayaran IS NOT NULL\r\n        AND p.status_pembayaran IN ('unpaid','pending')\r\n        AND TIMESTAMPDIFF(MINUTE, p.updated_at, NOW()) >= 20\r\n    `\r\n  );\r\n\r\n  if (!rows.length) return 0;\r\n\r\n  const catatanDefault =\r\n    'Pembayaran ditolak karena admin tidak mengkonfirmasi dalam batas waktu 20 menit.';\r\n\r\n  for (const row of rows) {\r\n    await runQuery(\r\n      `\r\n        UPDATE pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN jadwal j    ON r.id_jadwal    = j.id_jadwal\r\n        SET\r\n          p.status_pembayaran = 'rejected',\r\n          p.catatan_admin = COALESCE(p.catatan_admin, ?),\r\n          p.updated_at = NOW(),\r\n          r.status = 'ditolak',\r\n          j.status_slot = 'kosong'\r\n        WHERE p.id_pembayaran = ?\r\n      `,\r\n      [catatanDefault, row.id_pembayaran]\r\n    );\r\n\r\n    try {\r\n      await createLog(\r\n        row.id_reservasi,\r\n        row.status_reservasi || 'menunggu',\r\n        'ditolak',\r\n        'Pembayaran otomatis ditolak karena tidak dikonfirmasi admin dalam 20 menit.'\r\n      );\r\n    } catch (e) {\r\n      console.warn('Gagal buat log autoRejectLateConfirmed:', e);\r\n    }\r\n\r\n    try {\r\n      if (row.id_user) {\r\n        await Model_Notifikasi.Store({\r\n          id_user: row.id_user,\r\n          judul: 'Pembayaran Ditolak',\r\n          isi_pesan: `Pembayaran Anda untuk arena ${\r\n            row.nama_arena || 'Arena'\r\n          } ditolak karena admin tidak mengkonfirmasi pembayaran dalam batas waktu 20 menit.`,\r\n          jenis_notif: 'status',\r\n          tipe: 'payment',\r\n          dibaca: 0\r\n        });\r\n      }\r\n    } catch (e) {\r\n      console.warn('Gagal kirim notif autoRejectLateConfirmed:', e);\r\n    }\r\n  }\r\n\r\n  return rows.length;\r\n}\r\n}\r\n\r\nmodule.exports = Model_Pembayaran;\r\n"],"file":"Model_Pembayaran.dev.js"}