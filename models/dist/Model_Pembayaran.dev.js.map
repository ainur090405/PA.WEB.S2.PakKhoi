{"version":3,"sources":["Model_Pembayaran.js"],"names":["connection","require","Model_Pembayaran","Promise","resolve","reject","sql","query","err","rows","id_pembayaran","id_reservasi","data","result","jumlah","metode_pembayaran","status_pembayaran","status_bukti","konfirmasi_admin","tanggal_pembayaran","Date","created_at","updated_at","Store","filename","update","bukti_pembayaran","affectedRows","insert","err2","res2","status","catatan_admin","undefined","module","exports"],"mappings":"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","sourcesContent":["// models/Model_Pembayaran.js\r\nconst connection = require('../config/database');\r\n\r\nclass Model_Pembayaran {\r\n  // ========================\r\n  // BASIC GET / CRUD\r\n  // ========================\r\n\r\n  // Ambil semua pembayaran (untuk admin, join user & arena)\r\n  static async getAllWithUserArena() {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT \r\n          p.*,\r\n          r.status AS status_reservasi,\r\n          u.nama AS nama_user,\r\n          a.nama_arena\r\n        FROM pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        ORDER BY p.tanggal_pembayaran DESC\r\n      `;\r\n      connection.query(sql, (err, rows) => {\r\n        if (err) return reject(err);\r\n        resolve(rows);\r\n      });\r\n    });\r\n  }\r\n\r\n  static async getById(id_pembayaran) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n        [id_pembayaran],\r\n        (err, rows) => {\r\n          if (err) return reject(err);\r\n          resolve(rows);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // Ambil 1 pembayaran berdasarkan reservasi\r\n  static async getByReservasi(id_reservasi) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'SELECT * FROM pembayaran WHERE id_reservasi = ? LIMIT 1',\r\n        [id_reservasi],\r\n        (err, rows) => {\r\n          if (err) return reject(err);\r\n          resolve(rows);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Store(data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'INSERT INTO pembayaran SET ?',\r\n        data,\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Update(id_pembayaran, data) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_pembayaran = ?',\r\n        [data, id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  static async Delete(id_pembayaran) {\r\n    return new Promise((resolve, reject) => {\r\n      connection.query(\r\n        'DELETE FROM pembayaran WHERE id_pembayaran = ?',\r\n        [id_pembayaran],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA COD\r\n  // ========================\r\n\r\n  // Dipakai saat user pilih COD\r\n  static async createCODByReservasi(id_reservasi, jumlah) {\r\n    const data = {\r\n      id_reservasi,\r\n      metode_pembayaran: 'cod',      // enum('cod','transaksi')\r\n      status_pembayaran: 'unpaid',   // default di DB juga 'unpaid'\r\n      jumlah,\r\n      status_bukti: 'pending',\r\n      konfirmasi_admin: false,\r\n      tanggal_pembayaran: new Date(),\r\n      created_at: new Date(),\r\n      updated_at: new Date()\r\n    };\r\n    return this.Store(data);\r\n  }\r\n\r\n  // ========================\r\n  // LOGIKA TRANSFER (UPLOAD BUKTI)\r\n  // ========================\r\n\r\n  // Dipanggil ketika user upload bukti transfer\r\n  static async uploadBuktiByReservasi(id_reservasi, filename) {\r\n    return new Promise((resolve, reject) => {\r\n      const update = {\r\n        bukti_pembayaran: filename,\r\n        status_bukti: 'uploaded',           // enum('pending','uploaded')\r\n        status_pembayaran: 'pending',       // enum('pending','uploaded','paid','confirmed','unpaid')\r\n        tanggal_pembayaran: new Date(),\r\n        konfirmasi_admin: false,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [update, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n\r\n          if (result.affectedRows === 0) {\r\n            // belum ada pembayaran → buat baru\r\n            const insert = {\r\n              id_reservasi,\r\n              metode_pembayaran: 'transaksi',   // sesuai enum di tabel\r\n              status_pembayaran: 'pending',\r\n              status_bukti: 'uploaded',\r\n              bukti_pembayaran: filename,\r\n              jumlah: 0,\r\n              konfirmasi_admin: false,\r\n              tanggal_pembayaran: new Date(),\r\n              created_at: new Date(),\r\n              updated_at: new Date()\r\n            };\r\n            connection.query(\r\n              'INSERT INTO pembayaran SET ?',\r\n              insert,\r\n              (err2, res2) => {\r\n                if (err2) return reject(err2);\r\n                resolve(res2);\r\n              }\r\n            );\r\n          } else {\r\n            resolve(result);\r\n          }\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // ========================\r\n  // KONFIRMASI ADMIN\r\n  // ========================\r\n\r\n  /**\r\n   * status:\r\n   *   - 'confirmed' → pembayaran fix (bisa untuk COD atau transfer)\r\n   *   - 'paid'      → COD sudah dibayar tapi belum final, terserah flow-mu\r\n   *   - 'unpaid'    → belum bayar (COD)\r\n   *   - 'uploaded'  → jarang dipakai, kita pakai status_bukti utk ini\r\n   *\r\n   * Catatan: JANGAN gunakan 'rejected' karena tidak ada di enum status_pembayaran.\r\n   */\r\n  static async confirmPaymentByReservasi(id_reservasi, status, catatan_admin = null) {\r\n    return new Promise((resolve, reject) => {\r\n      const data = {\r\n        status_pembayaran: status,\r\n        // status_bukti hanya relevan untuk transfer\r\n        status_bukti: status === 'confirmed' || status === 'paid'\r\n          ? 'uploaded'    // bukti tetap 'uploaded'\r\n          : undefined,\r\n        konfirmasi_admin: true,\r\n        catatan_admin,\r\n        updated_at: new Date()\r\n      };\r\n\r\n      connection.query(\r\n        'UPDATE pembayaran SET ? WHERE id_reservasi = ?',\r\n        [data, id_reservasi],\r\n        (err, result) => {\r\n          if (err) return reject(err);\r\n          resolve(result);\r\n        }\r\n      );\r\n    });\r\n  }\r\n\r\n  // Pembayaran yang status_pembayaran masih 'pending' → untuk list verifikasi admin\r\n  static async getPendingPayments() {\r\n    return new Promise((resolve, reject) => {\r\n      const sql = `\r\n        SELECT \r\n          p.*,\r\n          r.status AS status_reservasi,\r\n          u.nama AS nama_user,\r\n          a.nama_arena\r\n        FROM pembayaran p\r\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\r\n        JOIN users u ON r.id_user = u.id_user\r\n        JOIN arena a ON r.id_arena = a.id_arena\r\n        WHERE p.status_pembayaran = 'pending'\r\n        ORDER BY p.tanggal_pembayaran ASC\r\n      `;\r\n      connection.query(sql, (err, rows) => {\r\n        if (err) return reject(err);\r\n        resolve(rows);\r\n      });\r\n    });\r\n  }\r\n}\r\n\r\nmodule.exports = Model_Pembayaran;\r\n"],"file":"Model_Pembayaran.dev.js"}