"use strict";function _classCallCheck(n,a){if(!(n instanceof a))throw new TypeError("Cannot call a class as a function")}function _defineProperties(n,a){for(var e=0;e<a.length;e++){var r=a[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(n,r.key,r)}}function _createClass(n,a,e){return a&&_defineProperties(n.prototype,a),e&&_defineProperties(n,e),n}var connection=require("../config/database"),Model_Notifikasi=function(){function n(){_classCallCheck(this,n)}return _createClass(n,null,[{key:"Store",value:function(a){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(e,r){a.id_user?connection.query("INSERT INTO notifikasi SET ?",a,function(n,a){n?r(n):e(a)}):r(new Error("id_user cannot be null"))}));case 1:case"end":return n.stop()}})}},{key:"getByUser",value:function(a){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(e,r){connection.query("SELECT * FROM notifikasi WHERE id_user = ? ORDER BY id_notifikasi DESC LIMIT 10",[a],function(n,a){n?r(n):e(a)})}));case 1:case"end":return n.stop()}})}},{key:"autoUpdateStatus",value:function(){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:if(this.isUpdating)return n.abrupt("return",console.log("⏳ Skip auto update, masih jalan."));n.next=2;break;case 2:return this.isUpdating=!0,n.prev=3,"\n        UPDATE reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        SET r.status = 'selesai'\n        WHERE r.status IN ('disetujui', 'menunggu')\n          AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\n\n        UPDATE reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        SET r.status = 'booking', j.status_slot = 'kosong'\n        WHERE r.status = 'menunggu'\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\n      ",n.next=7,regeneratorRuntime.awrap(new Promise(function(a,e){connection.query("\n        UPDATE reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        SET r.status = 'selesai'\n        WHERE r.status IN ('disetujui', 'menunggu')\n          AND CONCAT(j.tanggal, ' ', j.jam_selesai) < NOW();\n\n        UPDATE reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        SET r.status = 'booking', j.status_slot = 'kosong'\n        WHERE r.status = 'menunggu'\n          AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20;\n      ",function(n){return n?e(n):a()})}));case 7:return"\n        INSERT INTO notifikasi (id_user, pesan)\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' telah selesai otomatis.')\n        FROM reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        JOIN arena a ON j.id_arena = a.id_arena\n        WHERE r.status = 'selesai';\n\n        INSERT INTO notifikasi (id_user, pesan)\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' dibatalkan otomatis karena tidak dikonfirmasi admin.')\n        FROM reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        JOIN arena a ON j.id_arena = a.id_arena\n        WHERE r.status = 'booking';\n      ",n.next=10,regeneratorRuntime.awrap(new Promise(function(a,e){connection.query("\n        INSERT INTO notifikasi (id_user, pesan)\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' telah selesai otomatis.')\n        FROM reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        JOIN arena a ON j.id_arena = a.id_arena\n        WHERE r.status = 'selesai';\n\n        INSERT INTO notifikasi (id_user, pesan)\n        SELECT r.id_user, CONCAT('Reservasi kamu di arena ', a.nama_arena, ' dibatalkan otomatis karena tidak dikonfirmasi admin.')\n        FROM reservasi r\n        JOIN jadwal j ON r.id_jadwal = j.id_jadwal\n        JOIN arena a ON j.id_arena = a.id_arena\n        WHERE r.status = 'booking';\n      ",function(n){return n?e(n):a()})}));case 10:console.log("[AUTO] Status & notifikasi diperbarui otomatis ".concat((new Date).toLocaleString())),n.next=16;break;case 13:n.prev=13,n.t0=n.catch(3),console.error("❌ Error auto update:",n.t0);case 16:return n.prev=16,this.isUpdating=!1,n.finish(16);case 19:case"end":return n.stop()}},null,this,[[3,13,16,19]])}},{key:"getUnreadCount",value:function(a){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(e,r){connection.query("SELECT COUNT(*) as count FROM notifikasi WHERE id_user = ? AND dibaca = 0",[a],function(n,a){n?r(n):e(a[0].count)})}));case 1:case"end":return n.stop()}})}},{key:"markAsRead",value:function(a){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(e,r){connection.query("UPDATE notifikasi SET dibaca = 1 WHERE id_notifikasi = ?",[a],function(n,a){n?r(n):e(a)})}));case 1:case"end":return n.stop()}})}},{key:"markAllAsRead",value:function(a){return regeneratorRuntime.async(function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise(function(e,r){connection.query("UPDATE notifikasi SET dibaca = 1 WHERE id_user = ?",[a],function(n,a){n?r(n):e(a)})}));case 1:case"end":return n.stop()}})}}]),n}();module.exports=Model_Notifikasi;
//# sourceMappingURL=Model_Notifikasi.min.js.map
