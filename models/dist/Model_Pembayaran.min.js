"use strict";function _classCallCheck(a,e){if(!(a instanceof e))throw new TypeError("Cannot call a class as a function")}function _defineProperties(a,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(a,r.key,r)}}function _createClass(a,e,n){return e&&_defineProperties(a.prototype,e),n&&_defineProperties(a,n),a}var connection=require("../config/database"),Model_Notifikasi=require("./Model_Notifikasi"),Model_Reservasi=require("./Model_Reservasi"),Model_Jadwal=require("./Model_Jadwal"),_require=require("../helpers/logHelper"),createLog=_require.createLog;function runQuery(a){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[];return new Promise(function(n,r){connection.query(a,e,function(a,e){if(a)return r(a);n(e)})})}var Model_Pembayaran=function(){function a(){_classCallCheck(this,a)}return _createClass(a,null,[{key:"getAllWithUserArena",value:function(){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return"\n      SELECT \n        p.*,\n        r.status AS status_reservasi,\n        u.nama AS nama_user,\n        a.nama_arena\n      FROM pembayaran p\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n      JOIN users u ON r.id_user = u.id_user\n      JOIN arena a ON r.id_arena = a.id_arena\n      ORDER BY p.tanggal_pembayaran DESC\n    ",a.abrupt("return",runQuery("\n      SELECT \n        p.*,\n        r.status AS status_reservasi,\n        u.nama AS nama_user,\n        a.nama_arena\n      FROM pembayaran p\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n      JOIN users u ON r.id_user = u.id_user\n      JOIN arena a ON r.id_arena = a.id_arena\n      ORDER BY p.tanggal_pembayaran DESC\n    "));case 2:case"end":return a.stop()}})}},{key:"getById",value:function(e){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",runQuery("SELECT * FROM pembayaran WHERE id_pembayaran = ?",[e]));case 1:case"end":return a.stop()}})}},{key:"getByReservasi",value:function(e){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",runQuery("SELECT * FROM pembayaran WHERE id_reservasi = ? LIMIT 1",[e]));case 1:case"end":return a.stop()}})}},{key:"Store",value:function(e){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(function(n,r){connection.query("INSERT INTO pembayaran SET ?",e,function(a,e){if(a)return r(a);n(e)})}));case 1:case"end":return a.stop()}})}},{key:"Update",value:function(e,t){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(function(n,r){connection.query("UPDATE pembayaran SET ? WHERE id_pembayaran = ?",[t,e],function(a,e){if(a)return r(a);n(e)})}));case 1:case"end":return a.stop()}})}},{key:"Delete",value:function(e){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(function(n,r){connection.query("DELETE FROM pembayaran WHERE id_pembayaran = ?",[e],function(a,e){if(a)return r(a);n(e)})}));case 1:case"end":return a.stop()}})}},{key:"createCODByReservasi",value:function(e,n){var r;return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return r={id_reservasi:e,metode_pembayaran:"cod",status_pembayaran:"unpaid",jumlah:n,status_bukti:"pending",konfirmasi_admin:!1,tanggal_pembayaran:new Date,created_at:new Date,updated_at:new Date},a.abrupt("return",this.Store(r));case 2:case"end":return a.stop()}},null,this)}},{key:"uploadBuktiByReservasi",value:function(i,s){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.abrupt("return",new Promise(function(r,t){var a={bukti_pembayaran:s,status_bukti:"uploaded",status_pembayaran:"pending",tanggal_pembayaran:new Date,konfirmasi_admin:!1,updated_at:new Date};connection.query("UPDATE pembayaran SET ? WHERE id_reservasi = ?",[a,i],function(a,e){if(a)return t(a);if(0===e.affectedRows){var n={id_reservasi:i,metode_pembayaran:"transaksi",status_pembayaran:"pending",status_bukti:"uploaded",bukti_pembayaran:s,jumlah:0,konfirmasi_admin:!1,tanggal_pembayaran:new Date,created_at:new Date,updated_at:new Date};connection.query("INSERT INTO pembayaran SET ?",n,function(a,e){if(a)return t(a);r(e)})}else r(e)})}));case 1:case"end":return a.stop()}})}},{key:"confirmPaymentByReservasi",value:function(e,t){var i,n=arguments;return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return i=2<n.length&&void 0!==n[2]?n[2]:null,a.abrupt("return",new Promise(function(n,r){var a={status_pembayaran:t,status_bukti:"confirmed"===t||"paid"===t?"uploaded":void 0,konfirmasi_admin:!0,catatan_admin:i,updated_at:new Date};connection.query("UPDATE pembayaran SET ? WHERE id_reservasi = ?",[a,e],function(a,e){if(a)return r(a);n(e)})}));case 2:case"end":return a.stop()}})}},{key:"getPendingPayments",value:function(){return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return"\n      SELECT \n        p.*,\n        r.status AS status_reservasi,\n        u.nama AS nama_user,\n        a.nama_arena\n      FROM pembayaran p\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n      JOIN users u ON r.id_user = u.id_user\n      JOIN arena a ON r.id_arena = a.id_arena\n      WHERE p.status_pembayaran = 'pending'\n      ORDER BY p.tanggal_pembayaran ASC\n    ",a.abrupt("return",runQuery("\n      SELECT \n        p.*,\n        r.status AS status_reservasi,\n        u.nama AS nama_user,\n        a.nama_arena\n      FROM pembayaran p\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n      JOIN users u ON r.id_user = u.id_user\n      JOIN arena a ON r.id_arena = a.id_arena\n      WHERE p.status_pembayaran = 'pending'\n      ORDER BY p.tanggal_pembayaran ASC\n    "));case 2:case"end":return a.stop()}})}},{key:"autoRejectNoProof",value:function(){var e,n,r,t,i,s,u,o;return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,regeneratorRuntime.awrap(runQuery("\n      SELECT\n        p.id_pembayaran,\n        p.id_reservasi,\n        p.status_pembayaran,\n        p.bukti_pembayaran,\n        r.id_user,\n        r.id_jadwal,\n        a.nama_arena,          -- ⬅ ambil dari tabel arena\n        r.status       AS status_reservasi,\n        r.tanggal_pesan\n      FROM pembayaran p\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n      JOIN arena a     ON r.id_arena     = a.id_arena\n      WHERE p.metode_pembayaran = 'transaksi'\n        AND (p.bukti_pembayaran IS NULL OR p.bukti_pembayaran = '')\n        AND p.status_pembayaran IN ('unpaid','pending')\n        AND TIMESTAMPDIFF(MINUTE, r.tanggal_pesan, NOW()) >= 20\n    "));case 2:if((e=a.sent).length){a.next=5;break}return a.abrupt("return",0);case 5:n="Pembayaran ditolak (waktu upload bukti 20 menit habis).",t=!(r=!0),i=void 0,a.prev=9,s=e[Symbol.iterator]();case 11:if(r=(u=s.next()).done){a.next=35;break}return o=u.value,a.next=15,regeneratorRuntime.awrap(runQuery("\n        UPDATE pembayaran p\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n        JOIN jadwal j    ON r.id_jadwal    = j.id_jadwal\n        SET\n          p.status_pembayaran = 'rejected',\n          p.catatan_admin = COALESCE(p.catatan_admin, ?),\n          p.updated_at = NOW(),\n          r.status = 'ditolak',\n          j.status_slot = 'kosong'\n        WHERE p.id_pembayaran = ?\n      ",[n,o.id_pembayaran]));case 15:return a.prev=15,a.next=18,regeneratorRuntime.awrap(createLog(o.id_reservasi,o.status_reservasi||"menunggu","ditolak","Pembayaran otomatis ditolak karena batas waktu upload bukti (20 menit) telah habis."));case 18:a.next=23;break;case 20:a.prev=20,a.t0=a.catch(15),console.warn("Gagal buat log autoRejectNoProof:",a.t0);case 23:if(a.prev=23,o.id_user)return a.next=27,regeneratorRuntime.awrap(Model_Notifikasi.Store({id_user:o.id_user,judul:"Pembayaran Ditolak (Waktu Upload Habis)",isi_pesan:"Pembayaran Anda untuk arena ".concat(o.nama_arena||"Arena"," ditolak karena batas waktu upload bukti (20 menit) telah habis dan data pembayaran tidak lengkap."),jenis_notif:"status",tipe:"payment",dibaca:0}));a.next=27;break;case 27:a.next=32;break;case 29:a.prev=29,a.t1=a.catch(23),console.warn("Gagal kirim notif autoRejectNoProof:",a.t1);case 32:r=!0,a.next=11;break;case 35:a.next=41;break;case 37:a.prev=37,a.t2=a.catch(9),t=!0,i=a.t2;case 41:a.prev=41,a.prev=42,r||null==s.return||s.return();case 44:if(a.prev=44,t)throw i;a.next=47;break;case 47:return a.finish(44);case 48:return a.finish(41);case 49:return a.abrupt("return",e.length);case 50:case"end":return a.stop()}},null,null,[[9,37,41,49],[15,20],[23,29],[42,,44,48]])}},{key:"autoRejectLateConfirmed",value:function(){var e,n,r,t,i,s,u,o;return regeneratorRuntime.async(function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,regeneratorRuntime.awrap(runQuery("\n      SELECT\n        p.id_pembayaran,\n        p.id_reservasi,\n        p.status_pembayaran,\n        p.bukti_pembayaran,\n        p.updated_at,\n        r.id_user,\n        r.id_jadwal,\n        a.nama_arena,         -- ⬅ ambil dari tabel arena\n        r.status AS status_reservasi\n      FROM pembayaran p\n      JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n      JOIN arena a     ON r.id_arena     = a.id_arena\n      WHERE p.metode_pembayaran = 'transaksi'\n        AND p.bukti_pembayaran IS NOT NULL\n        AND p.status_pembayaran IN ('unpaid','pending')\n        AND TIMESTAMPDIFF(MINUTE, p.updated_at, NOW()) >= 20\n    "));case 2:if((e=a.sent).length){a.next=5;break}return a.abrupt("return",0);case 5:n="Pembayaran ditolak karena admin tidak mengkonfirmasi dalam batas waktu 20 menit.",t=!(r=!0),i=void 0,a.prev=9,s=e[Symbol.iterator]();case 11:if(r=(u=s.next()).done){a.next=35;break}return o=u.value,a.next=15,regeneratorRuntime.awrap(runQuery("\n        UPDATE pembayaran p\n        JOIN reservasi r ON p.id_reservasi = r.id_reservasi\n        JOIN jadwal j    ON r.id_jadwal    = j.id_jadwal\n        SET\n          p.status_pembayaran = 'rejected',\n          p.catatan_admin = COALESCE(p.catatan_admin, ?),\n          p.updated_at = NOW(),\n          r.status = 'ditolak',\n          j.status_slot = 'kosong'\n        WHERE p.id_pembayaran = ?\n      ",[n,o.id_pembayaran]));case 15:return a.prev=15,a.next=18,regeneratorRuntime.awrap(createLog(o.id_reservasi,o.status_reservasi||"menunggu","ditolak","Pembayaran otomatis ditolak karena tidak dikonfirmasi admin dalam 20 menit."));case 18:a.next=23;break;case 20:a.prev=20,a.t0=a.catch(15),console.warn("Gagal buat log autoRejectLateConfirmed:",a.t0);case 23:if(a.prev=23,o.id_user)return a.next=27,regeneratorRuntime.awrap(Model_Notifikasi.Store({id_user:o.id_user,judul:"Pembayaran Ditolak",isi_pesan:"Pembayaran Anda untuk arena ".concat(o.nama_arena||"Arena"," ditolak karena admin tidak mengkonfirmasi pembayaran dalam batas waktu 20 menit."),jenis_notif:"status",tipe:"payment",dibaca:0}));a.next=27;break;case 27:a.next=32;break;case 29:a.prev=29,a.t1=a.catch(23),console.warn("Gagal kirim notif autoRejectLateConfirmed:",a.t1);case 32:r=!0,a.next=11;break;case 35:a.next=41;break;case 37:a.prev=37,a.t2=a.catch(9),t=!0,i=a.t2;case 41:a.prev=41,a.prev=42,r||null==s.return||s.return();case 44:if(a.prev=44,t)throw i;a.next=47;break;case 47:return a.finish(44);case 48:return a.finish(41);case 49:return a.abrupt("return",e.length);case 50:case"end":return a.stop()}},null,null,[[9,37,41,49],[15,20],[23,29],[42,,44,48]])}}]),a}();module.exports=Model_Pembayaran;
//# sourceMappingURL=Model_Pembayaran.min.js.map
