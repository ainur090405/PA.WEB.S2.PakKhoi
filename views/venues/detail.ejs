<%- include('../partials/_header', { title: title }) %>

<div class="container py-5">
  <!-- Kartu Arena -->
  <div class="card border-0 shadow-sm mb-4">
    <img
      src="<%= arena.foto_cover ? arena.foto_cover : 'https://via.placeholder.com/800x400.png?text=Foto+Belum+Ada' %>"
      alt="<%= arena.nama_arena %>"
      class="card-img-top rounded-top-4"
      style="
        width: 100%;
        height: auto;
        max-height: 480px;
        object-fit: contain;
        background-color: #f8f9fa;
      ">

    <div class="card-body p-4">
      <h1 class="fw-bold mb-2"><%= arena.nama_arena %></h1>
      <span class="badge bg-dark mb-3 px-3 py-2 fs-6"><%= arena.jenis_olahraga %></span>

      <div class="d-flex flex-column gap-2 mb-4">
        <p class="fs-5 mb-0 text-muted">
          <i class="bi bi-geo-alt-fill text-danger me-2"></i>
          <%= arena.lokasi %>
        </p>
        <p class="fs-5 mb-0 text-success">
          <i class="bi bi-clock-fill me-2"></i>
          Jam Buka: <%= arena.jam_buka.substring(0,5) %> - <%= arena.jam_tutup.substring(0,5) %>
        </p>
        <p class="fs-4 mb-0 text-primary fw-bold">
          <i class="bi bi-cash me-2"></i>
          Harga: Rp <%= arena.harga ? arena.harga.toLocaleString('id-ID') : 'Belum ditentukan' %>
        </p>
        <% if (avgRating && totalReviews > 0) { %>
          <div class="d-flex align-items-center">
            <div class="me-2">
              <% for(let i = 0; i < Math.floor(avgRating); i++) { %>
                <i class="bi bi-star-fill text-warning"></i>
              <% } %>
              <% for(let i = Math.floor(avgRating); i < 5; i++) { %>
                <i class="bi bi-star text-warning"></i>
              <% } %>
            </div>
            <span class="text-muted small">(<%= totalReviews %> ulasan)</span>
          </div>
        <% } %>
      </div>

      <hr>
      <h5 class="fw-semibold mb-3">Deskripsi & Fasilitas</h5>

      <% if (fotoList.length > 0) { %>
        <ul class="list-group list-group-flush">
          <% fotoList.forEach(foto => { %>
            <% if (foto.deskripsi) { %>
              <li class="list-group-item border-0 ps-0">
                <i class="bi bi-check-circle-fill text-success me-2"></i>
                <%= foto.deskripsi %>
              </li>
            <% } %>
          <% }) %>
        </ul>
      <% } else { %>
        <p class="text-muted small">Belum ada daftar fasilitas tambahan.</p>
      <% } %>
    </div>
  </div>

  <!-- Ulasan Section -->
  <% if (reviews && reviews.length > 0) { %>
  <div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-light">
      <h5 class="mb-0"><i class="bi bi-star-fill text-warning me-2"></i>Ulasan Pengguna (<%= reviews.length %>)</h5>
    </div>
    <div class="card-body">
      <% reviews.slice(0, 3).forEach(review => { %>
        <div class="mb-3 pb-3 border-bottom">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <strong><%= review.nama_user %></strong>
              <div>
                <% for(let i = 0; i < review.rating; i++) { %>
                  <i class="bi bi-star-fill text-warning"></i>
                <% } %>
                <% for(let i = review.rating; i < 5; i++) { %>
                  <i class="bi bi-star text-warning"></i>
                <% } %>
              </div>
            </div>
            <small class="text-muted"><%= new Date(review.tanggal_ulasan).toLocaleDateString('id-ID') %></small>
          </div>
          <% if (review.komentar) { %>
            <p class="mb-0 mt-2">"<%= review.komentar %>"</p>
          <% } %>
        </div>
      <% }) %>
      <% if (reviews.length > 3) { %>
        <p class="text-center mb-0">
          <small class="text-muted">Dan <%= reviews.length - 3 %> ulasan lainnya...</small>
        </p>
      <% } %>
    </div>
  </div>
  <% } %>

  <!-- Jadwal Booking -->
  <div class="card border-0 shadow-sm mb-5">
    <div class="card-header bg-success text-white py-3">
      <h4 class="mb-0"><i class="bi bi-calendar-check me-2"></i> Pilih Jadwal Tersedia</h4>
    </div>
    <div class="card-body p-4">
      <%- include('../partials/_messages') %>

      <% if (jadwal.length > 0) { %>
        <p class="mb-4">Berikut jadwal yang tersedia untuk dipesan:</p>

        <%
          const grouped = {};
          jadwal.forEach(j => {
            const tanggal = new Date(j.tanggal).toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long' });
            if (!grouped[tanggal]) grouped[tanggal] = [];
            grouped[tanggal].push(j);
          });
        %>

        <% Object.keys(grouped).forEach(hari => { %>
          <div class="mb-4">
            <button class="btn btn-outline-success w-100 mb-3 d-flex justify-content-between align-items-center"
              type="button"
              data-bs-toggle="collapse"
              data-bs-target="#collapse<%= hari.replace(/\s+/g, '').replace(/,/g, '') %>">
              <h5 class="fw-bold mb-0">
                <i class="bi bi-calendar-event me-2"></i> <%= hari %>
              </h5>
              <i class="bi bi-chevron-down"></i>
            </button>

            <div class="collapse" id="collapse<%= hari.replace(/\s+/g, '').replace(/,/g, '') %>">
              <div class="card card-body border-success">
                <div class="row g-3">
                  <% grouped[hari].forEach(j => { %>
                    <div class="col-12 col-md-4 col-lg-3">
                      <div class="border rounded-3 p-3 text-center shadow-sm
                        <%= j.status_slot === 'terisi' ? 'bg-secondary text-white'
                          : j.status_slot === 'menunggu' ? 'bg-warning text-dark'
                          : 'bg-primary text-white' %>
                        h-100 d-flex flex-column justify-content-between">

                        <div>
                          <div class="fw-semibold mb-1">
                            <%= j.jam_mulai.substring(0,5) %> - <%= j.jam_selesai.substring(0,5) %>
                          </div>
                          <div class="small">
                            <%= j.status_slot === 'terisi' ? 'Tidak Tersedia'
                              : j.status_slot === 'menunggu' ? 'Menunggu Konfirmasi'
                              : 'Slot Tersedia' %>
                          </div>
                        </div>

                        <% if (j.status_slot === 'kosong') { %>
                          <button type="button"
                            class="btn btn-light text-dark"
                            data-bs-toggle="modal"
                            data-bs-target="#bookingModal"
                            data-id-jadwal="<%= j.id_jadwal %>"
                            data-jam="<%= j.jam_mulai.substring(0,5) %> - <%= j.jam_selesai.substring(0,5) %>"
                            data-tanggal="<%= hari %>">
                            Booking
                          </button>
                        <% } else { %>
                          <button type="button" class="btn btn-secondary" disabled>
                            <%= j.status_slot === 'terisi' ? 'Tidak Tersedia' : 'Menunggu' %>
                          </button>
                        <% } %>

                      </div>
                    </div>
                  <% }) %>
                </div>
              </div>
            </div>
          </div>
        <% }) %>

      <% } else { %>
        <div class="alert alert-warning text-center rounded-3 py-4">
          <h5 class="fw-bold mb-2">Jadwal Penuh</h5>
          <p class="mb-0">Belum ada jadwal kosong untuk arena ini.</p>
        </div>
      <% } %>

    </div>
  </div>
</div>

<!-- Booking Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Konfirmasi Booking</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <h5 class="text-center mb-3">Konfirmasi Booking</h5>
        <p class="text-muted text-center mb-3">Pastikan detail booking sudah benar</p>

        <div class="card bg-light mb-3">
          <div class="card-body">
            <p id="modalInfoSesi" class="mb-2"><strong>Sesi:</strong> Loading...</p>
            <p id="modalInfoHarga" class="mb-0"><strong>Harga:</strong> Loading...</p>
          </div>
        </div>

        <form id="bookingForm" action="/booking/create" method="POST">
          <input type="hidden" name="id_jadwal" id="modalBookingIdJadwal">

          <div class="mb-3">
            <label class="form-label">Metode Pembayaran</label>
            <select class="form-select" name="payment_method" id="payment_method" required>
              <option value="">Pilih Metode</option>
              <option value="transaksi">Transfer Bank</option>
              <option value="cod">COD</option>
            </select>
          </div>

          <div class="mb-3">
            <label class="form-label">Jumlah Pembayaran (Rp)</label>
            <input type="number" class="form-control" name="amount" id="amount" readonly>
            <small class="text-muted">Untuk Transfer: Upload bukti & rekening di halaman Riwayat.</small>
          </div>

        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button type="submit" form="bookingForm" class="btn btn-primary">Konfirmasi Booking</button>
      </div>

    </div>
  </div>
</div>

<%- include('../partials/_footer') %>

<script>
  const bookingModal = document.getElementById('bookingModal');
  const pmSelect = document.getElementById('payment_method');
  const amountInput = document.getElementById('amount');

  bookingModal.addEventListener('show.bs.modal', function (event) {
    const btn = event.relatedTarget;
    document.getElementById('modalBookingIdJadwal').value = btn.getAttribute('data-id-jadwal');
    document.getElementById('modalInfoSesi').textContent =
      `Tanggal: ${btn.getAttribute('data-tanggal')}, Jam: ${btn.getAttribute('data-jam')}`;

    const hargaArena = parseInt('<%= arena.harga || 0 %>') || 0;
    document.getElementById('modalInfoHarga').textContent =
      `Harga: Rp ${hargaArena.toLocaleString('id-ID')}`;

    amountInput.value = hargaArena;
    pmSelect.value = "";
  });

  pmSelect.addEventListener('change', function () {
    const hargaArena = parseInt('<%= arena.harga || 0 %>') || 0;

    if (this.value === "transaksi") {
      amountInput.value = hargaArena;
    } else if (this.value === "cod") {
      amountInput.value = 0;
    } else {
      amountInput.value = "";
    }
  });
</script>
