{"version":3,"sources":["users.js"],"names":["express","require","router","Router","bcrypt","Model_Users","isAuthenticated","isAdmin","use","get","req","res","getAll","users","render","title","data","console","error","flash","redirect","post","body","nama","email","password","no_hp","role","status","hash","dataUser","password_hash","tanggal_daftar","Date","Store","code","message","id","params","getById","length","user","dataToUpdate","trim","Update","Number","session","Delete","module","exports"],"mappings":"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","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst bcrypt = require('bcryptjs');\r\nconst Model_Users = require('../models/Model_Users'); \r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute di file ini\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Menampilkan daftar users\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const users = await Model_Users.getAll();\r\n    res.render('admin/users/index', {\r\n      title: 'Manajemen User',\r\n      data: users\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat data users.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: Form tambah user\r\nrouter.get('/create', (req, res) => {\r\n  res.render('admin/users/create', { title: 'Tambah User Baru' });\r\n});\r\n\r\n// POST: Simpan user baru\r\nrouter.post('/store', async (req, res) => {\r\n  const { nama, email, password, no_hp, role, status } = req.body;\r\n\r\n  try {\r\n    const hash = await bcrypt.hash(password, 10);\r\n\r\n    const dataUser = {\r\n      nama,\r\n      email,\r\n      no_hp,\r\n      role,\r\n      password_hash: hash,\r\n      tanggal_daftar: new Date(),\r\n      // kalau form belum punya field status, default-kan aktif\r\n      status: status || 'aktif'\r\n    };\r\n\r\n    await Model_Users.Store(dataUser);\r\n    req.flash('success_msg', 'User baru berhasil ditambahkan.');\r\n    res.redirect('/users');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menyimpan user: ' + (err.code || err.message));\r\n    res.redirect('/users/create');\r\n  }\r\n});\r\n\r\n// GET: Form edit user\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    const users = await Model_Users.getById(id);\r\n\r\n    if (!users || users.length === 0) {\r\n      req.flash('error_msg', 'User tidak ditemukan.');\r\n      return res.redirect('/users');\r\n    }\r\n\r\n    res.render('admin/users/edit', {\r\n      title: 'Edit User',\r\n      user: users[0]\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat data user.');\r\n    res.redirect('/users');\r\n  }\r\n});\r\n\r\n// POST: Update user\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  const { nama, email, password, no_hp, role, status } = req.body;\r\n\r\n  try {\r\n    // data dasar\r\n    const dataToUpdate = {\r\n      nama,\r\n      email,\r\n      no_hp,\r\n      role,\r\n      status: status || 'aktif'   // <-- penting\r\n    };\r\n\r\n    // kalau password diisi, update juga password_hash\r\n    if (password && password.trim() !== '') {\r\n      dataToUpdate.password_hash = await bcrypt.hash(password, 10);\r\n    }\r\n\r\n    await Model_Users.Update(id, dataToUpdate);\r\n    req.flash('success_msg', 'Data user berhasil diperbarui.');\r\n    res.redirect('/users');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui user: ' + (err.code || err.message));\r\n    res.redirect('/users/edit/' + id);\r\n  }\r\n});\r\n\r\n// GET: Hapus user\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n\r\n  // cegah user menghapus dirinya sendiri\r\n  if (Number(id) === Number(req.session.user.id)) {\r\n    req.flash('error_msg', 'Anda tidak bisa menghapus akun Anda sendiri.');\r\n    return res.redirect('/users');\r\n  }\r\n\r\n  try {\r\n    await Model_Users.Delete(id);\r\n    req.flash('success_msg', 'Data user berhasil dihapus.');\r\n    res.redirect('/users');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menghapus user: ' + (err.code || err.message));\r\n    res.redirect('/users');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"users.dev.js"}