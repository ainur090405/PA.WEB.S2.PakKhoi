{"version":3,"sources":["pembayaran.js"],"names":["express","require","router","Router","connection","Model_Reservasi","Model_Notifikasi","Model_Pembayaran","createLog","get","req","res","pembayaran","regeneratorRuntime","async","_context","prev","next","awrap","getPendingPayments","sent","title","data","t0","console","error","flash","stop","post","id_pembayaran","params","catatan_admin","body","query","err","rowsBayar","bayar","id_reservasi","_context3","abrupt","redirect","length","rowsReservasiBefore","reservasiBefore","statusAwal","rowsReservasi","reservasi","_context2","err2","getById","status","Update","id_jadwal","Model_Jadwal","status_slot","id_user","Store","judul","jenis_notif","tipe","dibaca","t1","warn","t2","_context5","_rowsReservasi","r","alasan","_context4","isi_pesan","rejectAndFreeSlot","trim","concat","nama_arena"],"mappings":"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","file":"pembayaran.min.js","sourcesContent":["// routes/pembayaran.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\n\r\nconst connection = require('../config/database');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi  = require('../models/Model_Reservasi');\r\nconst Model_Jadwal     = require('../models/Model_Jadwal');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// ‚¨áÔ∏è TAMBAHAN: helper untuk log_reservasi\r\nconst { createLog } = require('../helpers/logHelper');\r\n\r\n// semua route di sini hanya boleh diakses admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// ===============================\r\n// GET: daftar pembayaran pending\r\n// ===============================\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/pembayaran:', err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// =======================================\r\n// POST: KONFIRMASI PEMBAYARAN (BERHASIL)\r\n// =======================================\r\nrouter.post('/confirm/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran-nya\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran:', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update tabel pembayaran -> confirmed\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'confirmed',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran:', err2);\r\n            req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // üîé ambil data reservasi sebelum di-update untuk log status_awal\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> disetujui\r\n            await Model_Reservasi.Update(id_reservasi, { status: 'disetujui' });\r\n\r\n            // üîé ambil lagi sesudah update\r\n            const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasi = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n            // 3b) SIMPAN LOG RESERVASI\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'disetujui',\r\n                'Pembayaran dikonfirmasi admin'\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log konfirmasi pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) update jadwal -> terisi\r\n            if (reservasi && reservasi.id_jadwal) {\r\n              await Model_Jadwal.Update(reservasi.id_jadwal, { status_slot: 'terisi' });\r\n            }\r\n\r\n            // 5) kirim notifikasi ke pemain (kalau ada)\r\n            try {\r\n              if (reservasi && reservasi.id_user) {\r\n                await Model_Notifikasi.Store({\r\n                  id_user: reservasi.id_user,\r\n                  judul: 'Pembayaran Dikonfirmasi',\r\n                  isi_pesan: `Pembayaran Anda untuk arena ${\r\n                    reservasi.nama_arena || 'Arena'\r\n                  } telah dikonfirmasi. Booking Anda sekarang aktif.`,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif konfirmasi pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran:', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\n// ==================================\r\n// POST: TOLAK PEMBAYARAN (REJECTED)\r\n// ==================================\r\nrouter.post('/reject/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran (reject):', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update pembayaran -> rejected\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'rejected',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran (reject):', err2);\r\n            req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // üîé ambil status reservasi sebelum diubah\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> ditolak + kosongkan slot\r\n            if (typeof Model_Reservasi.rejectAndFreeSlot === 'function') {\r\n              await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n            } else {\r\n              await Model_Reservasi.Update(id_reservasi, { status: 'ditolak' });\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              if (rowsReservasi && rowsReservasi[0] && rowsReservasi[0].id_jadwal) {\r\n                await Model_Jadwal.Update(rowsReservasi[0].id_jadwal, { status_slot: 'kosong' });\r\n              }\r\n            }\r\n\r\n            // 3b) SIMPAN LOG RESERVASI (ditolak)\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'ditolak',\r\n                `Pembayaran ditolak admin. ${catatan_admin || ''}`\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log tolak pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) kirim notifikasi ke pemain\r\n            try {\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              const r = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n              if (r && r.id_user) {\r\n                // ‚¨áÔ∏è alasan default kalau admin tidak isi catatan\r\n                const alasan =\r\n                  catatan_admin && catatan_admin.trim() !== ''\r\n                    ? catatan_admin\r\n                    : 'Pembayaran ditolak karena data tidak lengkap atau batas waktu upload bukti pembayaran sudah habis.';\r\n\r\n                await Model_Notifikasi.Store({\r\n                  id_user: r.id_user,\r\n                  judul: 'Pembayaran Ditolak',\r\n                  isi_pesan: `Pembayaran Anda untuk arena ${\r\n                    r.nama_arena || 'Arena'\r\n                  } ditolak. ${alasan}`,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif tolak pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil ditolak.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran (reject):', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\nmodule.exports = router;\r\n"]}