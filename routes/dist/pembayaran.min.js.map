{"version":3,"sources":["pembayaran.js"],"names":["express","require","router","Router","connection","Model_Reservasi","Model_Notifikasi","Model_Pembayaran","createLog","get","req","res","pembayaran","regeneratorRuntime","async","_context","prev","next","awrap","getPendingPayments","sent","title","data","t0","console","error","flash","stop","post","id_pembayaran","params","catatan_admin","body","query","err","rowsBayar","bayar","id_reservasi","_context3","abrupt","redirect","length","rowsReservasiBefore","reservasiBefore","statusAwal","rowsReservasi","reservasi","tanggalMain","jamMulai","jamSelesai","metodePembayaran","isiPesan","_context2","err2","getById","status","Update","id_jadwal","Model_Jadwal","status_slot","id_user","tanggal","Date","toLocaleDateString","month","year","jam_mulai","jam_selesai","substring","metode_pembayaran","concat","nama_arena","Store","judul","isi_pesan","jenis_notif","t1","warn","t2","_context5","_rowsReservasi","r","alasan","_context4","rejectAndFreeSlot","trim","weekday","day","tipe","dibaca"],"mappings":"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","file":"pembayaran.min.js","sourcesContent":["// routes/pembayaran.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\n\r\nconst connection = require('../config/database');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi  = require('../models/Model_Reservasi');\r\nconst Model_Jadwal     = require('../models/Model_Jadwal');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// â¬‡ï¸ helper untuk log_reservasi\r\nconst { createLog } = require('../helpers/logHelper');\r\n\r\n// semua route di sini hanya boleh diakses admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// ===============================\r\n// GET: daftar pembayaran pending\r\n// ===============================\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/pembayaran:', err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// =======================================\r\n// POST: KONFIRMASI PEMBAYARAN (BERHASIL)\r\n// =======================================\r\nrouter.post('/confirm/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran-nya\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran:', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update tabel pembayaran -> confirmed\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'confirmed',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran:', err2);\r\n            req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // ðŸ”Ž ambil data reservasi sebelum di-update untuk log status_awal\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> disetujui\r\n            await Model_Reservasi.Update(id_reservasi, { status: 'disetujui' });\r\n\r\n            // ðŸ”Ž ambil lagi sesudah update\r\n            const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasi = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n            // 3b) SIMPAN LOG RESERVASI\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'disetujui',\r\n                'Pembayaran dikonfirmasi admin'\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log konfirmasi pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) update jadwal -> terisi\r\n            if (reservasi && reservasi.id_jadwal) {\r\n              await Model_Jadwal.Update(reservasi.id_jadwal, { status_slot: 'terisi' });\r\n            }\r\n\r\n            // 5) kirim notifikasi ke pemain (kalau ada)\r\n            try {\r\n              if (reservasi && reservasi.id_user) {\r\n                // ====== DETAIL RESERVASI UNTUK NOTIF ======\r\n                const tanggalMain = reservasi.tanggal\r\n                  ? new Date(reservasi.tanggal).toLocaleDateString('id-ID', {\r\n                      weekday: 'long',\r\n                      day: 'numeric',\r\n                      month: 'long',\r\n                      year: 'numeric'\r\n                    })\r\n                  : '-';\r\n\r\n                const jamMulai   = reservasi.jam_mulai   ? reservasi.jam_mulai.substring(0, 5)   : '-';\r\n                const jamSelesai = reservasi.jam_selesai ? reservasi.jam_selesai.substring(0, 5) : '-';\r\n\r\n                const metodePembayaran = bayar.metode_pembayaran || 'â€“';\r\n\r\n                const isiPesan = (\r\n                  `Pembayaran Anda untuk arena ${reservasi.nama_arena || 'Arena'} ` +\r\n                  `pada ${tanggalMain} pukul ${jamMulai}â€“${jamSelesai} ` +\r\n                  `dengan metode ${metodePembayaran} telah dikonfirmasi. ` +\r\n                  `Booking Anda sekarang aktif.`\r\n                );\r\n\r\n                await Model_Notifikasi.Store({\r\n                  id_user: reservasi.id_user,\r\n                  judul: 'Pembayaran Dikonfirmasi',\r\n                  isi_pesan: isiPesan,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif konfirmasi pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran:', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\n// ==================================\r\n// POST: TOLAK PEMBAYARAN (REJECTED)\r\n// ==================================\r\nrouter.post('/reject/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran (reject):', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update pembayaran -> rejected\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'rejected',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran (reject):', err2);\r\n            req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // ðŸ”Ž ambil status reservasi sebelum diubah\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> ditolak + kosongkan slot\r\n            if (typeof Model_Reservasi.rejectAndFreeSlot === 'function') {\r\n              await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n            } else {\r\n              await Model_Reservasi.Update(id_reservasi, { status: 'ditolak' });\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              if (rowsReservasi && rowsReservasi[0] && rowsReservasi[0].id_jadwal) {\r\n                await Model_Jadwal.Update(rowsReservasi[0].id_jadwal, { status_slot: 'kosong' });\r\n              }\r\n            }\r\n\r\n            // 3b) SIMPAN LOG RESERVASI (ditolak)\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'ditolak',\r\n                `Pembayaran ditolak admin. ${catatan_admin || ''}`\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log tolak pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) kirim notifikasi ke pemain\r\n            try {\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              const r = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n              if (r && r.id_user) {\r\n                // alasan default kalau admin tidak isi catatan\r\n                const alasan =\r\n                  catatan_admin && catatan_admin.trim() !== ''\r\n                    ? catatan_admin\r\n                    : 'Pembayaran ditolak karena data tidak lengkap atau batas waktu upload bukti pembayaran sudah habis.';\r\n\r\n                // DETAIL RESERVASI\r\n                const tanggalMain = r.tanggal\r\n                  ? new Date(r.tanggal).toLocaleDateString('id-ID', {\r\n                      weekday: 'long',\r\n                      day: 'numeric',\r\n                      month: 'long',\r\n                      year: 'numeric'\r\n                    })\r\n                  : '-';\r\n\r\n                const jamMulai   = r.jam_mulai   ? r.jam_mulai.substring(0, 5)   : '-';\r\n                const jamSelesai = r.jam_selesai ? r.jam_selesai.substring(0, 5) : '-';\r\n\r\n                const metodePembayaran = bayar.metode_pembayaran || 'â€“';\r\n\r\n                const isiPesan = (\r\n                  `Pembayaran Anda untuk arena ${r.nama_arena || 'Arena'} ` +\r\n                  `pada ${tanggalMain} pukul ${jamMulai}â€“${jamSelesai} ` +\r\n                  `dengan metode ${metodePembayaran} ditolak. ` +\r\n                  `Alasan: ${alasan}`\r\n                );\r\n\r\n                await Model_Notifikasi.Store({\r\n                  id_user: r.id_user,\r\n                  judul: 'Pembayaran Ditolak',\r\n                  isi_pesan: isiPesan,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif tolak pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil ditolak.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran (reject):', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\nmodule.exports = router;\r\n"]}