{"version":3,"sources":["pembayaran.js"],"names":["express","require","router","Router","connection","Model_Reservasi","Model_Notifikasi","Model_Pembayaran","createLog","get","req","res","pembayaran","regeneratorRuntime","async","_context","prev","next","awrap","getPendingPayments","sent","title","data","t0","console","error","flash","stop","post","id_pembayaran","params","catatan_admin","body","query","err","rowsBayar","bayar","id_reservasi","_context3","abrupt","redirect","length","rowsReservasiBefore","reservasiBefore","statusAwal","rowsReservasi","reservasi","_context2","err2","getById","status","Update","id_jadwal","Model_Jadwal","status_slot","id_user","Store","judul","nama_arena","tipe","dibaca","t1","warn","t2","_context5","_rowsReservasi","r","_context4","rejectAndFreeSlot","concat","isi_pesan","jenis_notif","module","exports"],"mappings":"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","file":"pembayaran.min.js","sourcesContent":["// routes/pembayaran.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\n\r\nconst connection = require('../config/database');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi  = require('../models/Model_Reservasi');\r\nconst Model_Jadwal     = require('../models/Model_Jadwal');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// â¬‡ï¸ TAMBAHAN: helper untuk log_reservasi\r\nconst { createLog } = require('../helpers/logHelper');\r\n\r\n// semua route di sini hanya boleh diakses admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// ===============================\r\n// GET: daftar pembayaran pending\r\n// ===============================\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/pembayaran:', err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// =======================================\r\n// POST: KONFIRMASI PEMBAYARAN (BERHASIL)\r\n// =======================================\r\nrouter.post('/confirm/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran-nya\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran:', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update tabel pembayaran -> confirmed\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'confirmed',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran:', err2);\r\n            req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // ðŸ”Ž ambil data reservasi sebelum di-update untuk log status_awal\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> disetujui\r\n            await Model_Reservasi.Update(id_reservasi, { status: 'disetujui' });\r\n\r\n            // ðŸ”Ž ambil lagi sesudah update (untuk keperluan jadwal & log kalau mau cek)\r\n            const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasi = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n            // 3b) SIMPAN LOG RESERVASI\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'disetujui',\r\n                'Pembayaran dikonfirmasi admin'\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log konfirmasi pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) update jadwal -> terisi\r\n            if (reservasi && reservasi.id_jadwal) {\r\n              await Model_Jadwal.Update(reservasi.id_jadwal, { status_slot: 'terisi' });\r\n            }\r\n\r\n            // 5) kirim notifikasi ke pemain (kalau ada)\r\n            try {\r\n              if (reservasi && reservasi.id_user) {\r\n                await Model_Notifikasi.Store({\r\n                  id_user: reservasi.id_user,\r\n                  judul: 'Pembayaran Dikonfirmasi',\r\n                  isi_pesan: `Pembayaran Anda untuk arena ${reservasi.nama_arena || 'Arena'} telah dikonfirmasi. Booking Anda sekarang aktif.`,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif konfirmasi pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran:', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\n// ==================================\r\n// POST: TOLAK PEMBAYARAN (REJECTED)\r\n// ==================================\r\nrouter.post('/reject/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran (reject):', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update pembayaran -> rejected\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'rejected',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran (reject):', err2);\r\n            req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // ðŸ”Ž ambil status reservasi sebelum diubah\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> ditolak + kosongkan slot\r\n            if (typeof Model_Reservasi.rejectAndFreeSlot === 'function') {\r\n              await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n            } else {\r\n              await Model_Reservasi.Update(id_reservasi, { status: 'ditolak' });\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              if (rowsReservasi && rowsReservasi[0] && rowsReservasi[0].id_jadwal) {\r\n                await Model_Jadwal.Update(rowsReservasi[0].id_jadwal, { status_slot: 'kosong' });\r\n              }\r\n            }\r\n\r\n            // 3b) SIMPAN LOG RESERVASI (ditolak)\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'ditolak',\r\n                `Pembayaran ditolak admin. ${catatan_admin || ''}`\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log tolak pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) kirim notifikasi ke pemain\r\n            try {\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              const r = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n              if (r && r.id_user) {\r\n                await Model_Notifikasi.Store({\r\n                  id_user: r.id_user,\r\n                  judul: 'Pembayaran Ditolak',\r\n                  isi_pesan: `Pembayaran Anda untuk arena ${r.nama_arena || 'Arena'} ditolak. ${catatan_admin || ''}`,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif tolak pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil ditolak.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran (reject):', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\nmodule.exports = router;\r\n"]}