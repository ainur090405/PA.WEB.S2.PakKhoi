{"version":3,"sources":["pembayaran.js"],"names":["express","require","router","Router","Model_Reservasi","use","isAuthenticated","isAdmin","get","req","res","getPendingPayments","render","title","data","console","error","_context","t0","flash","redirect","post","id_pembayaran","catatan_admin","pembayaranData","reservasiData","Model_Jadwal","Model_Notifikasi","notifData","regeneratorRuntime","async","_context2","prev","next","params","id","pembayaran","body","awrap","Model_Pembayaran","getById","sent","length","Update","id_reservasi","status","id_jadwal","status_slot","id_user","judul","isi_pesan","concat","nama_arena","jenis_notif","tipe","dibaca","Store","t1","stop","_context3","confirmPayment","json","success","message","_context4"],"mappings":"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","file":"pembayaran.min.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Tampilkan daftar pembayaran yang pending\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// POST: Konfirmasi pembayaran\r\nrouter.post('/confirm/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n    const { catatan_admin } = req.body;\r\n\r\n    // Konfirmasi pembayaran\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'confirmed', catatan_admin);\r\n\r\n    // Update status reservasi menjadi 'disetujui' jika pembayaran dikonfirmasi\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'disetujui' });\r\n\r\n      // Update status slot jadwal menjadi 'terisi'\r\n      const reservasiData = await Model_Reservasi.getById(pembayaranData[0].id_reservasi);\r\n      if (reservasiData.length > 0) {\r\n        const Model_Jadwal = require('../models/Model_Jadwal');\r\n        await Model_Jadwal.Update(reservasiData[0].id_jadwal, { status_slot: 'terisi' });\r\n      }\r\n\r\n      // Kirim notifikasi pembayaran dikonfirmasi\r\n      if (pembayaranData[0] && pembayaranData[0].id_user && typeof pembayaranData[0].id_user === 'number' && pembayaranData[0].id_user > 0) {\r\n        try {\r\n          const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n          const notifData = {\r\n            id_user: pembayaranData[0].id_user,\r\n            judul: 'Pembayaran Dikonfirmasi',\r\n            isi_pesan: `Pembayaran Anda untuk arena ${pembayaranData[0].nama_arena || 'Arena'} telah dikonfirmasi. Booking Anda sekarang aktif.`,\r\n            jenis_notif: 'status',\r\n            tipe: 'payment',\r\n            dibaca: 0\r\n          };\r\n          await Model_Notifikasi.Store(notifData);\r\n        } catch (notifErr) {\r\n          console.error('Failed to send notification:', notifErr);\r\n          // Continue with confirmation even if notification fails\r\n        }\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n    res.redirect('/admin/pembayaran');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n    res.redirect('/admin/pembayaran');\r\n  }\r\n});\r\n\r\n// POST: Konfirmasi COD (tanpa redirect, hanya flash message)\r\nrouter.post('/confirm-cod/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n\r\n    // Konfirmasi pembayaran COD\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'confirmed', 'COD - Pembayaran diterima langsung');\r\n\r\n    // Update status reservasi menjadi 'disetujui' jika pembayaran dikonfirmasi\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'disetujui' });\r\n\r\n      // Update status slot jadwal menjadi 'terisi'\r\n      const reservasiData = await Model_Reservasi.getById(pembayaranData[0].id_reservasi);\r\n      if (reservasiData.length > 0) {\r\n        const Model_Jadwal = require('../models/Model_Jadwal');\r\n        await Model_Jadwal.Update(reservasiData[0].id_jadwal, { status_slot: 'terisi' });\r\n      }\r\n\r\n      // Kirim notifikasi pembayaran dikonfirmasi\r\n      if (pembayaranData[0] && pembayaranData[0].id_user && typeof pembayaranData[0].id_user === 'number' && pembayaranData[0].id_user > 0) {\r\n        try {\r\n          const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n          const notifData = {\r\n            id_user: pembayaranData[0].id_user,\r\n            judul: 'Pembayaran COD Dikonfirmasi',\r\n            isi_pesan: `Pembayaran COD Anda untuk arena ${pembayaranData[0].nama_arena || 'Arena'} telah dikonfirmasi. Booking Anda sekarang aktif.`,\r\n            jenis_notif: 'status',\r\n            tipe: 'payment',\r\n            dibaca: 0\r\n          };\r\n          await Model_Notifikasi.Store(notifData);\r\n        } catch (notifErr) {\r\n          console.error('Failed to send notification:', notifErr);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Return JSON response untuk AJAX\r\n    res.json({ success: true, message: 'Pembayaran COD berhasil dikonfirmasi!' });\r\n  } catch (err) {\r\n    console.error(err);\r\n    // Return JSON error response untuk AJAX, bukan redirect\r\n    res.status(500).json({ success: false, message: 'Gagal mengkonfirmasi pembayaran COD. Silakan coba lagi.' });\r\n  }\r\n});\r\n\r\n// POST: Tolak pembayaran\r\nrouter.post('/reject/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n    const { catatan_admin } = req.body;\r\n\r\n    // Update status pembayaran menjadi 'rejected'\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'rejected', catatan_admin);\r\n\r\n    // Update status reservasi menjadi 'ditolak'\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'ditolak' });\r\n\r\n      // Kirim notifikasi ke pemain jika id_user valid\r\n      if (pembayaranData[0] && pembayaranData[0].id_user && typeof pembayaranData[0].id_user === 'number' && pembayaranData[0].id_user > 0) {\r\n        try {\r\n          const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n          const notifData = {\r\n            id_user: pembayaranData[0].id_user,\r\n            judul: 'Pembayaran Ditolak',\r\n            isi_pesan: `Pembayaran Anda untuk arena ${pembayaranData[0].nama_arena || 'Arena'} ditolak. ${catatan_admin}`,\r\n            jenis_notif: 'status',\r\n            tipe: 'payment',\r\n            dibaca: 0\r\n          };\r\n          await Model_Notifikasi.Store(notifData);\r\n        } catch (notifErr) {\r\n          console.error('Failed to send notification:', notifErr);\r\n          // Continue with rejection even if notification fails\r\n        }\r\n      }\r\n    }\r\n\r\n    req.flash('error_msg', 'Pembayaran berhasil ditolak.');\r\n    res.redirect('/admin/pembayaran');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n    res.redirect('/admin/pembayaran');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}