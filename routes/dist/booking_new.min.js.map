{"version":3,"sources":["booking_new.js"],"names":["express","require","router","Router","Model_Jadwal","Model_Arena","Model_Pembayaran","req","res","body","amount","id_user","session","user","id","id_jadwal","post","length","Error","jadwalData","status_slot","flash","redirect","id_arena","getById","arenaData","harga","dataReservasi","status","payment_method","payment_status","parseFloat","Model_Reservasi","Store","result","id_reservasi","insertId","dataPembayaran","status_pembayaran","jumlah","Update","module","exports"],"mappings":"aACA,IAAMA,QAAUC,QAAQ,WADxBC,OAAAF,QAAAG,SACMH,gBAAkBC,QAAxB,6BAGMG,aAAeH,QAAQ,0BAFvBC,iBAAiBC,QAAvB,8BAIME,YAAcJ,QAAQ,yBAD5BC,OAAMI,KAAAA,UAAmBL,SAAOM,EAACC,GAARP,IAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,EAAAA,OAAAA,mBAAAA,MAAAA,SAAAA,GAAAA,OAAAA,OAAAA,EAAAA,KAAAA,EAAAA,MAAAA,KAAAA,EAAAA,OAAAA,EAAAA,KAAAA,EAAAA,EACzBM,EAEAE,KAFMJ,EADmBJ,EACnBI,UAAcJ,EADKA,EACLA,eAAQS,EADHT,EACGS,OAG5BC,EAAAJ,EAAAK,QAAAC,KAAAC,GAJyBb,EAAAA,KAAAA,EAAAA,mBAAAA,MAMFG,aAAOG,QAAPQ,IANEd,KAAAA,EAAAA,GAMF,KAAhBe,EANkBf,EAAAA,MAMFgB,OANEhB,MAcb,IAAIiB,MAAM,8CAdGjB,EAAAA,KAAAA,EAAAA,MAAAA,KAAAA,EAAAA,GAMF,WAAAkB,EAAA,GAAAC,YANEnB,OAMFM,EAAAc,MAAA,YAAA,gDANEpB,EAAAA,OAAAA,SAMFO,EAAAc,SAE+Bb,SAR7BR,EAAAA,KAAAA,GAAAA,MAAAA,KAAAA,GAAAA,OAuBfsB,EAAWJ,EAAW,GAAGI,SAvBVtB,EAAAA,KAAAA,GAAAA,mBAAAA,MA0BGI,YAAYmB,QAAQD,IA1BvBtB,KAAAA,GAAAA,OA0BfwB,EA1BexB,EAAAA,KAMFyB,EAAAD,EAAA,GAAAC,OAAA,EAAAC,EAOL,CAPKhB,QAAAA,EAAAY,SAAAA,EAAAR,UAAAA,EA4BjBa,OAAQ,WA5BSC,eAQPX,EAsBVY,eAAmC,QAAnBD,EAA2B,UAAY,SA9BtCnB,OAAA,aAAAmB,EAAAE,WAAArB,GAAAgB,GANEzB,EAAAA,KAAAA,GAAAA,mBAAAA,MAMF+B,gBAAAC,MAAAN,IANE1B,KAAAA,GAAAA,OAMFiC,EANEjC,EAAAA,KA0CfkC,EAAeD,EAAOE,SAGtBC,EAAiB,CAvCJF,aAAAA,EAiBbZ,kBAAWJ,EAyBfmB,kBAAsC,QAAnBT,EAA2B,UAAY,SA1CzCU,OAAAZ,EAAAjB,QANET,EAAAA,KAAAA,GAAAA,mBAAAA,MAmDfK,iBAAiB2B,MAAMI,IAnDRpC,KAAAA,GAAAA,OAAAA,EAAAA,KAAAA,GAAAA,mBAAAA,MAuDfG,aAAaoC,OAAOzB,EAAW,CAAEK,YAAa,YAvD/BnB,KAAAA,GAgCnBsB,EAAAA,MAAAA,cAAUA,gDACVR,EAAAA,SAAAA,mBAjCmBd,EAAAA,KAAAA,GAAAA,MAAAA,KAAAA,GAAAA,EAAAA,KAAAA,GAAAA,EAAAA,GAAAA,EAAAA,MAAAA,GAmCnB4B,QAAAA,MAAAA,EAAAA,IACAC,EAAAA,MAAAA,YAAc,mDAAmDtB,EAAAc,SAAA,QApC9CrB,KAAAA,GAAAA,IAAAA,MAAAA,OAAAA,EAAAA,SAAAA,KAAAA,KAAAA,CAAAA,CAAAA,EAAAA,QAoEzBwC,OAAOC,QAAUxC","file":"booking_new.min.js","sourcesContent":["// routes/booking.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Arena = require('../models/Model_Arena');\r\n\r\n// Rute ini HANYA bisa diakses jika sudah login\r\n// (karena akan kita kunci di app.js)\r\n\r\nrouter.post('/create', async (req, res) => {\r\n  try {\r\n    const { id_jadwal, payment_method, amount } = req.body;\r\n    const id_user = req.session.user.id; // Ambil ID dari session\r\n\r\n    // 1. Ambil info jadwal untuk dapat id_arena\r\n    const jadwalData = await Model_Jadwal.getById(id_jadwal);\r\n    if (jadwalData.length === 0) {\r\n      throw new Error('Jadwal tidak ditemukan atau sudah dipesan.');\r\n    }\r\n\r\n    // 2. Pastikan slot masih kosong (double check)\r\n    if (jadwalData[0].status_slot !== 'kosong') {\r\n       req.flash('error_msg', 'Maaf, slot ini baru saja dipesan orang lain.');\r\n       return res.redirect('back');\r\n    }\r\n\r\n    const id_arena = jadwalData[0].id_arena;\r\n\r\n    // 3. Ambil harga arena\r\n    const arenaData = await Model_Arena.getById(id_arena);\r\n    const harga = arenaData[0].harga || 0;\r\n\r\n    // 4. Buat data reservasi baru dengan payment info\r\n    const dataReservasi = {\r\n      id_user: id_user,\r\n      id_arena: id_arena,\r\n      id_jadwal: id_jadwal,\r\n      status: 'menunggu', // Status awal\r\n      payment_method: payment_method,\r\n      payment_status: payment_method === 'cod' ? 'pending' : 'unpaid', // COD pending, Midtrans unpaid\r\n      amount: payment_method === 'midtrans' ? parseFloat(amount) : harga // Use provided amount for midtrans, arena price for COD\r\n    };\r\n\r\n    // Pastikan Model_Reservasi punya fungsi Store\r\n    const result = await Model_Reservasi.Store(dataReservasi);\r\n    const id_reservasi = result.insertId;\r\n\r\n    // 5. Buat record pembayaran\r\n    const dataPembayaran = {\r\n      id_reservasi: id_reservasi,\r\n      metode_pembayaran: payment_method,\r\n      status_pembayaran: payment_method === 'cod' ? 'pending' : 'unpaid',\r\n      jumlah: dataReservasi.amount\r\n    };\r\n    await Model_Pembayaran.Store(dataPembayaran);\r\n\r\n    // 6. UPDATE status slot jadwal menjadi 'terisi'\r\n    // Pastikan Model_Jadwal punya fungsi Update\r\n    await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n\r\n    // 7. Berhasil! Arahkan ke halaman profil\r\n    req.flash('success_msg', 'Booking berhasil! Menunggu konfirmasi Admin.');\r\n    res.redirect('/pemain/profile'); // Arahkan ke riwayat pemesanan\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Maaf, terjadi kesalahan saat melakukan booking.');\r\n    res.redirect('back'); // Kembali ke halaman detail arena\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}