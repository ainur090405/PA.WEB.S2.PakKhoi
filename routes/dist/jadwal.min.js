"use strict";function _slicedToArray(e,a){return _arrayWithHoles(e)||_iterableToArrayLimit(e,a)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,a){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var r=[],t=!0,n=!1,s=void 0;try{for(var i,l=e[Symbol.iterator]();!(t=(i=l.next()).done)&&(r.push(i.value),!a||r.length!==a);t=!0);}catch(e){n=!0,s=e}finally{try{t||null==l.return||l.return()}finally{if(n)throw s}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var express=require("express"),router=express.Router(),Model_Jadwal=require("../models/Model_Jadwal"),Model_Arena=require("../models/Model_Arena"),Model_Reservasi=require("../models/Model_Reservasi"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isAdmin=_require.isAdmin;router.use(isAuthenticated,isAdmin),router.get("/generator",function(a,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Arena.getAll());case 3:t=e.sent,r.render("admin/jadwal/generator",{title:"Generator Jadwal Massal",arenaList:t}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),a.flash("error_msg","Gagal memuat data arena."),r.redirect("/jadwal");case 11:case"end":return e.stop()}},null,null,[[0,7]])}),router.post("/generator",function(a,r){var t,n,s,i,l,o,u,d,c,m,g,p,_,w,f,h,b,v,j,x;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=a.body,n=t.id_arena,s=t.hari,i=t.jam_buka_operasi,l=t.jam_tutup_operasi,o=t.durasi_sesi,u=t.jumlah_minggu,s){e.next=5;break}return a.flash("error_msg","Anda harus memilih minimal satu hari."),e.abrupt("return",r.redirect("/jadwal/generator"));case 5:d=[],c=Array.isArray(s)?s:[s],m=6e4*parseInt(o),g=7*parseInt(u),p=["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"],_=0;case 11:if(!(_<g)){e.next=31;break}if((w=new Date).setDate(w.getDate()+_),f=p[w.getDay()],!c.includes(f)){e.next=28;break}b=(h=function(e,a){var r=_slicedToArray(a.split(":"),2),t=r[0],n=r[1],s=new Date(e.getTime());return s.setHours(t,n,0,0),s})(w,i),v=h(w,l);case 19:if(!(b<v)){e.next=28;break}if(j=new Date(b.getTime()+m),v<j)return e.abrupt("break",28);e.next=23;break;case 23:x={id_arena:n,tanggal:b.toISOString().slice(0,10),jam_mulai:b.toTimeString().slice(0,5),jam_selesai:j.toTimeString().slice(0,5),status_slot:"kosong"},d.push(x),b=j,e.next=19;break;case 28:_++,e.next=11;break;case 31:if(0<d.length)return e.next=34,regeneratorRuntime.awrap(Model_Jadwal.StoreMany(d));e.next=37;break;case 34:a.flash("success_msg","".concat(d.length," slot jadwal baru berhasil di-generate!")),e.next=38;break;case 37:a.flash("error_msg","Tidak ada jadwal yang di-generate. Cek kembali input Anda.");case 38:r.redirect("/jadwal"),e.next=46;break;case 41:e.prev=41,e.t0=e.catch(0),console.error(e.t0),a.flash("error_msg","Terjadi error saat generate jadwal: "+e.t0.message),r.redirect("/jadwal/generator");case 46:case"end":return e.stop()}},null,null,[[0,41]])}),router.get("/",function(a,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Jadwal.getAll());case 3:t=e.sent,r.render("admin/jadwal/index",{title:"Manajemen Jadwal",data:t}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),a.flash("error_msg","Gagal memuat data jadwal."),r.redirect("/admin/dashboard");case 11:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/create",function(a,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Arena.getAll());case 3:t=e.sent,r.render("admin/jadwal/create",{title:"Tambah Jadwal Baru",arenaList:t}),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),a.flash("error_msg","Gagal memuat data arena."),r.redirect("/jadwal");case 11:case"end":return e.stop()}},null,null,[[0,7]])}),router.post("/store",function(a,r){var t,n,s,i,l,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.body,n=t.id_arena,s=t.tanggal,i=t.jam_mulai,l=t.jam_selesai,o=t.status_slot,u={id_arena:n,tanggal:s,jam_mulai:i,jam_selesai:l,status_slot:o},e.next=5,regeneratorRuntime.awrap(Model_Jadwal.Store(u));case 5:a.flash("success_msg","Jadwal baru berhasil ditambahkan."),r.redirect("/jadwal"),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(0),a.flash("error_msg","Gagal menyimpan jadwal: "+e.t0.code),r.redirect("/jadwal/create");case 13:case"end":return e.stop()}},null,null,[[0,9]])}),router.get("/edit/:id",function(a,r){var t,n,s,i,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.params.id,e.next=4,regeneratorRuntime.awrap(Promise.all([Model_Jadwal.getById(t),Model_Arena.getAll()]));case 4:if(n=e.sent,s=_slicedToArray(n,2),i=s[0],l=s[1],0===i.length)return a.flash("error_msg","Jadwal tidak ditemukan."),e.abrupt("return",r.redirect("/jadwal"));e.next=11;break;case 11:r.render("admin/jadwal/edit",{title:"Edit Jadwal",jadwal:i[0],arenaList:l}),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(0),a.flash("error_msg","Gagal memuat data."),r.redirect("/jadwal");case 18:case"end":return e.stop()}},null,null,[[0,14]])}),router.post("/update/:id",function(a,r){var t,n,s,i,l,o,u,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.params.id,e.prev=1,n=a.body,s=n.id_arena,i=n.tanggal,l=n.jam_mulai,o=n.jam_selesai,u=n.status_slot,d={id_arena:s,tanggal:i,jam_mulai:l,jam_selesai:o,status_slot:u},e.next=6,regeneratorRuntime.awrap(Model_Jadwal.Update(t,d));case 6:a.flash("success_msg","Data jadwal berhasil diperbarui."),r.redirect("/jadwal"),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(1),a.flash("error_msg","Gagal memperbarui jadwal: "+e.t0.code),r.redirect("/jadwal/edit/"+t);case 14:case"end":return e.stop()}},null,null,[[1,10]])}),router.post("/update-status/:id",function(a,r){var t,n,s,i,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.params.id,n=a.body.status,e.next=5,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 5:if(s=e.sent,i=Array.isArray(s)?s[0]:s,console.log("[DEBUG] Reservasi Ditemukan:",i),i&&i.id_jadwal){e.next=12;break}return console.log("[DEBUG] Reservasi kosong atau tidak punya id_jadwal."),a.flash("error_msg","Data reservasi tidak ditemukan atau tidak valid."),e.abrupt("return",r.redirect("/reservasi"));case 12:return e.next=14,regeneratorRuntime.awrap(Model_Reservasi.Update(t,{status:n}));case 14:if(console.log("[DEBUG] Reservasi ".concat(t," → status ").concat(n)),l=i.id_jadwal,"disetujui"===n)return console.log("[DEBUG] Jadwal ".concat(l," → terisi")),e.next=20,regeneratorRuntime.awrap(Model_Jadwal.Update(l,{status_slot:"terisi"}));e.next=22;break;case 20:e.next=26;break;case 22:if("ditolak"===n||"batal"===n)return console.log("[DEBUG] Jadwal ".concat(l," → kosong")),e.next=26,regeneratorRuntime.awrap(Model_Jadwal.Update(l,{status_slot:"kosong"}));e.next=26;break;case 26:a.flash("success_msg","Status reservasi berhasil diperbarui menjadi ".concat(n)),r.redirect("/reservasi"),e.next=35;break;case 30:e.prev=30,e.t0=e.catch(0),console.error("[DEBUG ERROR] Gagal update status:",e.t0),a.flash("error_msg","Gagal memperbarui status reservasi"),r.redirect("/reservasi");case 35:case"end":return e.stop()}},null,null,[[0,30]])}),router.get("/delete/:id",function(a,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Jadwal.Delete(a.params.id));case 3:a.flash("success_msg","Data jadwal berhasil dihapus."),r.redirect("/jadwal"),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),a.flash("error_msg","Gagal menghapus jadwal: "+e.t0.code),r.redirect("/jadwal");case 11:case"end":return e.stop()}},null,null,[[0,7]])}),module.exports=router;
//# sourceMappingURL=jadwal.min.js.map
