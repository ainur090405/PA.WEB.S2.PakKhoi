"use strict";var express=require("express"),router=express.Router(),bcrypt=require("bcryptjs"),Model_Users=require("../models/Model_Users"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isAdmin=_require.isAdmin;router.use(isAuthenticated,isAdmin),router.get("/",function(r,t){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Users.getAll());case 3:s=e.sent,t.render("admin/users/index",{title:"Manajemen User",data:s}),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memuat data users."),t.redirect("/admin/dashboard");case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/create",function(e,r){r.render("admin/users/create",{title:"Tambah User Baru"})}),router.post("/store",function(r,t){var s,a,n,u,i,o,c,d,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return s=r.body,a=s.nama,n=s.email,u=s.password,i=s.no_hp,o=s.role,c=s.status,e.prev=1,e.next=4,regeneratorRuntime.awrap(bcrypt.hash(u,10));case 4:return d=e.sent,l={nama:a,email:n,no_hp:i,role:o,password_hash:d,tanggal_daftar:new Date,status:c||"aktif"},e.next=8,regeneratorRuntime.awrap(Model_Users.Store(l));case 8:r.flash("success_msg","User baru berhasil ditambahkan."),t.redirect("/users"),e.next=17;break;case 12:e.prev=12,e.t0=e.catch(1),console.error(e.t0),r.flash("error_msg","Gagal menyimpan user: "+(e.t0.code||e.t0.message)),t.redirect("/users/create");case 17:case"end":return e.stop()}},null,null,[[1,12]])}),router.get("/edit/:id",function(r,t){var s,a;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.id,e.next=4,regeneratorRuntime.awrap(Model_Users.getById(s));case 4:if((a=e.sent)&&0!==a.length){e.next=8;break}return r.flash("error_msg","User tidak ditemukan."),e.abrupt("return",t.redirect("/users"));case 8:t.render("admin/users/edit",{title:"Edit User",user:a[0]}),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memuat data user."),t.redirect("/users");case 16:case"end":return e.stop()}},null,null,[[0,11]])}),router.post("/update/:id",function(r,t){var s,a,n,u,i,o,c,d,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.params.id,a=r.body,n=a.nama,u=a.email,i=a.password,o=a.no_hp,c=a.role,d=a.status,e.prev=2,l={nama:n,email:u,no_hp:o,role:c,status:d||"aktif"},i&&""!==i.trim())return e.next=7,regeneratorRuntime.awrap(bcrypt.hash(i,10));e.next=8;break;case 7:l.password_hash=e.sent;case 8:return e.next=10,regeneratorRuntime.awrap(Model_Users.Update(s,l));case 10:r.flash("success_msg","Data user berhasil diperbarui."),t.redirect("/users"),e.next=19;break;case 14:e.prev=14,e.t0=e.catch(2),console.error(e.t0),r.flash("error_msg","Gagal memperbarui user: "+(e.t0.code||e.t0.message)),t.redirect("/users/edit/"+s);case 19:case"end":return e.stop()}},null,null,[[2,14]])}),router.get("/delete/:id",function(r,t){var s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(s=r.params.id,Number(s)===Number(r.session.user.id))return r.flash("error_msg","Anda tidak bisa menghapus akun Anda sendiri."),e.abrupt("return",t.redirect("/users"));e.next=4;break;case 4:return e.prev=4,e.next=7,regeneratorRuntime.awrap(Model_Users.Delete(s));case 7:r.flash("success_msg","Data user berhasil dihapus."),t.redirect("/users"),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(4),console.error(e.t0),r.flash("error_msg","Gagal menghapus user: "+(e.t0.code||e.t0.message)),t.redirect("/users");case 16:case"end":return e.stop()}},null,null,[[4,11]])}),module.exports=router;
//# sourceMappingURL=users.min.js.map
