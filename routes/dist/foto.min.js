"use strict";function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var a=[],t=!0,n=!1,o=void 0;try{for(var i,s=e[Symbol.iterator]();!(t=(i=s.next()).done)&&(a.push(i.value),!r||a.length!==r);t=!0);}catch(e){n=!0,o=e}finally{try{t||null==s.return||s.return()}finally{if(n)throw o}}return a}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var express=require("express"),router=express.Router(),Model_Arena=require("../models/Model_Arena"),Model_FotoArena=require("../models/Model_FotoArena"),_require=require("../middleware/uploadMiddleware"),uploadArena=_require.uploadArena,_require2=require("../middleware/authMiddleware"),isAuthenticated=_require2.isAuthenticated,isAdmin=_require2.isAdmin,fs=require("fs"),path=require("path");router.use(isAuthenticated,isAdmin),router.get("/manage/:id_arena",function(r,a){var t,n,o,i,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.params.id_arena,e.next=4,regeneratorRuntime.awrap(Promise.all([Model_Arena.getById(t),Model_FotoArena.getByArenaId(t)]));case 4:if(n=e.sent,o=_slicedToArray(n,2),i=o[0],s=o[1],0===i.length)return r.flash("error_msg","Arena tidak ditemukan."),e.abrupt("return",a.redirect("/arena"));e.next=11;break;case 11:a.render("admin/foto/manage",{title:"Galeri Foto: ".concat(i[0].nama_arena),arena:i[0],fotoList:s}),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(0),r.flash("error_msg","Gagal memuat galeri: "+e.t0.message),a.redirect("/arena");case 18:case"end":return e.stop()}},null,null,[[0,14]])}),router.post("/store/:id_arena",uploadArena.array("foto_galeri",10),function(r,a){var t,n,o,i,s,u,c,l,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.params.id_arena,e.prev=1,n=r.body.deskripsi,r.files&&0!==r.files.length){e.next=6;break}return r.flash("error_msg","Anda tidak memilih file untuk di-upload."),e.abrupt("return",a.redirect("/foto/manage/".concat(t)));case 6:i=!(o=!0),s=void 0,e.prev=9,u=r.files[Symbol.iterator]();case 11:if(o=(c=u.next()).done){e.next=19;break}return l=c.value,d={id_arena:t,url_foto:"/uploads/arena/"+l.filename,deskripsi:n},e.next=16,regeneratorRuntime.awrap(Model_FotoArena.Store(d));case 16:o=!0,e.next=11;break;case 19:e.next=25;break;case 21:e.prev=21,e.t0=e.catch(9),i=!0,s=e.t0;case 25:e.prev=25,e.prev=26,o||null==u.return||u.return();case 28:if(e.prev=28,i)throw s;e.next=31;break;case 31:return e.finish(28);case 32:return e.finish(25);case 33:r.flash("success_msg","".concat(r.files.length," foto berhasil di-upload.")),a.redirect("/foto/manage/".concat(t)),e.next=41;break;case 37:e.prev=37,e.t1=e.catch(1),r.flash("error_msg","Gagal upload foto: "+e.t1.message),a.redirect("/foto/manage/".concat(t));case 41:case"end":return e.stop()}},null,null,[[1,37],[9,21,25,33],[26,,28,32]])}),router.get("/delete/:id_arena/:id_foto",function(r,a){var t,n,o,i,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.params,n=t.id_arena,o=t.id_foto,e.prev=1,e.next=4,regeneratorRuntime.awrap(Model_FotoArena.getById(o));case 4:return 0<(i=e.sent).length&&i[0].url_foto&&(s=path.join(__dirname,"../public",i[0].url_foto),fs.existsSync(s)&&fs.unlinkSync(s)),e.next=8,regeneratorRuntime.awrap(Model_FotoArena.Delete(o));case 8:r.flash("success_msg","Foto berhasil dihapus."),a.redirect("/foto/manage/".concat(n)),e.next=16;break;case 12:e.prev=12,e.t0=e.catch(1),r.flash("error_msg","Gagal menghapus foto."),a.redirect("/foto/manage/".concat(n));case 16:case"end":return e.stop()}},null,null,[[1,12]])}),router.get("/setcover/:id_arena/:id_foto",function(r,a){var t,n,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.params,n=t.id_arena,o=t.id_foto,e.prev=1,e.next=4,regeneratorRuntime.awrap(Model_Arena.setCover(n,o));case 4:r.flash("success_msg","Foto cover berhasil diperbarui."),a.redirect("/foto/manage/".concat(n)),e.next=12;break;case 8:e.prev=8,e.t0=e.catch(1),r.flash("error_msg","Gagal set foto cover."),a.redirect("/foto/manage/".concat(n));case 12:case"end":return e.stop()}},null,null,[[1,8]])}),module.exports=router;
//# sourceMappingURL=foto.min.js.map
