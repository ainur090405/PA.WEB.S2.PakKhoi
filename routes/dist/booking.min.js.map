{"version":3,"sources":["booking.js"],"names":["express","require","router","Router","Model_Jadwal","Model_Arena","Model_Pembayaran","req","res","connection","body","id_jadwal","payment_method","amount","id_user","session","user","id","flash","redirect","includes","resolve","reject","beginTransaction","err","Promise","query","rows","length","Error","jadwalData","status_slot","id_arena","getById","arenaData","harga","finalAmount","isNaN","parseFloat","dataReservasi","status","payment_status","Model_Reservasi","Store","result","id_reservasi","insertId","dataPembayaran","metode_pembayaran","status_pembayaran","jumlah","Date","bukti_pembayaran","catatan_admin","konfirmasi_admin","Update","successMsg","rollback","errorMsg"],"mappings":"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","file":"booking.min.js","sourcesContent":["// routes/booking.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Arena = require('../models/Model_Arena');\r\n\r\n// Rute ini HANYA bisa diakses jika sudah login\r\n// (karena akan kita kunci di app.js)\r\n\r\nrouter.post('/create', async (req, res) => {\r\n  const connection = require('../config/database'); // Import connection for transaction\r\n\r\n  try {\r\n    const { id_jadwal, payment_method, amount } = req.body;\r\n    const id_user = req.session.user ? req.session.user.id : null;\r\n\r\n    // Validasi input\r\n    if (!id_user) {\r\n      req.flash('error_msg', 'Anda harus login untuk melakukan booking.');\r\n      return res.redirect('/auth/login');\r\n    }\r\n\r\n    if (!id_jadwal || !payment_method) {\r\n      req.flash('error_msg', 'Data booking tidak lengkap.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    if (!['cod', 'midtrans'].includes(payment_method)) {\r\n      req.flash('error_msg', 'Metode pembayaran tidak valid.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    // Start transaction\r\n    await new Promise((resolve, reject) => {\r\n      connection.beginTransaction(err => {\r\n        if (err) reject(err);\r\n        else resolve();\r\n      });\r\n    });\r\n\r\n    try {\r\n      // 1. Ambil info jadwal untuk dapat id_arena (lock for update)\r\n      const jadwalData = await new Promise((resolve, reject) => {\r\n        connection.query('SELECT * FROM jadwal WHERE id_jadwal = ? FOR UPDATE', [id_jadwal], (err, rows) => {\r\n          if (err) reject(err);\r\n          else resolve(rows);\r\n        });\r\n      });\r\n\r\n      if (jadwalData.length === 0) {\r\n        throw new Error('Jadwal tidak ditemukan.');\r\n      }\r\n\r\n      // 2. Pastikan slot masih kosong (double check dengan lock)\r\n      if (jadwalData[0].status_slot !== 'kosong') {\r\n        throw new Error('Maaf, slot ini sudah dipesan atau sedang menunggu konfirmasi.');\r\n      }\r\n\r\n      const id_arena = jadwalData[0].id_arena;\r\n\r\n      // 3. Ambil harga arena\r\n      const arenaData = await Model_Arena.getById(id_arena);\r\n      if (arenaData.length === 0) {\r\n        throw new Error('Arena tidak ditemukan.');\r\n      }\r\n      const harga = arenaData[0].harga || 0;\r\n\r\n      // 4. Validasi amount untuk midtrans\r\n      let finalAmount = harga;\r\n      if (payment_method === 'midtrans') {\r\n        if (!amount || isNaN(parseFloat(amount))) {\r\n          throw new Error('Jumlah pembayaran tidak valid.');\r\n        }\r\n        finalAmount = parseFloat(amount);\r\n      }\r\n\r\n      // 5. Buat data reservasi baru dengan payment info\r\n      const dataReservasi = {\r\n        id_user: id_user,\r\n        id_arena: id_arena,\r\n        id_jadwal: id_jadwal,\r\n        status: 'menunggu',\r\n        payment_method: payment_method,\r\n        payment_status: payment_method === 'cod' ? 'pending' : 'unpaid',\r\n        amount: finalAmount\r\n      };\r\n\r\n      const result = await Model_Reservasi.Store(dataReservasi);\r\n      const id_reservasi = result.insertId;\r\n\r\n      // 6. Buat record pembayaran\r\n      const dataPembayaran = {\r\n        id_reservasi: id_reservasi,\r\n        metode_pembayaran: payment_method,\r\n        status_pembayaran: payment_method === 'cod' ? 'pending' : 'unpaid',\r\n        jumlah: finalAmount,\r\n        tanggal_pembayaran: new Date(),\r\n        bukti_pembayaran: null, // Untuk COD tidak ada bukti pembayaran\r\n        catatan_admin: null,\r\n        konfirmasi_admin: false\r\n      };\r\n      await Model_Pembayaran.Store(dataPembayaran);\r\n\r\n      // 7. UPDATE status slot jadwal menjadi 'menunggu'\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'menunggu' });\r\n\r\n      // Commit transaction\r\n      await new Promise((resolve, reject) => {\r\n        connection.commit(err => {\r\n          if (err) reject(err);\r\n          else resolve();\r\n        });\r\n      });\r\n\r\n      // 8. Berhasil! Arahkan ke halaman profil\r\n      const successMsg = payment_method === 'cod'\r\n        ? 'Booking COD berhasil! Menunggu konfirmasi Admin.'\r\n        : 'Booking berhasil! Silakan selesaikan pembayaran.';\r\n      req.flash('success_msg', successMsg);\r\n      res.redirect('/pemain/profile');\r\n\r\n    } catch (innerErr) {\r\n      // Rollback transaction\r\n      await new Promise((resolve, reject) => {\r\n        connection.rollback(err => {\r\n          if (err) reject(err);\r\n          else resolve();\r\n        });\r\n      });\r\n      throw innerErr;\r\n    }\r\n\r\n  } catch (err) {\r\n    console.error('Booking error:', err);\r\n    const errorMsg = err.message || 'Maaf, terjadi kesalahan saat melakukan booking.';\r\n    req.flash('error_msg', errorMsg);\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}