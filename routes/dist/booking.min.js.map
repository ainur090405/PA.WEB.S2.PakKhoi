{"version":3,"sources":["booking.js"],"names":["express","require","router","Router","Model_Jadwal","Model_Arena","post","req","res","connection","_req$body","id_jadwal","payment_method","amount","id_user","jadwalData","id_arena","arenaData","harga","finalAmount","dataReservasi","result","id_reservasi","successMsg","errorMsg","regeneratorRuntime","async","_context","prev","next","body","user","session","id","flash","abrupt","redirect","awrap","Promise","resolve","reject","err","query","rows","sent","length","Error","status_slot","beginTransaction","getById","parseFloat","status","catatan","Model_Reservasi","Store","insertId","Model_Pembayaran","createCODByReservasi","metode_pembayaran","status_pembayaran","jumlah","tanggal_pembayaran","Date","status_bukti","created_at","updated_at","Update","commit","concat","t0","rollback","t1","message","stop","module","exports"],"mappings":"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","file":"booking.min.js","sourcesContent":["// routes/booking.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Arena = require('../models/Model_Arena');\r\n\r\nrouter.post('/create', async (req, res) => {\r\n  const connection = require('../config/database');\r\n\r\n  try {\r\n    const { id_jadwal, payment_method, amount } = req.body;\r\n    const id_user = req.session.user ? req.session.user.id : null;\r\n\r\n    if (!id_user) {\r\n      req.flash('error_msg', 'Anda harus login untuk melakukan booking.');\r\n      return res.redirect('/auth/login');\r\n    }\r\n\r\n    if (!id_jadwal || !payment_method) {\r\n      req.flash('error_msg', 'Data booking tidak lengkap.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    if (payment_method !== 'transaksi' && payment_method !== 'cod') {\r\n      req.flash('error_msg', 'Metode pembayaran tidak valid.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    // mulai transaksi\r\n    await new Promise((resolve, reject) => {\r\n      connection.beginTransaction(err => (err ? reject(err) : resolve()));\r\n    });\r\n\r\n    try {\r\n      // 1. lock jadwal\r\n      const jadwalData = await new Promise((resolve, reject) => {\r\n        connection.query(\r\n          'SELECT * FROM jadwal WHERE id_jadwal = ? FOR UPDATE',\r\n          [id_jadwal],\r\n          (err, rows) => (err ? reject(err) : resolve(rows))\r\n        );\r\n      });\r\n\r\n      if (!jadwalData || jadwalData.length === 0) {\r\n        throw new Error('Jadwal tidak ditemukan.');\r\n      }\r\n\r\n      if (jadwalData[0].status_slot !== 'kosong') {\r\n        throw new Error('Maaf, slot ini sudah dipesan atau sedang menunggu konfirmasi.');\r\n      }\r\n\r\n      const id_arena = jadwalData[0].id_arena;\r\n\r\n      // 2. ambil harga arena\r\n      const arenaData = await Model_Arena.getById(id_arena);\r\n      if (!arenaData || arenaData.length === 0) {\r\n        throw new Error('Arena tidak ditemukan.');\r\n      }\r\n      const harga = arenaData[0].harga || 0;\r\n\r\n      // 3. hitung amount\r\n      let finalAmount = harga;\r\n      if (payment_method === 'transaksi') {\r\n        if (!amount || isNaN(parseFloat(amount))) {\r\n          throw new Error('Jumlah pembayaran tidak valid.');\r\n        }\r\n        finalAmount = parseFloat(amount);\r\n      }\r\n\r\n      // 4. simpan reservasi (tanpa field pembayaran)\r\n      const dataReservasi = {\r\n        id_user,\r\n        id_arena,\r\n        id_jadwal,\r\n        status: 'menunggu',   // menunggu konfirmasi / pembayaran\r\n        catatan: null\r\n      };\r\n      const result = await Model_Reservasi.Store(dataReservasi);\r\n      const id_reservasi = result.insertId;\r\n\r\n      // 5. buat record pembayaran\r\n      if (payment_method === 'cod') {\r\n        // COD -> belum dibayar\r\n        await Model_Pembayaran.createCODByReservasi(id_reservasi, finalAmount);\r\n      } else {\r\n        // Transfer (transaksi) -> status 'unpaid'\r\n        await Model_Pembayaran.Store({\r\n          id_reservasi,\r\n          metode_pembayaran: 'transaksi',\r\n          status_pembayaran: 'unpaid',\r\n          jumlah: finalAmount,\r\n          tanggal_pembayaran: new Date(),\r\n          status_bukti: 'pending',\r\n          konfirmasi_admin: false,\r\n          created_at: new Date(),\r\n          updated_at: new Date()\r\n        });\r\n      }\r\n\r\n// 7. UPDATE status slot jadwal menjadi 'menunggu'\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'menunggu' });\r\n\r\n        // Commit transaction\r\n        await new Promise((resolve, reject) => {\r\n          connection.commit(err => {\r\n            if (err) reject(err);\r\n            else resolve();\r\n          });\r\n        });\r\n\r\n        // 8. Berhasil! Arahkan ke halaman DETAIL VENUE, bukan profil\r\n        const successMsg = payment_method === 'cod'\r\n          ? 'Booking COD berhasil! Menunggu konfirmasi Admin.'\r\n          : 'Booking berhasil! Silakan selesaikan pembayaran.';\r\n\r\n        req.flash('success_msg', successMsg);\r\n\r\n// id_arena sudah kita ambil sebelumnya dari tabel jadwal\r\nreturn res.redirect(`/venues/detail/${id_arena}`);\r\n\r\n    } catch (innerErr) {\r\n      await new Promise((resolve, reject) => {\r\n        connection.rollback(err => (err ? reject(err) : resolve()));\r\n      });\r\n      throw innerErr;\r\n    }\r\n  } catch (err) {\r\n    console.error('Booking error:', err);\r\n    const errorMsg = err.message || 'Maaf, terjadi kesalahan saat melakukan booking.';\r\n    req.flash('error_msg', errorMsg);\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}