{"version":3,"sources":["ulasan.js"],"names":["express","require","router","Router","Model_Reservasi","use","isAuthenticated","isPemain","get","req","res","id_reservasi","userId","reservasiData","reservasi","regeneratorRuntime","async","_context","prev","next","session","user","id","awrap","getById","sent","length","flash","abrupt","redirect","id_user","status","Model_Ulasan","getByReservasi","render","title","t0","console","error","stop","post","_req$body","rating","komentar","dataUlasan","_context2","params","body","existingReview","parseInt","Store","ulasanData","ulasan","_context3","_req$body2","dataUpdate","_context4","Update","_context5","Delete","module","exports"],"mappings":"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","file":"ulasan.min.js","sourcesContent":["// routes/ulasan.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Ulasan = require('../models/Model_Ulasan');\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst { isAuthenticated, isPemain } = require('../middleware/authMiddleware');\r\n\r\n// Middleware untuk pemain yang login\r\nrouter.use(isAuthenticated, isPemain);\r\n\r\n// GET: Form tambah ulasan\r\nrouter.get('/create/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n\r\n    const reservasiData = await Model_Reservasi.getById(id_reservasi);\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const reservasi = reservasiData[0];\r\n    if (reservasi.id_user !== userId) {\r\n      req.flash('error_msg', 'Anda tidak memiliki akses ke reservasi ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    if (reservasi.status !== 'selesai') {\r\n      req.flash('error_msg', 'Anda hanya bisa memberikan ulasan untuk reservasi yang sudah selesai.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    // âœ… gunakan getByReservasi\r\n    const existingReview = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (existingReview.length > 0) {\r\n      req.flash('error_msg', 'Anda sudah memberikan ulasan untuk reservasi ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    res.render('pemain/ulasan/create', {\r\n      title: 'Beri Ulasan',\r\n      reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat halaman ulasan.');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\n// POST: Simpan ulasan\r\nrouter.post('/create/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    if (!rating || rating < 1 || rating > 5) {\r\n      req.flash('error_msg', 'Rating harus antara 1-5.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    const existingReview = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (existingReview.length > 0) {\r\n      req.flash('error_msg', 'Anda sudah memberikan ulasan untuk reservasi ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const dataUlasan = {\r\n      id_user: userId,\r\n      id_reservasi,\r\n      rating: parseInt(rating),\r\n      komentar: komentar || null\r\n    };\r\n\r\n    await Model_Ulasan.Store(dataUlasan);\r\n    req.flash('success_msg', 'Terima kasih atas ulasan Anda!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menyimpan ulasan.');\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\n// GET: Edit ulasan\r\nrouter.get('/edit/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n\r\n    const ulasanData = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (ulasanData.length === 0) {\r\n      req.flash('error_msg', 'Ulasan tidak ditemukan.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const ulasan = ulasanData[0];\r\n    if (ulasan.id_user !== userId) {\r\n      req.flash('error_msg', 'Anda tidak memiliki akses ke ulasan ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const reservasiData = await Model_Reservasi.getById(id_reservasi);\r\n    const reservasi = reservasiData[0];\r\n\r\n    res.render('pemain/ulasan/edit', {\r\n      title: 'Edit Ulasan',\r\n      ulasan,\r\n      reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat halaman edit ulasan.');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\n// POST: Update ulasan\r\nrouter.post('/update/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    if (!rating || rating < 1 || rating > 5) {\r\n      req.flash('error_msg', 'Rating harus antara 1-5.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    const ulasanData = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (ulasanData.length === 0 || ulasanData[0].id_user !== userId) {\r\n      req.flash('error_msg', 'Ulasan tidak ditemukan atau Anda tidak memiliki akses.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const dataUpdate = {\r\n      rating: parseInt(rating),\r\n      komentar: komentar || null\r\n    };\r\n\r\n    await Model_Ulasan.Update(id_reservasi, dataUpdate);\r\n    req.flash('success_msg', 'Ulasan berhasil diperbarui!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui ulasan.');\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\n// POST: Hapus ulasan\r\nrouter.post('/delete/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n\r\n    const ulasanData = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (ulasanData.length === 0 || ulasanData[0].id_user !== userId) {\r\n      req.flash('error_msg', 'Ulasan tidak ditemukan atau Anda tidak memiliki akses.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    await Model_Ulasan.Delete(id_reservasi);\r\n    req.flash('success_msg', 'Ulasan berhasil dihapus.');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menghapus ulasan.');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}