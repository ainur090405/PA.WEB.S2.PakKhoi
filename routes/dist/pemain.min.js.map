{"version":3,"sources":["pemain.js"],"names":["express","require","router","Router","Model_Users","Model_Reservasi","Model_Ulasan","Model_Notifikasi","isAuthenticated","isPemain","use","isBusy","autoUpdateStatus","regeneratorRuntime","async","_context","prev","next","abrupt","awrap","console","log","concat","Date","toISOString","t0","error","finish","stop","setInterval","req","res","flash","get","userId","_ref","_ref2","reservasiData","notifications","stats","_context2","session","user","id","all","getByUser","sent","_slicedToArray","totalBookings","length","activeBookings","filter","r","status","totalSpent","reduce","sum","amount","render","title","slice","redirect","_ref3","_ref4","userData","ulasanData","_context3","Promise","getById","ulasan","reservasi","post","id_user","id_reservasi","_req$body","rating","komentar","_context4","params","body","Store","recentBookings","_req$body2","_context5","UpdateByReservasi","module","exports"],"mappings":"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","file":"pemain.min.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Users = require('../models/Model_Users');\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Ulasan = require('../models/Model_Ulasan');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst { isAuthenticated, isPemain } = require('../middleware/authMiddleware');\r\n\r\nrouter.use(isAuthenticated, isPemain);\r\n\r\n// ========================\r\n// Auto Update Status Reservasi\r\n// ========================\r\nlet isBusy = false; // flag untuk mencegah bentrok update\r\n\r\nasync function autoUpdateStatus() {\r\n  if (isBusy) return; // skip kalau sedang jalan\r\n  isBusy = true;\r\n\r\n  try {\r\n    // ✅ Panggil fungsi di model\r\n    await Model_Reservasi.autoUpdateStatus();\r\n    console.log(`✅ Auto update status selesai - ${new Date().toISOString()}`);\r\n  } catch (err) {\r\n    console.error('❌ Gagal auto update status:', err);\r\n  } finally {\r\n    isBusy = false;\r\n  }\r\n}\r\n\r\n// Jalankan setiap 1 menit sekali\r\nsetInterval(autoUpdateStatus, 60 * 1000);\r\n\r\n// Middleware untuk mencegah request saat proses update berlangsung\r\nrouter.use((req, res, next) => {\r\n  if (isBusy) {\r\n    req.flash('error_msg', 'Server sedang sibuk, silakan coba lagi beberapa saat.');\r\n    return res.redirect('back');\r\n  }\r\n  next();\r\n});\r\n\r\n// ========================\r\n// Dashboard Pemain\r\n// ========================\r\nrouter.get('/dashboard', async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id;\r\n\r\n    const [reservasiData, notifications] = await Promise.all([\r\n      Model_Reservasi.getByUser(userId),\r\n      Model_Notifikasi.getByUser(userId)\r\n    ]);\r\n\r\n    const stats = {\r\n      totalBookings: reservasiData.length,\r\n      activeBookings: reservasiData.filter(r => r.status === 'disetujui' || r.status === 'menunggu').length,\r\n      totalSpent: reservasiData.reduce((sum, r) => sum + (r.amount || 0), 0)\r\n    };\r\n\r\n    res.render('pemain/dashboard', {\r\n      title: 'Dashboard Pemain',\r\n      stats,\r\n      recentBookings: reservasiData.slice(0, 5),\r\n      notifications\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat dashboard.');\r\n    res.redirect('/');\r\n  }\r\n});\r\n\r\n// ========================\r\n// Halaman Profil\r\n// ========================\r\nrouter.get('/profile', async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id;\r\n\r\n    const [userData, ulasanData, reservasiData] = await Promise.all([\r\n      Model_Users.getById(userId),\r\n      Model_Ulasan.getByUser(userId),\r\n      Model_Reservasi.getByUser(userId)\r\n    ]);\r\n\r\n    if (userData.length === 0) {\r\n      req.flash('error_msg', 'User tidak ditemukan.');\r\n      return res.redirect('/pemain/dashboard');\r\n    }\r\n\r\n    res.render('pemain/profile', {\r\n      title: 'Profil Saya',\r\n      user: userData[0],\r\n      ulasan: ulasanData,\r\n      reservasi: reservasiData\r\n    });\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat halaman profil.');\r\n    res.redirect('/pemain/dashboard');\r\n  }\r\n});\r\n\r\n// ========================\r\n// Tambah Ulasan\r\n// ========================\r\nrouter.post('/ulasan/create/:id', async (req, res) => {\r\n  try {\r\n    const id_user = req.session.user.id;\r\n    const id_reservasi = req.params.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    await Model_Ulasan.Store({\r\n      id_user,\r\n      id_reservasi,\r\n      rating,\r\n      komentar\r\n    });\r\n\r\n    req.flash('success_msg', 'Ulasan berhasil disimpan!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menyimpan ulasan');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\n// ========================\r\n// Update Ulasan\r\n// ========================\r\nrouter.post('/ulasan/update/:id', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    await Model_Ulasan.UpdateByReservasi(id_reservasi, { rating, komentar });\r\n\r\n    req.flash('success_msg', 'Ulasan berhasil diperbarui!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui ulasan');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}