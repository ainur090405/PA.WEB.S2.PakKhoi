{"version":3,"sources":["booking_new.js"],"names":["express","require","router","Router","Model_Reservasi","Model_Jadwal","Model_Pembayaran","Model_Arena","post","req","res","body","id_jadwal","payment_method","amount","id_user","session","user","id","getById","jadwalData","length","Error","status_slot","flash","redirect","id_arena","arenaData","harga","dataReservasi","status","payment_status","parseFloat","Store","result","id_reservasi","insertId","dataPembayaran","metode_pembayaran","status_pembayaran","jumlah","Update","console","error","module","exports"],"mappings":"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","sourcesContent":["// routes/booking.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Arena = require('../models/Model_Arena');\r\n\r\n// Rute ini HANYA bisa diakses jika sudah login\r\n// (karena akan kita kunci di app.js)\r\n\r\nrouter.post('/create', async (req, res) => {\r\n  try {\r\n    const { id_jadwal, payment_method, amount } = req.body;\r\n    const id_user = req.session.user.id; // Ambil ID dari session\r\n\r\n    // 1. Ambil info jadwal untuk dapat id_arena\r\n    const jadwalData = await Model_Jadwal.getById(id_jadwal);\r\n    if (jadwalData.length === 0) {\r\n      throw new Error('Jadwal tidak ditemukan atau sudah dipesan.');\r\n    }\r\n\r\n    // 2. Pastikan slot masih kosong (double check)\r\n    if (jadwalData[0].status_slot !== 'kosong') {\r\n       req.flash('error_msg', 'Maaf, slot ini baru saja dipesan orang lain.');\r\n       return res.redirect('back');\r\n    }\r\n\r\n    const id_arena = jadwalData[0].id_arena;\r\n\r\n    // 3. Ambil harga arena\r\n    const arenaData = await Model_Arena.getById(id_arena);\r\n    const harga = arenaData[0].harga || 0;\r\n\r\n    // 4. Buat data reservasi baru dengan payment info\r\n    const dataReservasi = {\r\n      id_user: id_user,\r\n      id_arena: id_arena,\r\n      id_jadwal: id_jadwal,\r\n      status: 'menunggu', // Status awal\r\n      payment_method: payment_method,\r\n      payment_status: payment_method === 'cod' ? 'pending' : 'unpaid', // COD pending, Midtrans unpaid\r\n      amount: payment_method === 'midtrans' ? parseFloat(amount) : harga // Use provided amount for midtrans, arena price for COD\r\n    };\r\n\r\n    // Pastikan Model_Reservasi punya fungsi Store\r\n    const result = await Model_Reservasi.Store(dataReservasi);\r\n    const id_reservasi = result.insertId;\r\n\r\n    // 5. Buat record pembayaran\r\n    const dataPembayaran = {\r\n      id_reservasi: id_reservasi,\r\n      metode_pembayaran: payment_method,\r\n      status_pembayaran: payment_method === 'cod' ? 'pending' : 'unpaid',\r\n      jumlah: dataReservasi.amount\r\n    };\r\n    await Model_Pembayaran.Store(dataPembayaran);\r\n\r\n    // 6. UPDATE status slot jadwal menjadi 'terisi'\r\n    // Pastikan Model_Jadwal punya fungsi Update\r\n    await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n\r\n    // 7. Berhasil! Arahkan ke halaman profil\r\n    req.flash('success_msg', 'Booking berhasil! Menunggu konfirmasi Admin.');\r\n    res.redirect('/pemain/profile'); // Arahkan ke riwayat pemesanan\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Maaf, terjadi kesalahan saat melakukan booking.');\r\n    res.redirect('back'); // Kembali ke halaman detail arena\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"booking_new.dev.js"}