{"version":3,"sources":["ulasan.js"],"names":["express","require","router","Router","Model_Ulasan","Model_Reservasi","isAuthenticated","isPemain","use","get","req","res","id_reservasi","params","userId","session","user","id","getById","reservasiData","length","flash","redirect","reservasi","id_user","status","getByReservasi","existingReview","render","title","console","error","post","body","rating","komentar","dataUlasan","parseInt","Store","ulasanData","ulasan","dataUpdate","Update","Delete","module","exports"],"mappings":"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","sourcesContent":["// routes/ulasan.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Ulasan = require('../models/Model_Ulasan');\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst { isAuthenticated, isPemain } = require('../middleware/authMiddleware');\r\n\r\n// Middleware untuk pemain yang login\r\nrouter.use(isAuthenticated, isPemain);\r\n\r\n// GET: Form tambah ulasan\r\nrouter.get('/create/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n\r\n    const reservasiData = await Model_Reservasi.getById(id_reservasi);\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const reservasi = reservasiData[0];\r\n    if (reservasi.id_user !== userId) {\r\n      req.flash('error_msg', 'Anda tidak memiliki akses ke reservasi ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    if (reservasi.status !== 'selesai') {\r\n      req.flash('error_msg', 'Anda hanya bisa memberikan ulasan untuk reservasi yang sudah selesai.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    // âœ… gunakan getByReservasi\r\n    const existingReview = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (existingReview.length > 0) {\r\n      req.flash('error_msg', 'Anda sudah memberikan ulasan untuk reservasi ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    res.render('pemain/ulasan/create', {\r\n      title: 'Beri Ulasan',\r\n      reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat halaman ulasan.');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\n// POST: Simpan ulasan\r\nrouter.post('/create/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    if (!rating || rating < 1 || rating > 5) {\r\n      req.flash('error_msg', 'Rating harus antara 1-5.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    const existingReview = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (existingReview.length > 0) {\r\n      req.flash('error_msg', 'Anda sudah memberikan ulasan untuk reservasi ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const dataUlasan = {\r\n      id_user: userId,\r\n      id_reservasi,\r\n      rating: parseInt(rating),\r\n      komentar: komentar || null\r\n    };\r\n\r\n    await Model_Ulasan.Store(dataUlasan);\r\n    req.flash('success_msg', 'Terima kasih atas ulasan Anda!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menyimpan ulasan.');\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\n// GET: Edit ulasan\r\nrouter.get('/edit/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n\r\n    const ulasanData = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (ulasanData.length === 0) {\r\n      req.flash('error_msg', 'Ulasan tidak ditemukan.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const ulasan = ulasanData[0];\r\n    if (ulasan.id_user !== userId) {\r\n      req.flash('error_msg', 'Anda tidak memiliki akses ke ulasan ini.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const reservasiData = await Model_Reservasi.getById(id_reservasi);\r\n    const reservasi = reservasiData[0];\r\n\r\n    res.render('pemain/ulasan/edit', {\r\n      title: 'Edit Ulasan',\r\n      ulasan,\r\n      reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat halaman edit ulasan.');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\n// POST: Update ulasan\r\nrouter.post('/update/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    if (!rating || rating < 1 || rating > 5) {\r\n      req.flash('error_msg', 'Rating harus antara 1-5.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    const ulasanData = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (ulasanData.length === 0 || ulasanData[0].id_user !== userId) {\r\n      req.flash('error_msg', 'Ulasan tidak ditemukan atau Anda tidak memiliki akses.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    const dataUpdate = {\r\n      rating: parseInt(rating),\r\n      komentar: komentar || null\r\n    };\r\n\r\n    await Model_Ulasan.Update(id_reservasi, dataUpdate);\r\n    req.flash('success_msg', 'Ulasan berhasil diperbarui!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui ulasan.');\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\n// POST: Hapus ulasan\r\nrouter.post('/delete/:id_reservasi', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id_reservasi;\r\n    const userId = req.session.user.id;\r\n\r\n    const ulasanData = await Model_Ulasan.getByReservasi(id_reservasi);\r\n    if (ulasanData.length === 0 || ulasanData[0].id_user !== userId) {\r\n      req.flash('error_msg', 'Ulasan tidak ditemukan atau Anda tidak memiliki akses.');\r\n      return res.redirect('/pemain/profile');\r\n    }\r\n\r\n    await Model_Ulasan.Delete(id_reservasi);\r\n    req.flash('success_msg', 'Ulasan berhasil dihapus.');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menghapus ulasan.');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"ulasan.dev.js"}