{"version":3,"sources":["reservasi.js"],"names":["express","require","router","Router","Model_Pembayaran","use","isAuthenticated","isAdmin","get","req","res","getAll","render","title","data","console","error","_context","t0","flash","redirect","id","reservasiData","regeneratorRuntime","async","_context2","prev","next","params","awrap","Model_Reservasi","getById","reservasi","sent","length","abrupt","stop","post","id_reservasi","status","id_jadwal","_context3","body","rejectAndFreeSlot","Update","Model_Jadwal","status_slot","concat","_req$body","catatan","dataToUpdate","_Model_Jadwal","Model_Notifikasi","notif","_context4","id_user","judul","toUpperCase","isi_pesan","nama_arena","jenis_notif","tipe","dibaca","message","_context5","Delete","code","csv","_context6","forEach","r","nama_user","Date","tanggal","toLocaleDateString","jam_mulai","substring","tanggal_pesan","payment_method","amount","header","module","exports"],"mappings":"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","file":"reservasi.min.js","sourcesContent":["// routes/reservasi.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Tampilkan daftar reservasi\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    res.render('admin/reservasi/index', {\r\n      title: 'Manajemen Reservasi',\r\n      data: reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err); // Tampilkan error di console\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: Form edit reservasi (untuk ubah status)\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    const reservasiData = await Model_Reservasi.getById(id);\r\n\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/reservasi');\r\n    }\r\n\r\n    res.render('admin/reservasi/edit', {\r\n      title: 'Update Status Reservasi',\r\n      reservasi: reservasiData[0]\r\n    });\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\nrouter.post('/update-status/:id', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id;\r\n    const { status } = req.body;\r\n\r\n    if (status === 'ditolak') {\r\n      // âœ… Gunakan fungsi otomatis tolak + kosongkan slot\r\n      await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n    } else {\r\n      // Untuk status lain (disetujui, menunggu, dsb)\r\n      await Model_Reservasi.Update(id_reservasi, { status });\r\n\r\n      // Sinkronkan status slot manual\r\n      const reservasi = await Model_Reservasi.getById(id_reservasi);\r\n      const id_jadwal = reservasi[0].id_jadwal;\r\n\r\n      if (status === 'disetujui') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n      } else if (status === 'batal') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', `Status reservasi berhasil diperbarui menjadi ${status}`);\r\n    res.redirect('/reservasi');\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui status reservasi');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n\r\n// POST: Update reservasi\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  try {\r\n    const { status, catatan } = req.body;\r\n    const dataToUpdate = { status, catatan };\r\n\r\n    const reservasiData = await Model_Reservasi.getById(id);\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n\r\n    const id_jadwal = reservasiData[0].id_jadwal;\r\n    const Model_Jadwal = require('../models/Model_Jadwal');\r\n    const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n\r\n    // ðŸ”¹ Update status reservasi\r\n    await Model_Reservasi.Update(id, dataToUpdate);\r\n\r\n    // ðŸ”¹ Sinkronisasi status jadwal\r\n    if (status === 'disetujui') {\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n    } \r\n    else if (status === 'ditolak' || status === 'batal') {\r\n      // kalau ditolak atau dibatalkan, buka lagi slotnya\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n    } \r\n    else if (status === 'selesai') {\r\n      // biarkan tetap terisi, karena sudah main\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n    }\r\n\r\n    // ðŸ”¹ Kirim notifikasi ke pemain\r\n    if (reservasiData[0].id_user) {\r\n      const notif = {\r\n        id_user: reservasiData[0].id_user,\r\n        judul: `Status Booking: ${status.toUpperCase()}`,\r\n        isi_pesan:\r\n          status === 'disetujui' ? \r\n            `Booking Anda untuk arena ${reservasiData[0].nama_arena} telah disetujui.` :\r\n          status === 'ditolak' ?\r\n            `Maaf, booking Anda untuk arena ${reservasiData[0].nama_arena} ditolak.` :\r\n          status === 'selesai' ?\r\n            `Terima kasih telah bermain di ${reservasiData[0].nama_arena}.` :\r\n            `Status booking Anda telah berubah menjadi ${status}.`,\r\n        jenis_notif: 'status',\r\n        tipe: 'booking',\r\n        dibaca: 0\r\n      };\r\n      await Model_Notifikasi.Store(notif);\r\n    }\r\n\r\n    req.flash('success_msg', 'Status reservasi berhasil diperbarui.');\r\n    res.redirect('/admin/reservasi');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui reservasi: ' + err.message);\r\n    res.redirect('/admin/reservasi/edit/' + id);\r\n  }\r\n});\r\n\r\n\r\n// GET: Hapus reservasi\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  try {\r\n    await Model_Reservasi.Delete(req.params.id);\r\n    req.flash('success_msg', 'Data reservasi berhasil dihapus.');\r\n    res.redirect('/reservasi');\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal menghapus reservasi: ' + err.code);\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n// GET: Download reservasi data as CSV\r\nrouter.get('/download', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    let csv = 'ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Pembayaran,Jumlah\\n';\r\n\r\n    reservasi.forEach(r => {\r\n      csv += `${r.id_reservasi},${r.nama_user},${r.nama_arena},${new Date(r.tanggal).toLocaleDateString('id-ID')},${r.jam_mulai.substring(0,5)},${new Date(r.tanggal_pesan).toLocaleDateString('id-ID')},${r.status},${r.payment_method || ''},${r.amount || 0}\\n`;\r\n    });\r\n\r\n    res.header('Content-Type', 'text/csv');\r\n    res.attachment('reservasi.csv');\r\n    res.send(csv);\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal mendownload data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}