{"version":3,"sources":["reservasi.js"],"names":["express","require","router","Router","Model_Reservasi","Model_Notifikasi","isAuthenticated","isAdmin","req","res","getAll","reservasi","render","title","data","error","flash","redirect","get","id","rows","logs","regeneratorRuntime","async","_context2","prev","next","parseInt","params","awrap","getById","sent","length","abrupt","getByReservasi","console","t0","warn","t1","stop","post","id_reservasi","status","rowsBefore","reservasiBefore","status_awal","r","id_jadwal","_rows","_r","notif","_context3","body","rejectAndFreeSlot","Update","Model_Jadwal","status_slot","Model_LogReservasi","catatStatus","id_user","judul","concat","toUpperCase","isi_pesan","nama_arena","tipe","dibaca","Store","t2","_req$body","catatan","dataToUpdate","_context4","jenis_notif","message","_context5","Delete","code","csv","_context6","forEach","tanggal","Date","toLocaleDateString","jam","jam_mulai","substring","tanggalPesan","tanggal_pesan","metode","metode_pembayaran","statusPemb","status_pembayaran","jumlah","bukti","pembayaran_bukti","nama_user","replace","tanggalMain","header","attachment","send","module","exports"],"mappings":"aACA,IAAMA,QAAUC,QAAQ,WADxBC,OAAAF,QAAAG,SAIMC,gBAAkBH,QAAQ,6BAF1BC,aAAiBC,QAAvB,0BAIME,iBAAmBJ,QAAQ,8BAF3BG,mBAAkBH,QAAQ,yCAIKA,QAAQ,gCAArCK,yBAAAA,gBAAiBC,iBAAAA,QAFzBL,OAAMG,IAAAA,gBAAmBJ,SAUzBC,OARQI,IAAAA,IAAAA,SAQeE,EAAKC,GARpBH,IAAAA,EAAAA,OAAAA,mBAAAA,MAAAA,SAAAA,GAAAA,OAAAA,OAAAA,EAAAA,KAAAA,EAAAA,MAAAA,KAAAA,EAAAA,OAAAA,EAAAA,KAAAA,EAAAA,EAAAA,KAAAA,EAAAA,mBAAAA,MAUoBF,gBAAgBM,UAVpCJ,KAAAA,EAUEK,EAVFL,EAAAA,KAWJG,EAAIG,OAAO,wBAAyB,CARlCC,MAAKP,sBAGXQ,KAAAH,IANQL,EAAAA,KAAAA,GAAAA,MAAAA,KAAAA,EAAAA,OAAAA,EAAAA,KAAAA,EAAAA,EAAAA,GAAAA,EAAAA,MAAAA,GAQRJ,QAAWa,MAAK,4BAAhBb,EAAAA,IAAgBM,EAAAQ,MAAA,YAAA,gCARRV,EAAAA,OAAAA,SAQQG,EAAAQ,SAAA,qBARRX,KAAAA,GAAAA,IAAAA,MAAAA,OAAAA,EAAAA,SAAAA,KAAAA,KAAAA,CAAAA,CAAAA,EAAAA,OAQQJ,OAAAgB,IAAA,YAAA,SAAAV,EAAAC,GAAA,IAAAU,EAAAC,EAAAT,EAAAU,EAAA,OAAAC,mBAAAC,MAAA,SAAAC,GAAA,OAAA,OAAAA,EAAAC,KAAAD,EAAAE,MAAA,KAAA,EAAA,OAAAF,EAAAC,KAAA,EAiBNN,EAAKQ,SAASnB,EAAIoB,OAAOT,GAAI,IAjBvBK,EAAAE,KAAA,EAAAJ,mBAAAO,MAAAzB,gBAAA0B,QAAAX,IAAA,KAAA,EAAA,IAENR,EAFMa,EAAAO,OAGD,IAAPnB,EAAOoB,OAHC,CAAAR,EAAAE,KAAA,EAAA,MAAA,OAIVb,EAAAA,MAAAA,YAAO,mCAJGW,EAAAS,OAAA,SAKVnB,EAAIG,SAAEN,qBALI,KAAA,EAAA,OAAAA,EAAAS,EAAA,GAAAC,EAAA,GAAAG,EAAAC,KAAA,GAAAD,EAAAE,KAAA,GAAAJ,mBAAAO,MAQJd,mBAAMmB,eAAdf,IARY,KAAA,GAQZgB,EARYX,EAAAO,KAAAP,EAAAE,KAAA,GAAA,MAAA,KAAA,GAAAF,EAAAC,KAAA,GAAAD,EAAAY,GAAAZ,EAAA,MAAA,IAAAW,QAAAE,KAAA,iCAAAb,EAAAY,IAAA,KAAA,GAAA3B,EAAAG,OAAA,uBAAA,CAAAC,MAAA,0BAAAF,UAAAA,EAAAU,KAAAA,IAAAG,EAAAE,KAAA,GAAA,MAAA,KAAA,GAAAF,EAAAC,KAAA,GAAAD,EAAAc,GAAAd,EAAA,MAAA,GAyCZW,QAAQpB,MAAM,iCAAdS,EAAAc,IA1BJpC,EAAOgB,MAAI,YAAa,gCAAAT,EAAAQ,SAAA,oBAfR,KAAA,GAAA,IAAA,MAAA,OAAAO,EAAAe,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,IAAA,CAAA,GAAA,QAeQrC,OAAAsC,KAAA,qBAAA,SAAAhC,EAAAC,GAAA,IAAAgC,EAAAC,EAAAC,EAAAC,EAAAC,EAAAC,EAAA1B,EAAA2B,EAAAC,EAAAC,EAAAC,EAAA,OAAA5B,mBAAAC,MAAA,SAAA4B,GAAA,OAAA,OAAAA,EAAA1B,KAAA0B,EAAAzB,MAAA,KAAA,EAAA,OAAAyB,EAAA1B,KAAA,EAqCdgB,EAAejC,EAAIoB,OAAOT,GArCZuB,EAAAlC,EAAA4C,KAAAV,OAAAS,EAAAzB,KAAA,EAAAJ,mBAAAO,MAKHzB,gBALG0B,QAAAW,IAAA,KAAA,EAAA,IAAAE,EAAAQ,EAAApB,OAAA,IAAAY,EAAAX,OAAA,CAAAmB,EAAAzB,KAAA,EAAA,MAAA,OAAAlB,EAAAQ,MAAA,YAAA,8BAAAmC,EAAAlB,OAAA,SAAAxB,EAAAQ,SAAA,qBAAA,KAAA,EAAA,GAMlBT,EAAUmC,EAAa,GANLE,EAAAD,EAAAF,OAAA,YAahBrB,EAbgB,CAAA8B,EAAAzB,KAAA,GAAA,MAAA,GAAA,mBAAAtB,gBAAAiD,kBAAA,OAAAF,EAAAzB,KAAA,GAAAJ,mBAAAO,MAAAzB,gBAAAiD,kBAAAZ,IAAAU,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAAyB,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAA,OAAAyB,EAAAzB,KAAA,GAAAJ,mBAAAO,MAwDVzB,gBAAgBkD,OAAOb,EAAc,CAAEC,OAAQ,aAxDrC,KAAA,GAAA,OAAAS,EAAAzB,KAAA,GAAAJ,mBAAAO,MAAAzB,gBAAA0B,QAAAW,IAAA,KAAA,GAAA,IAAAK,EAAAK,EAAApB,OAAAe,EAAA,IAAAA,EAAA,GAAAC,UAAA,OAAAI,EAAAzB,KAAA,GAAAJ,mBAAAO,MAAA0B,aAAAD,OAAAR,EAAA,GAAAC,UAAA,CAAAS,YAAA,YAAAL,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAAyB,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAA,OAAAyB,EAAAzB,KAAA,GAAAJ,mBAAAO,MAAAzB,gBAAAkD,OAAAb,EAAA,CAAAC,OAAAA,KAAA,KAAA,GAAA,OAAAS,EAAAzB,KAAA,GAAAJ,mBAAAO,MAkECzB,gBAAgB0B,QAAQW,IAlEzB,KAAA,GAAA,KAkEZrB,EAlEY+B,EAAApB,QAAAX,EAAA,GAAA,CAAA+B,EAAAzB,KAAA,GAAA,MAAA,KAoBhBd,EAAOQ,EAAA,GAAA2B,WApBS,CAAAI,EAAAzB,KAAA,GAAA,MAAA,GAsBlBf,cAAAA,EAtBkB,OAAAwC,EAAAzB,KAAA,GAAAJ,mBAAAO,MAuBlBR,aAAOiC,OAAAP,EAAA,CAAAS,YAAA,YAvBWL,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAAyB,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAA,GAwEQ,UAAXgB,GAAiC,YAAXA,EAxEnB,OAAAS,EAAAzB,KAAA,GAAAJ,mBAAAO,MAoBpB0B,aAAAD,OAAAP,EAAA,CAAAS,YAAA,YApBoBL,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAAyB,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAA,GAAA,YAAAgB,EAAA,OAAAS,EAAAzB,KAAA,GAAAJ,mBAAAO,MAAA0B,aAAAD,OAAAP,EAAA,CAAAS,YAAA,YAAAL,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAA,OAAAyB,EAAA1B,KAAA,GAAA0B,EAAAzB,KAAA,GAAAJ,mBAAAO,MAmFZ4B,mBAAmBC,YAnFPjB,EAAAI,EAAAH,EAAA,2CAAA,KAAA,GAAAS,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAAyB,EAAA1B,KAAA,GAAA0B,EAAAf,GAAAe,EAAA,MAAA,IAgCxBhB,QAAAE,KAAA,gDAAAc,EAAAf,IAhCwB,KAAA,GAAA,OAAAe,EAAA1B,KAAA,GAAA0B,EAAAzB,KAAA,GAAAJ,mBAAAO,MAmCUzB,gBAAA0B,QAAAW,IAnCV,KAAA,GAAA,MAmCUrB,EAnCV+B,EAAApB,OAgGNX,EAAK,IAAMA,EAAK,GAAGuC,SAhGb,CAAAR,EAAAzB,KAAA,GAAA,MAAA,GAmCUoB,EAAA1B,EAAA,GAAA8B,EAAA,CAAAS,QAAAb,EAAAa,QAAAC,MAAA,mBAAAC,OAAAnB,EAAAoB,eAAAC,UAAA,cAExBtB,EAAAA,4BAAAA,OAGNK,EAAAkB,WAHMvB,qBAmEiB,YAAXC,EAAA,kCAAAmB,OArEkBf,EAAAkB,WAqElB,aArEkB,YAAAtB,EAAA,iCAAAmB,OAwEef,EAAEkB,WAxEjB,KAAA,6CAAAH,OAAAnB,EAAA,KAMxBC,YANwB,SA2ExBsB,KAAM,UA3EkBC,OAOzBvB,GAPyB,mBAAAtC,iBAAA8D,MAnCV,OAAAhB,EAAAzB,KAAA,GAAAJ,mBAAAO,MAmCUxB,iBAAA8D,MAAAjB,IAnCVC,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAAyB,EAAAzB,KAAA,GAAA,MAAA,KAAA,GAAAyB,EAAA1B,KAAA,GAAA0B,EAAAb,GAAAa,EAAA,MAAA,IAsHlBhB,QAAQE,KAAK,yCAAbc,EAAAb,IAtHkB,KAAA,GAAA,OA+CdO,EAAAA,MAAAA,cAAAA,gDAAAA,OAENH,EAFMG,MA/CcM,EAAAlB,OAAA,SAkDpBxB,EAAAQ,SAAA,qBAlDoB,KAAA,GAAA,OAAAkC,EAAA1B,KAAA,GAAA0B,EAAAiB,GAAAjB,EAAA,MAAA,GAmCUhB,QAAApB,MAiB1B2B,2CAjB0BS,EAAAiB,IAAA5D,EAAAQ,MAAA,YAAA,uCAnCVmC,EAAAlB,OAAA,SAmCUxB,EAAAQ,SAAA,qBAnCV,KAAA,GAAA,IAAA,MAAA,OAAAkC,EAAAZ,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,IAAA,CAAA,GAAA,IAAA,CAAA,GAAA,QAsIxBrC,OAAOsC,KAAK,cAAe,SAAOhC,EAAKC,GAAZ,IAAAU,EAAAkD,EAAA3B,EAAA4B,EAAAC,EAAAnD,EAAA0B,EAAAD,EAAAE,EAAAG,EAAA,OAAA5B,mBAAAC,MAAA,SAAAiD,GAAA,OAAA,OAAAA,EAAA/C,KAAA+C,EAAA9C,MAAA,KAAA,EAAA,OAnGOP,EAAAX,EAAAoB,OAAAT,GAmGPqD,EAAA/C,KAAA,EAAA4C,EAGK7D,EAAI4C,KAAxBV,EAHe2B,EAGf3B,OAAQ4B,EAHOD,EAGPC,QAtGcC,EAAA,CAAA7B,OAAAA,EAAA4B,QAAAA,GAmGPE,EAAA9C,KAAA,EAAAJ,mBAAAO,MAOJzB,gBAAgB0B,QAAQX,IAPpB,KAAA,EAAA,IAOjBC,EAPiBoD,EAAAzC,OAnGO,IAAAX,EAAAY,OAmGP,CAAAwC,EAAA9C,KAAA,GAAA,MAAA,OAnGOlB,EAAAQ,MAAA,YAAA,8BAmGPwD,EAAAvC,OAAA,SAnGOxB,EAAAQ,SAAA,qBAmGP,KAAA,GAAA,OA9EwB6B,EArBjB1B,EAAA,GAgHxByB,EAAcC,EAAEJ,OAhHQK,EAAAD,EAAAC,UAmGPyB,EAAA9C,KAAA,GAAAJ,mBAAAO,MAiBjBzB,gBAAgBkD,OAAOnC,EAAIoD,IAjBV,KAAA,GAAA,IAoBnBxB,EApBmB,CAAAyB,EAAA9C,KAAA,GAAA,MAAA,GA5EVoB,cAvBiBJ,EAmGP,OAAA8B,EAAA9C,KAAA,GAAAJ,mBAAAO,MAnGO0B,aAAAD,OAAAP,EAAA,CAAAS,YAAA,YAmGPgB,EAAA9C,KAAA,GAAA,MAAA,KAAA,GAAA8C,EAAA9C,KAAA,GAAA,MAAA,KAAA,GAAA,GAnGO,YAAAgB,GAAA,UAAAA,EAmGP,OAAA8B,EAAA9C,KAAA,GAAAJ,mBAAAO,MAnGO0B,aAAAD,OAAAP,EAAA,CAAAS,YAAA,YAmGPgB,EAAA9C,KAAA,GAAA,MAAA,KAAA,GAAA8C,EAAA9C,KAAA,GAAA,MAAA,KAAA,GAAA,GAyBC,YAAXgB,EAzBU,OAAA8B,EAAA9C,KAAA,GAAAJ,mBAAAO,MAnGO0B,aAAAD,OAAAP,EAAA,CAAAS,YAAA,YAmGPgB,EAAA9C,KAAA,GAAA,MAAA,KAAA,GAAA,OAAA8C,EAAA/C,KAAA,GAAA+C,EAAA9C,KAAA,GAAAJ,mBAAAO,MAnGO4B,mBAAAC,YAAAvC,EAqI1B0B,EArI0BH,EAAA4B,GAAA,OAmGP,KAAA,GAAAE,EAAA9C,KAAA,GAAA,MAAA,KAAA,GAAA8C,EAAA/C,KAAA,GAAA+C,EAAApC,GAAAoC,EAAA,MAAA,IAtEsBrC,QA7BfE,KAAA,8CA6BemC,EAAApC,IAsEtB,KAAA,GAAA,IAnGOU,EAAAa,QAmGP,CAAAa,EAAA9C,KAAA,GAAA,MAAA,GA4CfwB,EAAQ,CA/IcS,QAAAb,EAAAa,QA+BtBvC,MAAAA,mBAAAA,OA/BsBsB,EAAAoB,eAkJ1BC,UAlHM,cAhCoBrB,EAAA,4BAAAmB,OAAAf,EAAAkB,WAAA,qBAAA,YAAAtB,EAAA,kCAAAmB,OAAAf,EAAAkB,WAAA,aAuJT,YAAXtB,EAAA,iCAAAmB,OAvJoBf,EAAAkB,WAuJpB,KAAA,6CAAAH,OAE6CnB,EAF7C,KAvJoB+B,YAkCtB1B,SAlCsBkB,KAAA,UAAAC,OAAA,GA8JU,mBAA3B7D,iBAAiB8D,MA3DP,OAAAK,EAAA9C,KAAA,GAAAJ,mBAAAO,MAnGOxB,iBAmCT8D,MAAAjB,IAgEEsB,EAAA9C,KAAA,GAAA,MAAA,KAAA,GAAA,OAgEvBlB,EAAIQ,MAAM,cAAe,yCAhEFwD,EAAAvC,OAAA,SAnGOxB,EAAAQ,SAAA,qBAmGP,KAAA,GAAA,OAAAuD,EAAA/C,KAAA,GAAA+C,EAAAlC,GAAAkC,EAAA,MAAA,GA/DwBhB,QAAAA,MAAAA,oCAAAA,EAAAA,IAAFhD,EAAAQ,MApCf,YAAA,gCAAAwD,EAAAlC,GAAAoC,SAmGPF,EAAAvC,OAAA,SAqEhBxB,EAAIQ,SAAS,yBAA2BE,IArExB,KAAA,GAAA,IAAA,MAAA,OAAAqD,EAAAjC,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,IAAA,CAAA,GAAA,QAnGOrC,OAAAgB,IAAA,cAAA,SAAAV,EAAAC,GAAA,OAAAa,mBAAAC,MAAA,SAAAoD,GAAA,OAAA,OAAAA,EAAAlD,KAAAkD,EAAAjD,MAAA,KAAA,EAAA,OAAAiD,EAAAlD,KAAA,EAAAkD,EAAAjD,KAAA,EAAAJ,mBAAAO,MAAAzB,gBAAAwE,OAAApE,EAAAoB,OAAAT,KAAA,KAAA,EAAA,OAkL9BX,EAAIQ,MAAM,cAAe,oCAlLK2D,EAAA1C,OAAA,SAAAxB,EAAAQ,SAAA,qBAAA,KAAA,EAAA,OAAA0D,EAAAlD,KAAA,EAAAkD,EAAAvC,GAAAuC,EAAA,MAAA,GAsCiBnB,QAAAA,MAAAA,mCAAAA,EAAAA,IAAFhD,EAAAQ,MAtCf,YAAA,+BAAA2D,EAAAvC,GAAAsC,SAAAC,EAAAvC,GAAAyC,OAAAF,EAAA1C,OAAA,SAuLvBxB,EAAIQ,SAAS,qBAvLU,KAAA,GAAA,IAAA,MAAA,OAAA0D,EAAApC,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,OAAArC,OAAAgB,IAAA,YAAA,SAAAV,EAAAC,GAAA,IAAAE,EAAAmE,EAAA,OAAAxD,mBAAAC,MAAA,SAAAwD,GAAA,OAAA,OAAAA,EAAAtD,KAAAsD,EAAArD,MAAA,KAAA,EAAA,OAAAqD,EAAAtD,KAAA,EAAAsD,EAAArD,KAAA,EAAAJ,mBAAAO,MAAAzB,gBAAAM,UAAA,KAAA,EAAA,OAAAC,EAAAoE,EAAAhD,KAiM1B+C,EAAM,4GAjMoBnE,EAAAqE,QAAA,SAAAlC,GAwCiBU,IAAAA,EAAaV,EAAAmC,QAAA,IAAAC,KAAApC,EAAAmC,SAAAE,mBAAA,SAAA,GAxC9BC,EAAAtC,EAAAuC,UAAAvC,EAAAuC,UAAAC,UAAA,EAAA,GAAA,GAsMtBC,EAAezC,EAAE0C,cAAgB,IAAIN,KAAKpC,EAAE0C,eAAeL,mBAAmB,SAAW,GAtMnEM,EAAA3C,EAAA4C,mBAAA,GAAAC,EAAA7C,EAAA8C,mBAAA,GAAAC,EAAA/C,EAAA+C,QAAA,EA2MtBC,EAAQhD,EAAEiD,kBAAoB,GA3MRjB,GAAA,GAAAjB,OAAAf,EAAAL,aAAA,MAAAoB,QAAAf,EAAAkD,WAAA,IAAAC,QAAA,KAAA,MAAA,OAAApC,QAAAf,EAAAkB,YAAA,IAAAiC,QAAA,KAAA,MAAA,MAAApC,OAAAqC,EAAA,KAAArC,OAAAuB,EAAA,KAAAvB,OAAA0B,EAAA,KAAA1B,OAAAf,EAAAJ,QAAA,GAAA,KAAAmB,OAAA4B,EAAA,KAAA5B,OAAA8B,EAAA,KAAA9B,OAAAgC,EAAA,KAAAhC,OAAAiC,EAAA,QAAArF,EAAA0F,OAAA,eAAA,YAAA1F,EAAA2F,WAAA,iBAAArB,EAAA9C,OAAA,SAAAxB,EAAA4F,KAAAvB,IAAA,KAAA,GAAA,OAAAC,EAAAtD,KAAA,GAAAsD,EAAA3C,GAAA2C,EAAA,MAAA,GAoN9B5C,QAAQpB,MAAM,qCAAdgE,EAAA3C,IApN8B5B,EAAAQ,MAAA,YAAA,qCAAA+D,EAAA9C,OAAA,SAAAxB,EAAAQ,SAAA,qBAAA,KAAA,GAAA,IAAA,MAAA,OAAA8D,EAAAxC,SAAA,KAAA,KAAA,CAAA,CAAA,EAAA,QAAA+D,OAAAC,QAAArG","file":"reservasi.min.js","sourcesContent":["// routes/reservasi.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\n\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst Model_LogReservasi = require('../models/Model_LogReservasi'); \r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Semua route di sini khusus admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// ============================\r\n// LIST RESERVASI (ADMIN)\r\n// ============================\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    res.render('admin/reservasi/index', {\r\n      title: 'Manajemen Reservasi',\r\n      data: reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi:', err);\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    return res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: form edit reservasi\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = parseInt(req.params.id, 10);\r\n\r\n    const rows = await Model_Reservasi.getById(id);\r\n    if (!rows || rows.length === 0) {\r\n      req.flash('error_msg', 'Data reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n\r\n    const reservasi = rows[0];\r\n\r\n    // ⬇️ AMBIL RIWAYAT LOG UNTUK RESERVASI INI\r\n    let logs = [];\r\n    try {\r\n      logs = await Model_LogReservasi.getByReservasi(id);\r\n    } catch (logErr) {\r\n      console.warn('Gagal mengambil log reservasi:', logErr);\r\n    }\r\n\r\n    res.render('admin/reservasi/edit', {\r\n      title: 'Update Status Reservasi',\r\n      reservasi,\r\n      logs   // dikirim ke view (kalau mau dipakai)\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi/edit:', err);\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\n// ============================\r\n// UPDATE STATUS (SINGLE FIELD)\r\n// ============================\r\nrouter.post('/update-status/:id', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id;\r\n    const { status } = req.body;\r\n\r\n    // ⬇️ AMBIL STATUS AWAL UNTUK LOG\r\n    const rowsBefore = await Model_Reservasi.getById(id_reservasi);\r\n    if (!rowsBefore || rowsBefore.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n    const reservasiBefore = rowsBefore[0];\r\n    const status_awal = reservasiBefore.status;\r\n\r\n    // =======================\r\n    // LOGIKA LAMA (TIDAK DIUBAH)\r\n    // =======================\r\n    if (status === 'ditolak') {\r\n      if (typeof Model_Reservasi.rejectAndFreeSlot === 'function') {\r\n        await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n      } else {\r\n        await Model_Reservasi.Update(id_reservasi, { status: 'ditolak' });\r\n        const r = await Model_Reservasi.getById(id_reservasi);\r\n        if (r && r[0] && r[0].id_jadwal) {\r\n          await Model_Jadwal.Update(r[0].id_jadwal, { status_slot: 'kosong' });\r\n        }\r\n      }\r\n    } else {\r\n      // Status lain: cukup update status reservasi + sinkron jadwal\r\n      await Model_Reservasi.Update(id_reservasi, { status });\r\n\r\n      const rows = await Model_Reservasi.getById(id_reservasi);\r\n      if (rows && rows[0]) {\r\n        const id_jadwal = rows[0].id_jadwal;\r\n        if (id_jadwal) {\r\n          if (status === 'disetujui') {\r\n            await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n          } else if (status === 'batal' || status === 'ditolak') {\r\n            await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n          } else if (status === 'selesai') {\r\n            await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // ⬇️ CATAT LOG PERUBAHAN STATUS\r\n    try {\r\n      await Model_LogReservasi.catatStatus(\r\n        id_reservasi,\r\n        status_awal,\r\n        status,\r\n        'Update via tombol cepat /update-status'\r\n      );\r\n    } catch (logErr) {\r\n      console.warn('Gagal mencatat log reservasi (update-status):', logErr);\r\n    }\r\n\r\n    // Kirim notifikasi ke user (opsional)\r\n    try {\r\n      const rows = await Model_Reservasi.getById(id_reservasi);\r\n      if (rows && rows[0] && rows[0].id_user) {\r\n        const r = rows[0];\r\n        const notif = {\r\n          id_user: r.id_user,\r\n          judul: `Status Booking: ${status.toUpperCase()}`,\r\n          isi_pesan:\r\n            status === 'disetujui'\r\n              ? `Booking Anda untuk arena ${r.nama_arena} telah disetujui.`\r\n              : status === 'ditolak'\r\n              ? `Maaf, booking Anda untuk arena ${r.nama_arena} ditolak.`\r\n              : status === 'selesai'\r\n              ? `Terima kasih telah bermain di ${r.nama_arena}.`\r\n              : `Status booking Anda telah berubah menjadi ${status}.`,\r\n          jenis_notif: 'status',\r\n          tipe: 'booking',\r\n          dibaca: 0\r\n        };\r\n        if (typeof Model_Notifikasi.Store === 'function') {\r\n          await Model_Notifikasi.Store(notif);\r\n        }\r\n      }\r\n    } catch (notifErr) {\r\n      console.warn('Gagal kirim notifikasi (non blocking):', notifErr);\r\n    }\r\n\r\n    req.flash('success_msg', `Status reservasi berhasil diperbarui menjadi ${status}.`);\r\n    return res.redirect('/admin/reservasi');\r\n\r\n  } catch (err) {\r\n    console.error('ERR POST /admin/reservasi/update-status:', err);\r\n    req.flash('error_msg', 'Gagal memperbarui status reservasi.');\r\n    return res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\n// ============================\r\n// UPDATE FORM LENGKAP (STATUS + CATATAN)\r\n// ============================\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  try {\r\n    const { status, catatan } = req.body;\r\n    const dataToUpdate = { status, catatan };\r\n\r\n    // ⬇️ AMBIL DATA & STATUS AWAL UNTUK LOG\r\n    const rows = await Model_Reservasi.getById(id);\r\n    if (!rows || rows.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n    const r = rows[0];\r\n    const status_awal = r.status;\r\n    const id_jadwal = r.id_jadwal;\r\n\r\n    // Update status & catatan (LOGIKA LAMA)\r\n    await Model_Reservasi.Update(id, dataToUpdate);\r\n\r\n    // Sinkron jadwal (LOGIKA LAMA)\r\n    if (id_jadwal) {\r\n      if (status === 'disetujui') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n      } else if (status === 'ditolak' || status === 'batal') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n      } else if (status === 'selesai') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n      }\r\n    }\r\n\r\n    // ⬇️ CATAT LOG PERUBAHAN STATUS + CATATAN\r\n    try {\r\n      await Model_LogReservasi.catatStatus(\r\n        id,\r\n        status_awal,\r\n        status,\r\n        catatan || null\r\n      );\r\n    } catch (logErr) {\r\n      console.warn('Gagal mencatat log reservasi (update form):', logErr);\r\n    }\r\n\r\n    // Notifikasi opsional (LOGIKA LAMA)\r\n    if (r.id_user) {\r\n      const notif = {\r\n        id_user: r.id_user,\r\n        judul: `Status Booking: ${status.toUpperCase()}`,\r\n        isi_pesan:\r\n          status === 'disetujui'\r\n            ? `Booking Anda untuk arena ${r.nama_arena} telah disetujui.`\r\n            : status === 'ditolak'\r\n            ? `Maaf, booking Anda untuk arena ${r.nama_arena} ditolak.`\r\n            : status === 'selesai'\r\n            ? `Terima kasih telah bermain di ${r.nama_arena}.`\r\n            : `Status booking Anda telah berubah menjadi ${status}.`,\r\n        jenis_notif: 'status',\r\n        tipe: 'booking',\r\n        dibaca: 0\r\n      };\r\n      if (typeof Model_Notifikasi.Store === 'function') {\r\n        await Model_Notifikasi.Store(notif);\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', 'Status reservasi berhasil diperbarui.');\r\n    return res.redirect('/admin/reservasi');\r\n  } catch (err) {\r\n    console.error('ERR POST /admin/reservasi/update:', err);\r\n    req.flash('error_msg', 'Gagal memperbarui reservasi: ' + err.message);\r\n    return res.redirect('/admin/reservasi/edit/' + id);\r\n  }\r\n});\r\n\r\n// ============================\r\n// DELETE RESERVASI\r\n// ============================\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  try {\r\n    await Model_Reservasi.Delete(req.params.id);\r\n    req.flash('success_msg', 'Data reservasi berhasil dihapus.');\r\n    return res.redirect('/admin/reservasi');\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi/delete:', err);\r\n    req.flash('error_msg', 'Gagal menghapus reservasi: ' + (err.message || err.code));\r\n    return res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\n// ============================\r\n// DOWNLOAD CSV\r\n// ============================\r\nrouter.get('/download', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    let csv = 'ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Metode Pembayaran,Status Pembayaran,Jumlah,Bukti\\n';\r\n\r\n    reservasi.forEach(r => {\r\n      const tanggalMain = r.tanggal ? new Date(r.tanggal).toLocaleDateString('id-ID') : '';\r\n      const jam = r.jam_mulai ? r.jam_mulai.substring(0, 5) : '';\r\n      const tanggalPesan = r.tanggal_pesan ? new Date(r.tanggal_pesan).toLocaleDateString('id-ID') : '';\r\n\r\n      const metode = r.metode_pembayaran || '';          // dari join pembayaran\r\n      const statusPemb = r.status_pembayaran || '';\r\n      const jumlah = r.jumlah || 0;                       // alias di model\r\n      const bukti = r.pembayaran_bukti || '';\r\n\r\n      csv += `${r.id_reservasi},\"${(r.nama_user || '').replace(/\"/g,'\"\"')}\",\"${(r.nama_arena || '').replace(/\"/g,'\"\"')}\",${tanggalMain},${jam},${tanggalPesan},${r.status || ''},${metode},${statusPemb},${jumlah},${bukti}\\n`;\r\n    });\r\n\r\n    res.header('Content-Type', 'text/csv');\r\n    res.attachment('reservasi.csv');\r\n    return res.send(csv);\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi/download:', err);\r\n    req.flash('error_msg', 'Gagal mendownload data reservasi.');\r\n    return res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}