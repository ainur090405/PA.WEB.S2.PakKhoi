{"version":3,"sources":["reservasi_new.js"],"names":["express","require","router","Router","isAuthenticated","isAdmin","Model_Reservasi","req","res","getAll","reservasi","render","title","data","console","error","_context","t0","flash","redirect","get","id","reservasiData","regeneratorRuntime","async","_context2","prev","next","params","awrap","getById","sent","abrupt","stop","post","_req$body","status","catatan","dataToUpdate","Model_Notifikasi","notifData","_context3","body","Update","length","id_user","judul","nama_arena","tipe","dibaca","Store","code","_context4","Delete","csv","_context5","forEach","r","concat","id_reservasi","nama_user","Date","tanggal","toLocaleDateString","jam_mulai","substring","tanggal_pesan","payment_method","amount","attachment","send","module","exports"],"mappings":"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","file":"reservasi_new.min.js","sourcesContent":["// routes/reservasi.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Tampilkan daftar reservasi\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    res.render('admin/reservasi/index', {\r\n      title: 'Manajemen Reservasi',\r\n      data: reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err); // Tampilkan error di console\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: Form edit reservasi (untuk ubah status)\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    const reservasiData = await Model_Reservasi.getById(id);\r\n\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/reservasi');\r\n    }\r\n\r\n    res.render('admin/reservasi/edit', {\r\n      title: 'Update Status Reservasi',\r\n      reservasi: reservasiData[0]\r\n    });\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n// POST: Update reservasi\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  try {\r\n    const { status, catatan } = req.body;\r\n    const dataToUpdate = { status, catatan };\r\n\r\n    await Model_Reservasi.Update(id, dataToUpdate);\r\n\r\n    // Jika status diubah menjadi 'disetujui' atau 'selesai', kirim notifikasi ke pemain\r\n    if (status === 'disetujui' || status === 'selesai') {\r\n      const Model_Notifikasi = require('../models/Model_Notifikasi_new');\r\n      const reservasiData = await Model_Reservasi.getById(id);\r\n\r\n      if (reservasiData.length > 0) {\r\n        const notifData = {\r\n          id_user: reservasiData[0].id_user,\r\n          judul: status === 'disetujui' ? 'Booking Disetujui' : 'Booking Selesai',\r\n          pesan: `Booking Anda untuk arena ${reservasiData[0].nama_arena} telah ${status === 'disetujui' ? 'disetujui' : 'selesai'}.`,\r\n          tipe: 'booking',\r\n          dibaca: 0\r\n        };\r\n        await Model_Notifikasi.Store(notifData);\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', 'Status reservasi berhasil diperbarui.');\r\n    res.redirect('/admin/reservasi'); // ✅ FIX\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memperbarui reservasi: ' + err.code);\r\n    res.redirect('/admin/reservasi/edit/' + id); // ✅ FIX\r\n  }\r\n});\r\n\r\n\r\n// GET: Hapus reservasi\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  try {\r\n    await Model_Reservasi.Delete(req.params.id);\r\n    req.flash('success_msg', 'Data reservasi berhasil dihapus.');\r\n    res.redirect('/reservasi');\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal menghapus reservasi: ' + err.code);\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n// GET: Download reservasi data as CSV\r\nrouter.get('/download', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    let csv = 'ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Pembayaran,Jumlah\\n';\r\n\r\n    reservasi.forEach(r => {\r\n      csv += `${r.id_reservasi},${r.nama_user},${r.nama_arena},${new Date(r.tanggal).toLocaleDateString('id-ID')},${r.jam_mulai.substring(0,5)},${new Date(r.tanggal_pesan).toLocaleDateString('id-ID')},${r.status},${r.payment_method || ''},${r.amount || 0}\\n`;\r\n    });\r\n\r\n    res.header('Content-Type', 'text/csv');\r\n    res.attachment('reservasi.csv');\r\n    res.send(csv);\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal mendownload data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}