{"version":3,"sources":["booking.js"],"names":["express","require","router","Router","Model_Reservasi","Model_Jadwal","Model_Pembayaran","Model_Arena","post","req","res","connection","body","id_jadwal","payment_method","amount","id_user","session","user","id","flash","redirect","Promise","resolve","reject","beginTransaction","err","query","rows","jadwalData","length","Error","status_slot","id_arena","getById","arenaData","harga","finalAmount","isNaN","parseFloat","dataReservasi","status","catatan","Store","result","id_reservasi","insertId","createCODByReservasi","metode_pembayaran","status_pembayaran","jumlah","tanggal_pembayaran","Date","status_bukti","konfirmasi_admin","created_at","updated_at","Update","commit","successMsg","rollback","console","error","errorMsg","message","module","exports"],"mappings":";;AAAA;AACA,IAAMA,OAAO,GAAGC,OAAO,CAAC,SAAD,CAAvB;;AACA,IAAMC,MAAM,GAAGF,OAAO,CAACG,MAAR,EAAf;;AACA,IAAMC,eAAe,GAAGH,OAAO,CAAC,2BAAD,CAA/B;;AACA,IAAMI,YAAY,GAAGJ,OAAO,CAAC,wBAAD,CAA5B;;AACA,IAAMK,gBAAgB,GAAGL,OAAO,CAAC,4BAAD,CAAhC;;AACA,IAAMM,WAAW,GAAGN,OAAO,CAAC,uBAAD,CAA3B;;AAEAC,MAAM,CAACM,IAAP,CAAY,SAAZ,EAAuB,iBAAOC,GAAP,EAAYC,GAAZ;AAAA;;AAAA;AAAA;AAAA;AAAA;AACfC,UAAAA,UADe,GACFV,OAAO,CAAC,oBAAD,CADL;AAAA;AAAA,sBAI2BQ,GAAG,CAACG,IAJ/B,EAIXC,SAJW,aAIXA,SAJW,EAIAC,cAJA,aAIAA,cAJA,EAIgBC,MAJhB,aAIgBA,MAJhB;AAKbC,UAAAA,OALa,GAKHP,GAAG,CAACQ,OAAJ,CAAYC,IAAZ,GAAmBT,GAAG,CAACQ,OAAJ,CAAYC,IAAZ,CAAiBC,EAApC,GAAyC,IALtC;;AAAA,cAOdH,OAPc;AAAA;AAAA;AAAA;;AAQjBP,UAAAA,GAAG,CAACW,KAAJ,CAAU,WAAV,EAAuB,2CAAvB;AARiB,2CASVV,GAAG,CAACW,QAAJ,CAAa,aAAb,CATU;;AAAA;AAAA,gBAYf,CAACR,SAAD,IAAc,CAACC,cAZA;AAAA;AAAA;AAAA;;AAajBL,UAAAA,GAAG,CAACW,KAAJ,CAAU,WAAV,EAAuB,6BAAvB;AAbiB,2CAcVV,GAAG,CAACW,QAAJ,CAAa,MAAb,CAdU;;AAAA;AAAA,gBAiBfP,cAAc,KAAK,WAAnB,IAAkCA,cAAc,KAAK,KAjBtC;AAAA;AAAA;AAAA;;AAkBjBL,UAAAA,GAAG,CAACW,KAAJ,CAAU,WAAV,EAAuB,gCAAvB;AAlBiB,2CAmBVV,GAAG,CAACW,QAAJ,CAAa,MAAb,CAnBU;;AAAA;AAAA;AAAA,0CAuBb,IAAIC,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACrCb,YAAAA,UAAU,CAACc,gBAAX,CAA4B,UAAAC,GAAG;AAAA,qBAAKA,GAAG,GAAGF,MAAM,CAACE,GAAD,CAAT,GAAiBH,OAAO,EAAhC;AAAA,aAA/B;AACD,WAFK,CAvBa;;AAAA;AAAA;AAAA;AAAA,0CA6BQ,IAAID,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACxDb,YAAAA,UAAU,CAACgB,KAAX,CACE,qDADF,EAEE,CAACd,SAAD,CAFF,EAGE,UAACa,GAAD,EAAME,IAAN;AAAA,qBAAgBF,GAAG,GAAGF,MAAM,CAACE,GAAD,CAAT,GAAiBH,OAAO,CAACK,IAAD,CAA3C;AAAA,aAHF;AAKD,WANwB,CA7BR;;AAAA;AA6BXC,UAAAA,UA7BW;;AAAA,gBAqCb,CAACA,UAAD,IAAeA,UAAU,CAACC,MAAX,KAAsB,CArCxB;AAAA;AAAA;AAAA;;AAAA,gBAsCT,IAAIC,KAAJ,CAAU,yBAAV,CAtCS;;AAAA;AAAA,gBAyCbF,UAAU,CAAC,CAAD,CAAV,CAAcG,WAAd,KAA8B,QAzCjB;AAAA;AAAA;AAAA;;AAAA,gBA0CT,IAAID,KAAJ,CAAU,+DAAV,CA1CS;;AAAA;AA6CXE,UAAAA,QA7CW,GA6CAJ,UAAU,CAAC,CAAD,CAAV,CAAcI,QA7Cd,EA+CjB;;AA/CiB;AAAA,0CAgDO1B,WAAW,CAAC2B,OAAZ,CAAoBD,QAApB,CAhDP;;AAAA;AAgDXE,UAAAA,SAhDW;;AAAA,gBAiDb,CAACA,SAAD,IAAcA,SAAS,CAACL,MAAV,KAAqB,CAjDtB;AAAA;AAAA;AAAA;;AAAA,gBAkDT,IAAIC,KAAJ,CAAU,wBAAV,CAlDS;;AAAA;AAoDXK,UAAAA,KApDW,GAoDHD,SAAS,CAAC,CAAD,CAAT,CAAaC,KAAb,IAAsB,CApDnB,EAsDjB;;AACIC,UAAAA,WAvDa,GAuDCD,KAvDD;;AAAA,gBAwDbtB,cAAc,KAAK,WAxDN;AAAA;AAAA;AAAA;;AAAA,gBAyDX,CAACC,MAAD,IAAWuB,KAAK,CAACC,UAAU,CAACxB,MAAD,CAAX,CAzDL;AAAA;AAAA;AAAA;;AAAA,gBA0DP,IAAIgB,KAAJ,CAAU,gCAAV,CA1DO;;AAAA;AA4DfM,UAAAA,WAAW,GAAGE,UAAU,CAACxB,MAAD,CAAxB;;AA5De;AA+DjB;AACMyB,UAAAA,aAhEW,GAgEK;AACpBxB,YAAAA,OAAO,EAAPA,OADoB;AAEpBiB,YAAAA,QAAQ,EAARA,QAFoB;AAGpBpB,YAAAA,SAAS,EAATA,SAHoB;AAIpB4B,YAAAA,MAAM,EAAE,UAJY;AAIE;AACtBC,YAAAA,OAAO,EAAE;AALW,WAhEL;AAAA;AAAA,0CAuEItC,eAAe,CAACuC,KAAhB,CAAsBH,aAAtB,CAvEJ;;AAAA;AAuEXI,UAAAA,MAvEW;AAwEXC,UAAAA,YAxEW,GAwEID,MAAM,CAACE,QAxEX,EA0EjB;;AA1EiB,gBA2EbhC,cAAc,KAAK,KA3EN;AAAA;AAAA;AAAA;;AAAA;AAAA,0CA6ETR,gBAAgB,CAACyC,oBAAjB,CAAsCF,YAAtC,EAAoDR,WAApD,CA7ES;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA,0CAgFT/B,gBAAgB,CAACqC,KAAjB,CAAuB;AAC3BE,YAAAA,YAAY,EAAZA,YAD2B;AAE3BG,YAAAA,iBAAiB,EAAE,WAFQ;AAG3BC,YAAAA,iBAAiB,EAAE,QAHQ;AAI3BC,YAAAA,MAAM,EAAEb,WAJmB;AAK3Bc,YAAAA,kBAAkB,EAAE,IAAIC,IAAJ,EALO;AAM3BC,YAAAA,YAAY,EAAE,SANa;AAO3BC,YAAAA,gBAAgB,EAAE,KAPS;AAQ3BC,YAAAA,UAAU,EAAE,IAAIH,IAAJ,EARe;AAS3BI,YAAAA,UAAU,EAAE,IAAIJ,IAAJ;AATe,WAAvB,CAhFS;;AAAA;AAAA;AAAA,0CA8FT/C,YAAY,CAACoD,MAAb,CAAoB5C,SAApB,EAA+B;AAAEmB,YAAAA,WAAW,EAAE;AAAf,WAA/B,CA9FS;;AAAA;AAAA;AAAA,0CAiGT,IAAIV,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACrCb,YAAAA,UAAU,CAAC+C,MAAX,CAAkB,UAAAhC,GAAG,EAAI;AACvB,kBAAIA,GAAJ,EAASF,MAAM,CAACE,GAAD,CAAN,CAAT,KACKH,OAAO;AACb,aAHD;AAID,WALK,CAjGS;;AAAA;AAwGf;AACMoC,UAAAA,UAzGS,GAyGI7C,cAAc,KAAK,KAAnB,GACf,kDADe,GAEf,kDA3GW;AA6GfL,UAAAA,GAAG,CAACW,KAAJ,CAAU,aAAV,EAAyBuC,UAAzB,EA7Ge,CA+GvB;;AA/GuB,2CAgHhBjD,GAAG,CAACW,QAAJ,0BAA+BY,QAA/B,EAhHgB;;AAAA;AAAA;AAAA;AAAA;AAAA,0CAmHX,IAAIX,OAAJ,CAAY,UAACC,OAAD,EAAUC,MAAV,EAAqB;AACrCb,YAAAA,UAAU,CAACiD,QAAX,CAAoB,UAAAlC,GAAG;AAAA,qBAAKA,GAAG,GAAGF,MAAM,CAACE,GAAD,CAAT,GAAiBH,OAAO,EAAhC;AAAA,aAAvB;AACD,WAFK,CAnHW;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAyHnBsC,UAAAA,OAAO,CAACC,KAAR,CAAc,gBAAd;AACMC,UAAAA,QA1Ha,GA0HF,YAAIC,OAAJ,IAAe,iDA1Hb;AA2HnBvD,UAAAA,GAAG,CAACW,KAAJ,CAAU,WAAV,EAAuB2C,QAAvB;AACArD,UAAAA,GAAG,CAACW,QAAJ,CAAa,MAAb;;AA5HmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAvB;AAgIA4C,MAAM,CAACC,OAAP,GAAiBhE,MAAjB","sourcesContent":["// routes/booking.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Arena = require('../models/Model_Arena');\r\n\r\nrouter.post('/create', async (req, res) => {\r\n  const connection = require('../config/database');\r\n\r\n  try {\r\n    const { id_jadwal, payment_method, amount } = req.body;\r\n    const id_user = req.session.user ? req.session.user.id : null;\r\n\r\n    if (!id_user) {\r\n      req.flash('error_msg', 'Anda harus login untuk melakukan booking.');\r\n      return res.redirect('/auth/login');\r\n    }\r\n\r\n    if (!id_jadwal || !payment_method) {\r\n      req.flash('error_msg', 'Data booking tidak lengkap.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    if (payment_method !== 'transaksi' && payment_method !== 'cod') {\r\n      req.flash('error_msg', 'Metode pembayaran tidak valid.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    // mulai transaksi\r\n    await new Promise((resolve, reject) => {\r\n      connection.beginTransaction(err => (err ? reject(err) : resolve()));\r\n    });\r\n\r\n    try {\r\n      // 1. lock jadwal\r\n      const jadwalData = await new Promise((resolve, reject) => {\r\n        connection.query(\r\n          'SELECT * FROM jadwal WHERE id_jadwal = ? FOR UPDATE',\r\n          [id_jadwal],\r\n          (err, rows) => (err ? reject(err) : resolve(rows))\r\n        );\r\n      });\r\n\r\n      if (!jadwalData || jadwalData.length === 0) {\r\n        throw new Error('Jadwal tidak ditemukan.');\r\n      }\r\n\r\n      if (jadwalData[0].status_slot !== 'kosong') {\r\n        throw new Error('Maaf, slot ini sudah dipesan atau sedang menunggu konfirmasi.');\r\n      }\r\n\r\n      const id_arena = jadwalData[0].id_arena;\r\n\r\n      // 2. ambil harga arena\r\n      const arenaData = await Model_Arena.getById(id_arena);\r\n      if (!arenaData || arenaData.length === 0) {\r\n        throw new Error('Arena tidak ditemukan.');\r\n      }\r\n      const harga = arenaData[0].harga || 0;\r\n\r\n      // 3. hitung amount\r\n      let finalAmount = harga;\r\n      if (payment_method === 'transaksi') {\r\n        if (!amount || isNaN(parseFloat(amount))) {\r\n          throw new Error('Jumlah pembayaran tidak valid.');\r\n        }\r\n        finalAmount = parseFloat(amount);\r\n      }\r\n\r\n      // 4. simpan reservasi (tanpa field pembayaran)\r\n      const dataReservasi = {\r\n        id_user,\r\n        id_arena,\r\n        id_jadwal,\r\n        status: 'menunggu',   // menunggu konfirmasi / pembayaran\r\n        catatan: null\r\n      };\r\n      const result = await Model_Reservasi.Store(dataReservasi);\r\n      const id_reservasi = result.insertId;\r\n\r\n      // 5. buat record pembayaran\r\n      if (payment_method === 'cod') {\r\n        // COD -> belum dibayar\r\n        await Model_Pembayaran.createCODByReservasi(id_reservasi, finalAmount);\r\n      } else {\r\n        // Transfer (transaksi) -> status 'unpaid'\r\n        await Model_Pembayaran.Store({\r\n          id_reservasi,\r\n          metode_pembayaran: 'transaksi',\r\n          status_pembayaran: 'unpaid',\r\n          jumlah: finalAmount,\r\n          tanggal_pembayaran: new Date(),\r\n          status_bukti: 'pending',\r\n          konfirmasi_admin: false,\r\n          created_at: new Date(),\r\n          updated_at: new Date()\r\n        });\r\n      }\r\n\r\n// 7. UPDATE status slot jadwal menjadi 'menunggu'\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'menunggu' });\r\n\r\n        // Commit transaction\r\n        await new Promise((resolve, reject) => {\r\n          connection.commit(err => {\r\n            if (err) reject(err);\r\n            else resolve();\r\n          });\r\n        });\r\n\r\n        // 8. Berhasil! Arahkan ke halaman DETAIL VENUE, bukan profil\r\n        const successMsg = payment_method === 'cod'\r\n          ? 'Booking COD berhasil! Menunggu konfirmasi Admin.'\r\n          : 'Booking berhasil! Silakan selesaikan pembayaran.';\r\n\r\n        req.flash('success_msg', successMsg);\r\n\r\n// id_arena sudah kita ambil sebelumnya dari tabel jadwal\r\nreturn res.redirect(`/venues/detail/${id_arena}`);\r\n\r\n    } catch (innerErr) {\r\n      await new Promise((resolve, reject) => {\r\n        connection.rollback(err => (err ? reject(err) : resolve()));\r\n      });\r\n      throw innerErr;\r\n    }\r\n  } catch (err) {\r\n    console.error('Booking error:', err);\r\n    const errorMsg = err.message || 'Maaf, terjadi kesalahan saat melakukan booking.';\r\n    req.flash('error_msg', errorMsg);\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"booking.dev.js"}