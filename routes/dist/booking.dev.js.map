{"version":3,"sources":["booking.js"],"names":["express","require","router","Router","Model_Reservasi","Model_Jadwal","Model_Pembayaran","Model_Arena","post","req","res","connection","body","id_jadwal","payment_method","amount","id_user","session","user","id","flash","redirect","includes","Promise","resolve","reject","beginTransaction","err","query","rows","jadwalData","length","Error","status_slot","id_arena","getById","arenaData","harga","finalAmount","isNaN","parseFloat","dataReservasi","status","payment_status","Store","result","id_reservasi","insertId","dataPembayaran","metode_pembayaran","status_pembayaran","jumlah","tanggal_pembayaran","Date","bukti_pembayaran","catatan_admin","konfirmasi_admin","Update","commit","successMsg","rollback","console","error","errorMsg","message","module","exports"],"mappings":"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","sourcesContent":["// routes/booking.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Arena = require('../models/Model_Arena');\r\n\r\n// Rute ini HANYA bisa diakses jika sudah login\r\n// (karena akan kita kunci di app.js)\r\n\r\nrouter.post('/create', async (req, res) => {\r\n  const connection = require('../config/database'); // Import connection for transaction\r\n\r\n  try {\r\n    const { id_jadwal, payment_method, amount } = req.body;\r\n    const id_user = req.session.user ? req.session.user.id : null;\r\n\r\n    // Validasi input\r\n    if (!id_user) {\r\n      req.flash('error_msg', 'Anda harus login untuk melakukan booking.');\r\n      return res.redirect('/auth/login');\r\n    }\r\n\r\n    if (!id_jadwal || !payment_method) {\r\n      req.flash('error_msg', 'Data booking tidak lengkap.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    if (!['cod', 'midtrans'].includes(payment_method)) {\r\n      req.flash('error_msg', 'Metode pembayaran tidak valid.');\r\n      return res.redirect('back');\r\n    }\r\n\r\n    // Start transaction\r\n    await new Promise((resolve, reject) => {\r\n      connection.beginTransaction(err => {\r\n        if (err) reject(err);\r\n        else resolve();\r\n      });\r\n    });\r\n\r\n    try {\r\n      // 1. Ambil info jadwal untuk dapat id_arena (lock for update)\r\n      const jadwalData = await new Promise((resolve, reject) => {\r\n        connection.query('SELECT * FROM jadwal WHERE id_jadwal = ? FOR UPDATE', [id_jadwal], (err, rows) => {\r\n          if (err) reject(err);\r\n          else resolve(rows);\r\n        });\r\n      });\r\n\r\n      if (jadwalData.length === 0) {\r\n        throw new Error('Jadwal tidak ditemukan.');\r\n      }\r\n\r\n      // 2. Pastikan slot masih kosong (double check dengan lock)\r\n      if (jadwalData[0].status_slot !== 'kosong') {\r\n        throw new Error('Maaf, slot ini sudah dipesan atau sedang menunggu konfirmasi.');\r\n      }\r\n\r\n      const id_arena = jadwalData[0].id_arena;\r\n\r\n      // 3. Ambil harga arena\r\n      const arenaData = await Model_Arena.getById(id_arena);\r\n      if (arenaData.length === 0) {\r\n        throw new Error('Arena tidak ditemukan.');\r\n      }\r\n      const harga = arenaData[0].harga || 0;\r\n\r\n      // 4. Validasi amount untuk midtrans\r\n      let finalAmount = harga;\r\n      if (payment_method === 'midtrans') {\r\n        if (!amount || isNaN(parseFloat(amount))) {\r\n          throw new Error('Jumlah pembayaran tidak valid.');\r\n        }\r\n        finalAmount = parseFloat(amount);\r\n      }\r\n\r\n      // 5. Buat data reservasi baru dengan payment info\r\n      const dataReservasi = {\r\n        id_user: id_user,\r\n        id_arena: id_arena,\r\n        id_jadwal: id_jadwal,\r\n        status: 'menunggu',\r\n        payment_method: payment_method,\r\n        payment_status: payment_method === 'cod' ? 'pending' : 'unpaid',\r\n        amount: finalAmount\r\n      };\r\n\r\n      const result = await Model_Reservasi.Store(dataReservasi);\r\n      const id_reservasi = result.insertId;\r\n\r\n      // 6. Buat record pembayaran\r\n      const dataPembayaran = {\r\n        id_reservasi: id_reservasi,\r\n        metode_pembayaran: payment_method,\r\n        status_pembayaran: payment_method === 'cod' ? 'pending' : 'unpaid',\r\n        jumlah: finalAmount,\r\n        tanggal_pembayaran: new Date(),\r\n        bukti_pembayaran: null, // Untuk COD tidak ada bukti pembayaran\r\n        catatan_admin: null,\r\n        konfirmasi_admin: false\r\n      };\r\n      await Model_Pembayaran.Store(dataPembayaran);\r\n\r\n      // 7. UPDATE status slot jadwal menjadi 'menunggu'\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'menunggu' });\r\n\r\n      // Commit transaction\r\n      await new Promise((resolve, reject) => {\r\n        connection.commit(err => {\r\n          if (err) reject(err);\r\n          else resolve();\r\n        });\r\n      });\r\n\r\n      // 8. Berhasil! Arahkan ke halaman profil\r\n      const successMsg = payment_method === 'cod'\r\n        ? 'Booking COD berhasil! Menunggu konfirmasi Admin.'\r\n        : 'Booking berhasil! Silakan selesaikan pembayaran.';\r\n      req.flash('success_msg', successMsg);\r\n      res.redirect('/pemain/profile');\r\n\r\n    } catch (innerErr) {\r\n      // Rollback transaction\r\n      await new Promise((resolve, reject) => {\r\n        connection.rollback(err => {\r\n          if (err) reject(err);\r\n          else resolve();\r\n        });\r\n      });\r\n      throw innerErr;\r\n    }\r\n\r\n  } catch (err) {\r\n    console.error('Booking error:', err);\r\n    const errorMsg = err.message || 'Maaf, terjadi kesalahan saat melakukan booking.';\r\n    req.flash('error_msg', errorMsg);\r\n    res.redirect('back');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"booking.dev.js"}