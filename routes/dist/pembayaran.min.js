"use strict";var express=require("express"),router=express.Router(),Model_Pembayaran=require("../models/Model_Pembayaran"),Model_Reservasi=require("../models/Model_Reservasi"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isAdmin=_require.isAdmin;router.use(isAuthenticated,isAdmin),router.get("/",function(a,r){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Pembayaran.getPendingPayments());case 3:n=e.sent,r.render("admin/pembayaran/index",{title:"Konfirmasi Pembayaran",data:n}),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error(e.t0),a.flash("error_msg","Gagal memuat data pembayaran."),r.redirect("/admin/dashboard");case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.post("/confirm/:id",function(a,r){var n,t,i,s,o,d,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=a.params.id,t=a.body.catatan_admin,e.next=5,regeneratorRuntime.awrap(Model_Pembayaran.confirmPayment(n,"confirmed",t));case 5:return e.next=7,regeneratorRuntime.awrap(Model_Pembayaran.getById(n));case 7:if(0<(i=e.sent).length)return e.next=11,regeneratorRuntime.awrap(Model_Reservasi.Update(i[0].id_reservasi,{status:"disetujui"}));e.next=29;break;case 11:return e.next=13,regeneratorRuntime.awrap(Model_Reservasi.getById(i[0].id_reservasi));case 13:if(0<(s=e.sent).length)return o=require("../models/Model_Jadwal"),e.next=18,regeneratorRuntime.awrap(o.Update(s[0].id_jadwal,{status_slot:"terisi"}));e.next=18;break;case 18:if(i[0]&&i[0].id_user&&"number"==typeof i[0].id_user&&0<i[0].id_user)return e.prev=19,d=require("../models/Model_Notifikasi"),u={id_user:i[0].id_user,judul:"Pembayaran Dikonfirmasi",isi_pesan:"Pembayaran Anda untuk arena ".concat(i[0].nama_arena||"Arena"," telah dikonfirmasi. Booking Anda sekarang aktif."),jenis_notif:"status",tipe:"payment",dibaca:0},e.next=24,regeneratorRuntime.awrap(d.Store(u));e.next=29;break;case 24:e.next=29;break;case 26:e.prev=26,e.t0=e.catch(19),console.error("Failed to send notification:",e.t0);case 29:a.flash("success_msg","Pembayaran berhasil dikonfirmasi."),r.redirect("/admin/pembayaran"),e.next=38;break;case 33:e.prev=33,e.t1=e.catch(0),console.error(e.t1),a.flash("error_msg","Gagal mengkonfirmasi pembayaran."),r.redirect("/admin/pembayaran");case 38:case"end":return e.stop()}},null,null,[[0,33],[19,26]])}),router.post("/confirm-cod/:id",function(a,r){var n,t,i,s,o,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=a.params.id,e.next=4,regeneratorRuntime.awrap(Model_Pembayaran.confirmPayment(n,"confirmed","COD - Pembayaran diterima langsung"));case 4:return e.next=6,regeneratorRuntime.awrap(Model_Pembayaran.getById(n));case 6:if(0<(t=e.sent).length)return e.next=10,regeneratorRuntime.awrap(Model_Reservasi.Update(t[0].id_reservasi,{status:"disetujui"}));e.next=28;break;case 10:return e.next=12,regeneratorRuntime.awrap(Model_Reservasi.getById(t[0].id_reservasi));case 12:if(0<(i=e.sent).length)return s=require("../models/Model_Jadwal"),e.next=17,regeneratorRuntime.awrap(s.Update(i[0].id_jadwal,{status_slot:"terisi"}));e.next=17;break;case 17:if(t[0]&&t[0].id_user&&"number"==typeof t[0].id_user&&0<t[0].id_user)return e.prev=18,o=require("../models/Model_Notifikasi"),d={id_user:t[0].id_user,judul:"Pembayaran COD Dikonfirmasi",isi_pesan:"Pembayaran COD Anda untuk arena ".concat(t[0].nama_arena||"Arena"," telah dikonfirmasi. Booking Anda sekarang aktif."),jenis_notif:"status",tipe:"payment",dibaca:0},e.next=23,regeneratorRuntime.awrap(o.Store(d));e.next=28;break;case 23:e.next=28;break;case 25:e.prev=25,e.t0=e.catch(18),console.error("Failed to send notification:",e.t0);case 28:r.json({success:!0,message:"Pembayaran COD berhasil dikonfirmasi!"}),e.next=35;break;case 31:e.prev=31,e.t1=e.catch(0),console.error(e.t1),r.status(500).json({success:!1,message:"Gagal mengkonfirmasi pembayaran COD. Silakan coba lagi."});case 35:case"end":return e.stop()}},null,null,[[0,31],[18,25]])}),router.post("/reject/:id",function(a,r){var n,t,i,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=a.params.id,t=a.body.catatan_admin,e.next=5,regeneratorRuntime.awrap(Model_Pembayaran.confirmPayment(n,"rejected",t));case 5:return e.next=7,regeneratorRuntime.awrap(Model_Pembayaran.getById(n));case 7:if(0<(i=e.sent).length)return e.next=11,regeneratorRuntime.awrap(Model_Reservasi.Update(i[0].id_reservasi,{status:"ditolak"}));e.next=22;break;case 11:if(i[0]&&i[0].id_user&&"number"==typeof i[0].id_user&&0<i[0].id_user)return e.prev=12,s=require("../models/Model_Notifikasi"),o={id_user:i[0].id_user,judul:"Pembayaran Ditolak",isi_pesan:"Pembayaran Anda untuk arena ".concat(i[0].nama_arena||"Arena"," ditolak. ").concat(t),jenis_notif:"status",tipe:"payment",dibaca:0},e.next=17,regeneratorRuntime.awrap(s.Store(o));e.next=22;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(12),console.error("Failed to send notification:",e.t0);case 22:a.flash("error_msg","Pembayaran berhasil ditolak."),r.redirect("/admin/pembayaran"),e.next=31;break;case 26:e.prev=26,e.t1=e.catch(0),console.error(e.t1),a.flash("error_msg","Gagal menolak pembayaran."),r.redirect("/admin/pembayaran");case 31:case"end":return e.stop()}},null,null,[[0,26],[12,19]])}),module.exports=router;
//# sourceMappingURL=pembayaran.min.js.map
