"use strict";var express=require("express"),router=express.Router(),connection=require("../config/database"),Model_Pembayaran=require("../models/Model_Pembayaran"),Model_Reservasi=require("../models/Model_Reservasi"),Model_Jadwal=require("../models/Model_Jadwal"),Model_Notifikasi=require("../models/Model_Notifikasi"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isAdmin=_require.isAdmin,_require2=require("../helpers/logHelper"),createLog=_require2.createLog;router.use(isAuthenticated,isAdmin),router.get("/",function(a,r){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Pembayaran.getPendingPayments());case 3:n=e.sent,r.render("admin/pembayaran/index",{title:"Konfirmasi Pembayaran",data:n}),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("ERR GET /admin/pembayaran:",e.t0),a.flash("error_msg","Gagal memuat data pembayaran."),r.redirect("/admin/dashboard");case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.post("/confirm/:id_pembayaran",function(u,d){var t=u.params.id_pembayaran,i=(u.body||{}).catatan_admin;connection.query("SELECT * FROM pembayaran WHERE id_pembayaran = ?",[t],function(a,r){var n,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR SELECT pembayaran:",a),u.flash("error_msg","Gagal mengambil data pembayaran."),e.abrupt("return",d.redirect("/admin/pembayaran"));e.next=4;break;case 4:if(r&&0!==r.length){e.next=7;break}return u.flash("error_msg","Data pembayaran tidak ditemukan."),e.abrupt("return",d.redirect("/admin/pembayaran"));case 7:n=r[0],o=n.id_reservasi,connection.query("UPDATE pembayaran\n         SET status_pembayaran = 'confirmed',\n             konfirmasi_admin = 1,\n             catatan_admin = ?,\n             updated_at = NOW()\n         WHERE id_pembayaran = ?",[i||null,t],function(a){var r,n,t,i,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR UPDATE pembayaran:",a),u.flash("error_msg","Gagal mengkonfirmasi pembayaran."),e.abrupt("return",d.redirect("/admin/pembayaran"));e.next=4;break;case 4:return e.prev=4,e.next=7,regeneratorRuntime.awrap(Model_Reservasi.getById(o));case 7:return r=e.sent,n=r&&r[0]?r[0]:null,t=n&&n.status||null,e.next=12,regeneratorRuntime.awrap(Model_Reservasi.Update(o,{status:"disetujui"}));case 12:return e.next=14,regeneratorRuntime.awrap(Model_Reservasi.getById(o));case 14:return i=e.sent,s=i&&i[0]?i[0]:null,e.prev=16,e.next=19,regeneratorRuntime.awrap(createLog(o,t||"menunggu","disetujui","Pembayaran dikonfirmasi admin"));case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(16),console.warn("Gagal membuat log konfirmasi pembayaran:",e.t0);case 24:if(s&&s.id_jadwal)return e.next=27,regeneratorRuntime.awrap(Model_Jadwal.Update(s.id_jadwal,{status_slot:"terisi"}));e.next=27;break;case 27:if(e.prev=27,s&&s.id_user)return e.next=31,regeneratorRuntime.awrap(Model_Notifikasi.Store({id_user:s.id_user,judul:"Pembayaran Dikonfirmasi",isi_pesan:"Pembayaran Anda untuk arena ".concat(s.nama_arena||"Arena"," telah dikonfirmasi. Booking Anda sekarang aktif."),jenis_notif:"status",tipe:"payment",dibaca:0}));e.next=31;break;case 31:e.next=36;break;case 33:e.prev=33,e.t1=e.catch(27),console.warn("Gagal kirim notif konfirmasi pembayaran:",e.t1);case 36:return u.flash("success_msg","Pembayaran berhasil dikonfirmasi."),e.abrupt("return",d.redirect("/admin/pembayaran"));case 40:return e.prev=40,e.t2=e.catch(4),console.error("ERR AFTER UPDATE pembayaran:",e.t2),u.flash("error_msg","Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server."),e.abrupt("return",d.redirect("/admin/pembayaran"));case 45:case"end":return e.stop()}},null,null,[[4,40],[16,21],[27,33]])});case 10:case"end":return e.stop()}})})}),router.post("/reject/:id_pembayaran",function(d,m){var t=d.params.id_pembayaran,c=(d.body||{}).catatan_admin;connection.query("SELECT * FROM pembayaran WHERE id_pembayaran = ?",[t],function(a,r){var n,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR SELECT pembayaran (reject):",a),d.flash("error_msg","Gagal mengambil data pembayaran."),e.abrupt("return",m.redirect("/admin/pembayaran"));e.next=4;break;case 4:if(r&&0!==r.length){e.next=7;break}return d.flash("error_msg","Data pembayaran tidak ditemukan."),e.abrupt("return",m.redirect("/admin/pembayaran"));case 7:n=r[0],u=n.id_reservasi,connection.query("UPDATE pembayaran\n         SET status_pembayaran = 'rejected',\n             konfirmasi_admin = 1,\n             catatan_admin = ?,\n             updated_at = NOW()\n         WHERE id_pembayaran = ?",[c||null,t],function(a){var r,n,t,i,s,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR UPDATE pembayaran (reject):",a),d.flash("error_msg","Gagal menolak pembayaran."),e.abrupt("return",m.redirect("/admin/pembayaran"));e.next=4;break;case 4:return e.prev=4,e.next=7,regeneratorRuntime.awrap(Model_Reservasi.getById(u));case 7:if(r=e.sent,n=r&&r[0]?r[0]:null,t=n&&n.status||null,"function"==typeof Model_Reservasi.rejectAndFreeSlot)return e.next=13,regeneratorRuntime.awrap(Model_Reservasi.rejectAndFreeSlot(u));e.next=15;break;case 13:e.next=23;break;case 15:return e.next=17,regeneratorRuntime.awrap(Model_Reservasi.Update(u,{status:"ditolak"}));case 17:return e.next=19,regeneratorRuntime.awrap(Model_Reservasi.getById(u));case 19:if((i=e.sent)&&i[0]&&i[0].id_jadwal)return e.next=23,regeneratorRuntime.awrap(Model_Jadwal.Update(i[0].id_jadwal,{status_slot:"kosong"}));e.next=23;break;case 23:return e.prev=23,e.next=26,regeneratorRuntime.awrap(createLog(u,t||"menunggu","ditolak","Pembayaran ditolak admin. ".concat(c||"")));case 26:e.next=31;break;case 28:e.prev=28,e.t0=e.catch(23),console.warn("Gagal membuat log tolak pembayaran:",e.t0);case 31:return e.prev=31,e.next=34,regeneratorRuntime.awrap(Model_Reservasi.getById(u));case 34:if(s=e.sent,(o=s&&s[0]?s[0]:null)&&o.id_user)return e.next=39,regeneratorRuntime.awrap(Model_Notifikasi.Store({id_user:o.id_user,judul:"Pembayaran Ditolak",isi_pesan:"Pembayaran Anda untuk arena ".concat(o.nama_arena||"Arena"," ditolak. ").concat(c||""),jenis_notif:"status",tipe:"payment",dibaca:0}));e.next=39;break;case 39:e.next=44;break;case 41:e.prev=41,e.t1=e.catch(31),console.warn("Gagal kirim notif tolak pembayaran:",e.t1);case 44:return d.flash("success_msg","Pembayaran berhasil ditolak."),e.abrupt("return",m.redirect("/admin/pembayaran"));case 48:return e.prev=48,e.t2=e.catch(4),console.error("ERR AFTER UPDATE pembayaran (reject):",e.t2),d.flash("error_msg","Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server."),e.abrupt("return",m.redirect("/admin/pembayaran"));case 53:case"end":return e.stop()}},null,null,[[4,48],[23,28],[31,41]])});case 10:case"end":return e.stop()}})})}),module.exports=router;
//# sourceMappingURL=pembayaran.min.js.map
