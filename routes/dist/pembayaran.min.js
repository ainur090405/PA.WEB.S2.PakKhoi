"use strict";var express=require("express"),router=express.Router(),connection=require("../config/database"),Model_Pembayaran=require("../models/Model_Pembayaran"),Model_Reservasi=require("../models/Model_Reservasi"),Model_Jadwal=require("../models/Model_Jadwal"),Model_Notifikasi=require("../models/Model_Notifikasi"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isAdmin=_require.isAdmin,_require2=require("../helpers/logHelper"),createLog=_require2.createLog;router.use(isAuthenticated,isAdmin),router.get("/",function(a,r){var n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Pembayaran.getPendingPayments());case 3:n=e.sent,r.render("admin/pembayaran/index",{title:"Konfirmasi Pembayaran",data:n}),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error("ERR GET /admin/pembayaran:",e.t0),a.flash("error_msg","Gagal memuat data pembayaran."),r.redirect("/admin/dashboard");case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.post("/confirm/:id_pembayaran",function(b,g){var n=b.params.id_pembayaran,t=(b.body||{}).catatan_admin;connection.query("SELECT * FROM pembayaran WHERE id_pembayaran = ?",[n],function(a,r){var l,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR SELECT pembayaran:",a),b.flash("error_msg","Gagal mengambil data pembayaran."),e.abrupt("return",g.redirect("/admin/pembayaran"));e.next=4;break;case 4:if(r&&0!==r.length){e.next=7;break}return b.flash("error_msg","Data pembayaran tidak ditemukan."),e.abrupt("return",g.redirect("/admin/pembayaran"));case 7:l=r[0],p=l.id_reservasi,connection.query("UPDATE pembayaran\n         SET status_pembayaran = 'confirmed',\n             konfirmasi_admin = 1,\n             catatan_admin = ?,\n             updated_at = NOW()\n         WHERE id_pembayaran = ?",[t||null,n],function(a){var r,n,t,i,s,o,u,m,c,d;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR UPDATE pembayaran:",a),b.flash("error_msg","Gagal mengkonfirmasi pembayaran."),e.abrupt("return",g.redirect("/admin/pembayaran"));e.next=4;break;case 4:return e.prev=4,e.next=7,regeneratorRuntime.awrap(Model_Reservasi.getById(p));case 7:return r=e.sent,n=r&&r[0]?r[0]:null,t=n&&n.status||null,e.next=12,regeneratorRuntime.awrap(Model_Reservasi.Update(p,{status:"disetujui"}));case 12:return e.next=14,regeneratorRuntime.awrap(Model_Reservasi.getById(p));case 14:return i=e.sent,s=i&&i[0]?i[0]:null,e.prev=16,e.next=19,regeneratorRuntime.awrap(createLog(p,t||"menunggu","disetujui","Pembayaran dikonfirmasi admin"));case 19:e.next=24;break;case 21:e.prev=21,e.t0=e.catch(16),console.warn("Gagal membuat log konfirmasi pembayaran:",e.t0);case 24:if(s&&s.id_jadwal)return e.next=27,regeneratorRuntime.awrap(Model_Jadwal.Update(s.id_jadwal,{status_slot:"terisi"}));e.next=27;break;case 27:if(e.prev=27,s&&s.id_user)return o=s.tanggal?new Date(s.tanggal).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric"}):"-",u=s.jam_mulai?s.jam_mulai.substring(0,5):"-",m=s.jam_selesai?s.jam_selesai.substring(0,5):"-",c=l.metode_pembayaran||"–",d="Pembayaran Anda untuk arena ".concat(s.nama_arena||"Arena"," ")+"pada ".concat(o," pukul ").concat(u,"–").concat(m," ")+"dengan metode ".concat(c," telah dikonfirmasi. ")+"Booking Anda sekarang aktif.",e.next=36,regeneratorRuntime.awrap(Model_Notifikasi.Store({id_user:s.id_user,judul:"Pembayaran Dikonfirmasi",isi_pesan:d,jenis_notif:"status",tipe:"payment",dibaca:0}));e.next=36;break;case 36:e.next=41;break;case 38:e.prev=38,e.t1=e.catch(27),console.warn("Gagal kirim notif konfirmasi pembayaran:",e.t1);case 41:return b.flash("success_msg","Pembayaran berhasil dikonfirmasi."),e.abrupt("return",g.redirect("/admin/pembayaran"));case 45:return e.prev=45,e.t2=e.catch(4),console.error("ERR AFTER UPDATE pembayaran:",e.t2),b.flash("error_msg","Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server."),e.abrupt("return",g.redirect("/admin/pembayaran"));case 50:case"end":return e.stop()}},null,null,[[4,45],[16,21],[27,38]])});case 10:case"end":return e.stop()}})})}),router.post("/reject/:id_pembayaran",function(y,_){var n=y.params.id_pembayaran,f=(y.body||{}).catatan_admin;connection.query("SELECT * FROM pembayaran WHERE id_pembayaran = ?",[n],function(a,r){var b,g;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR SELECT pembayaran (reject):",a),y.flash("error_msg","Gagal mengambil data pembayaran."),e.abrupt("return",_.redirect("/admin/pembayaran"));e.next=4;break;case 4:if(r&&0!==r.length){e.next=7;break}return y.flash("error_msg","Data pembayaran tidak ditemukan."),e.abrupt("return",_.redirect("/admin/pembayaran"));case 7:b=r[0],g=b.id_reservasi,connection.query("UPDATE pembayaran\n         SET status_pembayaran = 'rejected',\n             konfirmasi_admin = 1,\n             catatan_admin = ?,\n             updated_at = NOW()\n         WHERE id_pembayaran = ?",[f||null,n],function(a){var r,n,t,i,s,o,u,m,c,d,l,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(a)return console.error("ERR UPDATE pembayaran (reject):",a),y.flash("error_msg","Gagal menolak pembayaran."),e.abrupt("return",_.redirect("/admin/pembayaran"));e.next=4;break;case 4:return e.prev=4,e.next=7,regeneratorRuntime.awrap(Model_Reservasi.getById(g));case 7:if(r=e.sent,n=r&&r[0]?r[0]:null,t=n&&n.status||null,"function"==typeof Model_Reservasi.rejectAndFreeSlot)return e.next=13,regeneratorRuntime.awrap(Model_Reservasi.rejectAndFreeSlot(g));e.next=15;break;case 13:e.next=23;break;case 15:return e.next=17,regeneratorRuntime.awrap(Model_Reservasi.Update(g,{status:"ditolak"}));case 17:return e.next=19,regeneratorRuntime.awrap(Model_Reservasi.getById(g));case 19:if((i=e.sent)&&i[0]&&i[0].id_jadwal)return e.next=23,regeneratorRuntime.awrap(Model_Jadwal.Update(i[0].id_jadwal,{status_slot:"kosong"}));e.next=23;break;case 23:return e.prev=23,e.next=26,regeneratorRuntime.awrap(createLog(g,t||"menunggu","ditolak","Pembayaran ditolak admin. ".concat(f||"")));case 26:e.next=31;break;case 28:e.prev=28,e.t0=e.catch(23),console.warn("Gagal membuat log tolak pembayaran:",e.t0);case 31:return e.prev=31,e.next=34,regeneratorRuntime.awrap(Model_Reservasi.getById(g));case 34:if(s=e.sent,(o=s&&s[0]?s[0]:null)&&o.id_user)return u=f&&""!==f.trim()?f:"Pembayaran ditolak karena data tidak lengkap atau batas waktu upload bukti pembayaran sudah habis.",m=o.tanggal?new Date(o.tanggal).toLocaleDateString("id-ID",{weekday:"long",day:"numeric",month:"long",year:"numeric"}):"-",c=o.jam_mulai?o.jam_mulai.substring(0,5):"-",d=o.jam_selesai?o.jam_selesai.substring(0,5):"-",l=b.metode_pembayaran||"–",p="Pembayaran Anda untuk arena ".concat(o.nama_arena||"Arena"," ")+"pada ".concat(m," pukul ").concat(c,"–").concat(d," ")+"dengan metode ".concat(l," ditolak. ")+"Alasan: ".concat(u),e.next=45,regeneratorRuntime.awrap(Model_Notifikasi.Store({id_user:o.id_user,judul:"Pembayaran Ditolak",isi_pesan:p,jenis_notif:"status",tipe:"payment",dibaca:0}));e.next=45;break;case 45:e.next=50;break;case 47:e.prev=47,e.t1=e.catch(31),console.warn("Gagal kirim notif tolak pembayaran:",e.t1);case 50:return y.flash("success_msg","Pembayaran berhasil ditolak."),e.abrupt("return",_.redirect("/admin/pembayaran"));case 54:return e.prev=54,e.t2=e.catch(4),console.error("ERR AFTER UPDATE pembayaran (reject):",e.t2),y.flash("error_msg","Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server."),e.abrupt("return",_.redirect("/admin/pembayaran"));case 59:case"end":return e.stop()}},null,null,[[4,54],[23,28],[31,47]])});case 10:case"end":return e.stop()}})})}),module.exports=router;
//# sourceMappingURL=pembayaran.min.js.map
