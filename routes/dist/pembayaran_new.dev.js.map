{"version":3,"sources":["pembayaran_new.js"],"names":["express","require","router","Router","Model_Pembayaran","Model_Reservasi","isAuthenticated","isAdmin","use","get","req","res","getPendingPayments","pembayaran","render","title","data","console","error","flash","redirect","post","id_pembayaran","params","id","catatan_admin","body","confirmPayment","getById","pembayaranData","length","Update","id_reservasi","status","Model_Notifikasi","notifData","id_user","judul","pesan","nama_arena","tipe","dibaca","Store","module","exports"],"mappings":"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","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Tampilkan daftar pembayaran yang pending\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// POST: Konfirmasi pembayaran\r\nrouter.post('/confirm/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n    const { catatan_admin } = req.body;\r\n\r\n    // Konfirmasi pembayaran\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'confirmed', catatan_admin);\r\n\r\n    // Update status reservasi menjadi 'disetujui' jika pembayaran dikonfirmasi\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'disetujui' });\r\n\r\n      // Kirim notifikasi ke pemain\r\n      const Model_Notifikasi = require('../models/Model_Notifikasi_new');\r\n      const notifData = {\r\n        id_user: pembayaranData[0].id_user,\r\n        judul: 'Pembayaran Dikonfirmasi',\r\n        pesan: `Pembayaran Anda untuk arena ${pembayaranData[0].nama_arena} telah dikonfirmasi.`,\r\n        tipe: 'payment',\r\n        dibaca: 0\r\n      };\r\n      await Model_Notifikasi.Store(notifData);\r\n    }\r\n\r\n    req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n    res.redirect('/admin/pembayaran');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n    res.redirect('/admin/pembayaran');\r\n  }\r\n});\r\n\r\n// POST: Tolak pembayaran\r\nrouter.post('/reject/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n    const { catatan_admin } = req.body;\r\n\r\n    // Update status pembayaran menjadi 'rejected'\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'rejected', catatan_admin);\r\n\r\n    // Update status reservasi menjadi 'ditolak'\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'ditolak' });\r\n\r\n      // Kirim notifikasi ke pemain\r\n      const Model_Notifikasi = require('../models/Model_Notifikasi_new');\r\n      const notifData = {\r\n        id_user: pembayaranData[0].id_user,\r\n        judul: 'Pembayaran Ditolak',\r\n        pesan: `Pembayaran Anda untuk arena ${pembayaranData[0].nama_arena} ditolak. ${catatan_admin}`,\r\n        tipe: 'payment',\r\n        dibaca: 0\r\n      };\r\n      await Model_Notifikasi.Store(notifData);\r\n    }\r\n\r\n    req.flash('error_msg', 'Pembayaran berhasil ditolak.');\r\n    res.redirect('/admin/pembayaran');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n    res.redirect('/admin/pembayaran');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"pembayaran_new.dev.js"}