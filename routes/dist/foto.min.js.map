{"version":3,"sources":["foto.js"],"names":["express","require","router","Router","Model_Arena","Model_FotoArena","uploadArena","isAuthenticated","isAdmin","fs","path","req","res","id_arena","params","Promise","all","getById","getByArenaId","arenaData","fotoData","length","flash","redirect","render","title","concat","nama_arena","arena","fotoList","_context","t0","message","get","post","array","deskripsi","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_iterator","_step","file","dataFoto","regeneratorRuntime","async","_context2","prev","next","body","files","abrupt","undefined","Symbol","iterator","done","value","url_foto","awrap","Store","finish","t1","stop","_req$params","id_foto","filePath","_context3","sent","join","__dirname","existsSync","unlinkSync","Delete","_req$params2","_context4","setCover","module","exports"],"mappings":"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","file":"foto.min.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Arena = require('../models/Model_Arena');\r\nconst Model_FotoArena = require('../models/Model_FotoArena');\r\nconst { uploadArena } = require('../middleware/uploadMiddleware');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\nconst fs = require('fs'); // Untuk hapus file\r\nconst path = require('path'); // Untuk hapus file\r\n\r\n// Lindungi semua rute di file ini, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n/**\r\n * =======================================================\r\n * GET: Halaman Manajemen Galeri (Tampilan Utama)\r\n * =======================================================\r\n * Menampilkan form upload dan semua foto yang sudah ada\r\n * untuk satu arena spesifik.\r\n */\r\nrouter.get('/manage/:id_arena', async (req, res) => {\r\n  try {\r\n    const id_arena = req.params.id_arena;\r\n    \r\n    // Ambil data arena (untuk judul) dan data foto (untuk galeri)\r\n    const [arenaData, fotoData] = await Promise.all([\r\n      Model_Arena.getById(id_arena),\r\n      Model_FotoArena.getByArenaId(id_arena)\r\n    ]);\r\n\r\n    if (arenaData.length === 0) {\r\n      req.flash('error_msg', 'Arena tidak ditemukan.');\r\n      return res.redirect('/arena');\r\n    }\r\n\r\n    res.render('admin/foto/manage', {\r\n      title: `Galeri Foto: ${arenaData[0].nama_arena}`,\r\n      arena: arenaData[0], // Kirim data arena (untuk id_foto_cover)\r\n      fotoList: fotoData // Kirim daftar foto\r\n    });\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memuat galeri: ' + err.message);\r\n    res.redirect('/arena');\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * POST: Upload Foto Baru (Multi-Upload)\r\n * =======================================================\r\n * Menerima upload (bisa banyak file) dan menyimpannya.\r\n */\r\nrouter.post('/store/:id_arena', uploadArena.array('foto_galeri', 10), async (req, res) => {\r\n  // 'foto_galeri' adalah 'name' dari input file, '10' adalah batas max file\r\n  const id_arena = req.params.id_arena;\r\n  try {\r\n    const deskripsi = req.body.deskripsi; // Ambil 1 deskripsi dari form\r\n\r\n    if (!req.files || req.files.length === 0) {\r\n      req.flash('error_msg', 'Anda tidak memilih file untuk di-upload.');\r\n      return res.redirect(`/foto/manage/${id_arena}`);\r\n    }\r\n\r\n    // Loop semua file yang di-upload\r\n    for (const file of req.files) {\r\n      const dataFoto = {\r\n        id_arena: id_arena,\r\n        url_foto: '/uploads/arena/' + file.filename,\r\n        deskripsi: deskripsi // Terapkan deskripsi yang sama ke semua foto\r\n      };\r\n      await Model_FotoArena.Store(dataFoto);\r\n    }\r\n\r\n    req.flash('success_msg', `${req.files.length} foto berhasil di-upload.`);\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal upload foto: ' + err.message);\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * GET: Hapus 1 Foto\r\n * =======================================================\r\n * Menghapus file fisik dari server DAN datanya dari DB.\r\n */\r\nrouter.get('/delete/:id_arena/:id_foto', async (req, res) => {\r\n  const { id_arena, id_foto } = req.params;\r\n  try {\r\n    // 1. Ambil data foto untuk dapat path file\r\n    const fotoData = await Model_FotoArena.getById(id_foto);\r\n    if (fotoData.length > 0 && fotoData[0].url_foto) {\r\n      // 2. Hapus file fisik\r\n      const filePath = path.join(__dirname, '../public', fotoData[0].url_foto);\r\n      if (fs.existsSync(filePath)) {\r\n        fs.unlinkSync(filePath);\r\n      }\r\n    }\r\n    // 3. Hapus data dari DB\r\n    await Model_FotoArena.Delete(id_foto);\r\n    req.flash('success_msg', 'Foto berhasil dihapus.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal menghapus foto.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * GET: Set 1 Foto sebagai Cover\r\n * =======================================================\r\n * Meng-update tabel 'arena' dengan 'id_foto_cover' yang baru.\r\n */\r\nrouter.get('/setcover/:id_arena/:id_foto', async (req, res) => {\r\n  const { id_arena, id_foto } = req.params;\r\n  try {\r\n    await Model_Arena.setCover(id_arena, id_foto);\r\n    req.flash('success_msg', 'Foto cover berhasil diperbarui.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal set foto cover.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\nmodule.exports = router;"]}