{"version":3,"sources":["foto.js"],"names":["express","require","router","Router","Model_Arena","Model_FotoArena","upload","isAuthenticated","isAdmin","fs","path","get","req","res","id_arena","_ref","_ref2","arenaData","fotoData","regeneratorRuntime","async","_context","prev","next","params","awrap","Promise","all","getById","getByArenaId","sent","_slicedToArray","length","flash","abrupt","redirect","render","title","concat","nama_arena","arena","fotoList","t0","message","stop","post","array","deskripsi","_iteratorNormalCompletion","_didIteratorError","_iteratorError","_iterator","_step","file","dataFoto","_context2","body","files","undefined","Symbol","iterator","done","value","url_foto","Store","finish","t1","_req$params","id_foto","filePath","_context3","join","__dirname","existsSync","unlinkSync","Delete","_req$params2","_context4","setCover","module","exports"],"mappings":"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","file":"foto.min.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Arena = require('../models/Model_Arena');\r\nconst Model_FotoArena = require('../models/Model_FotoArena');\r\nconst upload = require('../middleware/uploadMiddleware'); // <-- 'Multer' dipakai di sini\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\nconst fs = require('fs'); // Untuk hapus file\r\nconst path = require('path'); // Untuk hapus file\r\n\r\n// Lindungi semua rute di file ini, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n/**\r\n * =======================================================\r\n * GET: Halaman Manajemen Galeri (Tampilan Utama)\r\n * =======================================================\r\n * Menampilkan form upload dan semua foto yang sudah ada\r\n * untuk satu arena spesifik.\r\n */\r\nrouter.get('/manage/:id_arena', async (req, res) => {\r\n  try {\r\n    const id_arena = req.params.id_arena;\r\n    \r\n    // Ambil data arena (untuk judul) dan data foto (untuk galeri)\r\n    const [arenaData, fotoData] = await Promise.all([\r\n      Model_Arena.getById(id_arena),\r\n      Model_FotoArena.getByArenaId(id_arena)\r\n    ]);\r\n\r\n    if (arenaData.length === 0) {\r\n      req.flash('error_msg', 'Arena tidak ditemukan.');\r\n      return res.redirect('/arena');\r\n    }\r\n\r\n    res.render('admin/foto/manage', {\r\n      title: `Galeri Foto: ${arenaData[0].nama_arena}`,\r\n      arena: arenaData[0], // Kirim data arena (untuk id_foto_cover)\r\n      fotoList: fotoData // Kirim daftar foto\r\n    });\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memuat galeri: ' + err.message);\r\n    res.redirect('/arena');\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * POST: Upload Foto Baru (Multi-Upload)\r\n * =======================================================\r\n * Menerima upload (bisa banyak file) dan menyimpannya.\r\n */\r\nrouter.post('/store/:id_arena', upload.array('foto_galeri', 10), async (req, res) => {\r\n  // 'foto_galeri' adalah 'name' dari input file, '10' adalah batas max file\r\n  const id_arena = req.params.id_arena;\r\n  try {\r\n    const deskripsi = req.body.deskripsi; // Ambil 1 deskripsi dari form\r\n\r\n    if (!req.files || req.files.length === 0) {\r\n      req.flash('error_msg', 'Anda tidak memilih file untuk di-upload.');\r\n      return res.redirect(`/foto/manage/${id_arena}`);\r\n    }\r\n\r\n    // Loop semua file yang di-upload\r\n    for (const file of req.files) {\r\n      const dataFoto = {\r\n        id_arena: id_arena,\r\n        url_foto: '/uploads/arena/' + file.filename,\r\n        deskripsi: deskripsi // Terapkan deskripsi yang sama ke semua foto\r\n      };\r\n      await Model_FotoArena.Store(dataFoto);\r\n    }\r\n\r\n    req.flash('success_msg', `${req.files.length} foto berhasil di-upload.`);\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal upload foto: ' + err.message);\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * GET: Hapus 1 Foto\r\n * =======================================================\r\n * Menghapus file fisik dari server DAN datanya dari DB.\r\n */\r\nrouter.get('/delete/:id_arena/:id_foto', async (req, res) => {\r\n  const { id_arena, id_foto } = req.params;\r\n  try {\r\n    // 1. Ambil data foto untuk dapat path file\r\n    const fotoData = await Model_FotoArena.getById(id_foto);\r\n    if (fotoData.length > 0 && fotoData[0].url_foto) {\r\n      // 2. Hapus file fisik\r\n      const filePath = path.join(__dirname, '../public', fotoData[0].url_foto);\r\n      if (fs.existsSync(filePath)) {\r\n        fs.unlinkSync(filePath);\r\n      }\r\n    }\r\n    // 3. Hapus data dari DB\r\n    await Model_FotoArena.Delete(id_foto);\r\n    req.flash('success_msg', 'Foto berhasil dihapus.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal menghapus foto.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * GET: Set 1 Foto sebagai Cover\r\n * =======================================================\r\n * Meng-update tabel 'arena' dengan 'id_foto_cover' yang baru.\r\n */\r\nrouter.get('/setcover/:id_arena/:id_foto', async (req, res) => {\r\n  const { id_arena, id_foto } = req.params;\r\n  try {\r\n    await Model_Arena.setCover(id_arena, id_foto);\r\n    req.flash('success_msg', 'Foto cover berhasil diperbarui.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal set foto cover.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\nmodule.exports = router;"]}