"use strict";var express=require("express"),router=express.Router(),Model_Reservasi=require("../models/Model_Reservasi"),Model_Jadwal=require("../models/Model_Jadwal"),Model_Pembayaran=require("../models/Model_Pembayaran"),Model_Arena=require("../models/Model_Arena");router.post("/create",function(a,r){var t,n,s,o,i,u,d,c,l,m,k,g,p,b,_,w;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=require("../config/database"),e.prev=1,n=a.body,s=n.id_jadwal,o=n.payment_method,i=n.amount,u=a.session.user?a.session.user.id:null){e.next=7;break}return a.flash("error_msg","Anda harus login untuk melakukan booking."),e.abrupt("return",r.redirect("/auth/login"));case 7:if(s&&o){e.next=10;break}return a.flash("error_msg","Data booking tidak lengkap."),e.abrupt("return",r.redirect("back"));case 10:if("transaksi"!==o&&"cod"!==o)return a.flash("error_msg","Metode pembayaran tidak valid."),e.abrupt("return",r.redirect("back"));e.next=13;break;case 13:return e.next=15,regeneratorRuntime.awrap(new Promise(function(a,r){t.beginTransaction(function(e){return e?r(e):a()})}));case 15:return e.prev=15,e.next=18,regeneratorRuntime.awrap(new Promise(function(r,n){t.query("SELECT * FROM jadwal WHERE id_jadwal = ? FOR UPDATE",[s],function(e,a){return e?n(e):r(a)})}));case 18:if((d=e.sent)&&0!==d.length){e.next=21;break}throw new Error("Jadwal tidak ditemukan.");case 21:if("kosong"!==d[0].status_slot)throw new Error("Maaf, slot ini sudah dipesan atau sedang menunggu konfirmasi.");e.next=23;break;case 23:return c=d[0].id_arena,e.next=26,regeneratorRuntime.awrap(Model_Arena.getById(c));case 26:if((l=e.sent)&&0!==l.length){e.next=29;break}throw new Error("Arena tidak ditemukan.");case 29:if(m=l[0].harga||0,k=m,"transaksi"!==o){e.next=35;break}if(!i||isNaN(parseFloat(i)))throw new Error("Jumlah pembayaran tidak valid.");e.next=34;break;case 34:k=parseFloat(i);case 35:return g={id_user:u,id_arena:c,id_jadwal:s,status:"menunggu",catatan:null},e.next=38,regeneratorRuntime.awrap(Model_Reservasi.Store(g));case 38:if(p=e.sent,b=p.insertId,"cod"===o)return e.next=43,regeneratorRuntime.awrap(Model_Pembayaran.createCODByReservasi(b,k));e.next=45;break;case 43:e.next=47;break;case 45:return e.next=47,regeneratorRuntime.awrap(Model_Pembayaran.Store({id_reservasi:b,metode_pembayaran:"transaksi",status_pembayaran:"unpaid",jumlah:k,tanggal_pembayaran:new Date,status_bukti:"pending",konfirmasi_admin:!1,created_at:new Date,updated_at:new Date}));case 47:return e.next=49,regeneratorRuntime.awrap(Model_Jadwal.Update(s,{status_slot:"menunggu"}));case 49:return e.next=51,regeneratorRuntime.awrap(new Promise(function(a,r){t.commit(function(e){e?r(e):a()})}));case 51:return _="cod"===o?"Booking COD berhasil! Menunggu konfirmasi Admin.":"Booking berhasil! Silakan selesaikan pembayaran.",a.flash("success_msg",_),e.abrupt("return",r.redirect("/venues/detail/".concat(c)));case 56:return e.prev=56,e.t0=e.catch(15),e.next=60,regeneratorRuntime.awrap(new Promise(function(a,r){t.rollback(function(e){return e?r(e):a()})}));case 60:throw e.t0;case 61:e.next=69;break;case 63:e.prev=63,e.t1=e.catch(1),console.error("Booking error:",e.t1),w=e.t1.message||"Maaf, terjadi kesalahan saat melakukan booking.",a.flash("error_msg",w),r.redirect("back");case 69:case"end":return e.stop()}},null,null,[[1,63],[15,56]])}),module.exports=router;
//# sourceMappingURL=booking.min.js.map
