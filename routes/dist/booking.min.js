"use strict";var express=require("express"),router=express.Router(),Model_Reservasi=require("../models/Model_Reservasi"),Model_Jadwal=require("../models/Model_Jadwal"),Model_Pembayaran=require("../models/Model_Pembayaran"),Model_Arena=require("../models/Model_Arena");router.post("/create",function(a,r){var t,n,s,o,i,u,d,l,m,c,g,p,k,b,_,f,w;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=require("../config/database"),e.prev=1,n=a.body,s=n.id_jadwal,o=n.payment_method,i=n.amount,u=a.session.user?a.session.user.id:null){e.next=7;break}return a.flash("error_msg","Anda harus login untuk melakukan booking."),e.abrupt("return",r.redirect("/auth/login"));case 7:if(s&&o){e.next=10;break}return a.flash("error_msg","Data booking tidak lengkap."),e.abrupt("return",r.redirect("back"));case 10:if(["cod","midtrans"].includes(o)){e.next=13;break}return a.flash("error_msg","Metode pembayaran tidak valid."),e.abrupt("return",r.redirect("back"));case 13:return e.next=15,regeneratorRuntime.awrap(new Promise(function(a,r){t.beginTransaction(function(e){e?r(e):a()})}));case 15:return e.prev=15,e.next=18,regeneratorRuntime.awrap(new Promise(function(r,n){t.query("SELECT * FROM jadwal WHERE id_jadwal = ? FOR UPDATE",[s],function(e,a){e?n(e):r(a)})}));case 18:if(0===(d=e.sent).length)throw new Error("Jadwal tidak ditemukan.");e.next=21;break;case 21:if("kosong"!==d[0].status_slot)throw new Error("Maaf, slot ini sudah dipesan atau sedang menunggu konfirmasi.");e.next=23;break;case 23:return l=d[0].id_arena,e.next=26,regeneratorRuntime.awrap(Model_Arena.getById(l));case 26:if(0===(m=e.sent).length)throw new Error("Arena tidak ditemukan.");e.next=29;break;case 29:if(c=m[0].harga||0,g=c,"midtrans"!==o){e.next=35;break}if(!i||isNaN(parseFloat(i)))throw new Error("Jumlah pembayaran tidak valid.");e.next=34;break;case 34:g=parseFloat(i);case 35:return p={id_user:u,id_arena:l,id_jadwal:s,status:"menunggu",payment_method:o,payment_status:"cod"===o?"pending":"unpaid",amount:g},e.next=38,regeneratorRuntime.awrap(Model_Reservasi.Store(p));case 38:return k=e.sent,b=k.insertId,_={id_reservasi:b,metode_pembayaran:o,status_pembayaran:"cod"===o?"pending":"unpaid",jumlah:g,tanggal_pembayaran:new Date,bukti_pembayaran:null,catatan_admin:null,konfirmasi_admin:!1},e.next=43,regeneratorRuntime.awrap(Model_Pembayaran.Store(_));case 43:return e.next=45,regeneratorRuntime.awrap(Model_Jadwal.Update(s,{status_slot:"menunggu"}));case 45:return e.next=47,regeneratorRuntime.awrap(new Promise(function(a,r){t.commit(function(e){e?r(e):a()})}));case 47:f="cod"===o?"Booking COD berhasil! Menunggu konfirmasi Admin.":"Booking berhasil! Silakan selesaikan pembayaran.",a.flash("success_msg",f),r.redirect("/pemain/profile"),e.next=57;break;case 52:return e.prev=52,e.t0=e.catch(15),e.next=56,regeneratorRuntime.awrap(new Promise(function(a,r){t.rollback(function(e){e?r(e):a()})}));case 56:throw e.t0;case 57:e.next=65;break;case 59:e.prev=59,e.t1=e.catch(1),console.error("Booking error:",e.t1),w=e.t1.message||"Maaf, terjadi kesalahan saat melakukan booking.",a.flash("error_msg",w),r.redirect("back");case 65:case"end":return e.stop()}},null,null,[[1,59],[15,52]])}),module.exports=router;
//# sourceMappingURL=booking.min.js.map
