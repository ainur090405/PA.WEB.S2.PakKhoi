"use strict";function _slicedToArray(e,r){return _arrayWithHoles(e)||_iterableToArrayLimit(e,r)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,r){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var t=[],a=!0,s=!1,n=void 0;try{for(var i,o=e[Symbol.iterator]();!(a=(i=o.next()).done)&&(t.push(i.value),!r||t.length!==r);a=!0);}catch(e){s=!0,n=e}finally{try{a||null==o.return||o.return()}finally{if(s)throw n}}return t}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var express=require("express"),router=express.Router(),Model_Users=require("../models/Model_Users"),Model_Reservasi=require("../models/Model_Reservasi"),Model_Ulasan=require("../models/Model_Ulasan"),Model_Notifikasi=require("../models/Model_Notifikasi"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isPemain=_require.isPemain;router.use(isAuthenticated,isPemain);var isBusy=!1;function autoUpdateStatus(){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(isBusy)return e.abrupt("return");e.next=2;break;case 2:return isBusy=!0,e.prev=3,e.next=6,regeneratorRuntime.awrap(Model_Reservasi.autoUpdateStatus());case 6:console.log("✅ Auto update status selesai - ".concat((new Date).toISOString())),e.next=12;break;case 9:e.prev=9,e.t0=e.catch(3),console.error("❌ Gagal auto update status:",e.t0);case 12:return e.prev=12,isBusy=!1,e.finish(12);case 15:case"end":return e.stop()}},null,null,[[3,9,12,15]])}setInterval(autoUpdateStatus,6e4),router.use(function(e,r,t){if(isBusy)return e.flash("error_msg","Server sedang sibuk, silakan coba lagi beberapa saat."),r.redirect("back");t()}),router.get("/dashboard",function(r,t){var a,s,n,i,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.session.user.id,e.next=4,regeneratorRuntime.awrap(Promise.all([Model_Reservasi.getByUser(a),Model_Notifikasi.getByUser(a)]));case 4:s=e.sent,n=_slicedToArray(s,2),i=n[0],o=n[1],u={totalBookings:i.length,activeBookings:i.filter(function(e){return"disetujui"===e.status||"menunggu"===e.status}).length,totalSpent:i.reduce(function(e,r){return e+(r.amount||0)},0)},t.render("pemain/dashboard",{title:"Dashboard Pemain",stats:u,recentBookings:i.slice(0,5),notifications:o}),e.next=17;break;case 12:e.prev=12,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memuat dashboard."),t.redirect("/");case 17:case"end":return e.stop()}},null,null,[[0,12]])}),router.get("/profile",function(r,t){var a,s,n,i,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.session.user.id,e.next=4,regeneratorRuntime.awrap(Promise.all([Model_Users.getById(a),Model_Ulasan.getByUser(a),Model_Reservasi.getByUser(a)]));case 4:if(s=e.sent,n=_slicedToArray(s,3),i=n[0],o=n[1],u=n[2],0===i.length)return r.flash("error_msg","User tidak ditemukan."),e.abrupt("return",t.redirect("/pemain/dashboard"));e.next=12;break;case 12:t.render("pemain/profile",{title:"Profil Saya",user:i[0],ulasan:o,reservasi:u}),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memuat halaman profil."),t.redirect("/pemain/dashboard");case 20:case"end":return e.stop()}},null,null,[[0,15]])}),router.post("/ulasan/create/:id",function(r,t){var a,s,n,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.session.user.id,s=r.params.id,n=r.body,i=n.rating,o=n.komentar,e.next=6,regeneratorRuntime.awrap(Model_Ulasan.Store({id_user:a,id_reservasi:s,rating:i,komentar:o}));case 6:r.flash("success_msg","Ulasan berhasil disimpan!"),t.redirect("/pemain/profile"),e.next=15;break;case 10:e.prev=10,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal menyimpan ulasan"),t.redirect("/pemain/profile");case 15:case"end":return e.stop()}},null,null,[[0,10]])}),router.post("/ulasan/update/:id",function(r,t){var a,s,n,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,a=r.params.id,s=r.body,n=s.rating,i=s.komentar,e.next=5,regeneratorRuntime.awrap(Model_Ulasan.UpdateByReservasi(a,{rating:n,komentar:i}));case 5:r.flash("success_msg","Ulasan berhasil diperbarui!"),t.redirect("/pemain/profile"),e.next=14;break;case 9:e.prev=9,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memperbarui ulasan"),t.redirect("/pemain/profile");case 14:case"end":return e.stop()}},null,null,[[0,9]])}),module.exports=router;
//# sourceMappingURL=pemain.min.js.map
