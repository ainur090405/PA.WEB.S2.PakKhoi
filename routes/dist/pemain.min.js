"use strict";function _slicedToArray(e,a){return _arrayWithHoles(e)||_iterableToArrayLimit(e,a)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,a){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var r=[],t=!0,n=!1,s=void 0;try{for(var i,o=e[Symbol.iterator]();!(t=(i=o.next()).done)&&(r.push(i.value),!a||r.length!==a);t=!0);}catch(e){n=!0,s=e}finally{try{t||null==o.return||o.return()}finally{if(n)throw s}}return r}}function _arrayWithHoles(e){if(Array.isArray(e))return e}var express=require("express"),router=express.Router(),fs=require("fs"),path=require("path"),PDFDocument=require("pdfkit"),connection=require("../config/database"),Model_Jadwal=require("../models/Model_Jadwal"),Model_Users=require("../models/Model_Users"),Model_Reservasi=require("../models/Model_Reservasi"),Model_Ulasan=require("../models/Model_Ulasan"),Model_Notifikasi=require("../models/Model_Notifikasi"),Model_Pembayaran=require("../models/Model_Pembayaran"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isPemain=_require.isPemain,_require2=require("../middleware/uploadMiddleware"),uploadBuktiPembayaran=_require2.uploadBuktiPembayaran;router.use(isAuthenticated,isPemain);var isBusy=!1;function autoUpdateStatus(){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(isBusy)return e.abrupt("return");e.next=2;break;case 2:return isBusy=!0,e.prev=3,e.next=6,regeneratorRuntime.awrap(Model_Reservasi.autoUpdateStatus());case 6:return e.next=8,regeneratorRuntime.awrap(Model_Pembayaran.autoRejectNoProof());case 8:return e.next=10,regeneratorRuntime.awrap(Model_Pembayaran.autoRejectLateConfirmed());case 10:console.log("AUTO UPDATE OK - ".concat((new Date).toISOString())),e.next=16;break;case 13:e.prev=13,e.t0=e.catch(3),console.error("AUTO UPDATE ERROR:",e.t0);case 16:return e.prev=16,isBusy=!1,e.finish(16);case 19:case"end":return e.stop()}},null,null,[[3,13,16,19]])}setInterval(autoUpdateStatus,6e4),router.use(function(e,a,r){if(isBusy)return e.flash("error_msg","Server sedang update, coba sebentar lagi."),a.redirect("back");r()}),router.get("/dashboard",function(a,r){var t,n,s,i,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.session.user.id,e.next=4,regeneratorRuntime.awrap(Promise.all([Model_Reservasi.getByUser(t),Model_Notifikasi.getByUser(t)]));case 4:n=e.sent,s=_slicedToArray(n,2),i=s[0],o=s[1],u={totalBookings:i.length,activeBookings:i.filter(function(e){return"disetujui"===e.status||"menunggu"===e.status}).length,totalSpent:i.reduce(function(e,a){return e+(a.pembayaran_jumlah||0)},0)},r.render("pemain/dashboard",{title:"Dashboard Pemain",stats:u,recentBookings:i.slice(0,5),notifications:o}),e.next=17;break;case 12:e.prev=12,e.t0=e.catch(0),console.error(e.t0),a.flash("error_msg","Gagal memuat dashboard."),r.redirect("/");case 17:case"end":return e.stop()}},null,null,[[0,12]])}),router.get("/profile",function(a,r){var t,n,s,i,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.session.user.id,e.next=4,regeneratorRuntime.awrap(Promise.all([Model_Users.getById(t),Model_Ulasan.getByUser(t),Model_Reservasi.getByUser(t)]));case 4:if(n=e.sent,s=_slicedToArray(n,3),i=s[0],o=s[1],u=s[2],i&&0!==i.length){e.next=12;break}return a.flash("error_msg","User tidak ditemukan."),e.abrupt("return",r.redirect("/pemain/dashboard"));case 12:r.render("pemain/profile",{title:"Profil Saya",user:i[0],ulasan:o,reservasi:u}),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(0),console.error(e.t0),a.flash("error_msg","Gagal memuat halaman profil."),r.redirect("/pemain/dashboard");case 20:case"end":return e.stop()}},null,null,[[0,15]])}),router.post("/ulasan/create/:id",function(a,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Ulasan.Store({id_user:a.session.user.id,id_reservasi:a.params.id,rating:a.body.rating,komentar:a.body.komentar}));case 3:a.flash("success_msg","Ulasan berhasil disimpan!"),r.redirect("/pemain/riwayat-ulasan"),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error(e.t0),a.flash("error_msg","Gagal menyimpan ulasan"),r.redirect("/pemain/riwayat-ulasan");case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.post("/ulasan/update/:id",function(a,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Ulasan.UpdateByReservasi(a.params.id,{rating:a.body.rating,komentar:a.body.komentar}));case 3:a.flash("success_msg","Ulasan berhasil diperbarui!"),r.redirect("/pemain/riwayat-ulasan"),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error(e.t0),a.flash("error_msg","Gagal memperbarui ulasan"),r.redirect("/pemain/riwayat-ulasan");case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/riwayat-ulasan",function(a,r){var t,n,s,i,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.session.user.id,e.next=4,regeneratorRuntime.awrap(Promise.all([Model_Users.getById(t),Model_Ulasan.getByUser(t),Model_Reservasi.getByUser(t)]));case 4:n=e.sent,s=_slicedToArray(n,3),i=s[0],o=s[1],u=s[2],r.render("pemain/riwayat-ulasan",{title:"Riwayat & Ulasan",user:i[0]||null,ulasan:o||[],reservasi:u||[]}),e.next=17;break;case 12:e.prev=12,e.t0=e.catch(0),console.error(e.t0),a.flash("error_msg","Gagal memuat halaman."),r.redirect("/pemain/dashboard");case 17:case"end":return e.stop()}},null,null,[[0,12]])}),router.post("/upload-bukti/:id_reservasi",function(n,s){var i=parseInt(n.params.id_reservasi,10),o=n.session.user.id;uploadBuktiPembayaran.single("bukti_pembayaran")(n,s,function(a){var r,t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,a)return console.error("MULTER ERROR:",a),r="LIMIT_FILE_SIZE"===a.code?"File terlalu besar (maks 5MB).":a.message||"Gagal mengupload file.",n.flash("error_msg",r),e.abrupt("return",s.redirect("/pemain/riwayat-ulasan"));e.next=6;break;case 6:return e.next=8,regeneratorRuntime.awrap(Model_Reservasi.getById(i));case 8:if((t=e.sent)&&0!==t.length&&t[0].id_user===o){e.next=13;break}return n.file&&n.file.path&&fs.unlink(n.file.path,function(){}),n.flash("error_msg","Reservasi tidak valid atau tidak memiliki akses."),e.abrupt("return",s.redirect("/pemain/riwayat-ulasan"));case 13:if(n.file){e.next=16;break}return n.flash("error_msg","Silakan pilih file bukti pembayaran."),e.abrupt("return",s.redirect("/pemain/riwayat-ulasan"));case 16:return e.next=18,regeneratorRuntime.awrap(Model_Pembayaran.uploadBuktiByReservasi(i,n.file.filename));case 18:return n.flash("success_msg","Bukti berhasil diupload! Menunggu konfirmasi admin."),e.abrupt("return",s.redirect("/pemain/riwayat-ulasan"));case 22:return e.prev=22,e.t0=e.catch(0),console.error("UPLOAD HANDLER ERROR:",e.t0),n.file&&n.file.path&&fs.unlink(n.file.path,function(){}),n.flash("error_msg","Terjadi kesalahan saat mengupload bukti."),e.abrupt("return",s.redirect("/pemain/riwayat-ulasan"));case 28:case"end":return e.stop()}},null,null,[[0,22]])})}),router.get("/detail-pembayaran/:id_reservasi",function(a,r){var t,n,s,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=parseInt(a.params.id_reservasi,10),n=a.session.user.id,e.next=5,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 5:if((s=e.sent)&&0!==s.length&&s[0].id_user===n){e.next=8;break}return e.abrupt("return",r.json({success:!1,message:"Akses ditolak"}));case 8:return i=s[0],o={metode_pembayaran:i.pembayaran_metode,jumlah:i.pembayaran_jumlah,status_pembayaran:i.pembayaran_status,status_bukti:i.pembayaran_status_bukti,tanggal_pembayaran:i.pembayaran_tanggal,bukti_pembayaran:i.pembayaran_bukti,catatan_admin:i.pembayaran_catatan},e.abrupt("return",r.json({success:!0,pembayaran:o,reservasi:i}));case 13:return e.prev=13,e.t0=e.catch(0),console.error("Detail pembayaran error:",e.t0),e.abrupt("return",r.json({success:!1,message:"Error server"}));case 17:case"end":return e.stop()}},null,null,[[0,13]])}),router.post("/expire-upload/:id_reservasi",function(a,r){var t,n,s,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=parseInt(a.params.id_reservasi,10),n=a.session.user.id,s=a.body&&a.body.reason||"Batas waktu upload bukti pembayaran telah habis dan data tidak lengkap.",e.next=6,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 6:if((i=e.sent)&&0!==i.length&&i[0].id_user===n){e.next=9;break}return e.abrupt("return",r.status(403).json({success:!1,message:"Akses ditolak"}));case 9:if("menunggu"!==(o=i[0]).status||o.pembayaran_bukti)return e.abrupt("return",r.json({success:!0,skipped:!0}));e.next=12;break;case 12:if("function"==typeof Model_Reservasi.rejectAndFreeSlot)return e.next=15,regeneratorRuntime.awrap(Model_Reservasi.rejectAndFreeSlot(t));e.next=17;break;case 15:e.next=28;break;case 17:return e.next=19,regeneratorRuntime.awrap(Model_Reservasi.Update(t,{status:"ditolak"}));case 19:if(o.id_jadwal)return e.prev=20,e.next=23,regeneratorRuntime.awrap(Model_Jadwal.Update(o.id_jadwal,{status_slot:"kosong"}));e.next=28;break;case 23:e.next=28;break;case 25:e.prev=25,e.t0=e.catch(20),console.warn("Gagal update jadwal saat expire-upload:",e.t0);case 28:if("function"==typeof Model_Pembayaran.setExpiredByReservasi)return e.next=31,regeneratorRuntime.awrap(Model_Pembayaran.setExpiredByReservasi(t,s));e.next=33;break;case 31:e.next=36;break;case 33:if("function"==typeof Model_Pembayaran.markRejectedByReservasi)return e.next=36,regeneratorRuntime.awrap(Model_Pembayaran.markRejectedByReservasi(t,s));e.next=36;break;case 36:if(o.id_user&&"function"==typeof Model_Notifikasi.Store)return e.next=39,regeneratorRuntime.awrap(Model_Notifikasi.Store({id_user:o.id_user,judul:"Pembayaran Ditolak (Waktu Upload Habis)",isi_pesan:"Pembayaran Anda untuk arena ".concat(o.nama_arena||"Arena"," ditolak karena batas waktu upload bukti (20 menit) telah habis dan data pembayaran tidak lengkap."),jenis_notif:"status",tipe:"payment",dibaca:0}));e.next=39;break;case 39:return e.abrupt("return",r.json({success:!0}));case 42:return e.prev=42,e.t1=e.catch(0),console.error("expire-upload error:",e.t1),e.abrupt("return",r.status(500).json({success:!1,message:"Error server"}));case 46:case"end":return e.stop()}},null,null,[[0,42],[20,25]])}),router.get("/download-pdf/:id_reservasi",function(a,r){var t,n,s,i,o,u,l,c,d,m,p,g,b,f;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.session.user.id,n=parseInt(a.params.id_reservasi,10),e.next=5,regeneratorRuntime.awrap(Model_Reservasi.getById(n));case 5:if((s=e.sent)&&0!==s.length&&s[0].id_user===t){e.next=9;break}return a.flash("error_msg","Akses ditolak."),e.abrupt("return",r.redirect("/pemain/riwayat-ulasan"));case 9:if(i=s[0],o=i.pembayaran_bukti||null,u=o?path.join(__dirname,"..","public","uploads","bukti_pembayaran",o):null,console.log("PDF download, bukti file =",o),console.log("Bukti path =",u),l=new PDFDocument({margin:40,autoFirstPage:!0}),c="detail_pembayaran_".concat(n,".pdf"),r.setHeader("Content-Disposition",'attachment; filename="'.concat(c,'"')),r.setHeader("Content-Type","application/pdf"),l.pipe(r),l.fontSize(18).text("Detail Pembayaran",{align:"center"}),l.moveDown(.5),l.fontSize(10).text("Tanggal Cetak: ".concat((new Date).toLocaleString("id-ID")),{align:"right"}),l.moveDown(1),l.fontSize(12).text("Informasi Reservasi",{underline:!0}),l.moveDown(.3),l.fontSize(11).text("ID Reservasi : ".concat(i.id_reservasi)).text("Pemesan      : ".concat(i.nama_user||"-")).text("Arena        : ".concat(i.nama_arena||"-")).text("Tanggal      : ".concat(i.tanggal?new Date(i.tanggal).toLocaleDateString("id-ID"):"-")).text("Jam          : ".concat(i.jam_mulai?i.jam_mulai.substring(0,5):"-"," - ").concat(i.jam_selesai?i.jam_selesai.substring(0,5):"-")).text("Status       : ".concat(i.status||"-")).moveDown(.8),l.fontSize(12).text("Detail Pembayaran",{underline:!0}),l.moveDown(.3),d=i.pembayaran_metode||"transaksi",m=i.pembayaran_jumlah||0,p=i.pembayaran_status||"-",l.fontSize(11).text("Metode Pembayaran : ".concat(d)).text("Jumlah            : Rp ".concat(Number(m).toLocaleString("id-ID"))).text("Status Pembayaran : ".concat(p)).text("Tanggal Pembayaran: ".concat(i.pembayaran_tanggal?new Date(i.pembayaran_tanggal).toLocaleString("id-ID"):"-")).moveDown(.8),l.fontSize(12).text("Rekening Tujuan",{underline:!0}),l.moveDown(.3),l.fontSize(11).text("Bank        : -").text("No. Rekening: -").text("Atas Nama   : -").moveDown(.8),u&&fs.existsSync(u))try{g=path.extname(o).toLowerCase(),console.log("Ekstensi bukti:",g),[".jpg",".jpeg",".png"].includes(g)?(b=fs.readFileSync(u),l.addPage(),l.fontSize(14).text("Bukti Pembayaran",{align:"center"}),l.moveDown(.5),l.image(b,{fit:[450,650],align:"center",valign:"center"})):(l.addPage(),l.fontSize(14).text("Bukti Pembayaran",{align:"center"}),l.moveDown(.5),l.fontSize(11).fillColor("red").text("Format gambar bukti (".concat(g,") tidak didukung. Gunakan JPG/PNG untuk bisa muncul di PDF."),{align:"center"}),l.fillColor("black"))}catch(e){console.error("Gagal sisipkan gambar ke PDF:",e),l.addPage(),l.fontSize(14).text("Bukti Pembayaran",{align:"center"}),l.moveDown(.5),l.fontSize(11).fillColor("red").text("Gagal memuat gambar bukti ke PDF.",{align:"center"}),l.fillColor("black")}else l.moveDown(.3),l.fontSize(10).fillColor("gray").text("Bukti pembayaran: -",{align:"left"}),l.fillColor("black");(f=i.pembayaran_catatan||null)&&(l.addPage(),l.fontSize(12).text("Catatan Admin",{underline:!0}),l.moveDown(.3),l.fontSize(11).text(f)),l.end(),e.next=46;break;case 41:return e.prev=41,e.t0=e.catch(0),console.error("Download PDF error:",e.t0),a.flash("error_msg","Gagal membuat PDF. Silakan coba lagi."),e.abrupt("return",r.redirect("/pemain/riwayat-ulasan"));case 46:case"end":return e.stop()}},null,null,[[0,41]])}),module.exports=router;
//# sourceMappingURL=pemain.min.js.map
