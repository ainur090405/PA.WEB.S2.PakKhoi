{"version":3,"sources":["foto.js"],"names":["express","require","router","Router","Model_Arena","Model_FotoArena","uploadArena","isAuthenticated","isAdmin","fs","path","use","get","req","res","id_arena","params","Promise","all","getById","getByArenaId","arenaData","fotoData","length","flash","redirect","render","title","nama_arena","arena","fotoList","message","post","array","deskripsi","body","files","file","dataFoto","url_foto","filename","Store","id_foto","filePath","join","__dirname","existsSync","unlinkSync","Delete","setCover","module","exports"],"mappings":"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","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Arena = require('../models/Model_Arena');\r\nconst Model_FotoArena = require('../models/Model_FotoArena');\r\nconst { uploadArena } = require('../middleware/uploadMiddleware');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\nconst fs = require('fs'); // Untuk hapus file\r\nconst path = require('path'); // Untuk hapus file\r\n\r\n// Lindungi semua rute di file ini, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n/**\r\n * =======================================================\r\n * GET: Halaman Manajemen Galeri (Tampilan Utama)\r\n * =======================================================\r\n * Menampilkan form upload dan semua foto yang sudah ada\r\n * untuk satu arena spesifik.\r\n */\r\nrouter.get('/manage/:id_arena', async (req, res) => {\r\n  try {\r\n    const id_arena = req.params.id_arena;\r\n    \r\n    // Ambil data arena (untuk judul) dan data foto (untuk galeri)\r\n    const [arenaData, fotoData] = await Promise.all([\r\n      Model_Arena.getById(id_arena),\r\n      Model_FotoArena.getByArenaId(id_arena)\r\n    ]);\r\n\r\n    if (arenaData.length === 0) {\r\n      req.flash('error_msg', 'Arena tidak ditemukan.');\r\n      return res.redirect('/arena');\r\n    }\r\n\r\n    res.render('admin/foto/manage', {\r\n      title: `Galeri Foto: ${arenaData[0].nama_arena}`,\r\n      arena: arenaData[0], // Kirim data arena (untuk id_foto_cover)\r\n      fotoList: fotoData // Kirim daftar foto\r\n    });\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memuat galeri: ' + err.message);\r\n    res.redirect('/arena');\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * POST: Upload Foto Baru (Multi-Upload)\r\n * =======================================================\r\n * Menerima upload (bisa banyak file) dan menyimpannya.\r\n */\r\nrouter.post('/store/:id_arena', uploadArena.array('foto_galeri', 10), async (req, res) => {\r\n  // 'foto_galeri' adalah 'name' dari input file, '10' adalah batas max file\r\n  const id_arena = req.params.id_arena;\r\n  try {\r\n    const deskripsi = req.body.deskripsi; // Ambil 1 deskripsi dari form\r\n\r\n    if (!req.files || req.files.length === 0) {\r\n      req.flash('error_msg', 'Anda tidak memilih file untuk di-upload.');\r\n      return res.redirect(`/foto/manage/${id_arena}`);\r\n    }\r\n\r\n    // Loop semua file yang di-upload\r\n    for (const file of req.files) {\r\n      const dataFoto = {\r\n        id_arena: id_arena,\r\n        url_foto: '/uploads/arena/' + file.filename,\r\n        deskripsi: deskripsi // Terapkan deskripsi yang sama ke semua foto\r\n      };\r\n      await Model_FotoArena.Store(dataFoto);\r\n    }\r\n\r\n    req.flash('success_msg', `${req.files.length} foto berhasil di-upload.`);\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal upload foto: ' + err.message);\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * GET: Hapus 1 Foto\r\n * =======================================================\r\n * Menghapus file fisik dari server DAN datanya dari DB.\r\n */\r\nrouter.get('/delete/:id_arena/:id_foto', async (req, res) => {\r\n  const { id_arena, id_foto } = req.params;\r\n  try {\r\n    // 1. Ambil data foto untuk dapat path file\r\n    const fotoData = await Model_FotoArena.getById(id_foto);\r\n    if (fotoData.length > 0 && fotoData[0].url_foto) {\r\n      // 2. Hapus file fisik\r\n      const filePath = path.join(__dirname, '../public', fotoData[0].url_foto);\r\n      if (fs.existsSync(filePath)) {\r\n        fs.unlinkSync(filePath);\r\n      }\r\n    }\r\n    // 3. Hapus data dari DB\r\n    await Model_FotoArena.Delete(id_foto);\r\n    req.flash('success_msg', 'Foto berhasil dihapus.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal menghapus foto.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\n/**\r\n * =======================================================\r\n * GET: Set 1 Foto sebagai Cover\r\n * =======================================================\r\n * Meng-update tabel 'arena' dengan 'id_foto_cover' yang baru.\r\n */\r\nrouter.get('/setcover/:id_arena/:id_foto', async (req, res) => {\r\n  const { id_arena, id_foto } = req.params;\r\n  try {\r\n    await Model_Arena.setCover(id_arena, id_foto);\r\n    req.flash('success_msg', 'Foto cover berhasil diperbarui.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal set foto cover.');\r\n    res.redirect(`/foto/manage/${id_arena}`);\r\n  }\r\n});\r\n\r\nmodule.exports = router;"],"file":"foto.dev.js"}