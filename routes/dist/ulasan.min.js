"use strict";var express=require("express"),router=express.Router(),Model_Ulasan=require("../models/Model_Ulasan"),Model_Reservasi=require("../models/Model_Reservasi"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isPemain=_require.isPemain;router.use(isAuthenticated,isPemain),router.get("/create/:id_reservasi",function(r,a){var s,t,n,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.id_reservasi,t=r.session.user.id,e.next=5,regeneratorRuntime.awrap(Model_Reservasi.getById(s));case 5:if(0===(n=e.sent).length)return r.flash("error_msg","Reservasi tidak ditemukan."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=9;break;case 9:if((i=n[0]).id_user!==t)return r.flash("error_msg","Anda tidak memiliki akses ke reservasi ini."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=13;break;case 13:if("selesai"!==i.status)return r.flash("error_msg","Anda hanya bisa memberikan ulasan untuk reservasi yang sudah selesai."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=16;break;case 16:return e.next=18,regeneratorRuntime.awrap(Model_Ulasan.getByReservasi(s));case 18:if(0<e.sent.length)return r.flash("error_msg","Anda sudah memberikan ulasan untuk reservasi ini."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=22;break;case 22:a.render("pemain/ulasan/create",{title:"Beri Ulasan",reservasi:i}),e.next=30;break;case 25:e.prev=25,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memuat halaman ulasan."),a.redirect("/pemain/profile");case 30:case"end":return e.stop()}},null,null,[[0,25]])}),router.post("/create/:id_reservasi",function(r,a){var s,t,n,i,u,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=r.params.id_reservasi,t=r.session.user.id,n=r.body,i=n.rating,u=n.komentar,!i||i<1||5<i)return r.flash("error_msg","Rating harus antara 1-5."),e.abrupt("return",a.redirect("back"));e.next=7;break;case 7:return e.next=9,regeneratorRuntime.awrap(Model_Ulasan.getByReservasi(s));case 9:if(0<e.sent.length)return r.flash("error_msg","Anda sudah memberikan ulasan untuk reservasi ini."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=13;break;case 13:return l={id_user:t,id_reservasi:s,rating:parseInt(i),komentar:u||null},e.next=16,regeneratorRuntime.awrap(Model_Ulasan.Store(l));case 16:r.flash("success_msg","Terima kasih atas ulasan Anda!"),a.redirect("/pemain/profile"),e.next=25;break;case 20:e.prev=20,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal menyimpan ulasan."),a.redirect("back");case 25:case"end":return e.stop()}},null,null,[[0,20]])}),router.get("/edit/:id_reservasi",function(r,a){var s,t,n,i,u,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.id_reservasi,t=r.session.user.id,e.next=5,regeneratorRuntime.awrap(Model_Ulasan.getByReservasi(s));case 5:if(0===(n=e.sent).length)return r.flash("error_msg","Ulasan tidak ditemukan."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=9;break;case 9:if((i=n[0]).id_user!==t)return r.flash("error_msg","Anda tidak memiliki akses ke ulasan ini."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=13;break;case 13:return e.next=15,regeneratorRuntime.awrap(Model_Reservasi.getById(s));case 15:u=e.sent,l=u[0],a.render("pemain/ulasan/edit",{title:"Edit Ulasan",ulasan:i,reservasi:l}),e.next=25;break;case 20:e.prev=20,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memuat halaman edit ulasan."),a.redirect("/pemain/profile");case 25:case"end":return e.stop()}},null,null,[[0,20]])}),router.post("/update/:id_reservasi",function(r,a){var s,t,n,i,u,l,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,s=r.params.id_reservasi,t=r.session.user.id,n=r.body,i=n.rating,u=n.komentar,!i||i<1||5<i)return r.flash("error_msg","Rating harus antara 1-5."),e.abrupt("return",a.redirect("back"));e.next=7;break;case 7:return e.next=9,regeneratorRuntime.awrap(Model_Ulasan.getByReservasi(s));case 9:if(0===(l=e.sent).length||l[0].id_user!==t)return r.flash("error_msg","Ulasan tidak ditemukan atau Anda tidak memiliki akses."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=13;break;case 13:return o={rating:parseInt(i),komentar:u||null},e.next=16,regeneratorRuntime.awrap(Model_Ulasan.Update(s,o));case 16:r.flash("success_msg","Ulasan berhasil diperbarui!"),a.redirect("/pemain/profile"),e.next=25;break;case 20:e.prev=20,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memperbarui ulasan."),a.redirect("back");case 25:case"end":return e.stop()}},null,null,[[0,20]])}),router.post("/delete/:id_reservasi",function(r,a){var s,t,n;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,s=r.params.id_reservasi,t=r.session.user.id,e.next=5,regeneratorRuntime.awrap(Model_Ulasan.getByReservasi(s));case 5:if(0===(n=e.sent).length||n[0].id_user!==t)return r.flash("error_msg","Ulasan tidak ditemukan atau Anda tidak memiliki akses."),e.abrupt("return",a.redirect("/pemain/profile"));e.next=9;break;case 9:return e.next=11,regeneratorRuntime.awrap(Model_Ulasan.Delete(s));case 11:r.flash("success_msg","Ulasan berhasil dihapus."),a.redirect("/pemain/profile"),e.next=20;break;case 15:e.prev=15,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal menghapus ulasan."),a.redirect("/pemain/profile");case 20:case"end":return e.stop()}},null,null,[[0,15]])}),module.exports=router;
//# sourceMappingURL=ulasan.min.js.map
