{"version":3,"sources":["reservasi.js"],"names":["express","require","router","Router","Model_Reservasi","Model_Jadwal","Model_Notifikasi","Model_LogReservasi","isAuthenticated","isAdmin","use","get","req","res","getAll","reservasi","render","title","data","console","error","flash","redirect","id","parseInt","params","getById","rows","length","logs","getByReservasi","warn","post","id_reservasi","status","body","rowsBefore","reservasiBefore","status_awal","rejectAndFreeSlot","Update","r","id_jadwal","status_slot","catatStatus","id_user","notif","judul","toUpperCase","isi_pesan","nama_arena","jenis_notif","tipe","dibaca","Store","catatan","dataToUpdate","message","Delete","code","csv","forEach","tanggalMain","tanggal","Date","toLocaleDateString","jam","jam_mulai","substring","tanggalPesan","tanggal_pesan","metode","metode_pembayaran","statusPemb","status_pembayaran","jumlah","bukti","pembayaran_bukti","nama_user","replace","header","attachment","send","module","exports"],"mappings":"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","sourcesContent":["// routes/reservasi.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\n\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Jadwal = require('../models/Model_Jadwal');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst Model_LogReservasi = require('../models/Model_LogReservasi'); \r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Semua route di sini khusus admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// ============================\r\n// LIST RESERVASI (ADMIN)\r\n// ============================\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    res.render('admin/reservasi/index', {\r\n      title: 'Manajemen Reservasi',\r\n      data: reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi:', err);\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    return res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: form edit reservasi\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = parseInt(req.params.id, 10);\r\n\r\n    const rows = await Model_Reservasi.getById(id);\r\n    if (!rows || rows.length === 0) {\r\n      req.flash('error_msg', 'Data reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n\r\n    const reservasi = rows[0];\r\n\r\n    // ⬇️ AMBIL RIWAYAT LOG UNTUK RESERVASI INI\r\n    let logs = [];\r\n    try {\r\n      logs = await Model_LogReservasi.getByReservasi(id);\r\n    } catch (logErr) {\r\n      console.warn('Gagal mengambil log reservasi:', logErr);\r\n    }\r\n\r\n    res.render('admin/reservasi/edit', {\r\n      title: 'Update Status Reservasi',\r\n      reservasi,\r\n      logs   // dikirim ke view (kalau mau dipakai)\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi/edit:', err);\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\n// ============================\r\n// UPDATE STATUS (SINGLE FIELD)\r\n// ============================\r\nrouter.post('/update-status/:id', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id;\r\n    const { status } = req.body;\r\n\r\n    // ⬇️ AMBIL STATUS AWAL UNTUK LOG\r\n    const rowsBefore = await Model_Reservasi.getById(id_reservasi);\r\n    if (!rowsBefore || rowsBefore.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n    const reservasiBefore = rowsBefore[0];\r\n    const status_awal = reservasiBefore.status;\r\n\r\n    // =======================\r\n    // LOGIKA LAMA (TIDAK DIUBAH)\r\n    // =======================\r\n    if (status === 'ditolak') {\r\n      if (typeof Model_Reservasi.rejectAndFreeSlot === 'function') {\r\n        await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n      } else {\r\n        await Model_Reservasi.Update(id_reservasi, { status: 'ditolak' });\r\n        const r = await Model_Reservasi.getById(id_reservasi);\r\n        if (r && r[0] && r[0].id_jadwal) {\r\n          await Model_Jadwal.Update(r[0].id_jadwal, { status_slot: 'kosong' });\r\n        }\r\n      }\r\n    } else {\r\n      // Status lain: cukup update status reservasi + sinkron jadwal\r\n      await Model_Reservasi.Update(id_reservasi, { status });\r\n\r\n      const rows = await Model_Reservasi.getById(id_reservasi);\r\n      if (rows && rows[0]) {\r\n        const id_jadwal = rows[0].id_jadwal;\r\n        if (id_jadwal) {\r\n          if (status === 'disetujui') {\r\n            await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n          } else if (status === 'batal' || status === 'ditolak') {\r\n            await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n          } else if (status === 'selesai') {\r\n            await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n    // ⬇️ CATAT LOG PERUBAHAN STATUS\r\n    try {\r\n      await Model_LogReservasi.catatStatus(\r\n        id_reservasi,\r\n        status_awal,\r\n        status,\r\n        'Update via tombol cepat /update-status'\r\n      );\r\n    } catch (logErr) {\r\n      console.warn('Gagal mencatat log reservasi (update-status):', logErr);\r\n    }\r\n\r\n    // Kirim notifikasi ke user (opsional)\r\n    try {\r\n      const rows = await Model_Reservasi.getById(id_reservasi);\r\n      if (rows && rows[0] && rows[0].id_user) {\r\n        const r = rows[0];\r\n        const notif = {\r\n          id_user: r.id_user,\r\n          judul: `Status Booking: ${status.toUpperCase()}`,\r\n          isi_pesan:\r\n            status === 'disetujui'\r\n              ? `Booking Anda untuk arena ${r.nama_arena} telah disetujui.`\r\n              : status === 'ditolak'\r\n              ? `Maaf, booking Anda untuk arena ${r.nama_arena} ditolak.`\r\n              : status === 'selesai'\r\n              ? `Terima kasih telah bermain di ${r.nama_arena}.`\r\n              : `Status booking Anda telah berubah menjadi ${status}.`,\r\n          jenis_notif: 'status',\r\n          tipe: 'booking',\r\n          dibaca: 0\r\n        };\r\n        if (typeof Model_Notifikasi.Store === 'function') {\r\n          await Model_Notifikasi.Store(notif);\r\n        }\r\n      }\r\n    } catch (notifErr) {\r\n      console.warn('Gagal kirim notifikasi (non blocking):', notifErr);\r\n    }\r\n\r\n    req.flash('success_msg', `Status reservasi berhasil diperbarui menjadi ${status}.`);\r\n    return res.redirect('/admin/reservasi');\r\n\r\n  } catch (err) {\r\n    console.error('ERR POST /admin/reservasi/update-status:', err);\r\n    req.flash('error_msg', 'Gagal memperbarui status reservasi.');\r\n    return res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\n// ============================\r\n// UPDATE FORM LENGKAP (STATUS + CATATAN)\r\n// ============================\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  try {\r\n    const { status, catatan } = req.body;\r\n    const dataToUpdate = { status, catatan };\r\n\r\n    // ⬇️ AMBIL DATA & STATUS AWAL UNTUK LOG\r\n    const rows = await Model_Reservasi.getById(id);\r\n    if (!rows || rows.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n    const r = rows[0];\r\n    const status_awal = r.status;\r\n    const id_jadwal = r.id_jadwal;\r\n\r\n    // Update status & catatan (LOGIKA LAMA)\r\n    await Model_Reservasi.Update(id, dataToUpdate);\r\n\r\n    // Sinkron jadwal (LOGIKA LAMA)\r\n    if (id_jadwal) {\r\n      if (status === 'disetujui') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n      } else if (status === 'ditolak' || status === 'batal') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n      } else if (status === 'selesai') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n      }\r\n    }\r\n\r\n    // ⬇️ CATAT LOG PERUBAHAN STATUS + CATATAN\r\n    try {\r\n      await Model_LogReservasi.catatStatus(\r\n        id,\r\n        status_awal,\r\n        status,\r\n        catatan || null\r\n      );\r\n    } catch (logErr) {\r\n      console.warn('Gagal mencatat log reservasi (update form):', logErr);\r\n    }\r\n\r\n    // Notifikasi opsional (LOGIKA LAMA)\r\n    if (r.id_user) {\r\n      const notif = {\r\n        id_user: r.id_user,\r\n        judul: `Status Booking: ${status.toUpperCase()}`,\r\n        isi_pesan:\r\n          status === 'disetujui'\r\n            ? `Booking Anda untuk arena ${r.nama_arena} telah disetujui.`\r\n            : status === 'ditolak'\r\n            ? `Maaf, booking Anda untuk arena ${r.nama_arena} ditolak.`\r\n            : status === 'selesai'\r\n            ? `Terima kasih telah bermain di ${r.nama_arena}.`\r\n            : `Status booking Anda telah berubah menjadi ${status}.`,\r\n        jenis_notif: 'status',\r\n        tipe: 'booking',\r\n        dibaca: 0\r\n      };\r\n      if (typeof Model_Notifikasi.Store === 'function') {\r\n        await Model_Notifikasi.Store(notif);\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', 'Status reservasi berhasil diperbarui.');\r\n    return res.redirect('/admin/reservasi');\r\n  } catch (err) {\r\n    console.error('ERR POST /admin/reservasi/update:', err);\r\n    req.flash('error_msg', 'Gagal memperbarui reservasi: ' + err.message);\r\n    return res.redirect('/admin/reservasi/edit/' + id);\r\n  }\r\n});\r\n\r\n// ============================\r\n// DELETE RESERVASI\r\n// ============================\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  try {\r\n    await Model_Reservasi.Delete(req.params.id);\r\n    req.flash('success_msg', 'Data reservasi berhasil dihapus.');\r\n    return res.redirect('/admin/reservasi');\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi/delete:', err);\r\n    req.flash('error_msg', 'Gagal menghapus reservasi: ' + (err.message || err.code));\r\n    return res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\n// ============================\r\n// DOWNLOAD CSV\r\n// ============================\r\nrouter.get('/download', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    let csv = 'ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Metode Pembayaran,Status Pembayaran,Jumlah,Bukti\\n';\r\n\r\n    reservasi.forEach(r => {\r\n      const tanggalMain = r.tanggal ? new Date(r.tanggal).toLocaleDateString('id-ID') : '';\r\n      const jam = r.jam_mulai ? r.jam_mulai.substring(0, 5) : '';\r\n      const tanggalPesan = r.tanggal_pesan ? new Date(r.tanggal_pesan).toLocaleDateString('id-ID') : '';\r\n\r\n      const metode = r.metode_pembayaran || '';          // dari join pembayaran\r\n      const statusPemb = r.status_pembayaran || '';\r\n      const jumlah = r.jumlah || 0;                       // alias di model\r\n      const bukti = r.pembayaran_bukti || '';\r\n\r\n      csv += `${r.id_reservasi},\"${(r.nama_user || '').replace(/\"/g,'\"\"')}\",\"${(r.nama_arena || '').replace(/\"/g,'\"\"')}\",${tanggalMain},${jam},${tanggalPesan},${r.status || ''},${metode},${statusPemb},${jumlah},${bukti}\\n`;\r\n    });\r\n\r\n    res.header('Content-Type', 'text/csv');\r\n    res.attachment('reservasi.csv');\r\n    return res.send(csv);\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/reservasi/download:', err);\r\n    req.flash('error_msg', 'Gagal mendownload data reservasi.');\r\n    return res.redirect('/admin/reservasi');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"reservasi.dev.js"}