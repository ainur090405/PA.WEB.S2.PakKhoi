{"version":3,"sources":["reservasi.js"],"names":["express","require","router","Router","Model_Reservasi","Model_Pembayaran","isAuthenticated","isAdmin","use","get","req","res","getAll","reservasi","render","title","data","console","error","flash","redirect","id","params","getById","reservasiData","length","post","id_reservasi","status","body","rejectAndFreeSlot","Update","id_jadwal","Model_Jadwal","status_slot","catatan","dataToUpdate","Model_Notifikasi","id_user","notif","judul","toUpperCase","isi_pesan","nama_arena","jenis_notif","tipe","dibaca","Store","message","Delete","code","csv","forEach","r","nama_user","Date","tanggal","toLocaleDateString","jam_mulai","substring","tanggal_pesan","payment_method","amount","header","attachment","send","module","exports"],"mappings":"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","sourcesContent":["// routes/reservasi.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Tampilkan daftar reservasi\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    res.render('admin/reservasi/index', {\r\n      title: 'Manajemen Reservasi',\r\n      data: reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err); // Tampilkan error di console\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: Form edit reservasi (untuk ubah status)\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    const reservasiData = await Model_Reservasi.getById(id);\r\n\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/reservasi');\r\n    }\r\n\r\n    res.render('admin/reservasi/edit', {\r\n      title: 'Update Status Reservasi',\r\n      reservasi: reservasiData[0]\r\n    });\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\nrouter.post('/update-status/:id', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id;\r\n    const { status } = req.body;\r\n\r\n    if (status === 'ditolak') {\r\n      // âœ… Gunakan fungsi otomatis tolak + kosongkan slot\r\n      await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n    } else {\r\n      // Untuk status lain (disetujui, menunggu, dsb)\r\n      await Model_Reservasi.Update(id_reservasi, { status });\r\n\r\n      // Sinkronkan status slot manual\r\n      const reservasi = await Model_Reservasi.getById(id_reservasi);\r\n      const id_jadwal = reservasi[0].id_jadwal;\r\n\r\n      if (status === 'disetujui') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n      } else if (status === 'batal') {\r\n        await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', `Status reservasi berhasil diperbarui menjadi ${status}`);\r\n    res.redirect('/reservasi');\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui status reservasi');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n\r\n// POST: Update reservasi\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  try {\r\n    const { status, catatan } = req.body;\r\n    const dataToUpdate = { status, catatan };\r\n\r\n    const reservasiData = await Model_Reservasi.getById(id);\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/admin/reservasi');\r\n    }\r\n\r\n    const id_jadwal = reservasiData[0].id_jadwal;\r\n    const Model_Jadwal = require('../models/Model_Jadwal');\r\n    const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n\r\n    // ðŸ”¹ Update status reservasi\r\n    await Model_Reservasi.Update(id, dataToUpdate);\r\n\r\n    // ðŸ”¹ Sinkronisasi status jadwal\r\n    if (status === 'disetujui') {\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n    } \r\n    else if (status === 'ditolak' || status === 'batal') {\r\n      // kalau ditolak atau dibatalkan, buka lagi slotnya\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'kosong' });\r\n    } \r\n    else if (status === 'selesai') {\r\n      // biarkan tetap terisi, karena sudah main\r\n      await Model_Jadwal.Update(id_jadwal, { status_slot: 'terisi' });\r\n    }\r\n\r\n    // ðŸ”¹ Kirim notifikasi ke pemain\r\n    if (reservasiData[0].id_user) {\r\n      const notif = {\r\n        id_user: reservasiData[0].id_user,\r\n        judul: `Status Booking: ${status.toUpperCase()}`,\r\n        isi_pesan:\r\n          status === 'disetujui' ? \r\n            `Booking Anda untuk arena ${reservasiData[0].nama_arena} telah disetujui.` :\r\n          status === 'ditolak' ?\r\n            `Maaf, booking Anda untuk arena ${reservasiData[0].nama_arena} ditolak.` :\r\n          status === 'selesai' ?\r\n            `Terima kasih telah bermain di ${reservasiData[0].nama_arena}.` :\r\n            `Status booking Anda telah berubah menjadi ${status}.`,\r\n        jenis_notif: 'status',\r\n        tipe: 'booking',\r\n        dibaca: 0\r\n      };\r\n      await Model_Notifikasi.Store(notif);\r\n    }\r\n\r\n    req.flash('success_msg', 'Status reservasi berhasil diperbarui.');\r\n    res.redirect('/admin/reservasi');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui reservasi: ' + err.message);\r\n    res.redirect('/admin/reservasi/edit/' + id);\r\n  }\r\n});\r\n\r\n\r\n// GET: Hapus reservasi\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  try {\r\n    await Model_Reservasi.Delete(req.params.id);\r\n    req.flash('success_msg', 'Data reservasi berhasil dihapus.');\r\n    res.redirect('/reservasi');\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal menghapus reservasi: ' + err.code);\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n// GET: Download reservasi data as CSV\r\nrouter.get('/download', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    let csv = 'ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Pembayaran,Jumlah\\n';\r\n\r\n    reservasi.forEach(r => {\r\n      csv += `${r.id_reservasi},${r.nama_user},${r.nama_arena},${new Date(r.tanggal).toLocaleDateString('id-ID')},${r.jam_mulai.substring(0,5)},${new Date(r.tanggal_pesan).toLocaleDateString('id-ID')},${r.status},${r.payment_method || ''},${r.amount || 0}\\n`;\r\n    });\r\n\r\n    res.header('Content-Type', 'text/csv');\r\n    res.attachment('reservasi.csv');\r\n    res.send(csv);\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal mendownload data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"reservasi.dev.js"}