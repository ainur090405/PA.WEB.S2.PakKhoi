{"version":3,"sources":["pemain.js"],"names":["express","require","router","Router","Model_Users","Model_Reservasi","Model_Ulasan","Model_Notifikasi","isAuthenticated","isPemain","use","isBusy","autoUpdateStatus","console","log","Date","toISOString","error","setInterval","req","res","next","flash","redirect","get","userId","session","user","id","Promise","all","getByUser","reservasiData","notifications","stats","totalBookings","length","activeBookings","filter","r","status","totalSpent","reduce","sum","amount","render","title","recentBookings","slice","getById","userData","ulasanData","ulasan","reservasi","post","id_user","id_reservasi","params","body","rating","komentar","Store","UpdateByReservasi","module","exports"],"mappings":";;;;;;;;;;AAAA,IAAMA,OAAO,GAAGC,OAAO,CAAC,SAAD,CAAvB;;AACA,IAAMC,MAAM,GAAGF,OAAO,CAACG,MAAR,EAAf;;AACA,IAAMC,WAAW,GAAGH,OAAO,CAAC,uBAAD,CAA3B;;AACA,IAAMI,eAAe,GAAGJ,OAAO,CAAC,2BAAD,CAA/B;;AACA,IAAMK,YAAY,GAAGL,OAAO,CAAC,wBAAD,CAA5B;;AACA,IAAMM,gBAAgB,GAAGN,OAAO,CAAC,4BAAD,CAAhC;;eACsCA,OAAO,CAAC,8BAAD,C;IAArCO,e,YAAAA,e;IAAiBC,Q,YAAAA,Q;;AAEzBP,MAAM,CAACQ,GAAP,CAAWF,eAAX,EAA4BC,QAA5B,E,CAEA;AACA;AACA;;AACA,IAAIE,MAAM,GAAG,KAAb,C,CAAoB;;AAEpB,SAAeC,gBAAf;AAAA;AAAA;AAAA;AAAA;AAAA,eACMD,MADN;AAAA;AAAA;AAAA;;AAAA;;AAAA;AACsB;AACpBA,UAAAA,MAAM,GAAG,IAAT;AAFF;AAAA;AAAA,0CAMUN,eAAe,CAACO,gBAAhB,EANV;;AAAA;AAOIC,UAAAA,OAAO,CAACC,GAAR,+CAA8C,IAAIC,IAAJ,GAAWC,WAAX,EAA9C;AAPJ;AAAA;;AAAA;AAAA;AAAA;AASIH,UAAAA,OAAO,CAACI,KAAR,CAAc,6BAAd;;AATJ;AAAA;AAWIN,UAAAA,MAAM,GAAG,KAAT;AAXJ;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,C,CAeA;;;AACAO,WAAW,CAACN,gBAAD,EAAmB,KAAK,IAAxB,CAAX,C,CAEA;;AACAV,MAAM,CAACQ,GAAP,CAAW,UAACS,GAAD,EAAMC,GAAN,EAAWC,IAAX,EAAoB;AAC7B,MAAIV,MAAJ,EAAY;AACVQ,IAAAA,GAAG,CAACG,KAAJ,CAAU,WAAV,EAAuB,uDAAvB;AACA,WAAOF,GAAG,CAACG,QAAJ,CAAa,MAAb,CAAP;AACD;;AACDF,EAAAA,IAAI;AACL,CAND,E,CAQA;AACA;AACA;;AACAnB,MAAM,CAACsB,GAAP,CAAW,YAAX,EAAyB,iBAAOL,GAAP,EAAYC,GAAZ;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEfK,UAAAA,MAFe,GAENN,GAAG,CAACO,OAAJ,CAAYC,IAAZ,CAAiBC,EAFX;AAAA;AAAA,0CAIwBC,OAAO,CAACC,GAAR,CAAY,CACvDzB,eAAe,CAAC0B,SAAhB,CAA0BN,MAA1B,CADuD,EAEvDlB,gBAAgB,CAACwB,SAAjB,CAA2BN,MAA3B,CAFuD,CAAZ,CAJxB;;AAAA;AAAA;AAAA;AAIdO,UAAAA,aAJc;AAICC,UAAAA,aAJD;AASfC,UAAAA,KATe,GASP;AACZC,YAAAA,aAAa,EAAEH,aAAa,CAACI,MADjB;AAEZC,YAAAA,cAAc,EAAEL,aAAa,CAACM,MAAd,CAAqB,UAAAC,CAAC;AAAA,qBAAIA,CAAC,CAACC,MAAF,KAAa,WAAb,IAA4BD,CAAC,CAACC,MAAF,KAAa,UAA7C;AAAA,aAAtB,EAA+EJ,MAFnF;AAGZK,YAAAA,UAAU,EAAET,aAAa,CAACU,MAAd,CAAqB,UAACC,GAAD,EAAMJ,CAAN;AAAA,qBAAYI,GAAG,IAAIJ,CAAC,CAACK,MAAF,IAAY,CAAhB,CAAf;AAAA,aAArB,EAAwD,CAAxD;AAHA,WATO;AAerBxB,UAAAA,GAAG,CAACyB,MAAJ,CAAW,kBAAX,EAA+B;AAC7BC,YAAAA,KAAK,EAAE,kBADsB;AAE7BZ,YAAAA,KAAK,EAALA,KAF6B;AAG7Ba,YAAAA,cAAc,EAAEf,aAAa,CAACgB,KAAd,CAAoB,CAApB,EAAuB,CAAvB,CAHa;AAI7Bf,YAAAA,aAAa,EAAbA;AAJ6B,WAA/B;AAfqB;AAAA;;AAAA;AAAA;AAAA;AAsBrBpB,UAAAA,OAAO,CAACI,KAAR;AACAE,UAAAA,GAAG,CAACG,KAAJ,CAAU,WAAV,EAAuB,yBAAvB;AACAF,UAAAA,GAAG,CAACG,QAAJ,CAAa,GAAb;;AAxBqB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAzB,E,CA4BA;AACA;AACA;;AACArB,MAAM,CAACsB,GAAP,CAAW,UAAX,EAAuB,kBAAOL,GAAP,EAAYC,GAAZ;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEbK,UAAAA,MAFa,GAEJN,GAAG,CAACO,OAAJ,CAAYC,IAAZ,CAAiBC,EAFb;AAAA;AAAA,0CAIiCC,OAAO,CAACC,GAAR,CAAY,CAC9D1B,WAAW,CAAC6C,OAAZ,CAAoBxB,MAApB,CAD8D,EAE9DnB,YAAY,CAACyB,SAAb,CAAuBN,MAAvB,CAF8D,EAG9DpB,eAAe,CAAC0B,SAAhB,CAA0BN,MAA1B,CAH8D,CAAZ,CAJjC;;AAAA;AAAA;AAAA;AAIZyB,UAAAA,QAJY;AAIFC,UAAAA,UAJE;AAIUnB,UAAAA,aAJV;;AAAA,gBAUfkB,QAAQ,CAACd,MAAT,KAAoB,CAVL;AAAA;AAAA;AAAA;;AAWjBjB,UAAAA,GAAG,CAACG,KAAJ,CAAU,WAAV,EAAuB,uBAAvB;AAXiB,4CAYVF,GAAG,CAACG,QAAJ,CAAa,mBAAb,CAZU;;AAAA;AAenBH,UAAAA,GAAG,CAACyB,MAAJ,CAAW,gBAAX,EAA6B;AAC3BC,YAAAA,KAAK,EAAE,aADoB;AAE3BnB,YAAAA,IAAI,EAAEuB,QAAQ,CAAC,CAAD,CAFa;AAG3BE,YAAAA,MAAM,EAAED,UAHmB;AAI3BE,YAAAA,SAAS,EAAErB;AAJgB,WAA7B;AAfmB;AAAA;;AAAA;AAAA;AAAA;AAuBnBnB,UAAAA,OAAO,CAACI,KAAR;AACAE,UAAAA,GAAG,CAACG,KAAJ,CAAU,WAAV,EAAuB,8BAAvB;AACAF,UAAAA,GAAG,CAACG,QAAJ,CAAa,mBAAb;;AAzBmB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAvB,E,CA6BA;AACA;AACA;;AACArB,MAAM,CAACoD,IAAP,CAAY,oBAAZ,EAAkC,kBAAOnC,GAAP,EAAYC,GAAZ;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAExBmC,UAAAA,OAFwB,GAEdpC,GAAG,CAACO,OAAJ,CAAYC,IAAZ,CAAiBC,EAFH;AAGxB4B,UAAAA,YAHwB,GAGTrC,GAAG,CAACsC,MAAJ,CAAW7B,EAHF;AAAA,sBAIDT,GAAG,CAACuC,IAJH,EAItBC,MAJsB,aAItBA,MAJsB,EAIdC,QAJc,aAIdA,QAJc;AAAA;AAAA,0CAMxBtD,YAAY,CAACuD,KAAb,CAAmB;AACvBN,YAAAA,OAAO,EAAPA,OADuB;AAEvBC,YAAAA,YAAY,EAAZA,YAFuB;AAGvBG,YAAAA,MAAM,EAANA,MAHuB;AAIvBC,YAAAA,QAAQ,EAARA;AAJuB,WAAnB,CANwB;;AAAA;AAa9BzC,UAAAA,GAAG,CAACG,KAAJ,CAAU,aAAV,EAAyB,2BAAzB;AACAF,UAAAA,GAAG,CAACG,QAAJ,CAAa,iBAAb;AAd8B;AAAA;;AAAA;AAAA;AAAA;AAgB9BV,UAAAA,OAAO,CAACI,KAAR;AACAE,UAAAA,GAAG,CAACG,KAAJ,CAAU,WAAV,EAAuB,wBAAvB;AACAF,UAAAA,GAAG,CAACG,QAAJ,CAAa,iBAAb;;AAlB8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAlC,E,CAsBA;AACA;AACA;;AACArB,MAAM,CAACoD,IAAP,CAAY,oBAAZ,EAAkC,kBAAOnC,GAAP,EAAYC,GAAZ;AAAA;;AAAA;AAAA;AAAA;AAAA;AAAA;AAExBoC,UAAAA,YAFwB,GAETrC,GAAG,CAACsC,MAAJ,CAAW7B,EAFF;AAAA,uBAGDT,GAAG,CAACuC,IAHH,EAGtBC,MAHsB,cAGtBA,MAHsB,EAGdC,QAHc,cAGdA,QAHc;AAAA;AAAA,0CAKxBtD,YAAY,CAACwD,iBAAb,CAA+BN,YAA/B,EAA6C;AAAEG,YAAAA,MAAM,EAANA,MAAF;AAAUC,YAAAA,QAAQ,EAARA;AAAV,WAA7C,CALwB;;AAAA;AAO9BzC,UAAAA,GAAG,CAACG,KAAJ,CAAU,aAAV,EAAyB,6BAAzB;AACAF,UAAAA,GAAG,CAACG,QAAJ,CAAa,iBAAb;AAR8B;AAAA;;AAAA;AAAA;AAAA;AAU9BV,UAAAA,OAAO,CAACI,KAAR;AACAE,UAAAA,GAAG,CAACG,KAAJ,CAAU,WAAV,EAAuB,0BAAvB;AACAF,UAAAA,GAAG,CAACG,QAAJ,CAAa,iBAAb;;AAZ8B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAlC;AAgBAwC,MAAM,CAACC,OAAP,GAAiB9D,MAAjB","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Users = require('../models/Model_Users');\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst Model_Ulasan = require('../models/Model_Ulasan');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst { isAuthenticated, isPemain } = require('../middleware/authMiddleware');\r\n\r\nrouter.use(isAuthenticated, isPemain);\r\n\r\n// ========================\r\n// Auto Update Status Reservasi\r\n// ========================\r\nlet isBusy = false; // flag untuk mencegah bentrok update\r\n\r\nasync function autoUpdateStatus() {\r\n  if (isBusy) return; // skip kalau sedang jalan\r\n  isBusy = true;\r\n\r\n  try {\r\n    // ✅ Panggil fungsi di model\r\n    await Model_Reservasi.autoUpdateStatus();\r\n    console.log(`✅ Auto update status selesai - ${new Date().toISOString()}`);\r\n  } catch (err) {\r\n    console.error('❌ Gagal auto update status:', err);\r\n  } finally {\r\n    isBusy = false;\r\n  }\r\n}\r\n\r\n// Jalankan setiap 1 menit sekali\r\nsetInterval(autoUpdateStatus, 60 * 1000);\r\n\r\n// Middleware untuk mencegah request saat proses update berlangsung\r\nrouter.use((req, res, next) => {\r\n  if (isBusy) {\r\n    req.flash('error_msg', 'Server sedang sibuk, silakan coba lagi beberapa saat.');\r\n    return res.redirect('back');\r\n  }\r\n  next();\r\n});\r\n\r\n// ========================\r\n// Dashboard Pemain\r\n// ========================\r\nrouter.get('/dashboard', async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id;\r\n\r\n    const [reservasiData, notifications] = await Promise.all([\r\n      Model_Reservasi.getByUser(userId),\r\n      Model_Notifikasi.getByUser(userId)\r\n    ]);\r\n\r\n    const stats = {\r\n      totalBookings: reservasiData.length,\r\n      activeBookings: reservasiData.filter(r => r.status === 'disetujui' || r.status === 'menunggu').length,\r\n      totalSpent: reservasiData.reduce((sum, r) => sum + (r.amount || 0), 0)\r\n    };\r\n\r\n    res.render('pemain/dashboard', {\r\n      title: 'Dashboard Pemain',\r\n      stats,\r\n      recentBookings: reservasiData.slice(0, 5),\r\n      notifications\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat dashboard.');\r\n    res.redirect('/');\r\n  }\r\n});\r\n\r\n// ========================\r\n// Halaman Profil\r\n// ========================\r\nrouter.get('/profile', async (req, res) => {\r\n  try {\r\n    const userId = req.session.user.id;\r\n\r\n    const [userData, ulasanData, reservasiData] = await Promise.all([\r\n      Model_Users.getById(userId),\r\n      Model_Ulasan.getByUser(userId),\r\n      Model_Reservasi.getByUser(userId)\r\n    ]);\r\n\r\n    if (userData.length === 0) {\r\n      req.flash('error_msg', 'User tidak ditemukan.');\r\n      return res.redirect('/pemain/dashboard');\r\n    }\r\n\r\n    res.render('pemain/profile', {\r\n      title: 'Profil Saya',\r\n      user: userData[0],\r\n      ulasan: ulasanData,\r\n      reservasi: reservasiData\r\n    });\r\n\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat halaman profil.');\r\n    res.redirect('/pemain/dashboard');\r\n  }\r\n});\r\n\r\n// ========================\r\n// Tambah Ulasan\r\n// ========================\r\nrouter.post('/ulasan/create/:id', async (req, res) => {\r\n  try {\r\n    const id_user = req.session.user.id;\r\n    const id_reservasi = req.params.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    await Model_Ulasan.Store({\r\n      id_user,\r\n      id_reservasi,\r\n      rating,\r\n      komentar\r\n    });\r\n\r\n    req.flash('success_msg', 'Ulasan berhasil disimpan!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menyimpan ulasan');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\n// ========================\r\n// Update Ulasan\r\n// ========================\r\nrouter.post('/ulasan/update/:id', async (req, res) => {\r\n  try {\r\n    const id_reservasi = req.params.id;\r\n    const { rating, komentar } = req.body;\r\n\r\n    await Model_Ulasan.UpdateByReservasi(id_reservasi, { rating, komentar });\r\n\r\n    req.flash('success_msg', 'Ulasan berhasil diperbarui!');\r\n    res.redirect('/pemain/profile');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui ulasan');\r\n    res.redirect('/pemain/profile');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"pemain.dev.js"}