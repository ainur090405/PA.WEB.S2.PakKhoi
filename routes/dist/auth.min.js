"use strict";var express=require("express"),router=express.Router(),bcrypt=require("bcryptjs"),Model_Users=require("../models/Model_Users");router.get("/register",function(e,r){r.render("auth/register",{title:"Daftar Akun"})}),router.post("/register",function(r,a){var t,s,n,i,o,u,c,l;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.body,s=t.nama,n=t.email,i=t.password,o=t.konfirmasi_password,u=t.no_hp,s&&n&&i&&u){e.next=4;break}return r.flash("error_msg","Semua field wajib diisi."),e.abrupt("return",a.redirect("/auth/register"));case 4:if(i!==o)return r.flash("error_msg","Password dan konfirmasi password tidak cocok."),e.abrupt("return",a.redirect("/auth/register"));e.next=7;break;case 7:return e.prev=7,e.next=10,regeneratorRuntime.awrap(Model_Users.getByEmail(n));case 10:if(0<e.sent.length)return r.flash("error_msg","Email sudah terdaftar."),e.abrupt("return",a.redirect("/auth/register"));e.next=14;break;case 14:return e.next=16,regeneratorRuntime.awrap(bcrypt.hash(i,10));case 16:return c=e.sent,l={nama:s,email:n,no_hp:u,password_hash:c,role:"pemain",status:"aktif",tanggal_daftar:new Date},e.next=20,regeneratorRuntime.awrap(Model_Users.Store(l));case 20:r.flash("success_msg","Registrasi berhasil. Silakan login."),a.redirect("/auth/login"),e.next=29;break;case 24:e.prev=24,e.t0=e.catch(7),console.error(e.t0),r.flash("error_msg","Terjadi kesalahan server: "+e.t0.code),a.redirect("/auth/register");case 29:case"end":return e.stop()}},null,null,[[7,24]])}),router.get("/login",function(e,r){r.render("auth/login",{title:"Login"})}),router.post("/login",function(r,a){var t,s,n,i,o;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.body,s=t.email,n=t.password,e.prev=1,e.next=4,regeneratorRuntime.awrap(Model_Users.getByEmail(s));case 4:if(0===(i=e.sent).length)return r.flash("error_msg","Email atau Password salah."),e.abrupt("return",a.redirect("/auth/login"));e.next=8;break;case 8:if("nonaktif"===(o=i[0]).status)return r.flash("error_msg","Akun Anda tidak aktif. Silakan hubungi admin."),e.abrupt("return",a.redirect("/auth/login"));e.next=12;break;case 12:return e.next=14,regeneratorRuntime.awrap(bcrypt.compare(n,o.password_hash));case 14:if(e.sent){e.next=18;break}return r.flash("error_msg","Email atau Password salah."),e.abrupt("return",a.redirect("/auth/login"));case 18:r.session.user={id:o.id_user,nama:o.nama,email:o.email,role:o.role},r.flash("success_msg","Login berhasil! Selamat datang, "+o.nama),"admin"===o.role?a.redirect("/admin/dashboard"):a.redirect("/"),e.next=28;break;case 23:e.prev=23,e.t0=e.catch(1),console.error(e.t0),r.flash("error_msg","Terjadi kesalahan server."),a.redirect("/auth/login");case 28:case"end":return e.stop()}},null,null,[[1,23]])}),router.get("/logout",function(e,r){e.flash("success_msg","Anda berhasil logout."),e.session.destroy(function(e){e&&console.error(e),r.clearCookie("connect.sid"),r.redirect("/auth/login")})}),router.get("/lupa-password",function(e,r){r.render("auth/lupa_password",{title:"Lupa Password"})}),router.post("/lupa-password",function(r,a){var t,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.body.email,e.next=3,regeneratorRuntime.awrap(Model_Users.getByEmail(t));case 3:if((s=e.sent)&&0!==s.length){e.next=7;break}return r.flash("error","Email tidak ditemukan."),e.abrupt("return",a.redirect("/auth/lupa-password"));case 7:a.render("auth/reset_password_simple",{title:"Reset Password",id_user:s[0].id_user,email:s[0].email});case 8:case"end":return e.stop()}})}),router.post("/reset-password-simple",function(r,a){var t,s,n,i,o,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.body,s=t.id_user,n=t.password,i=t.password_confirm,n!==i)return r.flash("error","Konfirmasi password tidak sama."),e.abrupt("return",a.redirect("back"));e.next=4;break;case 4:if(n.length<6)return r.flash("error","Password minimal 6 karakter."),e.abrupt("return",a.redirect("back"));e.next=7;break;case 7:return o=require("bcryptjs"),e.next=10,regeneratorRuntime.awrap(o.hash(n,10));case 10:return u=e.sent,e.next=13,regeneratorRuntime.awrap(Model_Users.Update(s,{password_hash:u}));case 13:r.flash("success","Password berhasil diubah. Silakan login kembali."),a.redirect("/auth/login");case 15:case"end":return e.stop()}})}),module.exports=router;
//# sourceMappingURL=auth.min.js.map
