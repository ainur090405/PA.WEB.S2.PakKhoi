{"version":3,"sources":["users.js"],"names":["express","require","router","Router","Model_Users","use","isAuthenticated","isAdmin","get","req","res","getAll","render","title","data","console","error","_context","t0","flash","redirect","_req$body","nama","email","password","no_hp","role","status","hash","dataUser","regeneratorRuntime","async","_context2","prev","next","users","awrap","bcrypt","sent","tanggal_daftar","Date","Store","code","message","stop","id","_context3","params","getById","length","body","abrupt","post","_req$body2","dataToUpdate","_context4","trim","password_hash","Update","_context5","Number","session","user","Delete"],"mappings":"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","file":"users.min.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst bcrypt = require('bcryptjs');\r\nconst Model_Users = require('../models/Model_Users'); \r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute di file ini\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Menampilkan daftar users\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const users = await Model_Users.getAll();\r\n    res.render('admin/users/index', {\r\n      title: 'Manajemen User',\r\n      data: users\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat data users.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: Form tambah user\r\nrouter.get('/create', (req, res) => {\r\n  res.render('admin/users/create', { title: 'Tambah User Baru' });\r\n});\r\n\r\n// POST: Simpan user baru\r\nrouter.post('/store', async (req, res) => {\r\n  const { nama, email, password, no_hp, role, status } = req.body;\r\n\r\n  try {\r\n    const hash = await bcrypt.hash(password, 10);\r\n\r\n    const dataUser = {\r\n      nama,\r\n      email,\r\n      no_hp,\r\n      role,\r\n      password_hash: hash,\r\n      tanggal_daftar: new Date(),\r\n      // kalau form belum punya field status, default-kan aktif\r\n      status: status || 'aktif'\r\n    };\r\n\r\n    await Model_Users.Store(dataUser);\r\n    req.flash('success_msg', 'User baru berhasil ditambahkan.');\r\n    res.redirect('/users');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menyimpan user: ' + (err.code || err.message));\r\n    res.redirect('/users/create');\r\n  }\r\n});\r\n\r\n// GET: Form edit user\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    const users = await Model_Users.getById(id);\r\n\r\n    if (!users || users.length === 0) {\r\n      req.flash('error_msg', 'User tidak ditemukan.');\r\n      return res.redirect('/users');\r\n    }\r\n\r\n    res.render('admin/users/edit', {\r\n      title: 'Edit User',\r\n      user: users[0]\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat data user.');\r\n    res.redirect('/users');\r\n  }\r\n});\r\n\r\n// POST: Update user\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  const { nama, email, password, no_hp, role, status } = req.body;\r\n\r\n  try {\r\n    // data dasar\r\n    const dataToUpdate = {\r\n      nama,\r\n      email,\r\n      no_hp,\r\n      role,\r\n      status: status || 'aktif'   // <-- penting\r\n    };\r\n\r\n    // kalau password diisi, update juga password_hash\r\n    if (password && password.trim() !== '') {\r\n      dataToUpdate.password_hash = await bcrypt.hash(password, 10);\r\n    }\r\n\r\n    await Model_Users.Update(id, dataToUpdate);\r\n    req.flash('success_msg', 'Data user berhasil diperbarui.');\r\n    res.redirect('/users');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memperbarui user: ' + (err.code || err.message));\r\n    res.redirect('/users/edit/' + id);\r\n  }\r\n});\r\n\r\n// GET: Hapus user\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n\r\n  // cegah user menghapus dirinya sendiri\r\n  if (Number(id) === Number(req.session.user.id)) {\r\n    req.flash('error_msg', 'Anda tidak bisa menghapus akun Anda sendiri.');\r\n    return res.redirect('/users');\r\n  }\r\n\r\n  try {\r\n    await Model_Users.Delete(id);\r\n    req.flash('success_msg', 'Data user berhasil dihapus.');\r\n    res.redirect('/users');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menghapus user: ' + (err.code || err.message));\r\n    res.redirect('/users');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"]}