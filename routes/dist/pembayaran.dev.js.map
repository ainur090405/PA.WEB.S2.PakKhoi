{"version":3,"sources":["pembayaran.js"],"names":["express","require","router","Router","connection","Model_Pembayaran","Model_Reservasi","Model_Jadwal","Model_Notifikasi","isAuthenticated","isAdmin","createLog","use","get","req","res","getPendingPayments","pembayaran","render","title","data","console","error","flash","redirect","post","id_pembayaran","params","body","catatan_admin","query","err","rowsBayar","length","bayar","id_reservasi","err2","getById","rowsReservasiBefore","reservasiBefore","statusAwal","status","Update","rowsReservasi","reservasi","warn","id_jadwal","status_slot","id_user","Store","judul","isi_pesan","nama_arena","jenis_notif","tipe","dibaca","rejectAndFreeSlot","r","alasan","trim","module","exports"],"mappings":"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","sourcesContent":["// routes/pembayaran.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\n\r\nconst connection = require('../config/database');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi  = require('../models/Model_Reservasi');\r\nconst Model_Jadwal     = require('../models/Model_Jadwal');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// ‚¨áÔ∏è TAMBAHAN: helper untuk log_reservasi\r\nconst { createLog } = require('../helpers/logHelper');\r\n\r\n// semua route di sini hanya boleh diakses admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// ===============================\r\n// GET: daftar pembayaran pending\r\n// ===============================\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/pembayaran:', err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// =======================================\r\n// POST: KONFIRMASI PEMBAYARAN (BERHASIL)\r\n// =======================================\r\nrouter.post('/confirm/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran-nya\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran:', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update tabel pembayaran -> confirmed\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'confirmed',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran:', err2);\r\n            req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // üîé ambil data reservasi sebelum di-update untuk log status_awal\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> disetujui\r\n            await Model_Reservasi.Update(id_reservasi, { status: 'disetujui' });\r\n\r\n            // üîé ambil lagi sesudah update\r\n            const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasi = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n            // 3b) SIMPAN LOG RESERVASI\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'disetujui',\r\n                'Pembayaran dikonfirmasi admin'\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log konfirmasi pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) update jadwal -> terisi\r\n            if (reservasi && reservasi.id_jadwal) {\r\n              await Model_Jadwal.Update(reservasi.id_jadwal, { status_slot: 'terisi' });\r\n            }\r\n\r\n            // 5) kirim notifikasi ke pemain (kalau ada)\r\n            try {\r\n              if (reservasi && reservasi.id_user) {\r\n                await Model_Notifikasi.Store({\r\n                  id_user: reservasi.id_user,\r\n                  judul: 'Pembayaran Dikonfirmasi',\r\n                  isi_pesan: `Pembayaran Anda untuk arena ${\r\n                    reservasi.nama_arena || 'Arena'\r\n                  } telah dikonfirmasi. Booking Anda sekarang aktif.`,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif konfirmasi pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran:', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\n// ==================================\r\n// POST: TOLAK PEMBAYARAN (REJECTED)\r\n// ==================================\r\nrouter.post('/reject/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran (reject):', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update pembayaran -> rejected\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'rejected',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran (reject):', err2);\r\n            req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // üîé ambil status reservasi sebelum diubah\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> ditolak + kosongkan slot\r\n            if (typeof Model_Reservasi.rejectAndFreeSlot === 'function') {\r\n              await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n            } else {\r\n              await Model_Reservasi.Update(id_reservasi, { status: 'ditolak' });\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              if (rowsReservasi && rowsReservasi[0] && rowsReservasi[0].id_jadwal) {\r\n                await Model_Jadwal.Update(rowsReservasi[0].id_jadwal, { status_slot: 'kosong' });\r\n              }\r\n            }\r\n\r\n            // 3b) SIMPAN LOG RESERVASI (ditolak)\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'ditolak',\r\n                `Pembayaran ditolak admin. ${catatan_admin || ''}`\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log tolak pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) kirim notifikasi ke pemain\r\n            try {\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              const r = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n              if (r && r.id_user) {\r\n                // ‚¨áÔ∏è alasan default kalau admin tidak isi catatan\r\n                const alasan =\r\n                  catatan_admin && catatan_admin.trim() !== ''\r\n                    ? catatan_admin\r\n                    : 'Pembayaran ditolak karena data tidak lengkap atau batas waktu upload bukti pembayaran sudah habis.';\r\n\r\n                await Model_Notifikasi.Store({\r\n                  id_user: r.id_user,\r\n                  judul: 'Pembayaran Ditolak',\r\n                  isi_pesan: `Pembayaran Anda untuk arena ${\r\n                    r.nama_arena || 'Arena'\r\n                  } ditolak. ${alasan}`,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif tolak pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil ditolak.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran (reject):', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"pembayaran.dev.js"}