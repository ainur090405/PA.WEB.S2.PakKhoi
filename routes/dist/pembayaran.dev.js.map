{"version":3,"sources":["pembayaran.js"],"names":["express","require","router","Router","Model_Pembayaran","Model_Reservasi","isAuthenticated","isAdmin","use","get","req","res","getPendingPayments","pembayaran","render","title","data","console","error","flash","redirect","post","id_pembayaran","params","id","catatan_admin","body","confirmPayment","getById","pembayaranData","length","Update","id_reservasi","status","reservasiData","Model_Jadwal","id_jadwal","status_slot","id_user","Model_Notifikasi","notifData","judul","isi_pesan","nama_arena","jenis_notif","tipe","dibaca","Store","json","success","message","module","exports"],"mappings":";;AAAA,IAAMA,OAAO,GAAGC,OAAO,CAAC,SAAD,CAAvB;;AACA,IAAMC,MAAM,GAAGF,OAAO,CAACG,MAAR,EAAf;;AACA,IAAMC,gBAAgB,GAAGH,OAAO,CAAC,4BAAD,CAAhC;;AACA,IAAMI,eAAe,GAAGJ,OAAO,CAAC,2BAAD,CAA/B;;eACqCA,OAAO,CAAC,8BAAD,C;IAApCK,e,YAAAA,e;IAAiBC,O,YAAAA,O,EAEzB;;;AACAL,MAAM,CAACM,GAAP,CAAWF,eAAX,EAA4BC,OAA5B,E,CAEA;;AACAL,MAAM,CAACO,GAAP,CAAW,GAAX,EAAgB,iBAAOC,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,0CAEaP,gBAAgB,CAACQ,kBAAjB,EAFb;;AAAA;AAENC,UAAAA,UAFM;AAGZF,UAAAA,GAAG,CAACG,MAAJ,CAAW,wBAAX,EAAqC;AACnCC,YAAAA,KAAK,EAAE,uBAD4B;AAEnCC,YAAAA,IAAI,EAAEH;AAF6B,WAArC;AAHY;AAAA;;AAAA;AAAA;AAAA;AAQZI,UAAAA,OAAO,CAACC,KAAR;AACAR,UAAAA,GAAG,CAACS,KAAJ,CAAU,WAAV,EAAuB,+BAAvB;AACAR,UAAAA,GAAG,CAACS,QAAJ,CAAa,kBAAb;;AAVY;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAhB,E,CAcA;;AACAlB,MAAM,CAACmB,IAAP,CAAY,cAAZ,EAA4B,kBAAOX,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAElBW,UAAAA,aAFkB,GAEFZ,GAAG,CAACa,MAAJ,CAAWC,EAFT;AAGhBC,UAAAA,aAHgB,GAGEf,GAAG,CAACgB,IAHN,CAGhBD,aAHgB,EAKxB;;AALwB;AAAA,0CAMlBrB,gBAAgB,CAACuB,cAAjB,CAAgCL,aAAhC,EAA+C,WAA/C,EAA4DG,aAA5D,CANkB;;AAAA;AAAA;AAAA,0CASKrB,gBAAgB,CAACwB,OAAjB,CAAyBN,aAAzB,CATL;;AAAA;AASlBO,UAAAA,cATkB;;AAAA,gBAUpBA,cAAc,CAACC,MAAf,GAAwB,CAVJ;AAAA;AAAA;AAAA;;AAAA;AAAA,0CAWhBzB,eAAe,CAAC0B,MAAhB,CAAuBF,cAAc,CAAC,CAAD,CAAd,CAAkBG,YAAzC,EAAuD;AAAEC,YAAAA,MAAM,EAAE;AAAV,WAAvD,CAXgB;;AAAA;AAAA;AAAA,0CAcM5B,eAAe,CAACuB,OAAhB,CAAwBC,cAAc,CAAC,CAAD,CAAd,CAAkBG,YAA1C,CAdN;;AAAA;AAchBE,UAAAA,aAdgB;;AAAA,gBAelBA,aAAa,CAACJ,MAAd,GAAuB,CAfL;AAAA;AAAA;AAAA;;AAgBdK,UAAAA,YAhBc,GAgBClC,OAAO,CAAC,wBAAD,CAhBR;AAAA;AAAA,0CAiBdkC,YAAY,CAACJ,MAAb,CAAoBG,aAAa,CAAC,CAAD,CAAb,CAAiBE,SAArC,EAAgD;AAAEC,YAAAA,WAAW,EAAE;AAAf,WAAhD,CAjBc;;AAAA;AAAA,gBAqBlBR,cAAc,CAAC,CAAD,CAAd,IAAqBA,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAvC,IAAkD,OAAOT,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAzB,KAAqC,QAAvF,IAAmGT,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAlB,GAA4B,CArB7G;AAAA;AAAA;AAAA;;AAAA;AAuBZC,UAAAA,gBAvBY,GAuBOtC,OAAO,CAAC,4BAAD,CAvBd;AAwBZuC,UAAAA,SAxBY,GAwBA;AAChBF,YAAAA,OAAO,EAAET,cAAc,CAAC,CAAD,CAAd,CAAkBS,OADX;AAEhBG,YAAAA,KAAK,EAAE,yBAFS;AAGhBC,YAAAA,SAAS,wCAAiCb,cAAc,CAAC,CAAD,CAAd,CAAkBc,UAAlB,IAAgC,OAAjE,sDAHO;AAIhBC,YAAAA,WAAW,EAAE,QAJG;AAKhBC,YAAAA,IAAI,EAAE,SALU;AAMhBC,YAAAA,MAAM,EAAE;AANQ,WAxBA;AAAA;AAAA,0CAgCZP,gBAAgB,CAACQ,KAAjB,CAAuBP,SAAvB,CAhCY;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAkClBvB,UAAAA,OAAO,CAACC,KAAR,CAAc,8BAAd,gBAlCkB,CAmClB;;AAnCkB;AAwCxBR,UAAAA,GAAG,CAACS,KAAJ,CAAU,aAAV,EAAyB,mCAAzB;AACAR,UAAAA,GAAG,CAACS,QAAJ,CAAa,mBAAb;AAzCwB;AAAA;;AAAA;AAAA;AAAA;AA2CxBH,UAAAA,OAAO,CAACC,KAAR;AACAR,UAAAA,GAAG,CAACS,KAAJ,CAAU,WAAV,EAAuB,kCAAvB;AACAR,UAAAA,GAAG,CAACS,QAAJ,CAAa,mBAAb;;AA7CwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAA5B,E,CAiDA;;AACAlB,MAAM,CAACmB,IAAP,CAAY,kBAAZ,EAAgC,kBAAOX,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEtBW,UAAAA,aAFsB,GAENZ,GAAG,CAACa,MAAJ,CAAWC,EAFL,EAI5B;;AAJ4B;AAAA,0CAKtBpB,gBAAgB,CAACuB,cAAjB,CAAgCL,aAAhC,EAA+C,WAA/C,EAA4D,oCAA5D,CALsB;;AAAA;AAAA;AAAA,0CAQClB,gBAAgB,CAACwB,OAAjB,CAAyBN,aAAzB,CARD;;AAAA;AAQtBO,UAAAA,cARsB;;AAAA,gBASxBA,cAAc,CAACC,MAAf,GAAwB,CATA;AAAA;AAAA;AAAA;;AAAA;AAAA,0CAUpBzB,eAAe,CAAC0B,MAAhB,CAAuBF,cAAc,CAAC,CAAD,CAAd,CAAkBG,YAAzC,EAAuD;AAAEC,YAAAA,MAAM,EAAE;AAAV,WAAvD,CAVoB;;AAAA;AAAA;AAAA,0CAaE5B,eAAe,CAACuB,OAAhB,CAAwBC,cAAc,CAAC,CAAD,CAAd,CAAkBG,YAA1C,CAbF;;AAAA;AAapBE,UAAAA,aAboB;;AAAA,gBActBA,aAAa,CAACJ,MAAd,GAAuB,CAdD;AAAA;AAAA;AAAA;;AAelBK,UAAAA,YAfkB,GAeHlC,OAAO,CAAC,wBAAD,CAfJ;AAAA;AAAA,0CAgBlBkC,YAAY,CAACJ,MAAb,CAAoBG,aAAa,CAAC,CAAD,CAAb,CAAiBE,SAArC,EAAgD;AAAEC,YAAAA,WAAW,EAAE;AAAf,WAAhD,CAhBkB;;AAAA;AAAA,gBAoBtBR,cAAc,CAAC,CAAD,CAAd,IAAqBA,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAvC,IAAkD,OAAOT,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAzB,KAAqC,QAAvF,IAAmGT,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAlB,GAA4B,CApBzG;AAAA;AAAA;AAAA;;AAAA;AAsBhBC,UAAAA,gBAtBgB,GAsBGtC,OAAO,CAAC,4BAAD,CAtBV;AAuBhBuC,UAAAA,SAvBgB,GAuBJ;AAChBF,YAAAA,OAAO,EAAET,cAAc,CAAC,CAAD,CAAd,CAAkBS,OADX;AAEhBG,YAAAA,KAAK,EAAE,6BAFS;AAGhBC,YAAAA,SAAS,4CAAqCb,cAAc,CAAC,CAAD,CAAd,CAAkBc,UAAlB,IAAgC,OAArE,sDAHO;AAIhBC,YAAAA,WAAW,EAAE,QAJG;AAKhBC,YAAAA,IAAI,EAAE,SALU;AAMhBC,YAAAA,MAAM,EAAE;AANQ,WAvBI;AAAA;AAAA,0CA+BhBP,gBAAgB,CAACQ,KAAjB,CAAuBP,SAAvB,CA/BgB;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AAiCtBvB,UAAAA,OAAO,CAACC,KAAR,CAAc,8BAAd;;AAjCsB;AAsC5B;AACAP,UAAAA,GAAG,CAACqC,IAAJ,CAAS;AAAEC,YAAAA,OAAO,EAAE,IAAX;AAAiBC,YAAAA,OAAO,EAAE;AAA1B,WAAT;AAvC4B;AAAA;;AAAA;AAAA;AAAA;AAyC5BjC,UAAAA,OAAO,CAACC,KAAR,eAzC4B,CA0C5B;;AACAP,UAAAA,GAAG,CAACsB,MAAJ,CAAW,GAAX,EAAgBe,IAAhB,CAAqB;AAAEC,YAAAA,OAAO,EAAE,KAAX;AAAkBC,YAAAA,OAAO,EAAE;AAA3B,WAArB;;AA3C4B;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAAhC,E,CA+CA;;AACAhD,MAAM,CAACmB,IAAP,CAAY,aAAZ,EAA2B,kBAAOX,GAAP,EAAYC,GAAZ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEjBW,UAAAA,aAFiB,GAEDZ,GAAG,CAACa,MAAJ,CAAWC,EAFV;AAGfC,UAAAA,aAHe,GAGGf,GAAG,CAACgB,IAHP,CAGfD,aAHe,EAKvB;;AALuB;AAAA,0CAMjBrB,gBAAgB,CAACuB,cAAjB,CAAgCL,aAAhC,EAA+C,UAA/C,EAA2DG,aAA3D,CANiB;;AAAA;AAAA;AAAA,0CASMrB,gBAAgB,CAACwB,OAAjB,CAAyBN,aAAzB,CATN;;AAAA;AASjBO,UAAAA,cATiB;;AAAA,gBAUnBA,cAAc,CAACC,MAAf,GAAwB,CAVL;AAAA;AAAA;AAAA;;AAAA;AAAA,0CAWfzB,eAAe,CAAC0B,MAAhB,CAAuBF,cAAc,CAAC,CAAD,CAAd,CAAkBG,YAAzC,EAAuD;AAAEC,YAAAA,MAAM,EAAE;AAAV,WAAvD,CAXe;;AAAA;AAAA,gBAcjBJ,cAAc,CAAC,CAAD,CAAd,IAAqBA,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAvC,IAAkD,OAAOT,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAzB,KAAqC,QAAvF,IAAmGT,cAAc,CAAC,CAAD,CAAd,CAAkBS,OAAlB,GAA4B,CAd9G;AAAA;AAAA;AAAA;;AAAA;AAgBXC,UAAAA,gBAhBW,GAgBQtC,OAAO,CAAC,4BAAD,CAhBf;AAiBXuC,UAAAA,SAjBW,GAiBC;AAChBF,YAAAA,OAAO,EAAET,cAAc,CAAC,CAAD,CAAd,CAAkBS,OADX;AAEhBG,YAAAA,KAAK,EAAE,oBAFS;AAGhBC,YAAAA,SAAS,wCAAiCb,cAAc,CAAC,CAAD,CAAd,CAAkBc,UAAlB,IAAgC,OAAjE,uBAAqFlB,aAArF,CAHO;AAIhBmB,YAAAA,WAAW,EAAE,QAJG;AAKhBC,YAAAA,IAAI,EAAE,SALU;AAMhBC,YAAAA,MAAM,EAAE;AANQ,WAjBD;AAAA;AAAA,0CAyBXP,gBAAgB,CAACQ,KAAjB,CAAuBP,SAAvB,CAzBW;;AAAA;AAAA;AAAA;;AAAA;AAAA;AAAA;AA2BjBvB,UAAAA,OAAO,CAACC,KAAR,CAAc,8BAAd,gBA3BiB,CA4BjB;;AA5BiB;AAiCvBR,UAAAA,GAAG,CAACS,KAAJ,CAAU,WAAV,EAAuB,8BAAvB;AACAR,UAAAA,GAAG,CAACS,QAAJ,CAAa,mBAAb;AAlCuB;AAAA;;AAAA;AAAA;AAAA;AAoCvBH,UAAAA,OAAO,CAACC,KAAR;AACAR,UAAAA,GAAG,CAACS,KAAJ,CAAU,WAAV,EAAuB,2BAAvB;AACAR,UAAAA,GAAG,CAACS,QAAJ,CAAa,mBAAb;;AAtCuB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,CAA3B;AA0CA+B,MAAM,CAACC,OAAP,GAAiBlD,MAAjB","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Tampilkan daftar pembayaran yang pending\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// POST: Konfirmasi pembayaran\r\nrouter.post('/confirm/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n    const { catatan_admin } = req.body;\r\n\r\n    // Konfirmasi pembayaran\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'confirmed', catatan_admin);\r\n\r\n    // Update status reservasi menjadi 'disetujui' jika pembayaran dikonfirmasi\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'disetujui' });\r\n\r\n      // Update status slot jadwal menjadi 'terisi'\r\n      const reservasiData = await Model_Reservasi.getById(pembayaranData[0].id_reservasi);\r\n      if (reservasiData.length > 0) {\r\n        const Model_Jadwal = require('../models/Model_Jadwal');\r\n        await Model_Jadwal.Update(reservasiData[0].id_jadwal, { status_slot: 'terisi' });\r\n      }\r\n\r\n      // Kirim notifikasi pembayaran dikonfirmasi\r\n      if (pembayaranData[0] && pembayaranData[0].id_user && typeof pembayaranData[0].id_user === 'number' && pembayaranData[0].id_user > 0) {\r\n        try {\r\n          const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n          const notifData = {\r\n            id_user: pembayaranData[0].id_user,\r\n            judul: 'Pembayaran Dikonfirmasi',\r\n            isi_pesan: `Pembayaran Anda untuk arena ${pembayaranData[0].nama_arena || 'Arena'} telah dikonfirmasi. Booking Anda sekarang aktif.`,\r\n            jenis_notif: 'status',\r\n            tipe: 'payment',\r\n            dibaca: 0\r\n          };\r\n          await Model_Notifikasi.Store(notifData);\r\n        } catch (notifErr) {\r\n          console.error('Failed to send notification:', notifErr);\r\n          // Continue with confirmation even if notification fails\r\n        }\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n    res.redirect('/admin/pembayaran');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n    res.redirect('/admin/pembayaran');\r\n  }\r\n});\r\n\r\n// POST: Konfirmasi COD (tanpa redirect, hanya flash message)\r\nrouter.post('/confirm-cod/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n\r\n    // Konfirmasi pembayaran COD\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'confirmed', 'COD - Pembayaran diterima langsung');\r\n\r\n    // Update status reservasi menjadi 'disetujui' jika pembayaran dikonfirmasi\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'disetujui' });\r\n\r\n      // Update status slot jadwal menjadi 'terisi'\r\n      const reservasiData = await Model_Reservasi.getById(pembayaranData[0].id_reservasi);\r\n      if (reservasiData.length > 0) {\r\n        const Model_Jadwal = require('../models/Model_Jadwal');\r\n        await Model_Jadwal.Update(reservasiData[0].id_jadwal, { status_slot: 'terisi' });\r\n      }\r\n\r\n      // Kirim notifikasi pembayaran dikonfirmasi\r\n      if (pembayaranData[0] && pembayaranData[0].id_user && typeof pembayaranData[0].id_user === 'number' && pembayaranData[0].id_user > 0) {\r\n        try {\r\n          const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n          const notifData = {\r\n            id_user: pembayaranData[0].id_user,\r\n            judul: 'Pembayaran COD Dikonfirmasi',\r\n            isi_pesan: `Pembayaran COD Anda untuk arena ${pembayaranData[0].nama_arena || 'Arena'} telah dikonfirmasi. Booking Anda sekarang aktif.`,\r\n            jenis_notif: 'status',\r\n            tipe: 'payment',\r\n            dibaca: 0\r\n          };\r\n          await Model_Notifikasi.Store(notifData);\r\n        } catch (notifErr) {\r\n          console.error('Failed to send notification:', notifErr);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Return JSON response untuk AJAX\r\n    res.json({ success: true, message: 'Pembayaran COD berhasil dikonfirmasi!' });\r\n  } catch (err) {\r\n    console.error(err);\r\n    // Return JSON error response untuk AJAX, bukan redirect\r\n    res.status(500).json({ success: false, message: 'Gagal mengkonfirmasi pembayaran COD. Silakan coba lagi.' });\r\n  }\r\n});\r\n\r\n// POST: Tolak pembayaran\r\nrouter.post('/reject/:id', async (req, res) => {\r\n  try {\r\n    const id_pembayaran = req.params.id;\r\n    const { catatan_admin } = req.body;\r\n\r\n    // Update status pembayaran menjadi 'rejected'\r\n    await Model_Pembayaran.confirmPayment(id_pembayaran, 'rejected', catatan_admin);\r\n\r\n    // Update status reservasi menjadi 'ditolak'\r\n    const pembayaranData = await Model_Pembayaran.getById(id_pembayaran);\r\n    if (pembayaranData.length > 0) {\r\n      await Model_Reservasi.Update(pembayaranData[0].id_reservasi, { status: 'ditolak' });\r\n\r\n      // Kirim notifikasi ke pemain jika id_user valid\r\n      if (pembayaranData[0] && pembayaranData[0].id_user && typeof pembayaranData[0].id_user === 'number' && pembayaranData[0].id_user > 0) {\r\n        try {\r\n          const Model_Notifikasi = require('../models/Model_Notifikasi');\r\n          const notifData = {\r\n            id_user: pembayaranData[0].id_user,\r\n            judul: 'Pembayaran Ditolak',\r\n            isi_pesan: `Pembayaran Anda untuk arena ${pembayaranData[0].nama_arena || 'Arena'} ditolak. ${catatan_admin}`,\r\n            jenis_notif: 'status',\r\n            tipe: 'payment',\r\n            dibaca: 0\r\n          };\r\n          await Model_Notifikasi.Store(notifData);\r\n        } catch (notifErr) {\r\n          console.error('Failed to send notification:', notifErr);\r\n          // Continue with rejection even if notification fails\r\n        }\r\n      }\r\n    }\r\n\r\n    req.flash('error_msg', 'Pembayaran berhasil ditolak.');\r\n    res.redirect('/admin/pembayaran');\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n    res.redirect('/admin/pembayaran');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"pembayaran.dev.js"}