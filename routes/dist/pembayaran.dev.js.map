{"version":3,"sources":["pembayaran.js"],"names":["express","require","router","Router","connection","Model_Pembayaran","Model_Reservasi","Model_Jadwal","Model_Notifikasi","isAuthenticated","isAdmin","createLog","use","get","req","res","getPendingPayments","pembayaran","render","title","data","console","error","flash","redirect","post","id_pembayaran","params","body","catatan_admin","query","err","rowsBayar","length","bayar","id_reservasi","err2","getById","rowsReservasiBefore","reservasiBefore","statusAwal","status","Update","rowsReservasi","reservasi","warn","id_jadwal","status_slot","id_user","tanggalMain","tanggal","Date","toLocaleDateString","weekday","day","month","year","jamMulai","jam_mulai","substring","jamSelesai","jam_selesai","metodePembayaran","metode_pembayaran","isiPesan","nama_arena","Store","judul","isi_pesan","jenis_notif","tipe","dibaca","rejectAndFreeSlot","r","alasan","trim","module","exports"],"mappings":"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","sourcesContent":["// routes/pembayaran.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\n\r\nconst connection = require('../config/database');\r\nconst Model_Pembayaran = require('../models/Model_Pembayaran');\r\nconst Model_Reservasi  = require('../models/Model_Reservasi');\r\nconst Model_Jadwal     = require('../models/Model_Jadwal');\r\nconst Model_Notifikasi = require('../models/Model_Notifikasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// â¬‡ï¸ helper untuk log_reservasi\r\nconst { createLog } = require('../helpers/logHelper');\r\n\r\n// semua route di sini hanya boleh diakses admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// ===============================\r\n// GET: daftar pembayaran pending\r\n// ===============================\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const pembayaran = await Model_Pembayaran.getPendingPayments();\r\n    res.render('admin/pembayaran/index', {\r\n      title: 'Konfirmasi Pembayaran',\r\n      data: pembayaran\r\n    });\r\n  } catch (err) {\r\n    console.error('ERR GET /admin/pembayaran:', err);\r\n    req.flash('error_msg', 'Gagal memuat data pembayaran.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// =======================================\r\n// POST: KONFIRMASI PEMBAYARAN (BERHASIL)\r\n// =======================================\r\nrouter.post('/confirm/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran-nya\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran:', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update tabel pembayaran -> confirmed\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'confirmed',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran:', err2);\r\n            req.flash('error_msg', 'Gagal mengkonfirmasi pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // ðŸ”Ž ambil data reservasi sebelum di-update untuk log status_awal\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> disetujui\r\n            await Model_Reservasi.Update(id_reservasi, { status: 'disetujui' });\r\n\r\n            // ðŸ”Ž ambil lagi sesudah update\r\n            const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasi = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n            // 3b) SIMPAN LOG RESERVASI\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'disetujui',\r\n                'Pembayaran dikonfirmasi admin'\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log konfirmasi pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) update jadwal -> terisi\r\n            if (reservasi && reservasi.id_jadwal) {\r\n              await Model_Jadwal.Update(reservasi.id_jadwal, { status_slot: 'terisi' });\r\n            }\r\n\r\n            // 5) kirim notifikasi ke pemain (kalau ada)\r\n            try {\r\n              if (reservasi && reservasi.id_user) {\r\n                // ====== DETAIL RESERVASI UNTUK NOTIF ======\r\n                const tanggalMain = reservasi.tanggal\r\n                  ? new Date(reservasi.tanggal).toLocaleDateString('id-ID', {\r\n                      weekday: 'long',\r\n                      day: 'numeric',\r\n                      month: 'long',\r\n                      year: 'numeric'\r\n                    })\r\n                  : '-';\r\n\r\n                const jamMulai   = reservasi.jam_mulai   ? reservasi.jam_mulai.substring(0, 5)   : '-';\r\n                const jamSelesai = reservasi.jam_selesai ? reservasi.jam_selesai.substring(0, 5) : '-';\r\n\r\n                const metodePembayaran = bayar.metode_pembayaran || 'â€“';\r\n\r\n                const isiPesan = (\r\n                  `Pembayaran Anda untuk arena ${reservasi.nama_arena || 'Arena'} ` +\r\n                  `pada ${tanggalMain} pukul ${jamMulai}â€“${jamSelesai} ` +\r\n                  `dengan metode ${metodePembayaran} telah dikonfirmasi. ` +\r\n                  `Booking Anda sekarang aktif.`\r\n                );\r\n\r\n                await Model_Notifikasi.Store({\r\n                  id_user: reservasi.id_user,\r\n                  judul: 'Pembayaran Dikonfirmasi',\r\n                  isi_pesan: isiPesan,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif konfirmasi pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil dikonfirmasi.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran:', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\n// ==================================\r\n// POST: TOLAK PEMBAYARAN (REJECTED)\r\n// ==================================\r\nrouter.post('/reject/:id_pembayaran', (req, res) => {\r\n  const id_pembayaran = req.params.id_pembayaran;\r\n  const { catatan_admin } = req.body || {};\r\n\r\n  // 1) ambil dulu pembayaran\r\n  connection.query(\r\n    'SELECT * FROM pembayaran WHERE id_pembayaran = ?',\r\n    [id_pembayaran],\r\n    async (err, rowsBayar) => {\r\n      if (err) {\r\n        console.error('ERR SELECT pembayaran (reject):', err);\r\n        req.flash('error_msg', 'Gagal mengambil data pembayaran.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      if (!rowsBayar || rowsBayar.length === 0) {\r\n        req.flash('error_msg', 'Data pembayaran tidak ditemukan.');\r\n        return res.redirect('/admin/pembayaran');\r\n      }\r\n\r\n      const bayar = rowsBayar[0];\r\n      const id_reservasi = bayar.id_reservasi;\r\n\r\n      // 2) update pembayaran -> rejected\r\n      connection.query(\r\n        `UPDATE pembayaran\r\n         SET status_pembayaran = 'rejected',\r\n             konfirmasi_admin = 1,\r\n             catatan_admin = ?,\r\n             updated_at = NOW()\r\n         WHERE id_pembayaran = ?`,\r\n        [catatan_admin || null, id_pembayaran],\r\n        async (err2) => {\r\n          if (err2) {\r\n            console.error('ERR UPDATE pembayaran (reject):', err2);\r\n            req.flash('error_msg', 'Gagal menolak pembayaran.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n\r\n          try {\r\n            // ðŸ”Ž ambil status reservasi sebelum diubah\r\n            const rowsReservasiBefore = await Model_Reservasi.getById(id_reservasi);\r\n            const reservasiBefore = rowsReservasiBefore && rowsReservasiBefore[0] ? rowsReservasiBefore[0] : null;\r\n            const statusAwal = reservasiBefore ? (reservasiBefore.status || null) : null;\r\n\r\n            // 3) update reservasi -> ditolak + kosongkan slot\r\n            if (typeof Model_Reservasi.rejectAndFreeSlot === 'function') {\r\n              await Model_Reservasi.rejectAndFreeSlot(id_reservasi);\r\n            } else {\r\n              await Model_Reservasi.Update(id_reservasi, { status: 'ditolak' });\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              if (rowsReservasi && rowsReservasi[0] && rowsReservasi[0].id_jadwal) {\r\n                await Model_Jadwal.Update(rowsReservasi[0].id_jadwal, { status_slot: 'kosong' });\r\n              }\r\n            }\r\n\r\n            // 3b) SIMPAN LOG RESERVASI (ditolak)\r\n            try {\r\n              await createLog(\r\n                id_reservasi,\r\n                statusAwal || 'menunggu',\r\n                'ditolak',\r\n                `Pembayaran ditolak admin. ${catatan_admin || ''}`\r\n              );\r\n            } catch (logErr) {\r\n              console.warn('Gagal membuat log tolak pembayaran:', logErr);\r\n            }\r\n\r\n            // 4) kirim notifikasi ke pemain\r\n            try {\r\n              const rowsReservasi = await Model_Reservasi.getById(id_reservasi);\r\n              const r = rowsReservasi && rowsReservasi[0] ? rowsReservasi[0] : null;\r\n\r\n              if (r && r.id_user) {\r\n                // alasan default kalau admin tidak isi catatan\r\n                const alasan =\r\n                  catatan_admin && catatan_admin.trim() !== ''\r\n                    ? catatan_admin\r\n                    : 'Pembayaran ditolak karena data tidak lengkap atau batas waktu upload bukti pembayaran sudah habis.';\r\n\r\n                // DETAIL RESERVASI\r\n                const tanggalMain = r.tanggal\r\n                  ? new Date(r.tanggal).toLocaleDateString('id-ID', {\r\n                      weekday: 'long',\r\n                      day: 'numeric',\r\n                      month: 'long',\r\n                      year: 'numeric'\r\n                    })\r\n                  : '-';\r\n\r\n                const jamMulai   = r.jam_mulai   ? r.jam_mulai.substring(0, 5)   : '-';\r\n                const jamSelesai = r.jam_selesai ? r.jam_selesai.substring(0, 5) : '-';\r\n\r\n                const metodePembayaran = bayar.metode_pembayaran || 'â€“';\r\n\r\n                const isiPesan = (\r\n                  `Pembayaran Anda untuk arena ${r.nama_arena || 'Arena'} ` +\r\n                  `pada ${tanggalMain} pukul ${jamMulai}â€“${jamSelesai} ` +\r\n                  `dengan metode ${metodePembayaran} ditolak. ` +\r\n                  `Alasan: ${alasan}`\r\n                );\r\n\r\n                await Model_Notifikasi.Store({\r\n                  id_user: r.id_user,\r\n                  judul: 'Pembayaran Ditolak',\r\n                  isi_pesan: isiPesan,\r\n                  jenis_notif: 'status',\r\n                  tipe: 'payment',\r\n                  dibaca: 0\r\n                });\r\n              }\r\n            } catch (notifErr) {\r\n              console.warn('Gagal kirim notif tolak pembayaran:', notifErr);\r\n            }\r\n\r\n            req.flash('success_msg', 'Pembayaran berhasil ditolak.');\r\n            return res.redirect('/admin/pembayaran');\r\n          } catch (e) {\r\n            console.error('ERR AFTER UPDATE pembayaran (reject):', e);\r\n            req.flash('error_msg', 'Pembayaran terupdate, tapi terjadi error lanjutan. Cek log server.');\r\n            return res.redirect('/admin/pembayaran');\r\n          }\r\n        }\r\n      );\r\n    }\r\n  );\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"pembayaran.dev.js"}