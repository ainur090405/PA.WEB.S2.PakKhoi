{"version":3,"sources":["reservasi_new.js"],"names":["express","require","router","Router","Model_Reservasi","isAuthenticated","isAdmin","use","get","req","res","getAll","reservasi","render","title","data","console","error","flash","redirect","id","params","getById","reservasiData","length","post","body","status","catatan","dataToUpdate","Update","Model_Notifikasi","notifData","id_user","judul","pesan","nama_arena","tipe","dibaca","Store","code","Delete","csv","forEach","r","id_reservasi","nama_user","Date","tanggal","toLocaleDateString","jam_mulai","substring","tanggal_pesan","payment_method","amount","header","attachment","send","module","exports"],"mappings":"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","sourcesContent":["// routes/reservasi.js\r\nconst express = require('express');\r\nconst router = express.Router();\r\nconst Model_Reservasi = require('../models/Model_Reservasi');\r\nconst { isAuthenticated, isAdmin } = require('../middleware/authMiddleware');\r\n\r\n// Lindungi semua rute, hanya Admin\r\nrouter.use(isAuthenticated, isAdmin);\r\n\r\n// GET: Tampilkan daftar reservasi\r\nrouter.get('/', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    res.render('admin/reservasi/index', {\r\n      title: 'Manajemen Reservasi',\r\n      data: reservasi\r\n    });\r\n  } catch (err) {\r\n    console.error(err); // Tampilkan error di console\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/admin/dashboard');\r\n  }\r\n});\r\n\r\n// GET: Form edit reservasi (untuk ubah status)\r\nrouter.get('/edit/:id', async (req, res) => {\r\n  try {\r\n    const id = req.params.id;\r\n    const reservasiData = await Model_Reservasi.getById(id);\r\n\r\n    if (reservasiData.length === 0) {\r\n      req.flash('error_msg', 'Reservasi tidak ditemukan.');\r\n      return res.redirect('/reservasi');\r\n    }\r\n\r\n    res.render('admin/reservasi/edit', {\r\n      title: 'Update Status Reservasi',\r\n      reservasi: reservasiData[0]\r\n    });\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memuat data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n// POST: Update reservasi\r\nrouter.post('/update/:id', async (req, res) => {\r\n  const id = req.params.id;\r\n  try {\r\n    const { status, catatan } = req.body;\r\n    const dataToUpdate = { status, catatan };\r\n\r\n    await Model_Reservasi.Update(id, dataToUpdate);\r\n\r\n    // Jika status diubah menjadi 'disetujui' atau 'selesai', kirim notifikasi ke pemain\r\n    if (status === 'disetujui' || status === 'selesai') {\r\n      const Model_Notifikasi = require('../models/Model_Notifikasi_new');\r\n      const reservasiData = await Model_Reservasi.getById(id);\r\n\r\n      if (reservasiData.length > 0) {\r\n        const notifData = {\r\n          id_user: reservasiData[0].id_user,\r\n          judul: status === 'disetujui' ? 'Booking Disetujui' : 'Booking Selesai',\r\n          pesan: `Booking Anda untuk arena ${reservasiData[0].nama_arena} telah ${status === 'disetujui' ? 'disetujui' : 'selesai'}.`,\r\n          tipe: 'booking',\r\n          dibaca: 0\r\n        };\r\n        await Model_Notifikasi.Store(notifData);\r\n      }\r\n    }\r\n\r\n    req.flash('success_msg', 'Status reservasi berhasil diperbarui.');\r\n    res.redirect('/admin/reservasi'); // ✅ FIX\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal memperbarui reservasi: ' + err.code);\r\n    res.redirect('/admin/reservasi/edit/' + id); // ✅ FIX\r\n  }\r\n});\r\n\r\n\r\n// GET: Hapus reservasi\r\nrouter.get('/delete/:id', async (req, res) => {\r\n  try {\r\n    await Model_Reservasi.Delete(req.params.id);\r\n    req.flash('success_msg', 'Data reservasi berhasil dihapus.');\r\n    res.redirect('/reservasi');\r\n  } catch (err) {\r\n    req.flash('error_msg', 'Gagal menghapus reservasi: ' + err.code);\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\n// GET: Download reservasi data as CSV\r\nrouter.get('/download', async (req, res) => {\r\n  try {\r\n    const reservasi = await Model_Reservasi.getAll();\r\n    let csv = 'ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Pembayaran,Jumlah\\n';\r\n\r\n    reservasi.forEach(r => {\r\n      csv += `${r.id_reservasi},${r.nama_user},${r.nama_arena},${new Date(r.tanggal).toLocaleDateString('id-ID')},${r.jam_mulai.substring(0,5)},${new Date(r.tanggal_pesan).toLocaleDateString('id-ID')},${r.status},${r.payment_method || ''},${r.amount || 0}\\n`;\r\n    });\r\n\r\n    res.header('Content-Type', 'text/csv');\r\n    res.attachment('reservasi.csv');\r\n    res.send(csv);\r\n  } catch (err) {\r\n    console.error(err);\r\n    req.flash('error_msg', 'Gagal mendownload data reservasi.');\r\n    res.redirect('/reservasi');\r\n  }\r\n});\r\n\r\nmodule.exports = router;\r\n"],"file":"reservasi_new.dev.js"}