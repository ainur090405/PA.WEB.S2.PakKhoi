"use strict";var express=require("express"),router=express.Router(),Model_Reservasi=require("../models/Model_Reservasi"),Model_Jadwal=require("../models/Model_Jadwal"),Model_Notifikasi=require("../models/Model_Notifikasi"),Model_LogReservasi=require("../models/Model_LogReservasi"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isAdmin=_require.isAdmin;router.use(isAuthenticated,isAdmin),router.get("/",function(a,r){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Reservasi.getAll());case 3:t=e.sent,r.render("admin/reservasi/index",{title:"Manajemen Reservasi",data:t}),e.next=12;break;case 7:return e.prev=7,e.t0=e.catch(0),console.error("ERR GET /admin/reservasi:",e.t0),a.flash("error_msg","Gagal memuat data reservasi."),e.abrupt("return",r.redirect("/admin/dashboard"));case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/edit/:id",function(a,r){var t,n,s,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=parseInt(a.params.id,10),e.next=4,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 4:if((n=e.sent)&&0!==n.length){e.next=8;break}return a.flash("error_msg","Data reservasi tidak ditemukan."),e.abrupt("return",r.redirect("/admin/reservasi"));case 8:return s=n[0],i=[],e.prev=10,e.next=13,regeneratorRuntime.awrap(Model_LogReservasi.getByReservasi(t));case 13:i=e.sent,e.next=19;break;case 16:e.prev=16,e.t0=e.catch(10),console.warn("Gagal mengambil log reservasi:",e.t0);case 19:r.render("admin/reservasi/edit",{title:"Update Status Reservasi",reservasi:s,logs:i}),e.next=27;break;case 22:e.prev=22,e.t1=e.catch(0),console.error("ERR GET /admin/reservasi/edit:",e.t1),a.flash("error_msg","Gagal memuat data reservasi."),r.redirect("/admin/reservasi");case 27:case"end":return e.stop()}},null,null,[[0,22],[10,16]])}),router.post("/update-status/:id",function(a,r){var t,n,s,i,o,u,d,c,l,m,p;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=a.params.id,n=a.body.status,e.next=5,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 5:if((s=e.sent)&&0!==s.length){e.next=9;break}return a.flash("error_msg","Reservasi tidak ditemukan."),e.abrupt("return",r.redirect("/admin/reservasi"));case 9:if(i=s[0],o=i.status,"ditolak"!==n){e.next=27;break}if("function"==typeof Model_Reservasi.rejectAndFreeSlot)return e.next=15,regeneratorRuntime.awrap(Model_Reservasi.rejectAndFreeSlot(t));e.next=17;break;case 15:e.next=25;break;case 17:return e.next=19,regeneratorRuntime.awrap(Model_Reservasi.Update(t,{status:"ditolak"}));case 19:return e.next=21,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 21:if((u=e.sent)&&u[0]&&u[0].id_jadwal)return e.next=25,regeneratorRuntime.awrap(Model_Jadwal.Update(u[0].id_jadwal,{status_slot:"kosong"}));e.next=25;break;case 25:e.next=48;break;case 27:return e.next=29,regeneratorRuntime.awrap(Model_Reservasi.Update(t,{status:n}));case 29:return e.next=31,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 31:if(!(d=e.sent)||!d[0]){e.next=48;break}if(!(c=d[0].id_jadwal)){e.next=48;break}if("disetujui"===n)return e.next=38,regeneratorRuntime.awrap(Model_Jadwal.Update(c,{status_slot:"terisi"}));e.next=40;break;case 38:e.next=48;break;case 40:if("batal"===n||"ditolak"===n)return e.next=43,regeneratorRuntime.awrap(Model_Jadwal.Update(c,{status_slot:"kosong"}));e.next=45;break;case 43:e.next=48;break;case 45:if("selesai"===n)return e.next=48,regeneratorRuntime.awrap(Model_Jadwal.Update(c,{status_slot:"terisi"}));e.next=48;break;case 48:return e.prev=48,e.next=51,regeneratorRuntime.awrap(Model_LogReservasi.catatStatus(t,o,n,"Update via tombol cepat /update-status"));case 51:e.next=56;break;case 53:e.prev=53,e.t0=e.catch(48),console.warn("Gagal mencatat log reservasi (update-status):",e.t0);case 56:return e.prev=56,e.next=59,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 59:if(!((l=e.sent)&&l[0]&&l[0].id_user)){e.next=66;break}if(m=l[0],p={id_user:m.id_user,judul:"Status Booking: ".concat(n.toUpperCase()),isi_pesan:"disetujui"===n?"Booking Anda untuk arena ".concat(m.nama_arena," telah disetujui."):"ditolak"===n?"Maaf, booking Anda untuk arena ".concat(m.nama_arena," ditolak."):"selesai"===n?"Terima kasih telah bermain di ".concat(m.nama_arena,"."):"Status booking Anda telah berubah menjadi ".concat(n,"."),jenis_notif:"status",tipe:"booking",dibaca:0},"function"==typeof Model_Notifikasi.Store)return e.next=66,regeneratorRuntime.awrap(Model_Notifikasi.Store(p));e.next=66;break;case 66:e.next=71;break;case 68:e.prev=68,e.t1=e.catch(56),console.warn("Gagal kirim notifikasi (non blocking):",e.t1);case 71:return a.flash("success_msg","Status reservasi berhasil diperbarui menjadi ".concat(n,".")),e.abrupt("return",r.redirect("/admin/reservasi"));case 75:return e.prev=75,e.t2=e.catch(0),console.error("ERR POST /admin/reservasi/update-status:",e.t2),a.flash("error_msg","Gagal memperbarui status reservasi."),e.abrupt("return",r.redirect("/admin/reservasi"));case 80:case"end":return e.stop()}},null,null,[[0,75],[48,53],[56,68]])}),router.post("/update/:id",function(a,r){var t,n,s,i,o,u,d,c,l,m;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=a.params.id,e.prev=1,n=a.body,s=n.status,i=n.catatan,o={status:s,catatan:i},e.next=6,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 6:if((u=e.sent)&&0!==u.length){e.next=10;break}return a.flash("error_msg","Reservasi tidak ditemukan."),e.abrupt("return",r.redirect("/admin/reservasi"));case 10:return d=u[0],c=d.status,l=d.id_jadwal,e.next=15,regeneratorRuntime.awrap(Model_Reservasi.Update(t,o));case 15:if(!l){e.next=29;break}if("disetujui"===s)return e.next=19,regeneratorRuntime.awrap(Model_Jadwal.Update(l,{status_slot:"terisi"}));e.next=21;break;case 19:e.next=29;break;case 21:if("ditolak"===s||"batal"===s)return e.next=24,regeneratorRuntime.awrap(Model_Jadwal.Update(l,{status_slot:"kosong"}));e.next=26;break;case 24:e.next=29;break;case 26:if("selesai"===s)return e.next=29,regeneratorRuntime.awrap(Model_Jadwal.Update(l,{status_slot:"terisi"}));e.next=29;break;case 29:return e.prev=29,e.next=32,regeneratorRuntime.awrap(Model_LogReservasi.catatStatus(t,c,s,i||null));case 32:e.next=37;break;case 34:e.prev=34,e.t0=e.catch(29),console.warn("Gagal mencatat log reservasi (update form):",e.t0);case 37:if(!d.id_user){e.next=42;break}if(m={id_user:d.id_user,judul:"Status Booking: ".concat(s.toUpperCase()),isi_pesan:"disetujui"===s?"Booking Anda untuk arena ".concat(d.nama_arena," telah disetujui."):"ditolak"===s?"Maaf, booking Anda untuk arena ".concat(d.nama_arena," ditolak."):"selesai"===s?"Terima kasih telah bermain di ".concat(d.nama_arena,"."):"Status booking Anda telah berubah menjadi ".concat(s,"."),jenis_notif:"status",tipe:"booking",dibaca:0},"function"==typeof Model_Notifikasi.Store)return e.next=42,regeneratorRuntime.awrap(Model_Notifikasi.Store(m));e.next=42;break;case 42:return a.flash("success_msg","Status reservasi berhasil diperbarui."),e.abrupt("return",r.redirect("/admin/reservasi"));case 46:return e.prev=46,e.t1=e.catch(1),console.error("ERR POST /admin/reservasi/update:",e.t1),a.flash("error_msg","Gagal memperbarui reservasi: "+e.t1.message),e.abrupt("return",r.redirect("/admin/reservasi/edit/"+t));case 51:case"end":return e.stop()}},null,null,[[1,46],[29,34]])}),router.get("/delete/:id",function(a,r){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Reservasi.Delete(a.params.id));case 3:return a.flash("success_msg","Data reservasi berhasil dihapus."),e.abrupt("return",r.redirect("/admin/reservasi"));case 7:return e.prev=7,e.t0=e.catch(0),console.error("ERR GET /admin/reservasi/delete:",e.t0),a.flash("error_msg","Gagal menghapus reservasi: "+(e.t0.message||e.t0.code)),e.abrupt("return",r.redirect("/admin/reservasi"));case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/download",function(a,r){var t,u;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Reservasi.getAll());case 3:return t=e.sent,u="ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Metode Pembayaran,Status Pembayaran,Jumlah,Bukti\n",t.forEach(function(e){var a=e.tanggal?new Date(e.tanggal).toLocaleDateString("id-ID"):"",r=e.jam_mulai?e.jam_mulai.substring(0,5):"",t=e.tanggal_pesan?new Date(e.tanggal_pesan).toLocaleDateString("id-ID"):"",n=e.metode_pembayaran||"",s=e.status_pembayaran||"",i=e.jumlah||0,o=e.pembayaran_bukti||"";u+="".concat(e.id_reservasi,',"').concat((e.nama_user||"").replace(/"/g,'""'),'","').concat((e.nama_arena||"").replace(/"/g,'""'),'",').concat(a,",").concat(r,",").concat(t,",").concat(e.status||"",",").concat(n,",").concat(s,",").concat(i,",").concat(o,"\n")}),r.header("Content-Type","text/csv"),r.attachment("reservasi.csv"),e.abrupt("return",r.send(u));case 11:return e.prev=11,e.t0=e.catch(0),console.error("ERR GET /admin/reservasi/download:",e.t0),a.flash("error_msg","Gagal mendownload data reservasi."),e.abrupt("return",r.redirect("/admin/reservasi"));case 16:case"end":return e.stop()}},null,null,[[0,11]])}),module.exports=router;
//# sourceMappingURL=reservasi.min.js.map
