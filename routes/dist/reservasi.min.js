"use strict";var express=require("express"),router=express.Router(),Model_Reservasi=require("../models/Model_Reservasi"),Model_Pembayaran=require("../models/Model_Pembayaran"),_require=require("../middleware/authMiddleware"),isAuthenticated=_require.isAuthenticated,isAdmin=_require.isAdmin;router.use(isAuthenticated,isAdmin),router.get("/",function(r,a){var t;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Reservasi.getAll());case 3:t=e.sent,a.render("admin/reservasi/index",{title:"Manajemen Reservasi",data:t}),e.next=12;break;case 7:e.prev=7,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memuat data reservasi."),a.redirect("/admin/dashboard");case 12:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/edit/:id",function(r,a){var t,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=r.params.id,e.next=4,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 4:if(0===(s=e.sent).length)return r.flash("error_msg","Reservasi tidak ditemukan."),e.abrupt("return",a.redirect("/reservasi"));e.next=8;break;case 8:a.render("admin/reservasi/edit",{title:"Update Status Reservasi",reservasi:s[0]}),e.next=15;break;case 11:e.prev=11,e.t0=e.catch(0),r.flash("error_msg","Gagal memuat data reservasi."),a.redirect("/reservasi");case 15:case"end":return e.stop()}},null,null,[[0,11]])}),router.post("/update-status/:id",function(r,a){var t,s,n,i;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,t=r.params.id,"ditolak"===(s=r.body.status))return e.next=6,regeneratorRuntime.awrap(Model_Reservasi.rejectAndFreeSlot(t));e.next=8;break;case 6:e.next=22;break;case 8:return e.next=10,regeneratorRuntime.awrap(Model_Reservasi.Update(t,{status:s}));case 10:return e.next=12,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 12:if(n=e.sent,i=n[0].id_jadwal,"disetujui"===s)return e.next=17,regeneratorRuntime.awrap(Model_Jadwal.Update(i,{status_slot:"terisi"}));e.next=19;break;case 17:e.next=22;break;case 19:if("batal"===s)return e.next=22,regeneratorRuntime.awrap(Model_Jadwal.Update(i,{status_slot:"kosong"}));e.next=22;break;case 22:r.flash("success_msg","Status reservasi berhasil diperbarui menjadi ".concat(s)),a.redirect("/reservasi"),e.next=31;break;case 26:e.prev=26,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal memperbarui status reservasi"),a.redirect("/reservasi");case 31:case"end":return e.stop()}},null,null,[[0,26]])}),router.post("/update/:id",function(r,a){var t,s,n,i,u,o,c,d,l,m;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.params.id,e.prev=1,s=r.body,n=s.status,i=s.catatan,u={status:n,catatan:i},e.next=6,regeneratorRuntime.awrap(Model_Reservasi.getById(t));case 6:if(0===(o=e.sent).length)return r.flash("error_msg","Reservasi tidak ditemukan."),e.abrupt("return",a.redirect("/admin/reservasi"));e.next=10;break;case 10:return c=o[0].id_jadwal,d=require("../models/Model_Jadwal"),l=require("../models/Model_Notifikasi"),e.next=15,regeneratorRuntime.awrap(Model_Reservasi.Update(t,u));case 15:if("disetujui"===n)return e.next=18,regeneratorRuntime.awrap(d.Update(c,{status_slot:"terisi"}));e.next=20;break;case 18:e.next=28;break;case 20:if("ditolak"===n||"batal"===n)return e.next=23,regeneratorRuntime.awrap(d.Update(c,{status_slot:"kosong"}));e.next=25;break;case 23:e.next=28;break;case 25:if("selesai"===n)return e.next=28,regeneratorRuntime.awrap(d.Update(c,{status_slot:"terisi"}));e.next=28;break;case 28:if(o[0].id_user)return m={id_user:o[0].id_user,judul:"Status Booking: ".concat(n.toUpperCase()),isi_pesan:"disetujui"===n?"Booking Anda untuk arena ".concat(o[0].nama_arena," telah disetujui."):"ditolak"===n?"Maaf, booking Anda untuk arena ".concat(o[0].nama_arena," ditolak."):"selesai"===n?"Terima kasih telah bermain di ".concat(o[0].nama_arena,"."):"Status booking Anda telah berubah menjadi ".concat(n,"."),jenis_notif:"status",tipe:"booking",dibaca:0},e.next=32,regeneratorRuntime.awrap(l.Store(m));e.next=32;break;case 32:r.flash("success_msg","Status reservasi berhasil diperbarui."),a.redirect("/admin/reservasi"),e.next=41;break;case 36:e.prev=36,e.t0=e.catch(1),console.error(e.t0),r.flash("error_msg","Gagal memperbarui reservasi: "+e.t0.message),a.redirect("/admin/reservasi/edit/"+t);case 41:case"end":return e.stop()}},null,null,[[1,36]])}),router.get("/delete/:id",function(r,a){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Reservasi.Delete(r.params.id));case 3:r.flash("success_msg","Data reservasi berhasil dihapus."),a.redirect("/reservasi"),e.next=11;break;case 7:e.prev=7,e.t0=e.catch(0),r.flash("error_msg","Gagal menghapus reservasi: "+e.t0.code),a.redirect("/reservasi");case 11:case"end":return e.stop()}},null,null,[[0,7]])}),router.get("/download",function(r,a){var t,s;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,regeneratorRuntime.awrap(Model_Reservasi.getAll());case 3:t=e.sent,s="ID,Pemesan,Arena,Tanggal Main,Jam,Tanggal Pesan,Status,Pembayaran,Jumlah\n",t.forEach(function(e){s+="".concat(e.id_reservasi,",").concat(e.nama_user,",").concat(e.nama_arena,",").concat(new Date(e.tanggal).toLocaleDateString("id-ID"),",").concat(e.jam_mulai.substring(0,5),",").concat(new Date(e.tanggal_pesan).toLocaleDateString("id-ID"),",").concat(e.status,",").concat(e.payment_method||"",",").concat(e.amount||0,"\n")}),a.header("Content-Type","text/csv"),a.attachment("reservasi.csv"),a.send(s),e.next=16;break;case 11:e.prev=11,e.t0=e.catch(0),console.error(e.t0),r.flash("error_msg","Gagal mendownload data reservasi."),a.redirect("/reservasi");case 16:case"end":return e.stop()}},null,null,[[0,11]])}),module.exports=router;
//# sourceMappingURL=reservasi.min.js.map
